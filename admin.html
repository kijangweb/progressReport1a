<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Administrasi</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background-color: #f4f4f9; display: none; }
    .admin-container { max-width: 900px; margin: auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
    
    .main-header { display: flex; flex-direction: column; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; gap: 10px; }
    h1 { margin: 0; color: #007bff; }
    .logout-btn { padding: 8px 15px; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; width: 100%; text-align: center; }

    h3, h4 { color: #333; }
    .user-table, .bank-table, .student-table { width: 100%; border-collapse: collapse; margin-top: 10px; table-layout: auto; }
    .user-table th, .user-table td, .bank-table th, .bank-table td, .student-table th, .student-table td { border: 1px solid #ddd; padding: 12px; text-align: left; vertical-align: middle; }
    .user-table th, .bank-table th, .student-table th { background-color: #f2f2f2; white-space: normal; }
    .user-table td, .bank-table td, .student-table td { word-wrap: break-word; }
    
    .action-btn-disable, .action-btn-enable, .action-btn-edit {
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      border: none;
      margin-right: 5px;
      white-space: nowrap;
      width: auto;
    }
    .action-btn-disable { background-color: #ffc107; color: black; }
    .action-btn-enable { background-color: #28a745; color: white; }
    .action-btn-edit { background-color: #007bff; color: white; }

    .form-row { display: flex; flex-direction: column; gap: 10px; }
    .form-row > div { flex: 1; }
    
    .add-user-section input, .add-user-section select, 
    .reset-password-section select, .transfer-section select, 
    .bank-management-section input, .bank-management-section select,
    .filter-spp-options select, .filter-spp-options button,
    .branding-management-section input,
    #adminOverrideForm select, #adminOverrideForm input { /* <-- Styling Override Form */
      padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box; 
    }
    .add-user-section button, .reset-password-section button, 
    .transfer-section button, .bank-management-section button, 
    .spp-management-section button, .add-user-section .btn,
    .bulk-action-container button, .pagination-controls button,
    .filter-controls button, .branding-management-section button,
    .content-block #pinForm button,
    #adminOverrideForm button { /* <-- Styling Override Button */
      padding: 8px 15px; background-color: #28a745; color: white; 
      border: none; border-radius: 4px; cursor: pointer; 
      width: 100%; text-align: center;
    }
    
    h3, h4 { text-align: left; }
    #statusMessage, #resetPasswordStatusMessage, #studentStatusMessage, #transferStatusMessage, #bankStatusMessage, #sppDeleteStatusMessage, #sppSizeInfo, #sppGlobalStats, #brandingStatusMessage, #pinStatusMessage, #changePasswordStatusMessage, #overrideStatusMessage { margin-top: 15px; font-weight: bold; }
    
    .bulk-action-container { margin-top: 20px; padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #f9f9f9; display: flex; flex-direction: column; align-items: stretch; gap: 15px; }
    .bulk-action-container label { text-align: left; }
    .bulk-action-container select, .bulk-action-container button { width: 100%; }
    
    .pagination-controls select { width: auto; }
    .pagination-controls button { width: 100%; }

    .filter-controls { margin: 15px 0 5px 0; display: flex; flex-direction: column; gap: 10px; align-items: stretch; flex-wrap: wrap; }
    .disabled-row td { text-decoration: line-through; color: #999; background-color: #f8f9fa !important; }
    
    .pagination-controls { margin-top: 15px; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 10px; }
    .pagination-controls button:disabled { background-color: #ccc; cursor: not-allowed; }
    
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
    .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 8px; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    .modal-header h2 { margin: 0; color: #007bff; }
    .close-btn { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
    .close-btn:hover { color: black; }
    .modal-body { padding-top: 20px; }
    .modal-body .form-group { margin-bottom: 15px; }
    .modal-body label { display: block; margin-bottom: 5px; font-weight: bold; }
    .modal-body input, .modal-body select { width: 100%; padding: 8px; box-sizing: border-box; border-radius: 4px; border: 1px solid #ccc; }
    .modal-footer { text-align: right; padding-top: 20px; border-top: 1px solid #eee; }
    .modal-footer button { background-color: #007bff; }
    .curriculum-editor { border: 1px solid #ddd; padding: 15px; margin-top: 10px; border-radius: 6px; max-height: 400px; overflow-y: auto; }
    .lesson-input-group { margin-bottom: 10px; display: flex; flex-direction: column; align-items: stretch; }
    .lesson-input-group label { font-weight: bold; display: inline-block; width: auto; margin-bottom: 5px; }
    .lesson-input-group input { width: 100%; padding: 5px; }
    .add-lesson-btn { background-color: #17a2b8; color: white; border: none; padding: 8px 12px; margin-top: 15px; border-radius: 4px; cursor: pointer; }
    .btn-delete-attachments { background-color: #ffc107; color: black; border: none; padding: 8-px 15px; border-radius: 4px; cursor: pointer; }
    .spp-stats-info { margin-top: 20px; padding: 15px; background-color: #e2eafc; border-radius: 8px; border: 1px solid #b3cbe8; }
    .spp-stats-info p { margin: 5px 0; }
    .global-spp-stats { margin-top: 20px; padding: 15px; background-color: #e9f5e9; border-radius: 8px; border: 1px solid #c3e6cb; text-align: center; }
    .global-spp-stats p { margin: 5px 0; }
    .global-spp-stats span { font-size: 1.2em; font-weight: bold; color: #28a745; }
    .filter-spp-options { display: flex; flex-direction: column; gap: 10px; align-items: stretch; margin-bottom: 10px; }
    .filter-spp-options select, .filter-spp-options button { min-width: auto; width: 100%; }
    #readStatusIndicator { position: fixed; bottom: 10px; right: 10px; background-color: #212529; color: white; padding: 8px 15px; border-radius: 20px; font-size: 14px; font-family: monospace; z-index: 2000; box-shadow: 0 2px 10px rgba(0,0,0,0.3); opacity: 0.8; transition: opacity 0.3s; }
    #readStatusIndicator:hover { opacity: 1; }
    #readStatusIndicator button { margin-left: 10px; padding: 2px 8px; font-size: 12px; cursor: pointer; }
    
    .transfer-section > .form-row { display: flex; flex-direction: column; gap: 10px; }
    .transfer-section select { width: 100%; }
    .transfer-section button { align-self: stretch; margin-top: 10px; }

    .bulk-action-content {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .tabs {
      display: flex;
      border-bottom: 2px solid #ccc;
      margin-bottom: 20px;
      overflow-x: auto;
      white-space: nowrap;
    }
    .tab-btn {
      background-color: transparent;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      font-size: 1em;
      font-weight: 600;
      color: #6c757d;
      transition: color 0.2s, border-bottom 0.2s;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
    }
    .tab-btn.active {
      color: #007bff;
      border-bottom: 2px solid #007bff;
    }
    .tab-content {
      display: none;
      overflow-y: auto;
    }
    .tab-content.active {
      display: block;
    }
    .content-block {
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 8px;
      margin-top: 20px;
    }
    .table-container {
      overflow-x: auto;
    }
    
    @media (min-width: 768px) {
      .main-header { flex-direction: row; align-items: center; }
      h1 { text-align: left; }
      .logout-btn { width: auto; }
      
      .user-table th:first-child, .user-table td:first-child { width: 10%; }
      .user-table th:nth-child(2), .user-table td:nth-child(2) { width: 20%; }
      .user-table th:nth-child(3), .user-table td:nth-child(3) { width: 15%; }
      .user-table th:nth-child(4), .user-table td:nth-child(4) { width: 10%; }
      .user-table th:nth-child(5), .user-table td:nth-child(5) { width: 10%; }
      .user-table th:nth-child(6), .user-table td:nth-child(6) { width: 10%; }
      .user-table th:last-child, .user-table td:last-child { width: 25%; }
      .user-table td:last-child { text-align: left; }

      .filter-controls { flex-direction: row; gap: 20px; align-items: center; }
      .pagination-controls { flex-direction: row; justify-content: space-between; align-items: center; gap: 10px; }
      
      .form-row { flex-direction: row; align-items: flex-end; justify-content: flex-start; gap: 10px; }
      .form-row > div { flex: 1; min-width: 150px; }
      .form-row button { width: auto; align-self: flex-end; }
      
      .transfer-section > .form-row { 
        flex-direction: row;
        align-items: flex-end;
        gap: 15px;
        justify-content: flex-start;
      }
      .transfer-section .form-row > div {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
      }
      .transfer-section button { width: auto; margin-top: 0; }
      
      .filter-spp-options { flex-direction: row; gap: 10px; align-items: center; }
      .filter-spp-options select { min-width: 120px; width: auto; }
      .filter-spp-options button { margin-left: auto; width: auto; }
      
      .bulk-action-container { flex-direction: column; align-items: flex-start; gap: 15px; }
      .bulk-action-content {
        display: flex;
        flex-direction: row;
        align-items: flex-end;
        gap: 10px;
        flex-wrap: wrap;
      }
      .bulk-action-content .form-group {
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 10px;
        margin-bottom: 0;
      }
      .bulk-action-content select {
        width: 250px;
      }
      .bulk-action-content button {
        width: auto;
        margin-top: 0;
      }

      .user-table th, .user-table td, .bank-table th, .bank-table td, .student-table th, .student-table td { padding: 12px; }
      
      .lesson-input-group { flex-direction: row; align-items: center; }
      .lesson-input-group label { width: 90px; margin-bottom: 0; }
      .lesson-input-group input { width: calc(100% - 100px); }
      
      #userRowsPerPage, #studentRowsPerPage { width: auto; }
      #userPagination > div, #studentPagination > div {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      #addUserForm .form-row {
        display: flex;
        flex-wrap: wrap;
        align-items: flex-start;
        gap: 10px;
      }
      #addUserForm .form-row > div {
        flex: 1 1 200px;
      }
      #addUserForm .form-row button {
        width: auto;
        align-self: auto;
        margin-top: 20px;
      }
      
      .table-container {
        overflow-x: unset;
      }
    }
    @media (min-width: 900px) {
      #addUserForm .form-row > div {
        flex: 1;
      }
      #addUserForm .form-row button {
        margin-top: 0;
        align-self: flex-end;
      }
      /* Penyesuaian untuk Override Form di Desktop */
      #adminOverrideForm .form-row {
        flex-direction: row;
        align-items: flex-end;
        gap: 10px;
      }
      #adminOverrideForm .form-row > div {
        flex: 1;
      }
      #adminOverrideForm .form-row button {
        width: auto;
        margin-top: 0;
      }
    }

    .export-filters {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 20px;
    }
    .export-filters .filter-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .export-filters label {
      font-weight: bold;
    }
    .export-filters select,
    .export-filters button {
      width: 100%;
      box-sizing: border-box;
    }
    @media (min-width: 768px) {
      .export-filters {
        flex-direction: row;
        flex-wrap: wrap;
        align-items: flex-end;
      }
      .export-filters .filter-group {
        flex: 1;
        min-width: 150px;
      }
      .export-filters button {
        flex: 0;
        width: auto;
        align-self: flex-end;
        margin-bottom: 0;
      }
      /* Penyesuaian untuk Pengaturan PIN agar rapi di desktop */
      #pinForm .form-row {
        align-items: flex-end;
      }
      #pinForm .form-row > div {
        flex: 1;
      }
    }
  </style>
</head>
<body>
  <div id="readStatusIndicator">Reads Sesi Ini: 0</div>
  <div class="admin-container">
    <div class="main-header">
      <div>
        <h1>Panel Direktur</h1>
        <h4 id="companyNameHeader">Loading...</h4>
      </div>
      <button type="button" class="logout-btn" onclick="logout()">Logout</button>
    </div>
    <div class="tabs">
      <button class="tab-btn active" onclick="openTab('pengguna-tab')">Pengguna</button>
      <button class="tab-btn" onclick="openTab('kurikulum-tab')">Kurikulum</button>
      <button class="tab-btn" onclick="openTab('bank-tab')">Manajemen Bank</button>
      <button class="tab-btn" onclick="openTab('maintenance-tab')">Maintenance</button>
      <button class="tab-btn" onclick="openTab('spp-export-tab')">Export SPP</button>
    </div>

    <div id="pengguna-tab" class="tab-content active">
      <div class="content-block">
        <h3>Daftar Pengguna</h3>
        <div class="filter-controls">
          <div>
            <input type="checkbox" id="showDisabledUsers"><label for="showDisabledUsers">Tampilkan Pengguna Nonaktif</label>
          </div>
          <div>
            <input type="checkbox" id="showCoachesOnly"><label for="showCoachesOnly">Hanya Tampilkan Coach</label>
          </div>
          <button type="button" id="syncCountBtn" style="background-color: #17a2b8; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">Sinkronkan Jumlah Siswa</button>
        </div>
        <div class="table-container">
          <table class="user-table" id="usersTable"><thead><tr><th>ID</th><th>Email</th><th>Nama</th><th>Jml. Siswa</th><th>Role</th><th>Status</th><th>Aksi</th></tr></thead><tbody id="usersTableBody"></tbody></table>
        </div>
        <div class="pagination-controls" id="userPagination">
          <select id="userRowsPerPage"><option value="5" selected>5</option><option value="10">10</option><option value="15">15</option><option value="20">20</option></select>
          <div>
            <button type="button" id="userPrevBtn" disabled>&laquo; Sebelumnya</button>
            <span style="margin: 0 10px;">Halaman <b id="userCurrentPage">1</b> dari <b id="userTotalPages">1</b></span>
            <button type="button" id="userNextBtn" disabled>Berikutnya &raquo;</button>
          </div>
        </div>
      </div>
      <div class="content-block">
        <h4>Tambah Pengguna Baru</h4>
        <form id="addUserForm">
          <div class="form-row">
            <div><input type="email" id="newUserEmail" placeholder="Email" required></div>
            <div><input type="text" id="newUserName" placeholder="Nama" required></div>
            <div><input type="password" id="newUserPassword" placeholder="Kata Sandi" required></div>
            <div>
              <select id="newUserRole" required>
                <option value="user">Coach</option>
                <option value="bendahara">ADMIN</option>
                <option value="admin">DIREKTUR</option>
              </select>
            </div>
            <div><button type="submit" class="btn">Tambah Pengguna</button></div>
          </div>
          <div id="statusMessage"></div>
        </form>
      </div>
      
      <div class="content-block">
          <h4>Admin Override: Ganti Kata Sandi Langsung</h4>
          <p>Gunakan fitur ini untuk mengubah kata sandi pengguna secara langsung. Anda akan **sejenak mengambil alih sesi pengguna target** di latar belakang. Fitur ini aman karena menggunakan sesi otentikasi sekunder.</p>
          <form id="adminOverrideForm">
              <div class="form-row">
                  <div>
                      <label for="overrideEmailSelector">Pilih Pengguna:</label>
                      <select id="overrideEmailSelector" required></select>
                  </div>
                  <div>
                      <label for="overrideCurrentPassword">Kata Sandi Target Saat Ini (Lama)</label>
                      <input type="password" id="overrideCurrentPassword" required placeholder="Password Lama Target">
                  </div>
                  <div>
                      <label for="overrideNewPassword">Kata Sandi Baru</label>
                      <input type="password" id="overrideNewPassword" required placeholder="Password Baru (Min. 6 karakter)">
                  </div>
                  <div>
                      <button type="submit" class="btn" style="background-color: #00a0a0;">Ganti Password (Override)</button>
                  </div>
              </div>
              <div id="overrideStatusMessage" style="margin-top: 10px; font-weight: bold;"></div>
          </form>
      </div>
      <div class="content-block">
        <h4>Reset Password</h4>
        <p>Gunakan fitur ini untuk mengirim tautan reset password ke email pengguna.</p>
        <form id="resetPasswordForm">
          <div class="form-row">
            <div><select id="resetEmailSelector" required></select></div>
            <div><button type="submit" class="btn">Kirim Email Reset</button></div>
          </div>
          <div id="resetPasswordStatusMessage"></div>
        </form>
      </div>
      
    </div>

    <div id="kurikulum-tab" class="tab-content">
      <div class="content-block">
        <h3>Manajemen Kurikulum</h3>
        <h4>Tambah Level Kurikulum Baru</h4>
        <form id="addLevelForm">
          <div class="form-row">
            <div><input type="text" id="newLevelName" placeholder="Nama Level Baru (cth: Foundation 3)" required></div>
            <div><button type="submit" class="btn">Tambah Level</button></div>
          </div>
        </form>
      </div>
      <div class="content-block">
        <h4>Edit Level Kurikulum yang Ada</h4>
        <label for="levelEditorSelector">Pilih Level untuk Diedit:</label>
        <select id="levelEditorSelector"></select>
        <div id="curriculumEditor" class="curriculum-editor" style="display: none;">
          <p>Masukkan daftar aktivitas untuk setiap lesson, pisahkan dengan koma (,). Contoh: A,B,C,D</p>
          <form id="editCurriculumForm"></form>
          <button type="button" id="addLessonBtn" class="add-lesson-btn">(+) Tambah Lesson Baru</button>
          <hr style="margin: 20px 0;">
          <button type="button" id="saveCurriculumBtn" style="background-color: #007bff; margin-top: 15px;">Simpan Perubahan Kurikulum</button>
        </div>
      </div>
    </div>

    <div id="bank-tab" class="tab-content">
      <div class="content-block">
        <h3>Manajemen Bank</h3>
        <form id="addBankForm">
          <div class="form-row">
            <div><input type="text" id="newBankName" placeholder="Nama Bank (cth: BCA)" required></div>
            <div><input type="color" id="newBankColor" value="#007bff"></div>
            <div><button type="submit" class="btn">Tambah Bank</button></div>
          </div>
        </form>
        <div id="bankStatusMessage"></div>
        <h4 style="margin-top: 20px;">Daftar Bank</h4>
        <div class="table-container">
          <table class="bank-table"><thead><tr><th>Nama Bank</th><th>Warna</th><th>Aksi</th></tr></thead><tbody id="bankTableBody"></tbody></table>
        </div>
      </div>
    </div>

    <div id="maintenance-tab" class="tab-content">
      <div class="content-block">
        <h3>Manajemen Lampiran Database</h3>
        <div id="sppGlobalStats" class="global-spp-stats">
          <p><strong>Total Ukuran Lampiran (SPP & Non-SPP):</strong> <span id="sppGlobalTotalSize">--</span></p>
          <p><strong>Persentase Terpakai dari 1GB:</strong> <span id="sppGlobalSizePercentage">--</span></p>
        </div>
        <p style="margin-top:20px;">Kelola data lampiran (bukti bayar SPP & Non-SPP) untuk mengontrol ukuran database Anda.</p>
        
        <div class="filter-spp-options">
          <div>
            <label for="attachmentTypeToDelete">Pilih Jenis Lampiran:</label>
            <select id="attachmentTypeToDelete">
              <option value="spp">Lampiran Pembayaran SPP</option>
              <option value="nonspp">Lampiran Pembayaran Non-SPP</option>
            </select>
          </div>
          <div id="attachmentYearGroup">
            <label for="attachmentYearToDelete">Pilih Tahun:</label>
            <select id="attachmentYearToDelete">
              <option value="">-- Pilih Tahun --</option>
            </select>
          </div>
          <div id="attachmentMonthGroup">
            <label for="attachmentMonthToDelete">Pilih Bulan:</label>
            <select id="attachmentMonthToDelete">
              <option value="">-- Pilih Bulan --</option>
            </select>
          </div>
          <button class="action-button" onclick="calculateAttachmentSize()" style="background-color: #007bff; margin-left: 10px;">Hitung Ukuran Lampiran</button>
        </div>
        
        <div id="sppSizeInfo" class="spp-stats-info" style="display: none;">
          <p><strong>Jumlah Lampiran:</strong> <span id="sppFileCount">0</span></p>
          <p><strong>Total Ukuran:</strong> <span id="sppTotalSize">0 KB</span></p>
          <p><strong>Persentase dari 1GB:</strong> <span id="sppSizePercentage">0.00%</span></p>
          <p><em>Diperbarui: <span id="sppTimestamp">--</span></em></p>
        </div>
        
        <hr style="margin: 20px 0;">
        <p>Hapus lampiran bukti bayar/laporan untuk mengurangi ukuran database. Tindakan ini permanen.</p>
        <button class="action-button btn-delete-attachments" onclick="deleteAttachmentsByFilter()">Hapus Lampiran</button>
        <div id="sppDeleteStatusMessage" class="status-message"></div>
      </div>
      <div class="content-block">
        <h3>Manajemen Branding</h3>
        <form id="brandingForm">
          <div class="form-row">
            <div>
              <label for="companyNameInput">Nama Perusahaan</label>
              <input type="text" id="companyNameInput" placeholder="Nama Perusahaan (cth: SEMPOA SIP TC PARADUTA OPI)" required>
            </div>
            <div>
              <label for="logoFileInput">Logo (PNG, JPG, dll.)</label>
              <input type="file" id="logoFileInput" accept="image/*">
            </div>
          </div>
          <div class="form-row" style="margin-top: 15px;">
            <div style="flex: 1;"><button type="submit" class="btn">Simpan Branding</button></div>
          </div>
          <div id="brandingStatusMessage" style="margin-top: 10px;"></div>
        </form>
        <div style="margin-top: 20px;">
          <h4>Pratinjau Logo</h4>
          <img id="logoPreview" style="max-width: 150px; border: 1px solid #ccc; padding: 5px;">
          <p id="companyNamePreview" style="font-size: 1.2em; font-weight: bold; margin-top: 5px;"></p>
        </div>
      </div>
      
      <div class="content-block">
          <h3>Pengaturan PIN Edit Pembayaran (One-Time PIN)</h3>
          <form id="pinForm">
              <div class="form-row">
                  <div>
                      <label for="pinDigitLength">Jumlah Digit PIN (4-6)</label>
                      <select id="pinDigitLength" required>
                          <option value="4">4 Digit</option>
                          <option value="5">5 Digit</option>
                          <option value="6">6 Digit</option>
                      </select>
                  </div>
                  <div>
                      <label for="pinDuration">Durasi PIN Aktif (Jam)</label>
                      <select id="pinDuration" required>
                          <option value="3">3 Jam</option>
                          <option value="6">6 Jam</option>
                          <option value="9">9 Jam</option>
                      </select>
                  </div>
              </div>
              <div class="form-row">
                  <div>
                      <label for="pinInput">PIN Saat Ini</label>
                      <input type="text" id="pinInput" placeholder="PIN yang Aktif" maxlength="6" readonly style="font-weight: bold;">
                  </div>
              </div>
              <div class="form-row" style="margin-top: 15px; align-items: center;">
                  <div style="flex: 1;">
                      <label>Waktu Tersisa: <span id="pinTimer" style="font-weight: bold; color: #dc3545;">--</span></label>
                  </div>
                  <div style="flex: 1;">
                      <button type="button" id="generatePinBtn" class="btn" style="background-color: #007bff;">Generate PIN Baru</button>
                  </div>
              </div>
              <div id="pinStatusMessage" style="margin-top: 10px;"></div>
          </form>
      </div>
      </div>
    
    <div id="spp-export-tab" class="tab-content">
        <div class="content-block">
            <h3>Export Data SPP</h3>
            <p>Gunakan filter di bawah ini untuk menentukan data SPP yang akan diexport.</p>
            <div class="export-filters">
                <div class="filter-group">
                    <label for="exportCoachSelector">Pilih Coach:</label>
                    <select id="exportCoachSelector"></select>
                </div>
                <div class="filter-group">
                    <label for="exportStudentSelector">Pilih Siswa:</label>
                    <select id="exportStudentSelector"></select>
                </div>
                <div class="filter-group">
                    <label for="exportBankSelector">Pilih Bank:</label>
                    <select id="exportBankSelector"></select>
                </div>
                <div class="filter-group">
                    <label for="exportYearSelector">Pilih Tahun:</label>
                    <select id="exportYearSelector"></select>
                </div>
                <div class="filter-group">
                    <label for="exportMonthSelector">Pilih Bulan:</label>
                    <select id="exportMonthSelector">
                        <option value="all">Semua Bulan</option>
                        <option value="0">Januari</option>
                        <option value="1">Februari</option>
                        <option value="2">Maret</option>
                        <option value="3">April</option>
                        <option value="4">Mei</option>
                        <option value="5">Juni</option>
                        <option value="6">Juli</option>
                        <option value="7">Agustus</option>
                        <option value="8">September</option>
                        <option value="9">Oktober</option>
                        <option value="10">November</option>
                        <option value="11">Desember</option>
                    </select>
                </div>
                <div class="filter-group" style="align-self: center;">
                    <label>
                        <input type="checkbox" id="includePhone"> Sertakan Nomor Telepon
                    </label>
                </div>
                <button type="button" class="btn" onclick="exportSppData()">Export ke Excel</button>
            </div>
            <div id="exportStatusMessage" style="margin-top: 10px;"></div>
            
            <div style="display:none;">
                <table id="exportTable" border="1"></table>
            </div>
        </div>
    </div>
  </div>
  
  <div id="editUserModal" class="modal"><div class="modal-content"><div class="modal-header"><h2>Edit Detail Pengguna</h2><span class="close-btn">&times;</span></div><form id="editUserForm"><div class="modal-body"><p>Email: <strong id="editUserEmail"></strong></p><input type="hidden" id="editUserId"><div class="form-group"><label for="editFullName">Nama Lengkap</label><input type="text" id="editFullName" placeholder="Masukkan nama lengkap"></div><div class="form-group"><label for="editPhoneNumber">No. Telepon</label><input type="tel" id="editPhoneNumber" placeholder="Contoh: 08123456789"></div><div class="form-group" id="editUserLevelGroup"><label for="editUserLevel">Level (untuk Coach)</label><input type="text" id="editUserLevel" placeholder="Contoh: Master"></div></div><div class="modal-footer"><button type="submit">Simpan Perubahan</button></div></form></div></div>
  <div id="editBankModal" class="modal"><div class="modal-content"><div class="modal-header"><h2>Edit Detail Bank</h2><span class="close-btn">&times;</span></span></div><form id="editBankForm"><div class="modal-body"><input type="hidden" id="editBankId"><div class="form-group"><label for="editBankName">Nama Bank</label><input type="text" id="editBankName" required></div><div class="form-group"><label for="editBankColor">Warna</label><input type="color" id="editBankColor"></div></div><div class="modal-footer"><button type="submit">Simpan Perubahan</button></div></form></div></div>
  
  <div id="editStudentModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Edit Detail Siswa</h2>
            <span class="close-btn" onclick="document.getElementById('editStudentModal').style.display='none';">&times;</span>
        </div>
        <form id="editStudentFormInAdmin">
            <div class="modal-body">
                <input type="hidden" id="editStudentId">
                <div class="form-group">
                    <label for="editStudentName">Nama Siswa</label>
                    <input type="text" id="editStudentName" required>
                </div>
                <div class="form-group">
                    <label for="editStudentLevel">Level Siswa</label>
                    <select id="editStudentLevel"></select>
                </div>
                <div class="form-group">
                    <label for="editStudentCoach">Pindahkan ke Coach</label>
                    <select id="editStudentCoach" required></select>
                </div>
                <div class="form-group">
                    <label for="editStudentPhone">No. Telepon</label>
                    <input type="tel" id="editStudentPhone" placeholder="Contoh: 08123456789">
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="action-btn" style="background-color: #28a745;">Simpan Perubahan</button>
            </div>
        </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
  <script type="module">
    // START: Import diperbarui untuk menyertakan signInWithEmailAndPassword
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword, sendPasswordResetEmail, updatePassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getFirestore, collection, getDocs, doc, setDoc, getDoc, addDoc, query, where, updateDoc, writeBatch, increment, deleteDoc, deleteField } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
    // END: Import diperbarui
    
    // ====================== FIREBASE CONFIG (SINGLE DECLARATION) ======================
    const firebaseConfig = { apiKey: "AIzaSyBm3SkLLtl9LvczDDht-OQ6-R4OYLPYAJQ", authDomain: "progres-report-5d199.firebaseapp.com", projectId: "progres-report-5d199", storageBucket: "progres-report-5d199.firebasestorage.app", messagingSenderId: "363573365137", appId: "1:363573365137:web:98f32d5ff8fae05617b230", measurementId: "G-CPX04R69F5" };
    
    const mainApp = initializeApp(firebaseConfig);
    const secondaryApp = initializeApp(firebaseConfig, "secondary");
    const auth = getAuth(mainApp);
    const secondaryAuth = getAuth(secondaryApp);
    const db = getFirestore(mainApp);

    // ====================== GLOBAL VARIABLES & CONSTANTS ======================
    let sessionReadCount = 0;
    const readStatusElement = document.getElementById('readStatusIndicator');
    function updateReadStatus() {
      if(readStatusElement) readStatusElement.innerHTML = `Reads Sesi Ini: ${sessionReadCount} <button onclick="window.resetReadCount()">Reset</button>`;
    }
    window.resetReadCount = function() {
      sessionReadCount = 0;
      updateReadStatus();
    }

    let allUsers = [], allStudents = [], allBanks = {}, allLevels = [];
    let userCurrentPage = 1;
    
    // --- Elemen Maintenance ---
    const attachmentTypeSelect = document.getElementById('attachmentTypeToDelete');
    const attachmentYearToDeleteSelect = document.getElementById('attachmentYearToDelete');
    const attachmentMonthToDeleteSelect = document.getElementById('attachmentMonthToDelete');
    const sppDeleteStatusMessageDiv = document.getElementById('sppDeleteStatusMessage');
    const sppSizeInfoDiv = document.getElementById('sppSizeInfo');
    const sppFileCountSpan = document.getElementById('sppFileCount');
    const sppTotalSizeSpan = document.getElementById('sppTotalSize');
    const sppSizePercentageSpan = document.getElementById('sppSizePercentage');
    const sppTimestampSpan = document.getElementById('sppTimestamp'); 
    const sppGlobalTotalSizeSpan = document.getElementById('sppGlobalTotalSize');
    const sppGlobalSizePercentageSpan = document.getElementById('sppGlobalSizePercentage');
    
    // --- Lain-lain ---
    const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
    const pinStatusMessageDiv = document.getElementById('pinStatusMessage');
    let appEditPin = '';
    let pinExpiryTimer;
    let allYearsWithPayments = [];
    let allActiveBankNames = [];

    // ====================== CORE AUTH FLOW ======================
    window.logout = function() { signOut(auth).then(() => { window.location.href = 'login.html'; }); };

    const generateCoachId = () => {
      const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      const numbers = '0123456789';
      let result = '';
      for (let i = 0; i < 3; i++) {
        result += letters.charAt(Math.floor(Math.random() * letters.length));
      }
      for (let i = 0; i < 3; i++) {
        result += numbers.charAt(Math.floor(Math.random() * numbers.length));
      }
      return result;
    };
    
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        updateReadStatus();
        try {
          const docRef = doc(db, "users", user.email);
          const docSnap = await getDoc(docRef);
          sessionReadCount++; updateReadStatus();
          if (docSnap.exists() && docSnap.data().role === 'admin') {
            document.body.style.display = 'block';
            await loadAllData();
          } else {
            alert("Akses ditolak. Halaman ini hanya untuk Direktur.");
            await signOut(auth);
            window.location.href = 'login.html';
          }
        } catch (error) {
          console.error("Terjadi error saat verifikasi admin:", error);
          alert("Terjadi kesalahan saat otentikasi. Periksa console untuk detail.");
          await signOut(auth);
          window.location.href = 'login.html';
        }
      } else {
        window.location.href = 'login.html';
      }
    });

    // ====================== UTILITY FUNCTIONS ======================
    function setStatusMessage(element, message, color) {
        if (element) {
            element.textContent = message;
            element.style.color = color;
        }
    }

    function updateUserPagination(totalItems) {
      const rowsPerPage = parseInt(document.getElementById('userRowsPerPage').value, 10);
      const totalPages = Math.ceil(totalItems / rowsPerPage) || 1;
      
      if (userCurrentPage > totalPages) {
          userCurrentPage = totalPages;
      }
      
      document.getElementById('userCurrentPage').textContent = userCurrentPage;
      document.getElementById('userTotalPages').textContent = totalPages;
      document.getElementById('userPrevBtn').disabled = userCurrentPage === 1;
      document.getElementById('userNextBtn').disabled = userCurrentPage >= totalPages;
    }

    function formatFileSize(bytes, decimalPoint) {
      if (bytes == 0) return '0 Bytes';
      const k = 1024,
        dm = decimalPoint || 2,
        sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'],
        i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    }
    
    function normalizePhone(nomor) {
        nomor = nomor ? nomor.toString().trim().replace(/\D/g, "") : "";
        if (nomor.startsWith("0")) return "62" + nomor.substring(1);
        if (!nomor.startsWith("62") && nomor.length > 5) return "62" + nomor;
        return nomor;
    }

    function isMobile() {
        return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    }

    function populateCoachDropdowns() {
      const resetEmailSelector = document.getElementById('resetEmailSelector');
      // START: Tambahkan Override Selector
      const overrideEmailSelector = document.getElementById('overrideEmailSelector');
      // END: Tambahkan Override Selector

      const activeUsers = allUsers.filter(u => (u.status || 'active') === 'active');
      
      const roleMap = {
          admin: 'DIREKTUR',
          bendahara: 'ADMIN',
          user: 'Coach'
      };
      
      let userOptions = '<option value="">-- Pilih Pengguna --</option>';
      activeUsers.forEach(user => {
        let roleName = roleMap[user.role] || 'N/A';
        if(user.role === 'user') roleName += ` (${user.coachId || 'N/A'})`;
        userOptions += `<option value="${user.id}">${user.name} (${roleName})</option>`;
      });
      if (resetEmailSelector) {
        const currentVal = resetEmailSelector.value;
        resetEmailSelector.innerHTML = userOptions;
        resetEmailSelector.value = currentVal;
      }
      // START: Sinkronisasi ke dropdown override
      if (overrideEmailSelector) { 
        const currentVal = overrideEmailSelector.value;
        overrideEmailSelector.innerHTML = userOptions;
        overrideEmailSelector.value = currentVal;
      }
      // END: Sinkronisasi ke dropdown override
    }
    
    function populateLevelDropdowns() {
      const levelEditorSelector = document.getElementById('levelEditorSelector');
      const editStudentLevelSelector = document.getElementById('editStudentLevel');
      
      [levelEditorSelector, editStudentLevelSelector].forEach(selector => {
        if (!selector) return;
        const currentVal = selector.value;
        let options = (selector.id === 'levelEditorSelector') ? '<option value="">-- Pilih Level --</option>' : '';
        allLevels.forEach(level => {
          options += `<option value="${level}">${level}</option>`;
        });
        selector.innerHTML = options;
        selector.value = currentVal;
      });
    }

    function populateSppMonthsForDeletion() {
      const monthSelector = document.getElementById('attachmentMonthToDelete');
      if (!monthSelector) return;
      monthSelector.innerHTML = '<option value="">-- Semua Bulan --</option>';
      monthNames.forEach((month, index) => {
        monthSelector.innerHTML += `<option value="${index}">${month}</option>`;
      });
    }

    function populateExportSelectors() {
        const coachSelector = document.getElementById('exportCoachSelector');
        const studentSelector = document.getElementById('exportStudentSelector');
        const bankSelector = document.getElementById('exportBankSelector');
        const yearSelector = document.getElementById('exportYearSelector');

        const activeCoaches = allUsers.filter(u => (u.status || 'active') === 'active' && u.role === 'user');
        if (coachSelector) coachSelector.innerHTML = '<option value="all">Semua Coach</option>' + activeCoaches.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        
        const activeStudents = allStudents.filter(s => (s.status || 'active') === 'active');
        if (studentSelector) studentSelector.innerHTML = '<option value="all">Semua Siswa</option>' + activeStudents.map(s => `<option value="${s.id}">${s.name}</option>`).join('');

        if (bankSelector) bankSelector.innerHTML = '<option value="all">Semua Bank</option>' + allActiveBankNames.map(b => `<option value="${b}">${b}</option>`).join('');
        
        const years = new Set();
        allStudents.forEach(student => {
            if (student.spp) {
                Object.keys(student.spp).forEach(key => years.add(parseInt(key.split('-')[0])));
            }
        });
        allYearsWithPayments = Array.from(years).sort((a, b) => b - a);
        if (yearSelector) yearSelector.innerHTML = '<option value="all">Semua Tahun</option>' + allYearsWithPayments.map(y => `<option value="${y}">${y}</option>`).join('');
    }


    // ====================== LOAD ALL DATA ======================
    async function loadAllData() {
      try {
        const currentTab = sessionStorage.getItem('adminCurrentTab') || 'pengguna-tab';

        const [userSnapshot, studentSnapshot, bankSnapshot, curriculumSnapshot, otherPaymentsSnapshot] = await Promise.all([
            getDocs(collection(db, "users")),
            getDocs(collection(db, "students")),
            getDocs(collection(db, "banks")),
            getDocs(collection(db, "kurikulum")),
            getDocs(collection(db, "other_payments"))
        ]);
        
        sessionReadCount += userSnapshot.size + studentSnapshot.size + bankSnapshot.size + curriculumSnapshot.size + otherPaymentsSnapshot.size;
        updateReadStatus();

        allUsers = userSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        allStudents = studentSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        allBanks = {};
        bankSnapshot.forEach(doc => { allBanks[doc.id] = {id: doc.id, ...doc.data()}; });
        allLevels = curriculumSnapshot.docs.map(doc => doc.id).sort();
        allActiveBankNames = Object.values(allBanks).filter(b => (b.status || 'active') === 'active').map(b => b.bankName);
        
        renderUserTable();
        renderBankTable();
        populateCoachDropdowns();
        populateLevelDropdowns();
        
        loadAttachmentYears(otherPaymentsSnapshot.docs); 
        
        await calculateGlobalAttachmentSize(otherPaymentsSnapshot.docs); 
        
        await loadBranding();
        await loadPin(); 
        populateExportSelectors();
        openTab(currentTab);
      } catch (error) {
        console.error("ERROR di dalam loadAllData:", error);
        alert("Gagal memuat data utama. Kemungkinan ada masalah dengan Security Rules. Periksa console (F12).");
      }
    }


    // ====================== BRANDING & PIN LOGIC ======================
    
    async function loadBranding() {
      const companyNameInput = document.getElementById('companyNameInput');
      const logoPreview = document.getElementById('logoPreview');
      const companyNamePreview = document.getElementById('companyNamePreview');
      const companyNameHeader = document.getElementById('companyNameHeader');
    
      try {
        const docRef = doc(db, "settings", "brand");
        const docSnap = await getDoc(docRef);
        sessionReadCount++; updateReadStatus();
    
        if (docSnap.exists()) {
          const data = docSnap.data();
          if (data.companyName) {
            companyNameInput.value = data.companyName;
            companyNamePreview.textContent = data.companyName.toUpperCase();
            companyNameHeader.textContent = data.companyName;
          }
          if (data.logoBase64) {
            logoPreview.src = data.logoBase64;
            logoPreview.style.display = 'inline-block';
          } else {
            logoPreview.style.display = 'none';
          }
        }
      } catch (error) {
        console.error("Gagal memuat pengaturan branding:", error);
      }
    }
    async function saveBranding(companyName, logoBase64, button) {
      const brandingStatusMessage = document.getElementById('brandingStatusMessage');
      setStatusMessage(brandingStatusMessage, 'Menyimpan...', 'blue');
      button.disabled = true;
      try {
        await setDoc(doc(db, "settings", "brand"), {
          companyName: companyName,
          logoBase64: logoBase64
        });
        setStatusMessage(brandingStatusMessage, 'Branding berhasil disimpan!', 'green');
        await loadBranding();
      } catch (error) {
        console.error("Gagal menyimpan branding:", error);
        setStatusMessage(brandingStatusMessage, `Gagal menyimpan: ${error.message}`, 'red');
      } finally {
        button.disabled = false;
      }
    }

    function generateNumericPin(length) {
        return Array.from({length}, () => Math.floor(Math.random() * 10)).join('');
    }
    
    function startPinTimer(expiryTimestamp) {
        if (pinExpiryTimer) clearInterval(pinExpiryTimer);

        const timerSpan = document.getElementById('pinTimer');
        const pinInput = document.getElementById('pinInput');

        const updateTimer = async () => {
            const now = Date.now();
            const distance = expiryTimestamp - now;

            if (distance < 0) {
                timerSpan.textContent = "KEDALUWARSA";
                pinInput.value = '********'; 
                appEditPin = ''; 

                try {
                    await updateDoc(doc(db, "settings", "appEditPin"), { 
                        status: 'expired',
                        pin: 'PIN_EXPIRED_#_NON_NUMERIC_!@#$'
                    });
                } catch (e) {
                    console.error("Gagal memperbarui status PIN expired:", e);
                }

                clearInterval(pinExpiryTimer);
                return;
            }

            const hours = Math.floor(distance / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);
            timerSpan.textContent = `${hours}j ${minutes}m ${seconds}s`;
        };

        pinExpiryTimer = setInterval(updateTimer, 1000);
        updateTimer();
    }
    
    async function handleGeneratePin(e) {
        e.target.disabled = true;
        const length = parseInt(document.getElementById('pinDigitLength').value, 10);
        const durationHours = parseInt(document.getElementById('pinDuration').value, 10);
        const durationMs = durationHours * 60 * 60 * 1000;
        
        const newPin = generateNumericPin(length);
        const expiryDate = new Date(Date.now() + durationMs); 
        
        setStatusMessage(pinStatusMessageDiv, 'Menyimpan PIN baru...', 'blue');
        
        try {
            await setDoc(doc(db, "settings", "appEditPin"), { 
                pin: newPin,
                expiry: expiryDate,
                length: length,
                durationHours: durationHours,
                status: 'active'
            });
            
            appEditPin = newPin;
            document.getElementById('pinInput').value = newPin;
            startPinTimer(expiryDate.getTime());
            setStatusMessage(pinStatusMessageDiv, `PIN Baru: ${newPin} berhasil di-generate! Berlaku selama ${durationHours} jam.`, 'green');
            
        } catch (error) {
            setStatusMessage(pinStatusMessageDiv, `Error: ${error.message}`, 'red');
            console.error("Gagal menyimpan PIN baru:", error);
        } finally {
            e.target.disabled = false;
        }
    }

    async function loadPin() {
        try {
            const docRef = doc(db, "settings", "appEditPin");
            const docSnap = await getDoc(docRef);
            sessionReadCount++; updateReadStatus();
            const pinInput = document.getElementById('pinInput');
            const pinTimer = document.getElementById('pinTimer');
            const digitSelector = document.getElementById('pinDigitLength');
            const durationSelector = document.getElementById('pinDuration');

            if (docSnap.exists()) {
                const data = docSnap.data();
                if (data.status === 'active' && data.expiry && data.expiry.toDate && data.expiry.toDate().getTime() > Date.now()) {
                    appEditPin = data.pin || '';
                    pinInput.value = appEditPin;
                    startPinTimer(data.expiry.toDate().getTime());
                } else {
                    appEditPin = '';
                    pinInput.value = '********';
                    pinTimer.textContent = 'NONAKTIF';
                    if (pinExpiryTimer) clearInterval(pinExpiryTimer);
                }
                if (data.length) digitSelector.value = data.length;
                if (data.durationHours) durationSelector.value = data.durationHours;
            } else {
                pinInput.value = '********';
                pinTimer.textContent = 'NONAKTIF';
            }
        } catch (error) {
            console.error("Gagal memuat PIN:", error);
            appEditPin = '';
        }
    }
    
    // ====================== USER, BANK, CURRICULUM MANAGEMENT ======================
    
    function renderUserTable() {
        const tableBody = document.getElementById('usersTableBody');
        if (!tableBody) return;
        
        const showDisabled = document.getElementById('showDisabledUsers').checked;
        const showCoachesOnly = document.getElementById('showCoachesOnly').checked;

        let filteredUsers = allUsers.filter(user => {
            const isCoach = user.role === 'user';
            const isActive = (user.status || 'active') === 'active';
            
            if (showCoachesOnly && !isCoach) return false;
            if (!showDisabled && !isActive) return false;
            return true;
        });
        
        updateUserPagination(filteredUsers.length);
        
        const rowsPerPage = parseInt(document.getElementById('userRowsPerPage').value, 10);
        const startIndex = (userCurrentPage - 1) * rowsPerPage;
        const endIndex = startIndex + rowsPerPage;
        const paginatedUsers = filteredUsers.slice(startIndex, endIndex);

        const roleMap = { admin: 'DIREKTUR', bendahara: 'ADMIN', user: 'Coach' };
        
        if (paginatedUsers.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Tidak ada data pengguna yang cocok.</td></tr>';
            return;
        }
        
        tableBody.innerHTML = paginatedUsers.map(user => {
            const isActive = (user.status || 'active') === 'active';
            let actionsCellHtml = '<span>-</span>'; 

            if (user.role !== 'admin') {
                const actionButton = isActive 
                    ? `<button class="action-btn-disable" data-user-id="${user.id}">Nonaktifkan</button>` 
                    : `<button class="action-btn-enable" data-user-id="${user.id}">Aktifkan</button>`;
                actionsCellHtml = `
                    <button class="action-btn-edit" data-user-id="${user.id}">Edit</button>
                    ${actionButton}
                `;
            }

            return `
                <tr class="${!isActive ? 'disabled-row' : ''}">
                    <td>${user.coachId || 'N/A'}</td>
                    <td>${user.id}</td>
                    <td>${user.name}</td>
                    <td>${user.role === 'user' ? (user.studentCount || 0) : 'N/A'}</td>
                    <td>${roleMap[user.role] || user.role}</td>
                    <td><span style="color: ${isActive ? 'green' : 'red'}; font-weight: bold;">${isActive ? 'Aktif' : 'Nonaktif'}</span></td>
                    <td>${actionsCellHtml}</td>
                </tr>
            `;
        }).join('');
    }

    function renderBankTable() {
        const tableBody = document.getElementById('bankTableBody');
        if (!tableBody) return;

        const banks = Object.values(allBanks);
        if (banks.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="3" style="text-align:center;">Belum ada bank yang ditambahkan.</td></tr>';
            return;
        }

        tableBody.innerHTML = banks.map(bank => {
            const isActive = (bank.status || 'active') === 'active';
            const actionButton = isActive 
                ? `<button class="action-btn-disable" data-bank-id="${bank.id}">Nonaktifkan</button>`
                : `<button class="action-btn-enable" data-bank-id="${bank.id}">Aktifkan</button>`;
            
            return `
                <tr class="${!isActive ? 'disabled-row' : ''}">
                    <td>${bank.bankName}</td>
                    <td><div style="width: 20px; height: 20px; background-color: ${bank.color}; border: 1px solid #ccc;"></div></td>
                    <td>
                        <button class="action-btn-edit" data-bank-id="${bank.id}">Edit</button>
                        ${actionButton}
                    </td>
                </tr>
            `;
        }).join('');
    }

    async function syncStudentCount() {
      if (!confirm('Yakin ingin menyinkronkan jumlah siswa? Ini akan memperbaiki jumlah yang salah.')) return;
      
      const syncBtn = document.getElementById('syncCountBtn');
      syncBtn.disabled = true;
      syncBtn.textContent = 'Menyinkronkan...';
      
      try {
        const studentSnapshot = await getDocs(query(collection(db, "students"), where("status", "==", "active")));
        sessionReadCount += studentSnapshot.size; updateReadStatus();
        
        const studentCounts = {};
        studentSnapshot.forEach(studentDoc => {
          const coachEmail = studentDoc.data().coachEmail;
          if (coachEmail) {
            studentCounts[coachEmail] = (studentCounts[coachEmail] || 0) + 1;
          }
        });
        
        const batch = writeBatch(db);
        const allCoaches = allUsers.filter(u => u.role === 'user');
        
        allCoaches.forEach(coach => {
            const newCount = studentCounts[coach.id] || 0;
            if (coach.studentCount !== newCount) {
                batch.update(doc(db, "users", coach.id), { studentCount: newCount });
            }
        });
        
        await batch.commit();
        alert('Sinkronisasi jumlah siswa berhasil!');
        await loadAllData();
      } catch (error) {
        console.error("Gagal menyinkronkan jumlah siswa:", error);
        alert('Gagal menyinkronkan jumlah siswa. Periksa console untuk detail.');
      } finally {
        syncBtn.disabled = false;
        syncBtn.textContent = 'Sinkronkan Jumlah Siswa';
      }
    }
    
    async function handleLevelSelect(e) {
      const level = e.target.value;
      const editor = document.getElementById('curriculumEditor');
      const form = document.getElementById('editCurriculumForm');
      form.innerHTML = '';
      if (!level) { editor.style.display = 'none'; return; }
      try { 
        const docSnap = await getDoc(doc(db, "kurikulum", level));
        sessionReadCount++; updateReadStatus();
        if (docSnap.exists()) {
          const lessons = docSnap.data().lessons || {};
          const sortedKeys = Object.keys(lessons).sort((a,b) => parseInt(a.replace('Lesson ', '')) - parseInt(b.replace('Lesson ', '')));
          sortedKeys.forEach(key => {
            const activities = lessons[key].join(',');
            form.innerHTML += `<div class="lesson-input-group"><label for="${key}">${key}:</label><input type="text" id="${key}" value="${activities}" data-lesson-name="${key}"></div>`;
          });
        }
        editor.style.display = 'block';
      } catch(error) {
        console.error("Error fetching curriculum:", error);
      }
    }
    
    // ====================== MAINTENANCE LOGIC (OPTIMIZED) ======================

    function loadAttachmentYears(otherPaymentsDocs) {
      const attachmentYearSelect = document.getElementById('attachmentYearToDelete');
      const years = new Set();

      allStudents.forEach(student => {
        if (student.spp) {
          Object.keys(student.spp).forEach(key => {
            const year = key.split('-')[0];
            if (year) years.add(parseInt(year));
          });
        }
      });
      
      otherPaymentsDocs.forEach(doc => {
          const data = doc.data();
          if (data.date && typeof data.date.toDate === 'function') {
              years.add(data.date.toDate().getFullYear());
          }
      });

      const sortedYears = Array.from(years).sort((a, b) => b - a);
      if(attachmentYearSelect) {
        attachmentYearSelect.innerHTML = '<option value="">-- Pilih Tahun --</option>';
        sortedYears.forEach(year => {
          attachmentYearSelect.innerHTML += `<option value="${year}">${year}</option>`;
        });
      }
    }
    
    window.calculateGlobalAttachmentSize = async function(otherPaymentsDocs) {
      let totalSize = 0;
      const oneGigabyte = 1073741824;
      
      const calculateBase64Size = (base64) => (base64.length / 4) * 3;
      
      allStudents.forEach(student => {
        if (student.spp) {
          Object.values(student.spp).forEach(payment => {
            if (payment.attachmentBase64) totalSize += calculateBase64Size(payment.attachmentBase64);
          });
        }
      });
      
      otherPaymentsDocs.forEach(docSnap => {
        if (docSnap.data().attachmentBase64) totalSize += calculateBase64Size(docSnap.data().attachmentBase64);
      });
      
      sppGlobalTotalSizeSpan.textContent = formatFileSize(totalSize);
      sppGlobalSizePercentageSpan.textContent = ((totalSize / oneGigabyte) * 100).toFixed(2) + '%';
    }

    window.calculateAttachmentSize = async function() {
      const type = document.getElementById('attachmentTypeToDelete').value;
      const year = document.getElementById('attachmentYearToDelete').value;
      const month = document.getElementById('attachmentMonthToDelete').value;
      
      let totalSize = 0;
      let fileCount = 0;
      const oneGigabyte = 1073741824;
      
      setStatusMessage(sppDeleteStatusMessageDiv, 'Menghitung ukuran...', 'blue');

      if (!year) {
          setStatusMessage(sppDeleteStatusMessageDiv, 'Harap pilih tahun terlebih dahulu.', 'red');
          return;
      }

      if (type === 'spp') {
        allStudents.forEach(student => {
          if (student.spp) {
            for (const key in student.spp) {
              const [paymentYear, paymentMonth] = key.split('-');
              if (paymentYear == year && (month === '' || paymentMonth == month) && student.spp[key].attachmentBase64) {
                fileCount++;
                totalSize += (student.spp[key].attachmentBase64.length / 4) * 3;
              }
            }
          }
        });
      } else if (type === 'nonspp') {
        const otherPaymentsSnapshot = await getDocs(collection(db, "other_payments"));
        sessionReadCount += otherPaymentsSnapshot.size; updateReadStatus();
        otherPaymentsSnapshot.forEach(docSnap => {
            const data = docSnap.data();
            if (data.attachmentBase64 && data.date && typeof data.date.toDate === 'function') {
                const paymentDate = data.date.toDate();
                if (paymentDate.getFullYear() == year && (month === '' || paymentDate.getMonth() == month)) {
                    fileCount++;
                    totalSize += (data.attachmentBase64.length / 4) * 3;
                }
            }
        });
      }
      
      sppFileCountSpan.textContent = fileCount;
      sppTotalSizeSpan.textContent = formatFileSize(totalSize);
      sppSizePercentageSpan.textContent = ((totalSize / oneGigabyte) * 100).toFixed(3) + '%';
      sppTimestampSpan.textContent = new Date().toLocaleString('id-ID');
      sppSizeInfoDiv.style.display = 'block';
      setStatusMessage(sppDeleteStatusMessageDiv, '', 'black');
    }

    window.deleteAttachmentsByFilter = async function() {
      const type = document.getElementById('attachmentTypeToDelete').value;
      const yearToDelete = document.getElementById('attachmentYearToDelete').value;
      const monthToDelete = document.getElementById('attachmentMonthToDelete').value;
      
      if (!yearToDelete) {
        setStatusMessage(sppDeleteStatusMessageDiv, 'Harap pilih tahun untuk melanjutkan penghapusan.', 'red');
        return;
      }
      
      let subject = (type === 'spp') ? `SPP` : `NON-SPP`;
      let period = `tahun ${yearToDelete}${monthToDelete !== '' ? ` bulan ${monthNames[monthToDelete]}` : ' (semua bulan)'}`;
      let confirmMessage = `Apakah Anda yakin ingin menghapus SEMUA lampiran ${subject} untuk ${period}? Tindakan ini tidak bisa dibatalkan.`;
      
      if (!confirm(confirmMessage)) return;
      
      setStatusMessage(sppDeleteStatusMessageDiv, `Menghapus lampiran ${subject}... Ini mungkin memakan waktu.`, 'blue');

      try {
          let updatedCount = 0;
          
          if (type === 'spp') {
              const studentsToUpdate = allStudents.filter(student => {
                  if (!student.spp) return false;
                  return Object.keys(student.spp).some(key => {
                      const [py, pm] = key.split('-');
                      return py == yearToDelete && (monthToDelete === '' || pm == monthToDelete) && student.spp[key].attachmentBase64;
                  });
              });
              
              if (studentsToUpdate.length === 0) {
                  setStatusMessage(sppDeleteStatusMessageDiv, 'Tidak ada lampiran SPP yang cocok untuk dihapus.', 'orange');
                  return;
              }

              const batch = writeBatch(db);
              studentsToUpdate.forEach(student => {
                  const updates = {};
                  Object.keys(student.spp).forEach(key => {
                      const [py, pm] = key.split('-');
                      if (py == yearToDelete && (monthToDelete === '' || pm == monthToDelete) && student.spp[key].attachmentBase64) {
                          updates[`spp.${key}.attachmentBase64`] = deleteField();
                      }
                  });
                  if (Object.keys(updates).length > 0) {
                      batch.update(doc(db, "students", student.id), updates);
                      updatedCount++;
                  }
              });
              await batch.commit();
              setStatusMessage(sppDeleteStatusMessageDiv, `Lampiran SPP berhasil dihapus. Total dokumen siswa diperbarui: ${updatedCount}.`, 'green');

          } else if (type === 'nonspp') {
              const year = parseInt(yearToDelete);
              const month = monthToDelete !== '' ? parseInt(monthToDelete) : -1;
              
              const startDate = new Date(year, month === -1 ? 0 : month, 1);
              const endDate = new Date(year, month === -1 ? 12 : month + 1, 1);

              const paymentsRef = collection(db, "other_payments");
              const q = query(paymentsRef, where("date", ">=", startDate), where("date", "<", endDate));
              
              const querySnapshot = await getDocs(q);
              sessionReadCount += querySnapshot.size; updateReadStatus();
              
              const docsToDelete = querySnapshot.docs.filter(doc => doc.data().attachmentBase64);

              if (docsToDelete.length === 0) {
                  setStatusMessage(sppDeleteStatusMessageDiv, 'Tidak ada lampiran Non-SPP yang cocok untuk dihapus.', 'orange');
                  return;
              }
              
              const batch = writeBatch(db);
              docsToDelete.forEach(docSnap => {
                  batch.update(doc(db, "other_payments", docSnap.id), { attachmentBase64: deleteField() });
                  updatedCount++;
              });
              await batch.commit();
              setStatusMessage(sppDeleteStatusMessageDiv, `Lampiran Non-SPP berhasil dihapus. Total dokumen diperbarui: ${updatedCount}.`, 'green');
          }
          
          await loadAllData();
          
      } catch (error) {
        setStatusMessage(sppDeleteStatusMessageDiv, `Error saat menghapus lampiran: ${error.message}`, 'red');
        console.error("Error deleting attachments:", error);
      }
    }
    
    // ====================== EVENT LISTENERS SETUP ======================
    function setupEventListeners() {
        // --- Tab Pengguna: Tambah Pengguna ---
        document.getElementById('addUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const button = e.target.querySelector('button');
            button.disabled = true;
            const statusDiv = document.getElementById('statusMessage');
            setStatusMessage(statusDiv, 'Menambahkan pengguna...', 'blue');

            const email = document.getElementById('newUserEmail').value;
            const name = document.getElementById('newUserName').value;
            const password = document.getElementById('newUserPassword').value;
            const role = document.getElementById('newUserRole').value;

            try {
                const userCredential = await createUserWithEmailAndPassword(secondaryAuth, email, password);
                const userData = {
                    name: name,
                    role: role,
                    status: 'active',
                    phone: '',
                    level: ''
                };
                if (role === 'user') {
                    userData.coachId = generateCoachId();
                    userData.studentCount = 0;
                }
                await setDoc(doc(db, "users", email), userData);
                setStatusMessage(statusDiv, 'Pengguna berhasil ditambahkan!', 'green');
                e.target.reset();
                await loadAllData();
            } catch (error) {
                setStatusMessage(statusDiv, `Error: ${error.message}`, 'red');
                console.error("Gagal menambah pengguna:", error);
            } finally {
                button.disabled = false;
            }
        });

        // --- Tab Pengguna: Reset Password (via Email) ---
        document.getElementById('resetPasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const button = e.target.querySelector('button');
            button.disabled = true;
            const statusDiv = document.getElementById('resetPasswordStatusMessage');
            const email = document.getElementById('resetEmailSelector').value;
            if (!email) {
                setStatusMessage(statusDiv, 'Harap pilih pengguna.', 'red');
                button.disabled = false;
                return;
            }
            setStatusMessage(statusDiv, 'Mengirim email reset...', 'blue');
            try {
                await sendPasswordResetEmail(auth, email);
                setStatusMessage(statusDiv, `Email reset password telah dikirim ke ${email}.`, 'green');
            } catch (error) {
                setStatusMessage(statusDiv, `Error: ${error.message}`, 'red');
            } finally {
                button.disabled = false;
            }
        });

        // --- START: Tab Pengguna: Admin Override (Fitur Baru) ---
        document.getElementById('adminOverrideForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const button = e.target.querySelector('button');
            button.disabled = true;
            const statusDiv = document.getElementById('overrideStatusMessage');
            
            const targetEmail = document.getElementById('overrideEmailSelector').value;
            const currentPass = document.getElementById('overrideCurrentPassword').value;
            const newPass = document.getElementById('overrideNewPassword').value;

            if (newPass.length < 6) {
                setStatusMessage(statusDiv, 'Kata sandi baru minimal harus 6 karakter.', 'red');
                button.disabled = false;
                return;
            }
            if (!targetEmail) {
                setStatusMessage(statusDiv, 'Harap pilih pengguna.', 'red');
                button.disabled = false;
                return;
            }

            setStatusMessage(statusDiv, `Mencoba login sementara sebagai ${targetEmail} untuk update...`, 'blue');

            try {
                // 1. Login Sementara Menggunakan SECONDARY AUTH (User Target)
                const userCredential = await signInWithEmailAndPassword(secondaryAuth, targetEmail, currentPass);
                const targetUser = userCredential.user;

                // 2. Update Password Pengguna Target
                await updatePassword(targetUser, newPass);

                // 3. Logout Sesi Sementara (Pengguna Target)
                await signOut(secondaryAuth);
                
                setStatusMessage(statusDiv, `✅ Kata sandi untuk ${targetEmail} berhasil diperbarui!`, 'green');
                e.target.reset();

            } catch (error) {
                let errorMessage = `Gagal mengubah kata sandi: ${error.message}`;
                if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Gagal: Kata Sandi Lama (saat ini) untuk pengguna target salah.';
                } else if (error.code === 'auth/user-not-found') {
                    errorMessage = 'Gagal: Pengguna target tidak ditemukan.';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'Terlalu banyak permintaan. Coba lagi nanti.';
                }
                
                setStatusMessage(statusDiv, errorMessage, 'red');
                console.error("Admin Override Error:", error);
                
            } finally {
                button.disabled = false;
            }
        });
        // --- END: Tab Pengguna: Admin Override (Fitur Baru) ---

        // --- Tab Pengguna: Kontrol Tabel ---
        document.getElementById('showDisabledUsers').addEventListener('change', renderUserTable);
        document.getElementById('showCoachesOnly').addEventListener('change', renderUserTable);
        document.getElementById('syncCountBtn').addEventListener('click', syncStudentCount);
        document.getElementById('userRowsPerPage').addEventListener('change', () => { userCurrentPage = 1; renderUserTable(); });
        document.getElementById('userPrevBtn').addEventListener('click', () => { if (userCurrentPage > 1) { userCurrentPage--; renderUserTable(); } });
        document.getElementById('userNextBtn').addEventListener('click', () => { userCurrentPage++; renderUserTable(); });

        // --- Tab Kurikulum ---
        document.getElementById('addLevelForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const levelName = document.getElementById('newLevelName').value;
            if (!levelName) return;
            try {
                await setDoc(doc(db, "kurikulum", levelName), { lessons: {} });
                alert(`Level "${levelName}" berhasil ditambahkan.`);
                e.target.reset();
                await loadAllData();
            } catch (error) {
                alert(`Gagal menambah level: ${error.message}`);
            }
        });
        
        document.getElementById('levelEditorSelector').addEventListener('change', handleLevelSelect);
        
        document.getElementById('addLessonBtn').addEventListener('click', () => {
            const form = document.getElementById('editCurriculumForm');
            const newLessonNum = form.querySelectorAll('.lesson-input-group').length + 1;
            const newLessonName = `Lesson ${newLessonNum}`;
            form.insertAdjacentHTML('beforeend', `<div class="lesson-input-group"><label for="${newLessonName}">${newLessonName}:</label><input type="text" id="${newLessonName}" value="" data-lesson-name="${newLessonName}"></div>`);
        });

        document.getElementById('saveCurriculumBtn').addEventListener('click', async (e) => {
            const button = e.target;
            button.disabled = true;
            const level = document.getElementById('levelEditorSelector').value;
            if (!level) { button.disabled = false; return; }

            const newLessons = {};
            document.querySelectorAll('#editCurriculumForm input').forEach(input => {
                const lessonName = input.dataset.lessonName;
                const activities = input.value.split(',').map(item => item.trim()).filter(Boolean);
                newLessons[lessonName] = activities;
            });

            try {
                await updateDoc(doc(db, "kurikulum", level), { lessons: newLessons });
                alert(`Kurikulum untuk level "${level}" berhasil disimpan.`);
            } catch (error) {
                alert(`Gagal menyimpan kurikulum: ${error.message}`);
            } finally {
                button.disabled = false;
            }
        });

        // --- Tab Bank ---
        document.getElementById('addBankForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const button = e.target.querySelector('button');
            button.disabled = true;
            const bankName = document.getElementById('newBankName').value;
            const color = document.getElementById('newBankColor').value;
            const statusDiv = document.getElementById('bankStatusMessage');
            setStatusMessage(statusDiv, 'Menambahkan bank...', 'blue');
            try {
                await addDoc(collection(db, "banks"), { bankName, color, status: 'active' });
                setStatusMessage(statusDiv, `Bank "${bankName}" berhasil ditambahkan.`, 'green');
                e.target.reset();
                document.getElementById('newBankColor').value = '#007bff';
                await loadAllData();
            } catch (error) {
                setStatusMessage(statusDiv, `Gagal: ${error.message}`, 'red');
            } finally {
                button.disabled = false;
            }
        });

        // --- Tab Maintenance ---
        document.getElementById('brandingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const companyName = document.getElementById('companyNameInput').value;
            const logoFile = document.getElementById('logoFileInput').files[0];
            let logoBase64 = document.getElementById('logoPreview').src;
        
            if (logoFile) {
                const reader = new FileReader();
                reader.onload = async () => {
                    await saveBranding(companyName, reader.result, e.target.querySelector('button'));
                };
                reader.readAsDataURL(logoFile);
            } else {
                await saveBranding(companyName, logoBase64, e.target.querySelector('button'));
            }
        });
        document.getElementById('logoFileInput').addEventListener('change', (e) => {
            if (e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = (event) => { document.getElementById('logoPreview').src = event.target.result; };
                reader.readAsDataURL(e.target.files[0]);
            }
        });
        document.getElementById('generatePinBtn').addEventListener('click', handleGeneratePin);

        // --- Modal Event Listeners ---
        document.getElementById('editUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const button = e.target.querySelector('button');
            button.disabled = true;
            const userId = document.getElementById('editUserId').value;
            const updatedData = {
                name: document.getElementById('editFullName').value,
                phone: document.getElementById('editPhoneNumber').value,
                level: document.getElementById('editUserLevel').value
            };
            try {
                await updateDoc(doc(db, "users", userId), updatedData);
                alert('Data pengguna berhasil diperbarui.');
                document.getElementById('editUserModal').style.display = 'none';
                await loadAllData();
            } catch (error) {
                alert(`Gagal memperbarui: ${error.message}`);
            } finally {
                button.disabled = false;
            }
        });

        document.getElementById('editBankForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const button = e.target.querySelector('button');
            button.disabled = true;
            const bankId = document.getElementById('editBankId').value;
            const updatedData = {
                bankName: document.getElementById('editBankName').value,
                color: document.getElementById('editBankColor').value
            };
            try {
                await updateDoc(doc(db, "banks", bankId), updatedData);
                alert('Data bank berhasil diperbarui.');
                document.getElementById('editBankModal').style.display = 'none';
                await loadAllData();
            } catch (error) {
                alert(`Gagal memperbarui: ${error.message}`);
            } finally {
                button.disabled = false;
            }
        });

        document.addEventListener('click', async (e) => {
            // Aksi pada Tabel Pengguna
            if (e.target.matches('.action-btn-edit[data-user-id]')) {
                const userId = e.target.dataset.userId;
                const user = allUsers.find(u => u.id === userId);
                if (user) {
                    document.getElementById('editUserId').value = user.id;
                    document.getElementById('editUserEmail').textContent = user.id;
                    document.getElementById('editFullName').value = user.name || '';
                    document.getElementById('editPhoneNumber').value = user.phone || '';
                    document.getElementById('editUserLevel').value = user.level || '';
                    document.getElementById('editUserLevelGroup').style.display = user.role === 'user' ? 'block' : 'none';
                    document.getElementById('editUserModal').style.display = 'block';
                }
            }
            if (e.target.matches('.action-btn-disable[data-user-id]') || e.target.matches('.action-btn-enable[data-user-id]')) {
                const userId = e.target.dataset.userId;
                const newStatus = e.target.matches('.action-btn-disable') ? 'disabled' : 'active';
                if (confirm(`Yakin ingin mengubah status pengguna ini menjadi "${newStatus}"?`)) {
                    try {
                        await updateDoc(doc(db, "users", userId), { status: newStatus });
                        await loadAllData();
                    } catch (error) { alert(`Gagal: ${error.message}`); }
                }
            }

            // Aksi pada Tabel Bank
            if (e.target.matches('.action-btn-edit[data-bank-id]')) {
                const bankId = e.target.dataset.bankId;
                const bank = allBanks[bankId];
                if (bank) {
                    document.getElementById('editBankId').value = bank.id;
                    document.getElementById('editBankName').value = bank.bankName;
                    document.getElementById('editBankColor').value = bank.color;
                    document.getElementById('editBankModal').style.display = 'block';
                }
            }
            if (e.target.matches('.action-btn-disable[data-bank-id]') || e.target.matches('.action-btn-enable[data-bank-id]')) {
                const bankId = e.target.dataset.bankId;
                const newStatus = e.target.matches('.action-btn-disable') ? 'disabled' : 'active';
                if (confirm(`Yakin ingin mengubah status bank ini menjadi "${newStatus}"?`)) {
                    try {
                        await updateDoc(doc(db, "banks", bankId), { status: newStatus });
                        await loadAllData();
                    } catch (error) { alert(`Gagal: ${error.message}`); }
                }
            }
            
            // Tombol Close Modal
            if (e.target.matches('.close-btn')) {
                e.target.closest('.modal').style.display = 'none';
            }
        });
        
        window.onclick = (e) => {
            if (e.target.matches('.modal')) {
                e.target.style.display = 'none';
            }
        };

        populateSppMonthsForDeletion();
    }
    
    // ====================== FINAL SETUP ======================

    window.openTab = function(tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');
      document.querySelector(`.tab-btn[onclick="openTab('${tabName}')"]`).classList.add('active');
      sessionStorage.setItem('adminCurrentTab', tabName);
    }
    
    window.openStudentEditModal = function(studentId) {
        const student = allStudents.find(s => s.id === studentId);
        if (!student) return;
        
        document.getElementById('editStudentId').value = studentId;
        document.getElementById('editStudentName').value = student.name;
        
        const levelSelector = document.getElementById('editStudentLevel');
        levelSelector.innerHTML = allLevels.map(l => `<option value="${l}" ${student.studentLevel === l ? 'selected' : ''}>${l}</option>`).join('');
        
        const coachSelector = document.getElementById('editStudentCoach');
        const activeCoaches = allUsers.filter(u => u.role === 'user' && (u.status || 'active') === 'active');
        coachSelector.innerHTML = activeCoaches.map(u => `<option value="${u.id}" ${student.coachEmail === u.id ? 'selected' : ''}>${u.name}</option>`).join('');
        
        document.getElementById('editStudentPhone').value = student.phone || '';
        document.getElementById('editStudentModal').style.display = 'block';
    };

    async function handleEditStudent(e) {
        e.preventDefault();
        const studentId = document.getElementById('editStudentId').value;
        const studentBefore = allStudents.find(s => s.id === studentId);
        const oldCoachEmail = studentBefore.coachEmail;
        const newCoachEmail = document.getElementById('editStudentCoach').value;
        
        const updatedData = {
            name: document.getElementById('editStudentName').value,
            studentLevel: document.getElementById('editStudentLevel').value,
            coachEmail: newCoachEmail,
            phone: document.getElementById('editStudentPhone').value
        };
        
        try {
            const batch = writeBatch(db);
            batch.update(doc(db, "students", studentId), updatedData);
            
            if (oldCoachEmail !== newCoachEmail) {
                if (oldCoachEmail) batch.update(doc(db, "users", oldCoachEmail), { studentCount: increment(-1) });
                if (newCoachEmail) batch.update(doc(db, "users", newCoachEmail), { studentCount: increment(1) });
                
                const reportsSnapshot = await getDocs(query(collection(db, "reports"), where("studentId", "==", studentId)));
                reportsSnapshot.forEach(reportDoc => batch.update(doc(db, "reports", reportDoc.id), { coachEmail: newCoachEmail }));
            }
            
            await batch.commit();
            alert('Detail siswa dan riwayat laporan berhasil diperbarui!');
            document.getElementById('editStudentModal').style.display = 'none';
            await loadAllData();
        } catch(error) {
            console.error("Gagal menyimpan dan memindahkan riwayat:", error);
            alert('Gagal menyimpan dan memindahkan riwayat. Periksa konsol untuk detail.');
        }
    }
    
    window.exportSppData = async function() {
        const coachFilter = document.getElementById('exportCoachSelector').value;
        const studentFilter = document.getElementById('exportStudentSelector').value;
        const bankFilter = document.getElementById('exportBankSelector').value;
        const yearFilter = document.getElementById('exportYearSelector').value;
        const monthFilter = document.getElementById('exportMonthSelector').value;
        const includePhone = document.getElementById('includePhone').checked;
        const statusDiv = document.getElementById('exportStatusMessage');

        setStatusMessage(statusDiv, 'Memproses data...', 'blue');

        const filteredStudents = allStudents.filter(student => 
            (coachFilter === 'all' || student.coachEmail === coachFilter) &&
            (studentFilter === 'all' || student.id === studentFilter) &&
            (student.status || 'active') === 'active' &&
            student.spp
        );

        if (filteredStudents.length === 0) {
            setStatusMessage(statusDiv, 'Tidak ada data siswa yang cocok dengan filter.', 'orange');
            return;
        }

        const workbook = new ExcelJS.Workbook();
        const sheet = workbook.addWorksheet('Laporan SPP');

        const header = ["No", "Nama Siswa", "Coach", "Tanggal Bayar", "Tahun", "Bulan", "Nominal (Rp)", "Bank"];
        const columnKeys = ['no', 'studentName', 'coach', 'paymentDate', 'year', 'month', 'nominal', 'bank'];

        if (includePhone) {
            header.push("No. Telepon");
            columnKeys.push("phone");
        }
        
        const headerRow = sheet.addRow(header);
        headerRow.eachCell((cell) => {
            cell.font = { bold: true, color: { argb: "FFFFFFFF" } };
            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF4472C4' } };
            cell.alignment = { vertical: 'middle', horizontal: 'center' };
            cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
        });

        let rowNum = 1;
        let foundPayments = false;
        const rows = []; 

        filteredStudents.forEach(student => {
            const coachName = allUsers.find(u => u.id === student.coachEmail)?.name || 'N/A';
            const studentSpp = student.spp || {};
            const studentPhone = student.phone || '';

            Object.entries(studentSpp).forEach(([key, payment]) => {
                const [paymentYear, paymentMonth] = key.split('-');
                const matchesYear = yearFilter === 'all' || paymentYear === yearFilter;
                const matchesMonth = monthFilter === 'all' || paymentMonth == monthFilter;
                const matchesBank = bankFilter === 'all' || payment.bank === bankFilter;

                if (matchesYear && matchesMonth && matchesBank) {
                    foundPayments = true;
                    const paymentDateValue = (payment.date && typeof payment.date.toDate === 'function') ? payment.date.toDate() : null;
                    const monthName = monthNames[parseInt(paymentMonth)];

                    const rowData = [
                        rowNum++,
                        student.name,
                        coachName,
                        paymentDateValue,
                        parseInt(paymentYear),
                        monthName,
                        payment.nominal, 
                        payment.bank
                    ];

                    if (includePhone) {
                        const normalizedPhone = normalizePhone(studentPhone);
                        if (normalizedPhone) {
                             const link = isMobile()
                               ? `https://api.whatsapp.com/send?phone=${normalizedPhone}`
                               : `https://web.whatsapp.com/send/?phone=${normalizedPhone}&text&type=phone_number&app_absent=1`;
                             rowData.push({ text: studentPhone, hyperlink: link });
                        } else {
                            rowData.push('');
                        }
                    }
                    rows.push(rowData);
                }
            });
        });

        if (!foundPayments) {
            setStatusMessage(statusDiv, 'Tidak ada pembayaran yang cocok dengan kombinasi filter.', 'orange');
            return;
        }
        
        rows.forEach(rowData => {
            const row = sheet.addRow(rowData);
            row.eachCell((cell, colNumber) => {
                cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
                if (colNumber === 4 && cell.value) { cell.numFmt = 'dd/mm/yyyy'; }
                if (colNumber === 7 && cell.value) { cell.numFmt = '#,##0'; }
                const phoneColIndex = columnKeys.indexOf('phone');
                if (includePhone && colNumber === phoneColIndex + 1 && cell.value && cell.value.hyperlink) {
                    cell.font = { color: { argb: "FF1D8F14" }, underline: true };
                }
            });
        });

        sheet.columns = columnKeys.map(key => ({
            key: key,
            width: key === 'phone' ? 18 : 
                   key === 'studentName' || key === 'coach' ? 25 : 
                   key === 'paymentDate' ? 15 : 
                   key === 'nominal' ? 20 : 
                   key === 'bank' ? 15 : 10
        }));
        
        sheet.views = [{ state: 'frozen', ySplit: 1 }];

        const now = new Date();
        const dateString = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`;
        const timeString = `${now.getHours().toString().padStart(2, '0')}-${now.getMinutes().toString().padStart(2, '0')}`;
        const fileName = `Laporan_SPP_${dateString}_${timeString}.xlsx`;

        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], {type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = fileName;
        link.click();
        
        setStatusMessage(statusDiv, `Data berhasil diexport ke ${fileName}!`, 'green');
    };

    setupEventListeners();

  </script>
</body>
</html>
