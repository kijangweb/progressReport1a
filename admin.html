<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Administrasi</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background-color: #f4f4f9; display: none; }
    .admin-container { max-width: 900px; margin: auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
    
    .main-header { display: flex; flex-direction: column; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; gap: 10px; }
    h1 { margin: 0; color: #007bff; }
    .logout-btn { padding: 8px 15px; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; width: 100%; text-align: center; }

    h3, h4 { color: #333; }
    .user-table, .bank-table, .student-table { width: 100%; border-collapse: collapse; margin-top: 10px; table-layout: auto; }
    .user-table th, .user-table td, .bank-table th, .bank-table td, .student-table th, .student-table td { border: 1px solid #ddd; padding: 12px; text-align: left; vertical-align: middle; }
    .user-table th, .bank-table th, .student-table th { background-color: #f2f2f2; white-space: normal; }
    .user-table td, .bank-table td, .student-table td { word-wrap: break-word; }
    
    .action-btn-disable, .action-btn-enable, .action-btn-edit {
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      border: none;
      margin-right: 5px;
      white-space: nowrap;
      width: auto;
    }
    .action-btn-disable { background-color: #ffc107; color: black; }
    .action-btn-enable { background-color: #28a745; color: white; }
    .action-btn-edit { background-color: #007bff; color: white; }

    .form-row { display: flex; flex-direction: column; gap: 10px; }
    .form-row > div { flex: 1; }
    
    .add-user-section input, .add-user-section select, 
    .reset-password-section select, .transfer-section select, 
    .bank-management-section input, .bank-management-section select,
    .filter-spp-options select, .filter-spp-options button,
    .branding-management-section input {
      padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box; 
    }
    .add-user-section button, .reset-password-section button, 
    .transfer-section button, .bank-management-section button, 
    .spp-management-section button, .add-user-section .btn,
    .bulk-action-container button, .pagination-controls button,
    .filter-controls button, .branding-management-section button,
    .content-block #pinForm button {
      padding: 8px 15px; background-color: #28a745; color: white; 
      border: none; border-radius: 4px; cursor: pointer; 
      width: 100%; text-align: center;
    }
    
    h3, h4 { text-align: left; }
    #statusMessage, #resetPasswordStatusMessage, #studentStatusMessage, #transferStatusMessage, #bankStatusMessage, #sppDeleteStatusMessage, #sppSizeInfo, #sppGlobalStats, #brandingStatusMessage, #pinStatusMessage, #changePasswordStatusMessage { margin-top: 15px; font-weight: bold; }
    
    .bulk-action-container { margin-top: 20px; padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #f9f9f9; display: flex; flex-direction: column; align-items: stretch; gap: 15px; }
    .bulk-action-container label { text-align: left; }
    .bulk-action-container select, .bulk-action-container button { width: 100%; }
    
    .pagination-controls select { width: auto; }
    .pagination-controls button { width: 100%; }

    .filter-controls { margin: 15px 0 5px 0; display: flex; flex-direction: column; gap: 10px; align-items: stretch; flex-wrap: wrap; }
    .disabled-row td { text-decoration: line-through; color: #999; background-color: #f8f9fa !important; }
    
    .pagination-controls { margin-top: 15px; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 10px; }
    .pagination-controls button:disabled { background-color: #ccc; cursor: not-allowed; }
    
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
    .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 8px; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    .modal-header h2 { margin: 0; color: #007bff; }
    .close-btn { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
    .close-btn:hover { color: black; }
    .modal-body { padding-top: 20px; }
    .modal-body .form-group { margin-bottom: 15px; }
    .modal-body label { display: block; margin-bottom: 5px; font-weight: bold; }
    .modal-body input, .modal-body select { width: 100%; padding: 8px; box-sizing: border-box; border-radius: 4px; border: 1px solid #ccc; }
    .modal-footer { text-align: right; padding-top: 20px; border-top: 1px solid #eee; }
    .modal-footer button { background-color: #007bff; }
    .curriculum-editor { border: 1px solid #ddd; padding: 15px; margin-top: 10px; border-radius: 6px; max-height: 400px; overflow-y: auto; }
    .lesson-input-group { margin-bottom: 10px; display: flex; flex-direction: column; align-items: stretch; }
    .lesson-input-group label { font-weight: bold; display: inline-block; width: auto; margin-bottom: 5px; }
    .lesson-input-group input { width: 100%; padding: 5px; }
    .add-lesson-btn { background-color: #17a2b8; color: white; border: none; padding: 8px 12px; margin-top: 15px; border-radius: 4px; cursor: pointer; }
    .btn-delete-attachments { background-color: #ffc107; color: black; border: none; padding: 8-px 15px; border-radius: 4px; cursor: pointer; }
    .spp-stats-info { margin-top: 20px; padding: 15px; background-color: #e2eafc; border-radius: 8px; border: 1px solid #b3cbe8; }
    .spp-stats-info p { margin: 5px 0; }
    .global-spp-stats { margin-top: 20px; padding: 15px; background-color: #e9f5e9; border-radius: 8px; border: 1px solid #c3e6cb; text-align: center; }
    .global-spp-stats p { margin: 5px 0; }
    .global-spp-stats span { font-size: 1.2em; font-weight: bold; color: #28a745; }
    .filter-spp-options { display: flex; flex-direction: column; gap: 10px; align-items: stretch; margin-bottom: 10px; }
    .filter-spp-options select, .filter-spp-options button { min-width: auto; width: 100%; }
    #readStatusIndicator { position: fixed; bottom: 10px; right: 10px; background-color: #212529; color: white; padding: 8px 15px; border-radius: 20px; font-size: 14px; font-family: monospace; z-index: 2000; box-shadow: 0 2px 10px rgba(0,0,0,0.3); opacity: 0.8; transition: opacity 0.3s; }
    #readStatusIndicator:hover { opacity: 1; }
    #readStatusIndicator button { margin-left: 10px; padding: 2px 8px; font-size: 12px; cursor: pointer; }
    
    .transfer-section > .form-row { display: flex; flex-direction: column; gap: 10px; }
    .transfer-section select { width: 100%; }
    .transfer-section button { align-self: stretch; margin-top: 10px; }

    .bulk-action-content {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .tabs {
      display: flex;
      border-bottom: 2px solid #ccc;
      margin-bottom: 20px;
      overflow-x: auto;
      white-space: nowrap;
    }
    .tab-btn {
      background-color: transparent;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      font-size: 1em;
      font-weight: 600;
      color: #6c757d;
      transition: color 0.2s, border-bottom 0.2s;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
    }
    .tab-btn.active {
      color: #007bff;
      border-bottom: 2px solid #007bff;
    }
    .tab-content {
      display: none;
      overflow-y: auto;
    }
    .tab-content.active {
      display: block;
    }
    .content-block {
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 8px;
      margin-top: 20px;
    }
    .table-container {
      overflow-x: auto;
    }
    
    @media (min-width: 768px) {
      .main-header { flex-direction: row; align-items: center; }
      h1 { text-align: left; }
      .logout-btn { width: auto; }
      
      .user-table th:first-child, .user-table td:first-child { width: 10%; }
      .user-table th:nth-child(2), .user-table td:nth-child(2) { width: 20%; }
      .user-table th:nth-child(3), .user-table td:nth-child(3) { width: 15%; }
      .user-table th:nth-child(4), .user-table td:nth-child(4) { width: 10%; }
      .user-table th:nth-child(5), .user-table td:nth-child(5) { width: 10%; }
      .user-table th:nth-child(6), .user-table td:nth-child(6) { width: 10%; }
      .user-table th:last-child, .user-table td:last-child { width: 15%; }
      .user-table td:last-child { text-align: left; }

      .filter-controls { flex-direction: row; gap: 20px; align-items: center; }
      .pagination-controls { flex-direction: row; justify-content: space-between; align-items: center; gap: 10px; }
      
      .form-row { flex-direction: row; align-items: flex-end; justify-content: flex-start; gap: 10px; }
      .form-row > div { flex: 1; min-width: 150px; }
      .form-row button { width: auto; align-self: flex-end; }
      
      .transfer-section > .form-row { 
        flex-direction: row;
        align-items: flex-end;
        gap: 15px;
        justify-content: flex-start;
      }
      .transfer-section .form-row > div {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
      }
      .transfer-section button { width: auto; margin-top: 0; }
      
      .filter-spp-options { flex-direction: row; gap: 10px; align-items: center; }
      .filter-spp-options select { min-width: 120px; width: auto; }
      .filter-spp-options button { margin-left: auto; width: auto; }
      
      .bulk-action-container { flex-direction: column; align-items: flex-start; gap: 15px; }
      .bulk-action-content {
        display: flex;
        flex-direction: row;
        align-items: flex-end;
        gap: 10px;
        flex-wrap: wrap;
      }
      .bulk-action-content .form-group {
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 10px;
        margin-bottom: 0;
      }
      .bulk-action-content select {
        width: 250px;
      }
      .bulk-action-content button {
        width: auto;
        margin-top: 0;
      }

      .user-table th, .user-table td, .bank-table th, .bank-table td, .student-table th, .student-table td { padding: 12px; }
      
      .lesson-input-group { flex-direction: row; align-items: center; }
      .lesson-input-group label { width: 90px; margin-bottom: 0; }
      .lesson-input-group input { width: calc(100% - 100px); }
      
      #userRowsPerPage, #studentRowsPerPage { width: auto; }
      #userPagination > div, #studentPagination > div {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      #addUserForm .form-row {
        display: flex;
        flex-wrap: wrap;
        align-items: flex-start;
        gap: 10px;
      }
      #addUserForm .form-row > div {
        flex: 1 1 200px;
      }
      #addUserForm .form-row button {
        width: auto;
        align-self: auto;
        margin-top: 20px;
      }
      
      .table-container {
        overflow-x: unset;
      }
    }
    @media (min-width: 900px) {
      #addUserForm .form-row > div {
        flex: 1;
      }
      #addUserForm .form-row button {
        margin-top: 0;
        align-self: flex-end;
      }
    }

    .export-filters {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 20px;
    }
    .export-filters .filter-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .export-filters label {
      font-weight: bold;
    }
    .export-filters select,
    .export-filters button {
      width: 100%;
      box-sizing: border-box;
    }
    @media (min-width: 768px) {
      .export-filters {
        flex-direction: row;
        flex-wrap: wrap;
        align-items: flex-end;
      }
      .export-filters .filter-group {
        flex: 1;
        min-width: 150px;
      }
      .export-filters button {
        flex: 0;
        width: auto;
        align-self: flex-end;
        margin-bottom: 0;
      }
      /* Penyesuaian untuk Pengaturan PIN agar rapi di desktop */
      #pinForm .form-row {
        align-items: flex-end;
      }
      #pinForm .form-row > div {
        flex: 1;
      }
    }
  </style>
</head>
<body>
  <div id="readStatusIndicator">Reads Sesi Ini: 0</div>
  <div class="admin-container">
    <div class="main-header">
      <div>
        <h1>Panel Direktur</h1>
        <h4 id="companyNameHeader">Loading...</h4>
      </div>
      <button type="button" class="logout-btn" onclick="logout()">Logout</button>
    </div>
    <div class="tabs">
      <button class="tab-btn active" onclick="openTab('pengguna-tab')">Pengguna</button>
      <button class="tab-btn" onclick="openTab('kurikulum-tab')">Kurikulum</button>
      <button class="tab-btn" onclick="openTab('bank-tab')">Manajemen Bank</button>
      <button class="tab-btn" onclick="openTab('maintenance-tab')">Maintenance</button>
      <button class="tab-btn" onclick="openTab('spp-export-tab')">Export SPP</button>
    </div>

    <div id="pengguna-tab" class="tab-content active">
      <div class="content-block">
        <h3>Daftar Pengguna</h3>
        <div class="filter-controls">
          <div>
            <input type="checkbox" id="showDisabledUsers"><label for="showDisabledUsers">Tampilkan Pengguna Nonaktif</label>
          </div>
          <div>
            <input type="checkbox" id="showCoachesOnly"><label for="showCoachesOnly">Hanya Tampilkan Coach</label>
          </div>
          <button type="button" id="syncCountBtn" style="background-color: #17a2b8; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">Sinkronkan Jumlah Siswa</button>
        </div>
        <div class="table-container">
          <table class="user-table" id="usersTable"><thead><tr><th>ID</th><th>Email</th><th>Nama</th><th>Jml. Siswa</th><th>Role</th><th>Status</th><th>Aksi</th></tr></thead><tbody id="usersTableBody"></tbody></table>
        </div>
        <div class="pagination-controls" id="userPagination">
          <select id="userRowsPerPage"><option value="5" selected>5</option><option value="10">10</option><option value="15">15</option><option value="20">20</option></select>
          <div>
            <button type="button" id="userPrevBtn" disabled>&laquo; Sebelumnya</button>
            <span style="margin: 0 10px;">Halaman <b id="userCurrentPage">1</b> dari <b id="userTotalPages">1</b></span>
            <button type="button" id="userNextBtn" disabled>Berikutnya &raquo;</button>
          </div>
        </div>
      </div>
      <div class="content-block">
        <h4>Tambah Pengguna Baru</h4>
        <form id="addUserForm">
          <div class="form-row">
            <div><input type="email" id="newUserEmail" placeholder="Email" required></div>
            <div><input type="text" id="newUserName" placeholder="Nama" required></div>
            <div><input type="password" id="newUserPassword" placeholder="Kata Sandi" required></div>
            <div>
              <select id="newUserRole" required>
                <option value="user">Coach</option>
                <option value="bendahara">ADMIN</option>
                <option value="admin">DIREKTUR</option>
              </select>
            </div>
            <div><button type="submit" class="btn">Tambah Pengguna</button></div>
          </div>
          <div id="statusMessage"></div>
        </form>
      </div>
      <div class="content-block">
        <h4>Reset Password</h4>
        <p>Gunakan fitur ini untuk mengirim tautan reset password ke email pengguna.</p>
        <form id="resetPasswordForm">
          <div class="form-row">
            <div><select id="resetEmailSelector" required></select></div>
            <div><button type="submit" class="btn">Kirim Email Reset</button></div>
          </div>
          <div id="resetPasswordStatusMessage"></div>
        </form>
      </div>
      
    </div>

    <div id="kurikulum-tab" class="tab-content">
      <div class="content-block">
        <h3>Manajemen Kurikulum</h3>
        <h4>Tambah Level Kurikulum Baru</h4>
        <form id="addLevelForm">
          <div class="form-row">
            <div><input type="text" id="newLevelName" placeholder="Nama Level Baru (cth: Foundation 3)" required></div>
            <div><button type="submit" class="btn">Tambah Level</button></div>
          </div>
        </form>
      </div>
      <div class="content-block">
        <h4>Edit Level Kurikulum yang Ada</h4>
        <label for="levelEditorSelector">Pilih Level untuk Diedit:</label>
        <select id="levelEditorSelector"></select>
        <div id="curriculumEditor" class="curriculum-editor" style="display: none;">
          <p>Masukkan daftar aktivitas untuk setiap lesson, pisahkan dengan koma (,). Contoh: A,B,C,D</p>
          <form id="editCurriculumForm"></form>
          <button type="button" id="addLessonBtn" class="add-lesson-btn">(+) Tambah Lesson Baru</button>
          <hr style="margin: 20px 0;">
          <button type="button" id="saveCurriculumBtn" style="background-color: #007bff; margin-top: 15px;">Simpan Perubahan Kurikulum</button>
        </div>
      </div>
    </div>

    <div id="bank-tab" class="tab-content">
      <div class="content-block">
        <h3>Manajemen Bank</h3>
        <form id="addBankForm">
          <div class="form-row">
            <div><input type="text" id="newBankName" placeholder="Nama Bank (cth: BCA)" required></div>
            <div><input type="color" id="newBankColor" value="#007bff"></div>
            <div><button type="submit" class="btn">Tambah Bank</button></div>
          </div>
        </form>
        <div id="bankStatusMessage"></div>
        <h4 style="margin-top: 20px;">Daftar Bank</h4>
        <div class="table-container">
          <table class="bank-table"><thead><tr><th>Nama Bank</th><th>Warna</th><th>Aksi</th></tr></thead><tbody id="bankTableBody"></tbody></table>
        </div>
      </div>
    </div>

    <div id="maintenance-tab" class="tab-content">
      <div class="content-block">
        <h3>Manajemen SPP</h3>
        <div id="sppGlobalStats" class="global-spp-stats">
          <p><strong>Total Ukuran Base64 (Semua Tahun):</strong> <span id="sppGlobalTotalSize">--</span></p>
          <p><strong>Persentase Terpakai dari 1GB:</strong> <span id="sppGlobalSizePercentage">--</span></p>
        </div>
        <p style="margin-top:20px;">Kelola data lampiran pembayaran SPP untuk mengontrol ukuran database Anda.</p>
        <div class="filter-spp-options">
          <div>
            <label for="sppYearToDelete">Pilih Tahun:</label>
            <select id="sppYearToDelete">
              <option value="">-- Pilih Tahun --</option>
            </select>
          </div>
          <div>
            <label for="sppMonthToDelete">Pilih Bulan:</label>
            <select id="sppMonthToDelete">
              <option value="">-- Pilih Bulan --</option>
            </select>
          </div>
          <button class="action-button" onclick="calculateSppAttachmentSize()" style="background-color: #007bff; margin-left: 10px;">Hitung Ukuran Lampiran</button>
        </div>
        <div id="sppSizeInfo" class="spp-stats-info" style="display: none;">
          <p><strong>Jumlah Lampiran:</strong> <span id="sppFileCount">0</span></p>
          <p><strong>Total Ukuran:</strong> <span id="sppTotalSize">0 KB</span></p>
          <p><strong>Persentase dari 1GB:</strong> <span id="sppSizePercentage">0.00%</span></p>
          <p><em>Diperbarui: <span id="sppTimestamp">--</span></em></p>
        </div>
        <hr style="margin: 20px 0;">
        <p>Hapus lampiran bukti bayar untuk mengurangi ukuran database. Tindakan ini permanen.</p>
        <button class="action-button btn-delete-attachments" onclick="deleteSppAttachmentsByYearAndMonth()">Hapus Lampiran</button>
        <div id="sppDeleteStatusMessage" class="status-message"></div>
      </div>
      <div class="content-block">
        <h3>Manajemen Branding</h3>
        <form id="brandingForm">
          <div class="form-row">
            <div>
              <label for="companyNameInput">Nama Perusahaan</label>
              <input type="text" id="companyNameInput" placeholder="Nama Perusahaan (cth: SEMPOA SIP TC PARADUTA OPI)" required>
            </div>
            <div>
              <label for="logoFileInput">Logo (PNG, JPG, dll.)</label>
              <input type="file" id="logoFileInput" accept="image/*">
            </div>
          </div>
          <div class="form-row" style="margin-top: 15px;">
            <div style="flex: 1;"><button type="submit" class="btn">Simpan Branding</button></div>
          </div>
          <div id="brandingStatusMessage" style="margin-top: 10px;"></div>
        </form>
        <div style="margin-top: 20px;">
          <h4>Pratinjau Logo</h4>
          <img id="logoPreview" style="max-width: 150px; border: 1px solid #ccc; padding: 5px;">
          <p id="companyNamePreview" style="font-size: 1.2em; font-weight: bold; margin-top: 5px;"></p>
        </div>
      </div>
      
      <div class="content-block">
          <h3>Pengaturan PIN Edit Pembayaran (One-Time PIN)</h3>
          <form id="pinForm">
              <div class="form-row">
                  <div>
                      <label for="pinDigitLength">Jumlah Digit PIN (4-6)</label>
                      <select id="pinDigitLength" required>
                          <option value="4">4 Digit</option>
                          <option value="5">5 Digit</option>
                          <option value="6">6 Digit</option>
                      </select>
                  </div>
                  <div>
                      <label for="pinDuration">Durasi PIN Aktif (Jam)</label>
                      <select id="pinDuration" required>
                          <option value="3">3 Jam</option>
                          <option value="6">6 Jam</option>
                          <option value="9">9 Jam</option>
                      </select>
                  </div>
              </div>
              <div class="form-row">
                  <div>
                      <label for="pinInput">PIN Saat Ini</label>
                      <input type="text" id="pinInput" placeholder="PIN yang Aktif" maxlength="6" readonly style="font-weight: bold;">
                  </div>
              </div>
              <div class="form-row" style="margin-top: 15px; align-items: center;">
                  <div style="flex: 1;">
                      <label>Waktu Tersisa: <span id="pinTimer" style="font-weight: bold; color: #dc3545;">--</span></label>
                  </div>
                  <div style="flex: 1;">
                      <button type="button" id="generatePinBtn" class="btn" style="background-color: #007bff;">Generate PIN Baru</button>
                  </div>
              </div>
              <div id="pinStatusMessage" style="margin-top: 10px;"></div>
          </form>
      </div>
      </div>
    
    <div id="spp-export-tab" class="tab-content">
        <div class="content-block">
            <h3>Export Data SPP</h3>
            <p>Gunakan filter di bawah ini untuk menentukan data SPP yang akan diexport.</p>
            <div class="export-filters">
                <div class="filter-group">
                    <label for="exportCoachSelector">Pilih Coach:</label>
                    <select id="exportCoachSelector"></select>
                </div>
                <div class="filter-group">
                    <label for="exportStudentSelector">Pilih Siswa:</label>
                    <select id="exportStudentSelector"></select>
                </div>
                <div class="filter-group">
                    <label for="exportBankSelector">Pilih Bank:</label>
                    <select id="exportBankSelector"></select>
                </div>
                <div class="filter-group">
                    <label for="exportYearSelector">Pilih Tahun:</label>
                    <select id="exportYearSelector"></select>
                </div>
                <div class="filter-group">
                    <label for="exportMonthSelector">Pilih Bulan:</label>
                    <select id="exportMonthSelector">
                        <option value="all">Semua Bulan</option>
                        <option value="0">Januari</option>
                        <option value="1">Februari</option>
                        <option value="2">Maret</option>
                        <option value="3">April</option>
                        <option value="4">Mei</option>
                        <option value="5">Juni</option>
                        <option value="6">Juli</option>
                        <option value="7">Agustus</option>
                        <option value="8">September</option>
                        <option value="9">Oktober</option>
                        <option value="10">November</option>
                        <option value="11">Desember</option>
                    </select>
                </div>
                <div class="filter-group" style="align-self: center;">
                    <label>
                        <input type="checkbox" id="includePhone"> Sertakan Nomor Telepon
                    </label>
                </div>
                <button type="button" class="btn" onclick="exportSppData()">Export ke Excel</button>
            </div>
            <div id="exportStatusMessage" style="margin-top: 10px;"></div>
            
            <div style="display:none;">
                <table id="exportTable" border="1"></table>
            </div>
        </div>
    </div>
  </div>
  
  <div id="editUserModal" class="modal"><div class="modal-content"><div class="modal-header"><h2>Edit Detail Pengguna</h2><span class="close-btn">&times;</span></div><form id="editUserForm"><div class="modal-body"><p>Email: <strong id="editUserEmail"></strong></p><input type="hidden" id="editUserId"><div class="form-group"><label for="editFullName">Nama Lengkap</label><input type="text" id="editFullName" placeholder="Masukkan nama lengkap"></div><div class="form-group"><label for="editPhoneNumber">No. Telepon</label><input type="tel" id="editPhoneNumber" placeholder="Contoh: 08123456789"></div><div class="form-group" id="editUserLevelGroup"><label for="editUserLevel">Level (untuk Coach)</label><input type="text" id="editUserLevel" placeholder="Contoh: Master"></div></div><div class="modal-footer"><button type="submit">Simpan Perubahan</button></div></form></div></div>
  <div id="editBankModal" class="modal"><div class="modal-content"><div class="modal-header"><h2>Edit Detail Bank</h2><span class="close-btn">&times;</span></span></div><form id="editBankForm"><div class="modal-body"><input type="hidden" id="editBankId"><div class="form-group"><label for="editBankName">Nama Bank</label><input type="text" id="editBankName" required></div><div class="form-group"><label for="editBankColor">Warna</label><input type="color" id="editBankColor"></div></div><div class="modal-footer"><button type="submit">Simpan Perubahan</button></div></form></div></div>
  
  <div id="editStudentModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Edit Detail Siswa</h2>
            <span class="close-btn" onclick="document.getElementById('editStudentModal').style.display='none';">&times;</span>
        </div>
        <form id="editStudentFormInAdmin">
            <div class="modal-body">
                <input type="hidden" id="editStudentId">
                <div class="form-group">
                    <label for="editStudentName">Nama Siswa</label>
                    <input type="text" id="editStudentName" required>
                </div>
                <div class="form-group">
                    <label for="editStudentLevel">Level Siswa</label>
                    <select id="editStudentLevel"></select>
                </div>
                <div class="form-group">
                    <label for="editStudentCoach">Pindahkan ke Coach</label>
                    <select id="editStudentCoach" required></select>
                </div>
                <div class="form-group">
                    <label for="editStudentPhone">No. Telepon</label>
                    <input type="tel" id="editStudentPhone" placeholder="Contoh: 08123456789">
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="action-btn" style="background-color: #28a745;">Simpan Perubahan</button>
            </div>
        </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword, sendPasswordResetEmail, updatePassword } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getFirestore, collection, getDocs, doc, setDoc, getDoc, addDoc, query, where, updateDoc, writeBatch, increment, deleteDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
    
    const firebaseConfig = { apiKey: "AIzaSyBm3SkLLtl9LvczDDht-OQ6-R4OYLPYAJQ", authDomain: "progres-report-5d199.firebaseapp.com", projectId: "progres-report-5d199", storageBucket: "progres-report-5d199.firebasestorage.app", messagingSenderId: "363573365137", appId: "1:363573365137:web:98f32d5ff8fae05617b230", measurementId: "G-CPX04R69F5" };
    
    const mainApp = initializeApp(firebaseConfig);
    const secondaryApp = initializeApp(firebaseConfig, "secondary");
    const auth = getAuth(mainApp);
    const secondaryAuth = getAuth(secondaryApp);
    const db = getFirestore(mainApp);

    let sessionReadCount = 0;
    const readStatusElement = document.getElementById('readStatusIndicator');
    function updateReadStatus() {
      if(readStatusElement) readStatusElement.innerHTML = `Reads Sesi Ini: ${sessionReadCount} <button onclick="window.resetReadCount()">Reset</button>`;
    }
    window.resetReadCount = function() {
      sessionReadCount = 0;
      updateReadStatus();
    }

    let allUsers = [], allStudents = [], allBanks = {}, allLevels = [];
    let userCurrentPage = 1;
    const sppYearToDeleteSelect = document.getElementById('sppYearToDelete');
    const sppMonthToDeleteSelect = document.getElementById('sppMonthToDelete');
    const sppDeleteStatusMessageDiv = document.getElementById('sppDeleteStatusMessage');
    const statusMessageDiv = document.getElementById('statusMessage');
    const resetPasswordStatusMessageDiv = document.getElementById('resetPasswordStatusMessage');
    const bankStatusMessageDiv = document.getElementById('bankStatusMessage');
    const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
    const sppSizeInfoDiv = document.getElementById('sppSizeInfo');
    const sppFileCountSpan = document.getElementById('sppFileCount');
    const sppTotalSizeSpan = document.getElementById('sppTotalSize');
    const sppTimestampSpan = document.getElementById('sppTimestamp');
    const sppSizePercentageSpan = document.getElementById('sppSizePercentage');
    const sppGlobalTotalSizeSpan = document.getElementById('sppGlobalTotalSize');
    const sppGlobalSizePercentageSpan = document.getElementById('sppGlobalSizePercentage');
    
    const pinStatusMessageDiv = document.getElementById('pinStatusMessage');
    let appEditPin = '';
    let pinExpiryTimer; // Variabel global untuk timer PIN
    
    let allYearsWithPayments = [];
    let allActiveBankNames = [];

    window.logout = function() { signOut(auth).then(() => { window.location.href = 'login.html'; }); };

    const generateCoachId = () => {
      const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      const numbers = '0123456789';
      let result = '';
      for (let i = 0; i < 3; i++) {
        result += letters.charAt(Math.floor(Math.random() * letters.length));
      }
      for (let i = 0; i < 3; i++) {
        result += numbers.charAt(Math.floor(Math.random() * numbers.length));
      }
      return result;
    };
    
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        updateReadStatus();
        try {
          const docRef = doc(db, "users", user.email);
          const docSnap = await getDoc(docRef);
          sessionReadCount++; updateReadStatus();
          if (docSnap.exists() && docSnap.data().role === 'admin') {
            document.body.style.display = 'block';
            await loadAllData();
          } else {
            alert("Akses ditolak. Anda bukan admin atau data Anda tidak ditemukan.");
            await signOut(auth);
            window.location.href = 'login.html';
          }
        } catch (error) {
          console.error("Terjadi error saat verifikasi admin:", error);
          alert("Terjadi kesalahan saat otentikasi. Periksa console untuk detail.");
          await signOut(auth);
          window.location.href = 'login.html';
        }
      } else {
        window.location.href = 'login.html';
      }
    });

    async function loadAllData() {
      try {
        const currentTab = sessionStorage.getItem('adminCurrentTab') || 'pengguna-tab';

        const userSnapshot = await getDocs(collection(db, "users"));
        sessionReadCount += userSnapshot.size;

        const studentSnapshot = await getDocs(collection(db, "students"));
        sessionReadCount += studentSnapshot.size;
        allStudents = studentSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const bankSnapshot = await getDocs(collection(db, "banks"));
        sessionReadCount += bankSnapshot.size;
        
        const curriculumSnapshot = await getDocs(collection(db, "kurikulum"));
        sessionReadCount += curriculumSnapshot.size;
        updateReadStatus();

        allUsers = userSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        allBanks = {};
        bankSnapshot.forEach(doc => { 
            allBanks[doc.id] = {id: doc.id, ...doc.data()}; 
        });
        allLevels = curriculumSnapshot.docs.map(doc => doc.id).sort();
        allActiveBankNames = Object.values(allBanks).filter(b => (b.status || 'active') === 'active').map(b => b.bankName);
        
        renderUserTable();
        renderBankTable();
        populateCoachDropdowns();
        populateLevelDropdowns();
        loadSppYearsForDeletion();
        calculateGlobalSppAttachmentSize();
        setupEventListeners();
        loadBranding();
        loadPin(); 
        populateExportSelectors();
        openTab(currentTab);
      } catch (error) {
        console.error("ERROR di dalam loadAllData:", error);
        alert("Gagal memuat data utama. Kemungkinan ada masalah dengan Security Rules. Periksa console (F12).");
      }
    }
    
    async function loadBranding() {
      const brandingForm = document.getElementById('brandingForm');
      const companyNameInput = document.getElementById('companyNameInput');
      const logoPreview = document.getElementById('logoPreview');
      const companyNamePreview = document.getElementById('companyNamePreview');
      const brandingStatusMessage = document.getElementById('brandingStatusMessage');
      const companyNameHeader = document.getElementById('companyNameHeader');
    
      try {
        const docRef = doc(db, "settings", "brand");
        const docSnap = await getDoc(docRef);
        sessionReadCount++; updateReadStatus();
    
        if (docSnap.exists()) {
          const data = docSnap.data();
          if (data.companyName) {
            companyNameInput.value = data.companyName;
            companyNamePreview.textContent = data.companyName.toUpperCase();
            if (companyNameHeader) {
              companyNameHeader.textContent = data.companyName;
            }
          }
          if (data.logoBase64) {
            logoPreview.src = data.logoBase64;
            logoPreview.style.display = 'inline-block';
          } else {
            logoPreview.style.display = 'none';
          }
        }
      } catch (error) {
        console.error("Gagal memuat pengaturan branding:", error);
        brandingStatusMessage.textContent = 'Gagal memuat data branding.';
        brandingStatusMessage.style.color = 'red';
      }
    
      if (brandingForm) {
        brandingForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          brandingStatusMessage.textContent = 'Menyimpan...';
          brandingStatusMessage.style.color = 'blue';
          const companyName = companyNameInput.value;
          const logoFile = document.getElementById('logoFileInput').files[0];
          let logoBase64 = logoPreview.src;
      
          if (logoFile) {
            const reader = new FileReader();
            reader.onload = async function() {
              logoBase64 = reader.result;
              await saveBranding(companyName, logoBase64);
            };
            reader.readAsDataURL(logoFile);
          } else {
            await saveBranding(companyName, logoBase64);
          }
        });
      }
      const logoFileInput = document.getElementById('logoFileInput');
      if (logoFileInput) {
        logoFileInput.addEventListener('change', function(e) {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
              logoPreview.src = event.target.result;
            };
            reader.readAsDataURL(file);
          }
        });
      }
    }
    async function saveBranding(companyName, logoBase64) {
      const brandingStatusMessage = document.getElementById('brandingStatusMessage');
      try {
        await setDoc(doc(db, "settings", "brand"), {
          companyName: companyName,
          logoBase64: logoBase64
        });
        brandingStatusMessage.textContent = 'Branding berhasil disimpan!';
        brandingStatusMessage.style.color = 'green';
        await loadBranding();
      } catch (error) {
        console.error("Gagal menyimpan branding:", error);
        brandingStatusMessage.textContent = `Gagal menyimpan: ${error.message}`;
        brandingStatusMessage.style.color = 'red';
      }
    }

    // --- LOGIC PIN BARU START ---

    function generateNumericPin(length) {
        let result = '';
        const characters = '0123456789';
        for (let i = 0; i < length; i++) {
            result += characters.charAt(Math.floor(Math.random() * characters.length));
        }
        return result;
    }
    
    function startPinTimer(expiryTimestamp) {
        if (pinExpiryTimer) {
            clearInterval(pinExpiryTimer);
        }

        const timerSpan = document.getElementById('pinTimer');
        const pinInput = document.getElementById('pinInput');

        const updateTimer = async () => {
            const now = Date.now();
            const distance = expiryTimestamp - now;

            if (distance < 0) {
                timerSpan.textContent = "KEDALUWARSA";
                pinInput.value = '********'; 
                appEditPin = ''; // Hapus PIN lokal

                // Menandai PIN di Firestore sebagai 'expired' dan mengisi PIN dengan string mustahil
                try {
                    await updateDoc(doc(db, "settings", "appEditPin"), { 
                        status: 'expired',
                        // TRICK: Mengganti PIN dengan string mustahil agar di Dashboard (atau modul lain)
                        // variabel appEditPin tidak menjadi '' (string kosong) saat PIN expired.
                        // Ini akan menutup celah keamanan "PIN kosong sama dengan PIN kosong".
                        pin: 'PIN_EXPIRED_#_NON_NUMERIC_!@#$'
                    });
                } catch (e) {
                    // Hanya log error, tidak perlu mengganggu UI
                    console.error("Gagal memperbarui status PIN expired:", e);
                }

                clearInterval(pinExpiryTimer);
                return;
            }

            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);

            timerSpan.textContent = `${hours}j ${minutes}m ${seconds}s`;
        };

        pinExpiryTimer = setInterval(updateTimer, 1000);
        updateTimer();
    }
    
    async function handleGeneratePin(e) {
        e.preventDefault();
        const length = parseInt(document.getElementById('pinDigitLength').value, 10);
        const durationHours = parseInt(document.getElementById('pinDuration').value, 10);
        const durationMs = durationHours * 60 * 60 * 1000;
        
        const newPin = generateNumericPin(length);
        const expiryDate = new Date(Date.now() + durationMs); 

        pinStatusMessageDiv.textContent = 'Menyimpan PIN baru...';
        pinStatusMessageDiv.style.color = 'blue';
        
        try {
            await setDoc(doc(db, "settings", "appEditPin"), { 
                pin: newPin,
                expiry: expiryDate,
                length: length,
                durationHours: durationHours,
                status: 'active'
            });
            
            // Perbarui tampilan di UI
            appEditPin = newPin;
            document.getElementById('pinInput').value = newPin;
            startPinTimer(expiryDate.getTime());
            
            pinStatusMessageDiv.textContent = `PIN Baru: ${newPin} berhasil di-generate! Berlaku selama ${durationHours} jam.`;
            pinStatusMessageDiv.style.color = 'green';
            
        } catch (error) {
            pinStatusMessageDiv.textContent = `Error: ${error.message}`;
            pinStatusMessageDiv.style.color = 'red';
            console.error("Gagal menyimpan PIN baru:", error);
        }
    }

    async function loadPin() {
        try {
            const docRef = doc(db, "settings", "appEditPin");
            const docSnap = await getDoc(docRef);
            sessionReadCount++; updateReadStatus();
            const pinInput = document.getElementById('pinInput');
            const pinTimer = document.getElementById('pinTimer');
            const digitSelector = document.getElementById('pinDigitLength');
            const durationSelector = document.getElementById('pinDuration');

            if (docSnap.exists()) {
                const data = docSnap.data();
                
                // Jika PIN Aktif dan belum kedaluwarsa
                // Note: Ketika expired, data.pin akan berisi string mustahil. 
                // Karena data.status bukan 'active', blok ini tidak akan tereksekusi.
                if (data.status === 'active' && data.expiry && data.expiry.toDate) {
                    appEditPin = data.pin || '';
                    pinInput.value = appEditPin;
                    startPinTimer(data.expiry.toDate().getTime()); // Mulai timer
                } else {
                    // Blok ini tereksekusi saat expired/nonaktif.
                    // PIN lokal admin di-set kosong agar tombol generate baru bisa digunakan.
                    appEditPin = '';
                    pinInput.value = '********';
                    pinTimer.textContent = 'NONAKTIF';
                    if (pinExpiryTimer) clearInterval(pinExpiryTimer);
                }
                
                // Mengatur pilihan digit jika tersimpan
                if (data.length) {
                    digitSelector.value = data.length;
                }
                // Mengatur pilihan durasi jika tersimpan
                if (data.durationHours) {
                    durationSelector.value = data.durationHours;
                }
            } else {
                pinInput.value = '********';
                pinTimer.textContent = 'NONAKTIF';
            }
        } catch (error) {
            console.error("Gagal memuat PIN:", error);
            appEditPin = '';
        }
    }
    
    // --- LOGIC PIN BARU END ---

    async function syncStudentCount() {
      if (!confirm('Yakin ingin menyinkronkan jumlah siswa? Ini akan memperbaiki jumlah yang salah.')) {
        return;
      }
      alert('Proses sinkronisasi dimulai...');
      try {
        const studentSnapshot = await getDocs(query(collection(db, "students"), where("status", "==", "active")));
        sessionReadCount += studentSnapshot.size; updateReadStatus();
        
        const studentCounts = {};
        studentSnapshot.forEach(studentDoc => {
          const coachEmail = studentDoc.data().coachEmail;
          if (coachEmail) {
            studentCounts[coachEmail] = (studentCounts[coachEmail] || 0) + 1;
          }
        });
        
        const batch = writeBatch(db);
        
        const allCoaches = allUsers.filter(u => u.role === 'user').map(u => u.id);
        allCoaches.forEach(coachEmail => {
            batch.update(doc(db, "users", coachEmail), { studentCount: studentCounts[coachEmail] || 0 });
        });
        
        await batch.commit();
        alert('Sinkronisasi jumlah siswa berhasil!');
        await loadAllData();
      } catch (error) {
        console.error("Gagal menyinkronkan jumlah siswa:", error);
        alert('Gagal menyinkronkan jumlah siswa. Periksa console untuk detail.');
      }
    }
    
    async function handleLevelSelect(e) {
      const level = e.target.value;
      const editor = document.getElementById('curriculumEditor');
      const form = document.getElementById('editCurriculumForm');
      form.innerHTML = '';
      if (!level) { editor.style.display = 'none'; return; }
      try { 
        const docSnap = await getDoc(doc(db, "kurikulum", level));
        sessionReadCount++; updateReadStatus();
        if (docSnap.exists()) {
          const lessons = docSnap.data().lessons || {};
          const sortedKeys = Object.keys(lessons).sort((a,b) => parseInt(a.split(' ')[1]) - parseInt(b.split(' ')[1]));
          sortedKeys.forEach(key => {
            const activities = lessons[key].join(',');
            form.innerHTML += `<div class="lesson-input-group"><label>${key}:</label><input type="text" value="${activities}" data-lesson-name="${key}">`;
          });
        }
        editor.style.display = 'block';
      } catch(error) {
        console.error("Error fetching curriculum:", error);
      }
    }
    window.deleteSppAttachmentsByYearAndMonth = async function() {
      const yearToDelete = sppYearToDeleteSelect.value;
      const monthToDelete = sppMonthToDeleteSelect.value;
      if (!yearToDelete) {
        sppDeleteStatusMessageDiv.textContent = 'Harap pilih tahun untuk menghapus lampiran.';
        sppDeleteStatusMessageDiv.style.color = 'red';
        return;
      }
      let confirmMessage = `Apakah Anda yakin ingin menghapus semua lampiran (bukti bayar Base64) untuk tahun ${yearToDelete}`;
      if (monthToDelete) {
        confirmMessage += ` bulan ${monthNames[monthToDelete]}`;
      }
      confirmMessage += `? Tindakan ini tidak bisa dibatalkan.`;
      if (!confirm(confirmMessage)) {
        return;
      }
      sppDeleteStatusMessageDiv.textContent = `Menghapus lampiran untuk tahun ${yearToDelete}...`;
      sppDeleteStatusMessageDiv.style.color = 'blue';
      try {
        const studentsRef = collection(db, "students");
        const querySnapshot = await getDocs(studentsRef);
        sessionReadCount += querySnapshot.size; updateReadStatus();

        const updates = [];
        querySnapshot.forEach(docSnapshot => {
          const studentRef = doc(db, "students", docSnapshot.id);
          const studentData = docSnapshot.data();
          const updatedSpp = { ...studentData.spp };
          let hasAttachmentsToDelete = false;
          Object.keys(updatedSpp).forEach(key => {
            const [paymentYear, paymentMonth] = key.split('-');
            if (paymentYear == yearToDelete && (monthToDelete === '' || paymentMonth == monthToDelete)) {
              if (updatedSpp[key].attachmentBase64) {
                delete updatedSpp[key].attachmentBase64;
                hasAttachmentsToDelete = true;
              }
            }
          });
          if (hasAttachmentsToDelete) {
            updates.push(updateDoc(studentRef, { spp: updatedSpp }));
          }
        });
        if (updates.length > 0) {
          await Promise.all(updates);
          await loadAllData();
          sppDeleteStatusMessageDiv.textContent = `Semua lampiran untuk tahun ${yearToDelete} berhasil dihapus. Total dokumen diperbarui: ${updates.length}.`;
          sppDeleteStatusMessageDiv.style.color = 'green';
        } else {
          sppDeleteStatusMessageDiv.textContent = `Tidak ada lampiran yang ditemukan untuk tahun ${yearToDelete}.`;
          sppDeleteStatusMessageDiv.style.color = 'orange';
        }
      } catch (error) {
        sppDeleteStatusMessageDiv.textContent = `Error saat menghapus lampiran: ${error.message}`;
        sppDeleteStatusMessageDiv.style.color = 'red';
        console.error("Error deleting old attachments:", error);
      }
    }
    
    function loadSppYearsForDeletion() {
      const years = new Set();
      allStudents.forEach(student => {
        if (student.spp) {
          Object.keys(student.spp).forEach(key => {
            const year = key.split('-')[0];
            if (year) {
              years.add(parseInt(year));
            }
          });
        }
      });
      const sortedYears = Array.from(years).sort((a, b) => b - a);
      sppYearToDeleteSelect.innerHTML = '<option value="">-- Pilih Tahun --</option>';
      sortedYears.forEach(year => {
        sppYearToDeleteSelect.innerHTML += `<option value="${year}">${year}</option>`;
      });
    }
    async function updateCoachStudentCount(coachEmail, value) {
      if (!coachEmail) return;
      const coachRef = doc(db, "users", coachEmail);
      try {
        await updateDoc(coachRef, { studentCount: increment(value) });
      } catch (error) {
        if (error.code && (error.code.includes('not-found') || error.code.includes('no-document-to-update'))) {
          await setDoc(coachRef, { studentCount: value > 0 ? value : 0 }, { merge: true });
        } else {
          console.error(`Gagal update studentCount untuk ${coachEmail}:`, error);
        }
      }
    }
    function renderUserTable() {
      const tableBody = document.getElementById('usersTableBody');
      const showDisabled = document.getElementById('showDisabledUsers').checked;
      const showCoachesOnly = document.getElementById('showCoachesOnly').checked;
      let filteredUsers = allUsers;
      if (!showDisabled) { filteredUsers = filteredUsers.filter(u => (u.status || 'active') === 'active'); }
      if (showCoachesOnly) { filteredUsers = filteredUsers.filter(u => u.role === 'user'); }
      const rowsPerPage = parseInt(document.getElementById('userRowsPerPage').value, 10);
      const totalItems = filteredUsers.length;
      const totalPages = Math.ceil(totalItems / rowsPerPage) || 1;
      if (userCurrentPage > totalPages) userCurrentPage = totalPages;
      const start = (userCurrentPage - 1) * rowsPerPage;
      const paginatedUsers = filteredUsers.slice(start, start + rowsPerPage);
      tableBody.innerHTML = '';
      paginatedUsers.forEach(userData => {
        const row = tableBody.insertRow();
        let studentCountCell = '<td>-</td>';
        if (userData.role === 'user') {
          const studentCount = userData.studentCount || 0;
          studentCountCell = `<td style="text-align: center;">${studentCount}</td>`;
        }
        
        let displayedRole;
        switch (userData.role) {
          case 'admin':
            displayedRole = 'DIREKTUR';
            break;
          case 'bendahara':
            displayedRole = 'ADMIN';
            break;
          case 'user':
            displayedRole = 'Coach';
            break;
          default:
            displayedRole = 'N/A';
        }
        
        const status = (userData.status === 'active' || userData.status === undefined) ? 'active' : 'disabled';
        row.className = status === 'disabled' ? 'disabled-row' : '';
        
        let actionButtons = '';
        let coachId = userData.coachId || 'N/A';
        
        if (userData.role === 'admin') {
          actionButtons = '<span>Aksi tidak tersedia</span>';
        } else {
          const buttonText = status === 'active' ? 'Disable' : 'Enable';
          const buttonClass = status === 'active' ? 'action-btn-disable' : 'action-btn-enable';
          
          let regenerateIdButton = '';
          if (userData.role === 'user' && !userData.coachId) {
            regenerateIdButton = `<button type="button" class="action-btn-edit" onclick="regenerateCoachId('${userData.id}')">Regenerate ID</button>`;
          }
          
          actionButtons = `
            <button type="button" class="${buttonClass}" onclick="toggleUserStatus('${userData.id}','${userData.status || 'active'}')">${buttonText}</button>
            <button type="button" class="action-btn-edit" onclick="openEditModal('${userData.id}')">Detail</button>
            ${regenerateIdButton}
          `;
        }
        
        row.innerHTML = `
          <td>${coachId}</td>
          <td>${userData.id}</td>
          <td>${userData.name || ''}</td>
          ${studentCountCell}
          <td>${displayedRole}</td>
          <td>${status}</td>
          <td style="white-space: nowrap;">${actionButtons}</td>
        `;
      });
      updateUserPagination(totalItems);
    }
    function renderBankTable() {
      const tableBody = document.getElementById('bankTableBody');
      tableBody.innerHTML = '';
      Object.values(allBanks).forEach(bank => {
        const status = bank.status || 'active';
        const row = tableBody.insertRow();
        row.className = status === 'disabled' ? 'disabled-row' : '';
        const buttonText = status === 'active' ? 'Disable' : 'Enable';
        const buttonClass = status === 'active' ? 'action-btn-disable' : 'action-btn-enable';
        row.innerHTML = `<td>${bank.bankName}</td><td><div style="width:20px; height:20px; background-color:${bank.color}; border:1px solid #ccc;"></div></td><td style="white-space:nowrap;"><button class="${buttonClass}" onclick="toggleBankStatus('${bank.id}', '${status}')">${buttonText}</button> <button class="action-btn-edit" onclick="openEditBankModal('${bank.id}')">Edit</button></td>`;
      });
    }
    function setupEventListeners() {
      document.getElementById('userRowsPerPage').addEventListener('change', () => { userCurrentPage = 1; renderUserTable(); });
      document.getElementById('userPrevBtn').addEventListener('click', () => { if (userCurrentPage > 1) { userCurrentPage--; renderUserTable(); } });
      document.getElementById('userNextBtn').addEventListener('click', () => { const totalPages = parseInt(document.getElementById('userTotalPages').textContent); if (userCurrentPage < totalPages) { userCurrentPage++; renderUserTable(); } });
      document.getElementById('showDisabledUsers').addEventListener('change', () => { userCurrentPage = 1; renderUserTable(); });
      document.getElementById('showCoachesOnly').addEventListener('change', () => { userCurrentPage = 1; renderUserTable(); });
      document.getElementById('addUserForm').addEventListener('submit', handleAddUser);
      document.getElementById('resetPasswordForm').addEventListener('submit', handleResetPassword);
      document.querySelector('#editUserModal .close-btn').onclick = () => document.getElementById('editUserModal').style.display = 'none';
      document.querySelector('#editBankModal .close-btn').onclick = () => document.getElementById('editBankModal').style.display = 'none';
      window.onclick = (event) => {
        const modals = document.getElementsByClassName('modal');
        for (let i = 0; i < modals.length; i++) {
          if (event.target == modals[i]) modals[i].style.display = "none";
        }
      };
      document.getElementById('editUserForm').addEventListener('submit', handleEditUser);
      document.getElementById('addLevelForm').addEventListener('submit', handleAddLevel);
      document.getElementById('levelEditorSelector').addEventListener('change', handleLevelSelect);
      document.getElementById('saveCurriculumBtn').addEventListener('click', handleSaveCurriculum);
      document.getElementById('addBankForm').addEventListener('submit', handleAddBank);
      document.getElementById('editBankForm').addEventListener('submit', handleEditBank);
      document.getElementById('addLessonBtn').addEventListener('click', addNewLessonInput);
      const sppYearToDeleteSelect = document.getElementById('sppYearToDelete');
      if(sppYearToDeleteSelect) {
        sppYearToDeleteSelect.addEventListener('change', () => {
          sppSizeInfoDiv.style.display = 'none';
          sppDeleteStatusMessageDiv.textContent = '';
        });
        sppYearToDeleteSelect.addEventListener('change', populateSppMonthsForDeletion);
      }
      document.querySelectorAll('.tab-btn').forEach(button => {
        button.addEventListener('click', () => {
          const tabId = button.getAttribute('onclick').match(/'(.*?)'/)[1];
          openTab(tabId);
        });
      });
      const syncCountBtn = document.getElementById('syncCountBtn');
      if(syncCountBtn) syncCountBtn.addEventListener('click', syncStudentCount);
      
      // PERUBAHAN: Ganti listener form PIN lama dengan tombol Generate baru
      const generatePinBtn = document.getElementById('generatePinBtn');
      if (generatePinBtn) generatePinBtn.addEventListener('click', handleGeneratePin);
      
      const changePasswordForm = document.getElementById('changePasswordForm');
      if(changePasswordForm) changePasswordForm.addEventListener('submit', handleChangePassword);

      document.getElementById('exportCoachSelector').addEventListener('change', populateExportStudentSelector);
      document.getElementById('exportStudentSelector').addEventListener('change', () => { document.getElementById('exportStatusMessage').textContent = ''; });
      document.getElementById('exportBankSelector').addEventListener('change', () => { document.getElementById('exportStatusMessage').textContent = ''; });
      document.getElementById('exportYearSelector').addEventListener('change', () => { document.getElementById('exportStatusMessage').textContent = ''; });
      document.getElementById('exportMonthSelector').addEventListener('change', () => { document.getElementById('exportStatusMessage').textContent = ''; });
      
      // Event listener untuk modal edit siswa
      document.getElementById('editStudentFormInAdmin').addEventListener('submit', handleEditStudent);
      document.querySelector('#editStudentModal .close-btn').onclick = () => document.getElementById('editStudentModal').style.display = 'none';
    }
    function updateUserPagination(totalItems) {
      const rowsPerPage = parseInt(document.getElementById('userRowsPerPage').value, 10);
      const totalPages = Math.ceil(totalItems / rowsPerPage) || 1;
      document.getElementById('userCurrentPage').textContent = userCurrentPage;
      document.getElementById('userTotalPages').textContent = totalPages;
      document.getElementById('userPrevBtn').disabled = userCurrentPage === 1;
      document.getElementById('userNextBtn').disabled = userCurrentPage >= totalPages;
    }

    window.regenerateCoachId = async function(userEmail) {
      if (!confirm(`Yakin ingin meregenerasi ID unik untuk coach: ${userEmail}?`)) {
        return;
      }
      try {
        const userRef = doc(db, "users", userEmail);
        const newCoachId = generateCoachId();
        await updateDoc(userRef, { coachId: newCoachId });
        alert(`ID unik baru '${newCoachId}' berhasil dibuat untuk ${userEmail}.`);
        await loadAllData();
      } catch (error) {
        console.error("Gagal meregenerasi coach ID:", error);
        alert(`Gagal meregenerasi ID. Error: ${error.message}`);
      }
    };

    async function handleAddUser(e) {
      e.preventDefault();
      const email = document.getElementById('newUserEmail').value;
      const name = document.getElementById('newUserName').value;
      const password = document.getElementById('newUserPassword').value;
      const role = document.getElementById('newUserRole').value;
      const statusMessageDiv = document.getElementById('statusMessage');
      statusMessageDiv.textContent = 'Memproses...';
      try {
        let newCoachId = null;
        if (role === 'user') {
          newCoachId = generateCoachId();
        }
        await createUserWithEmailAndPassword(secondaryAuth, email, password);
        const userData = { email, name, role, status: 'active', coachId: newCoachId };
        if (role === 'user') { userData.studentCount = 0; }
        await setDoc(doc(db, "users", email), userData);
        statusMessageDiv.textContent = `User ${name} (${email}) berhasil ditambahkan dengan ID unik: ${newCoachId || 'N/A'}!`;
        await loadAllData();
      } catch (error) { statusMessageDiv.textContent = `Error: ${error.message}`; }
    }
    window.toggleUserStatus = async function(email, currentStatus) {
      const newStatus = currentStatus === 'active' ? 'disabled' : 'active';
      const user = allUsers.find(u => u.id === email);
      if (user.role === 'admin') {
        alert('Tidak dapat mengubah status pengguna dengan peran direktur.');
        return;
      }
      if (confirm(`Yakin ingin ${newStatus === 'active' ? 'mengaktifkan' : 'menonaktifkan'} pengguna: ${email}?`)) {
        await updateDoc(doc(db, "users", email), { status: newStatus });
        await loadAllData();
      }
    };
    window.toggleBankStatus = async function(bankId, currentStatus) {
      const newStatus = currentStatus === 'active' ? 'disabled' : 'active';
      if (confirm(`Yakin ingin ${newStatus === 'active' ? 'mengaktifkan' : 'menonaktifkan'} bank ini?`)) {
        await updateDoc(doc(db, "banks", bankId), { status: newStatus });
        await loadAllData();
      }
    };
    async function handleAddLevel(e) { e.preventDefault(); const name = document.getElementById('newLevelName').value.trim(); if (!name) return; await setDoc(doc(db, "kurikulum", name), {lessons: {}}); alert('Level berhasil dibuat'); await loadAllData(); }
    async function handleAddBank(e) { e.preventDefault(); const name = document.getElementById('newBankName').value.trim(); const color = document.getElementById('newBankColor').value; if (!name) return; await addDoc(collection(db, "banks"), {bankName: name, color: color, status: 'active'}); alert('Bank berhasil ditambah'); await loadAllData(); }
    async function handleEditBank(e) { e.preventDefault(); const id = document.getElementById('editBankId').value; const name = document.getElementById('editBankName').value; const color = document.getElementById('editBankColor').value; await updateDoc(doc(db, "banks", id), {bankName: name, color: color}); alert('Bank berhasil diupdate'); document.getElementById('editBankModal').style.display = 'none'; await loadAllData(); }
    function addNewLessonInput() { const form = document.getElementById('editCurriculumForm'); const nextNum = form.children.length + 1; const newDiv = document.createElement('div'); newDiv.className = 'lesson-input-group'; newDiv.innerHTML = `<label>Lesson ${nextNum}:</label><input type="text" data-lesson-name="Lesson ${nextNum}">`; form.appendChild(newDiv); }
    async function handleSaveCurriculum() { const level = document.getElementById('levelEditorSelector').value; if (!level) return; const lessons = {}; document.querySelectorAll('#editCurriculumForm input').forEach(input => { lessons[input.dataset.lessonName] = input.value.split(',').map(s => s.trim()).filter(Boolean); }); await updateDoc(doc(db, "kurikulum", level), { lessons }); alert('Kurikulum berhasil disimpan'); }
    window.calculateGlobalSppAttachmentSize = function() {
      let totalSize = 0;
      const oneGigabyte = 1073741824;
      allStudents.forEach(student => {
        if (student.spp) {
          for (const key in student.spp) {
            if (student.spp[key].attachmentBase64) {
              const base64String = student.spp[key].attachmentBase64;
              totalSize += (base64String.length / 4) * 3; 
            }
          }
        }
      });
      const sppGlobalTotalSizeSpan = document.getElementById('sppGlobalTotalSize');
      if (sppGlobalTotalSizeSpan) sppGlobalTotalSizeSpan.textContent = formatFileSize(totalSize);
      const percentage = (totalSize / oneGigabyte) * 100;
      const sppGlobalSizePercentageSpan = document.getElementById('sppGlobalSizePercentage');
      if (sppGlobalSizePercentageSpan) sppGlobalSizePercentageSpan.textContent = percentage.toFixed(2) + '%';
    }
    window.calculateSppAttachmentSize = function() {
      const year = sppYearToDeleteSelect.value;
      const month = sppMonthToDeleteSelect.value;
      if (!year) {
        sppDeleteStatusMessageDiv.textContent = 'Harap pilih tahun untuk menghapus lampiran.';
        sppDeleteStatusMessageDiv.style.color = 'red';
        return;
      }
      let totalSize = 0;
      let fileCount = 0;
      const oneGigabyte = 1073741824;
      allStudents.forEach(student => {
        if (student.spp) {
          for (const key in student.spp) {
            const [paymentYear, paymentMonth] = key.split('-');
            if (paymentYear == year && (month === '' || paymentMonth == month)) {
              if (student.spp[key].attachmentBase64) {
                fileCount++;
                const base64String = student.spp[key].attachmentBase64;
                totalSize += (base64String.length / 4) * 3;
              }
            }
          }
        }
      });
      sppFileCountSpan.textContent = fileCount;
      sppTotalSizeSpan.textContent = formatFileSize(totalSize);
      const percentage = (totalSize / oneGigabyte) * 100;
      sppSizePercentageSpan.textContent = percentage.toFixed(2) + '%';
      sppTimestampSpan.textContent = new Date().toLocaleString('id-ID');
      sppSizeInfoDiv.style.display = 'block';
      sppDeleteStatusMessageDiv.textContent = '';
    }
    function formatFileSize(bytes, decimalPoint) {
      if (bytes == 0) return '0 Bytes';
      const k = 1024,
        dm = decimalPoint || 2,
        sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'],
        i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    }

    function populateSppMonthsForDeletion() {
      const monthSelector = document.getElementById('sppMonthToDelete');
      if (!monthSelector) return;
      monthSelector.innerHTML = '<option value="">-- Semua Bulan --</option>';
      monthNames.forEach((month, index) => {
        monthSelector.innerHTML += `<option value="${index}">${month}</option>`;
      });
    }
    
    window.openTab = function(tabName) {
      const tabContents = document.querySelectorAll('.tab-content');
      tabContents.forEach(tab => {
        tab.classList.remove('active');
      });
      const tabButtons = document.querySelectorAll('.tab-btn');
      tabButtons.forEach(btn => {
        btn.classList.remove('active');
      });
      const selectedTab = document.getElementById(tabName);
      const selectedTabButton = document.querySelector(`.tab-btn[onclick="openTab('${tabName}')"]`);
      if (selectedTab) selectedTab.classList.add('active');
      if (selectedTabButton) selectedTabButton.classList.add('active');
      sessionStorage.setItem('adminCurrentTab', tabName);
      if(tabName === 'pengguna-tab') {
        renderUserTable();
      } else if (tabName === 'kurikulum-tab') {
      } else if (tabName === 'bank-tab') {
        renderBankTable();
      } else if (tabName === 'maintenance-tab') {
        loadSppYearsForDeletion();
      } else if (tabName === 'spp-export-tab') {
        populateExportSelectors();
      }
    }
    
    function populateCoachDropdowns() {
      const resetEmailSelector = document.getElementById('resetEmailSelector');
      const changePasswordEmailSelector = document.getElementById('changePasswordEmailSelector');
      const activeUsers = allUsers.filter(u => (u.status || 'active') === 'active');
      
      let userOptions = '<option value="">-- Pilih Pengguna --</option>';
      let passwordChangeOptions = '<option value="">-- Pilih Pengguna --</option>';
      activeUsers.forEach(user => {
        let roleName = '';
        switch (user.role) {
          case 'admin':
            roleName = 'DIREKTUR';
            break;
          case 'bendahara':
            roleName = 'ADMIN';
            passwordChangeOptions += `<option value="${user.id}">${user.name} (ADMIN)</option>`;
            break;
          case 'user':
            roleName = `Coach (${user.coachId || 'N/A'})`;
            passwordChangeOptions += `<option value="${user.id}">${user.name} (${roleName})</option>`;
            break;
        }
        userOptions += `<option value="${user.id}">${user.name} (${roleName})</option>`;
      });
      if (resetEmailSelector) {
        const currentVal = resetEmailSelector.value;
        resetEmailSelector.innerHTML = userOptions;
        resetEmailSelector.value = currentVal;
      }
      if (changePasswordEmailSelector) {
        const currentVal = changePasswordEmailSelector.value;
        changePasswordEmailSelector.innerHTML = passwordChangeOptions;
        changePasswordEmailSelector.value = currentVal;
      }
    }
    
    function populateLevelDropdowns() {
      const levelEditorSelector = document.getElementById('levelEditorSelector');
      if (!levelEditorSelector) return;
      const currentVal = levelEditorSelector.value;
      let options = '<option value="">-- Pilih Level --</option>';
      allLevels.forEach(level => {
        options += `<option value="${level}">${level}</option>`;
      });
      levelEditorSelector.innerHTML = options;
      levelEditorSelector.value = currentVal;
    }

    async function handleResetPassword(e) {
      e.preventDefault();
      const email = document.getElementById('resetEmailSelector').value;
      const statusMessageDiv = document.getElementById('resetPasswordStatusMessage');
      if (!email) { statusMessageDiv.textContent = 'Pilih pengguna.'; return; }
      const user = allUsers.find(u => u.id === email);
      if (user && user.role === 'admin') {
        alert('Tidak dapat mereset kata sandi pengguna dengan peran direktur.');
        return;
      }
      try {
        await sendPasswordResetEmail(auth, email);
        statusMessageDiv.textContent = `Email reset password telah dikirim ke ${email}.`;
      } catch (error) { statusMessageDiv.textContent = `Error: ${error.message}`; }
    }
    
    async function handleChangePassword(e) {
        e.preventDefault();
        const email = document.getElementById('changePasswordEmailSelector').value;
        const newPassword = document.getElementById('newPasswordInput').value;
        const statusMessageDiv = document.getElementById('changePasswordStatusMessage');

        if (!email || !newPassword) {
            statusMessageDiv.textContent = 'Pilih pengguna dan masukkan password baru.';
            statusMessageDiv.style.color = 'red';
            return;
        }

        const userToChange = allUsers.find(u => u.id === email);
        if (!userToChange) {
            statusMessageDiv.textContent = 'Pengguna tidak ditemukan.';
            statusMessageDiv.style.color = 'red';
            return;
        }
        
        if (userToChange.role === 'admin') {
            statusMessageDiv.textContent = 'Tidak dapat mengganti password direktur melalui menu ini.';
            statusMessageDiv.style.color = 'orange';
            return;
        }

        statusMessageDiv.textContent = 'Mengganti password...';
        statusMessageDiv.style.color = 'blue';

        try {
            await sendPasswordResetEmail(auth, email);

            statusMessageDiv.textContent = `Email reset password telah dikirim ke ${email}. Beritahu pengguna untuk memeriksa emailnya dan mengikuti petunjuk.`;
            statusMessageDiv.style.color = 'green';
            document.getElementById('changePasswordForm').reset();
            
        } catch (error) {
            statusMessageDiv.textContent = `Error: ${error.message}`;
            statusMessageDiv.style.color = 'red';
            console.error("Error changing password:", error);
        }
    }

    async function handleEditUser(e) {
      e.preventDefault();
      const userId = document.getElementById('editUserId').value;
      const user = allUsers.find(u => u.id === userId);
      if (user && user.role === 'admin') {
        alert('Tidak dapat mengedit detail pengguna dengan peran direktur.');
        return;
      }
      const updatedData = {
        name: document.getElementById('editFullName').value,
        phone: document.getElementById('editPhoneNumber').value,
        level: document.getElementById('editUserLevel').value,
      };
      try {
        await updateDoc(doc(db, "users", userId), updatedData);
        alert('Detail pengguna diperbarui!');
        document.getElementById('editUserModal').style.display = 'none';
        await loadAllData();
      } catch(error) { alert('Gagal menyimpan.'); }
    }
    window.openEditModal = function(userId) {
      const user = allUsers.find(u => u.id === userId);
      if (!user) return;
      if (user.role === 'admin') {
        alert('Tidak dapat mengedit detail pengguna dengan peran direktur.');
        return;
      }
      document.getElementById('editUserEmail').textContent = user.id;
      document.getElementById('editUserId').value = user.id;
      document.getElementById('editFullName').value = user.name || '';
      const editPhoneNumberInput = document.getElementById('editPhoneNumber');
      if (editPhoneNumberInput) editPhoneNumberInput.value = user.phone || '';
      const editUserLevelGroup = document.getElementById('editUserLevelGroup');
      if (editUserLevelGroup) editUserLevelGroup.style.display = user.role === 'user' ? 'block' : 'none';
      const editUserLevelInput = document.getElementById('editUserLevel');
      if (editUserLevelInput) editUserLevelInput.value = user.level || '';
      document.getElementById('editUserModal').style.display = 'block';
    };

    window.openEditBankModal = function(bankId) {
      const bank = allBanks[bankId];
      if (!bank) return;
      document.getElementById('editBankId').value = bankId;
      document.getElementById('editBankName').value = bank.bankName;
      document.getElementById('editBankColor').value = bank.color;
      document.getElementById('editBankModal').style.display = 'block';
    };
    
    function populateExportSelectors() {
        const coachSelector = document.getElementById('exportCoachSelector');
        const studentSelector = document.getElementById('exportStudentSelector');
        const bankSelector = document.getElementById('exportBankSelector');
        const yearSelector = document.getElementById('exportYearSelector');

        const activeCoaches = allUsers.filter(u => (u.status || 'active') === 'active');
        coachSelector.innerHTML = '<option value="all">Semua Coach</option>';
        activeCoaches.forEach(coach => {
            if (coach.role === 'user') {
                coachSelector.innerHTML += `<option value="${coach.id}">${coach.name}</option>`;
            }
        });

        studentSelector.innerHTML = '<option value="all">Semua Siswa</option>';
        allStudents.forEach(student => {
            studentSelector.innerHTML += `<option value="${student.id}">${student.name}</option>`;
        });

        bankSelector.innerHTML = '<option value="all">Semua Bank</option>';
        allActiveBankNames.forEach(bankName => {
             bankSelector.innerHTML += `<option value="${bankName}">${bankName}</option>`;
        });
        
        const years = new Set();
        allStudents.forEach(student => {
            if (student.spp) {
                Object.keys(student.spp).forEach(key => {
                    const year = key.split('-')[0];
                    if (year) {
                        years.add(parseInt(year));
                    }
                });
            }
        });
        allYearsWithPayments = Array.from(years).sort((a, b) => b - a);
        yearSelector.innerHTML = '<option value="all">Semua Tahun</option>';
        allYearsWithPayments.forEach(year => {
            yearSelector.innerHTML += `<option value="${year}">${year}</option>`;
        });
    }

    function populateExportStudentSelector() {
        const coachFilter = document.getElementById('exportCoachSelector').value;
        const studentSelector = document.getElementById('exportStudentSelector');
        studentSelector.innerHTML = '<option value="all">Semua Siswa</option>';
        
        const filteredStudents = allStudents.filter(s => coachFilter === 'all' || s.coachEmail === coachFilter);
        filteredStudents.forEach(student => {
            studentSelector.innerHTML += `<option value="${student.id}">${student.name}</option>`;
        });
    }
    
    function normalizePhone(nomor) {
        nomor = nomor ? nomor.toString().trim().replace(/\D/g, "") : "";
        if (nomor.startsWith("0")) return "62" + nomor.substring(1);
        if (!nomor.startsWith("62") && nomor.length > 5) return "62" + nomor;
        return nomor;
    }

    function isMobile() {
        return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    }

    window.exportSppData = async function() {
        const coachFilter = document.getElementById('exportCoachSelector').value;
        const studentFilter = document.getElementById('exportStudentSelector').value;
        const bankFilter = document.getElementById('exportBankSelector').value;
        const yearFilter = document.getElementById('exportYearSelector').value;
        const monthFilter = document.getElementById('exportMonthSelector').value;
        const includePhone = document.getElementById('includePhone').checked;
        const statusDiv = document.getElementById('exportStatusMessage');

        statusDiv.textContent = 'Memproses data...';
        statusDiv.style.color = 'blue';

        let filteredStudents = allStudents.filter(student => {
            let matchesCoach = coachFilter === 'all' || student.coachEmail === coachFilter;
            let matchesStudent = studentFilter === 'all' || student.id === studentFilter;
            const studentStatus = student.status || 'active';
            return matchesCoach && matchesStudent && student.spp && studentStatus === 'active';
        });

        if (filteredStudents.length === 0) {
            statusDiv.textContent = 'Tidak ada data yang cocok dengan filter.';
            statusDiv.style.color = 'red';
            return;
        }

        const workbook = new ExcelJS.Workbook();
        const sheet = workbook.addWorksheet('Laporan SPP');

        const header = ["No", "Nama Siswa", "Coach", "Tanggal Bayar", "Tahun", "Bulan", "Nominal (Rp)", "Bank"];
        const columnKeys = ['no', 'studentName', 'coach', 'paymentDate', 'year', 'month', 'nominal', 'bank'];

        if (includePhone) {
            header.push("No. Telepon");
            columnKeys.push("phone");
        }
        
        const headerRow = sheet.addRow(header);
        
        headerRow.eachCell((cell) => {
            cell.font = { bold: true, color: { argb: "FFFFFFFF" } };
            cell.fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: { argb: 'FF4472C4' }
            };
            cell.alignment = { vertical: 'middle', horizontal: 'center' };
            cell.border = {
                top: {style:'thin'},
                left: {style:'thin'},
                bottom: {style:'thin'},
                right: {style:'thin'}
            };
        });

        let rowNum = 1;
        let foundPayments = false;
        
        const rows = [];

        filteredStudents.forEach(student => {
            const coachName = allUsers.find(u => u.id === student.coachEmail)?.name || 'N/A';
            const studentSpp = student.spp || {};
            const paymentKeys = Object.keys(studentSpp);
            const studentPhone = student.phone || '';

            paymentKeys.forEach(key => {
                const payment = studentSpp[key];
                const [paymentYear, paymentMonth] = key.split('-');

                const matchesYear = yearFilter === 'all' || paymentYear === yearFilter;
                const matchesMonth = monthFilter === 'all' || paymentMonth == monthFilter;
                const matchesBank = bankFilter === 'all' || payment.bank === bankFilter;

                if (matchesYear && matchesMonth && matchesBank) {
                    foundPayments = true;
                    const paymentDateValue = (payment.date && typeof payment.date.toDate === 'function') ? payment.date.toDate() : null;
                    const monthName = monthNames[parseInt(paymentMonth)];

                    const rowData = [
                        rowNum++,
                        student.name,
                        coachName,
                        paymentDateValue,
                        parseInt(paymentYear),
                        monthName,
                        payment.nominal, 
                        payment.bank
                    ];

                    if (includePhone) {
                        const normalizedPhone = normalizePhone(studentPhone);
                        if (normalizedPhone) {
                             const link = isMobile()
                               ? `https://api.whatsapp.com/send?phone=${normalizedPhone}`
                               : `https://web.whatsapp.com/send/?phone=${normalizedPhone}&text&type=phone_number&app_absent=1`;
                             rowData.push({ text: studentPhone, hyperlink: link });
                        } else {
                            rowData.push('');
                        }
                    }
                    rows.push(rowData);
                }
            });
        });

        if (!foundPayments) {
            statusDiv.textContent = 'Tidak ada pembayaran yang cocok dengan kombinasi filter yang dipilih.';
            statusDiv.style.color = 'orange';
            return;
        }
        
        rows.forEach(rowData => {
            const row = sheet.addRow(rowData);
            row.eachCell((cell, colNumber) => {
                cell.border = {
                    top: {style:'thin'},
                    left: {style:'thin'},
                    bottom: {style:'thin'},
                    right: {style:'thin'}
                };
                
                if (colNumber === 4 && cell.value) {
                    cell.numFmt = 'dd/mm/yyyy';
                }
                
                if (colNumber === 7 && cell.value) {
                    cell.numFmt = '#,##0';
                }

                const phoneColIndex = columnKeys.indexOf('phone');
                if (includePhone && colNumber === phoneColIndex + 1 && cell.value && cell.value.hyperlink) {
                    cell.font = { color: { argb: "FF1D8F14" }, underline: true };
                }
            });
        });

        sheet.columns = columnKeys.map(key => ({
            key: key,
            width: key === 'phone' ? 18 : 
                   key === 'studentName' || key === 'coach' ? 25 : 
                   key === 'paymentDate' ? 15 : 
                   key === 'nominal' ? 20 : 
                   key === 'bank' ? 15 : 10
        }));
        
        sheet.views = [{ state: 'frozen', ySplit: 1 }];

        const now = new Date();
        const dateString = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`;
        const timeString = `${now.getHours().toString().padStart(2, '0')}-${now.getMinutes().toString().padStart(2, '0')}-${now.getSeconds().toString().padStart(2, '0')}`;
        const fileName = `Laporan_SPP_${dateString}_${timeString}.xlsx`;

        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], {type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = fileName;
        link.click();
        
        statusDiv.textContent = `Data berhasil diexport ke ${fileName}!`;
        statusDiv.style.color = 'green';
    };

    // Fungsi untuk membuka modal edit siswa
    window.openStudentEditModal = function(studentId) {
        const student = allStudents.find(s => s.id === studentId);
        if (!student) return;
        
        document.getElementById('editStudentId').value = studentId;
        document.getElementById('editStudentName').value = student.name;
        
        // Mengisi dropdown level
        const levelSelector = document.getElementById('editStudentLevel');
        levelSelector.innerHTML = allLevels.map(l => `<option value="${l}">${l}</option>`).join('');
        levelSelector.value = student.studentLevel || "";
        
        // Mengisi dropdown coach
        const coachSelector = document.getElementById('editStudentCoach');
        const activeCoaches = allUsers.filter(u => u.role === 'user');
        coachSelector.innerHTML = activeCoaches.map(u => `<option value="${u.id}">${u.name}</option>`).join('');
        coachSelector.value = student.coachEmail;
        
        document.getElementById('editStudentPhone').value = student.phone || '';
        document.getElementById('editStudentModal').style.display = 'block';
    };

    // Fungsi untuk menangani pengiriman form edit siswa
    async function handleEditStudent(e) {
        e.preventDefault();
        const studentId = document.getElementById('editStudentId').value;
        const studentBefore = allStudents.find(s => s.id === studentId);
        const oldCoachEmail = studentBefore.coachEmail;
        const newCoachEmail = document.getElementById('editStudentCoach').value;
        
        const updatedData = {
            name: document.getElementById('editStudentName').value,
            studentLevel: document.getElementById('editStudentLevel').value,
            coachEmail: newCoachEmail,
            phone: document.getElementById('editStudentPhone').value
        };
        
        try {
            const batch = writeBatch(db);
            const studentDocRef = doc(db, "students", studentId);
            batch.update(studentDocRef, updatedData);
            
            // Perbarui jumlah siswa hanya jika coach berubah
            if (oldCoachEmail !== newCoachEmail) {
                if (oldCoachEmail) {
                    const oldCoachRef = doc(db, "users", oldCoachEmail);
                    batch.update(oldCoachRef, { studentCount: increment(-1) });
                }
                if (newCoachEmail) {
                    const newCoachRef = doc(db, "users", newCoachEmail);
                    batch.update(newCoachRef, { studentCount: increment(1) });
                }
                
                // Perbarui semua laporan siswa dengan coachEmail yang baru
                const reportsQuery = query(collection(db, "reports"), where("studentId", "==", studentId));
                const reportsSnapshot = await getDocs(reportsQuery);
                reportsSnapshot.forEach(reportDoc => {
                    const reportRef = doc(db, "reports", reportDoc.id);
                    batch.update(reportRef, { coachEmail: newCoachEmail });
                });
            }
            
            await batch.commit();
            alert('Detail siswa dan riwayat laporan berhasil diperbarui!');
            document.getElementById('editStudentModal').style.display = 'none';
            await loadAllData();
        } catch(error) {
            console.error("Gagal menyimpan dan memindahkan riwayat:", error);
            alert('Gagal menyimpan dan memindahkan riwayat. Periksa konsol untuk detail.');
        }
    }
  </script>
</body>
</html>
