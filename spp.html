<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pembayaran & Manajemen Siswa</title>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --light-bg: #f8f9fa;
            --dark-text: #212529;
            --light-text: #fff;
            --border-color: #ddd;
            --box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background-color: var(--light-bg);
            display: none;
            color: var(--dark-text);
        }
        .container {
            max-width: 1200px;
            margin: auto;
            background: var(--light-text);
            padding: 30px;
            border-radius: 10px;
            box-shadow: var(--box-shadow);
        }
        h1, h3, h4 {
            color: var(--primary-color);
            margin-bottom: 20px;
        }
        h1 {
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
        }
        .header-section {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: flex-start;
            gap: 10px;
        }
        .header-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
        }
        .logout-btn, .refresh-btn, .btn-export, .btn-whatsapp, .btn-reset, .action-btn-disable, .action-btn-enable, .action-btn-edit {
            padding: 8px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s ease;
            width: 100%;
            text-align: center;
        }
        .logout-btn {
            background-color: var(--danger-color);
            color: var(--light-text);
        }
        .logout-btn:hover {
            background-color: #c82333;
        }
        .action-btn-disable { background-color: var(--warning-color); color: var(--dark-text); }
        .action-btn-enable { background-color: var(--success-color); color: var(--light-text); }
        .action-btn-edit { background-color: var(--primary-color); color: var(--light-text); }
        .content-block {
            margin-top: 40px;
            padding: 25px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--light-bg);
        }
        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            align-items: end;
        }
        .form-grid .full-width {
            grid-column: 1;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        label {
            font-weight: 600;
            color: var(--dark-text);
        }
        input[type="text"], input[type="number"], input[type="email"], input[type="tel"], select, textarea, input[type="date"], input[type="file"], input[type="password"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 16px;
        }
        select:focus, input:focus, textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
            outline: none;
        }
        #studentSelector option {
            padding: 5px;
        }
        #paymentYear {
            width: auto;
        }
        .month-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .month-selector label {
            font-weight: normal;
            display: flex;
            align-items: center;
            cursor: pointer;
            gap: 5px;
            background-color: #e9ecef;
            padding: 8px 12px;
            border-radius: 5px;
            transition: background-color 0.2s ease;
        }
        .month-selector input[type="checkbox"] {
            appearance: none;
            width: 18px;
            height: 18px;
            border: 1px solid var(--secondary-color);
            border-radius: 3px;
            position: relative;
            cursor: pointer;
            margin: 0;
            flex-shrink: 0;
        }
        .month-selector input[type="checkbox"]:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        .month-selector input[type="checkbox"]:checked::after {
            content: 'âœ”';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
            color: var(--light-text);
        }
        .month-selector label:hover {
            background-color: #dee2e6;
        }
        .btn, #addPaymentBtn, #addOtherPaymentBtn, #addStudentForm button, .bulk-action-container button, .action-btn, .transfer-section .action-btn {
            padding: 12px 25px;
            background-color: var(--success-color);
            color: var(--light-text);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin-top: 20px;
            width: 100%;
        }
        .btn:hover, #addPaymentBtn:hover, #addOtherPaymentBtn:hover {
            background-color: #218838;
        }
        #addOtherPaymentBtn { background-color: var(--info-color); }
        #addOtherPaymentBtn:hover { background-color: #138496; }
        .bulk-action-container button {
            background-color: var(--primary-color);
        }
        .bank-color {
            display: inline-block;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-right: 5px;
            border: 1px solid #ccc;
        }
        .legend {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            font-size: 0.9em;
            flex-direction: column;
            gap: 10px;
        }
        .legend-item {
            display: flex;
            align-items: center;
        }
        #statusMessage, #otherStatusMessage, #studentStatusMessage, #importStatusMessage, #assignStatusMessage, #transferStatusMessage, #bulkActionStatusMessage, #pinVerificationMessage, #pinStatusMessage {
            margin-top: 15px;
            font-weight: 600;
        }
        .spp-table-controls, .filter-controls {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: stretch;
            gap: 15px;
            margin-bottom: 20px;
        }
        .spp-table-controls .filter-group, .filter-controls > div {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .spp-table-container, .student-table-container, #otherPaymentsTable-container {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow-x: auto;
        }
        .spp-table, .student-table, #otherPaymentsTable {
            width: 100%;
            border-collapse: collapse;
        }
        .spp-table th, .spp-table td, .student-table th, .student-table td, #otherPaymentsTable th, #otherPaymentsTable td {
            border: 1px solid var(--border-color);
            padding: 10px;
            text-align: center;
            vertical-align: middle;
            font-size: 14px;
            min-width: 90px;
        }
        .spp-table th, .student-table th, #otherPaymentsTable th {
            font-weight: 600;
            background-color: #e9ecef;
        }
        .spp-table thead th {
            position: sticky;
            z-index: 10;
        }
        .spp-table thead tr:first-child th {
            top: 0;
        }
        .spp-table thead tr:nth-child(2) th {
            top: 48px;
            background-color: #e9ecef;
        }
        .spp-table thead tr:first-child th:first-child,
        .spp-table tbody td:first-child {
            position: sticky;
            left: 0;
            background-color: var(--light-bg);
            z-index: 20;
            min-width: 10%;
            text-align: left;
            border-right: 2px solid #ccc;
        }
        .spp-table thead tr:first-child th:first-child {
            z-index: 30;
        }
        .spp-table td {
            position: relative;
        }
        .payment-info {
            background-color: #fff;
            padding: 8px;
            border-radius: 5px;
            min-height: 50px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
        }
        .payment-info .payment-level {
            font-size: 0.75em;
            color: var(--secondary-color);
            margin-top: 5px;
        }
        .payment-date {
            font-size: 0.75em;
            color: var(--secondary-color);
            margin-top: 5px;
        }
        .payment-amount {
            font-weight: 700;
        }
        .payment-bank-color {
            display: block;
            width: 100%;
            height: 4px;
            border-radius: 5px 5px 0 0;
        }
        .attachment-link {
            display: inline-block;
            margin-top: 5px;
            text-decoration: none;
            color: var(--primary-color);
            font-weight: 500;
            transition: color 0.2s ease;
        }
        .attachment-link:hover {
            color: #0056b3;
        }
        .btn-export {
            background-color: var(--primary-color);
            color: var(--light-text);
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.2s ease;
        }
        .btn-export:hover {
            background-color: #0056b3;
        }
        .btn-whatsapp {
            background-color: #25D366;
            color: var(--light-text);
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.2s ease;
        }
        .btn-whatsapp:hover {
            background-color: #128C7E;
        }
        .pagination-controls {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .pagination-controls button {
            padding: 8px 15px;
            background-color: var(--primary-color);
            color: var(--light-text);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .pagination-controls button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .no-data {
            color: #888;
            font-style: italic;
        }
        .student-status {
            font-size: 0.8em;
            color: var(--secondary-color);
            margin-top: 5px;
            display: block;
        }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.9); justify-content: center; align-items: center; }
        .modal-content { background-color: var(--light-bg); margin: auto; padding: 20px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); width: 90%; max-width: 600px; position: relative; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 15px; }
        .modal-header h3 { margin: 0; color: var(--dark-text); }
        .modal-body { display: flex; flex-direction: column; gap: 5px; }
        .modal-body p { margin: 5px 0; }
        .modal-body strong { color: var(--primary-color); }
        .close-btn { color: var(--dark-text); font-size: 30px; font-weight: bold; cursor: pointer; transition: color 0.2s; }
        .close-btn:hover { color: var(--secondary-color); }
        .attachment-preview { max-width: 100%; height: auto; display: block; margin-top: 15px; border-radius: 8px; border: 1px solid var(--border-color); }
        .attachment-iframe { width: 100%; height: 500px; border: 1px solid var(--border-color); border-radius: 8px; }
        .back-button { background-color: var(--secondary-color); color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin-top: 15px; }
        .payment-keterangan-modal { font-size: 1em; color: var(--dark-text); white-space: pre-wrap; text-align: left; padding-top: 10px; }
        .btn-reset {
            background-color: var(--secondary-color);
            color: var(--light-text);
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s ease;
        }
        .btn-reset:hover {
            background-color: #5a6268;
        }
        #addOtherPaymentBtn {
            background-color: var(--info-color);
        }
        #addOtherPaymentBtn:hover {
            background-color: #138496;
        }
        .spp-table .checkbox-cell, .student-table .checkbox-cell, #otherPaymentsTable .checkbox-cell {
            width: 30px; 
            min-width: 10%;
            padding: 5px;
        }
        #readStatusIndicator {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background-color: #212529;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-family: monospace;
            z-index: 2000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            opacity: 0.8;
            transition: opacity 0.3s;
        }
        #readStatusIndicator:hover {
            opacity: 1;
        }
        #readStatusIndicator button {
            margin-left: 10px;
            padding: 2px 8px;
            font-size: 12px;
            cursor: pointer;
        }
        .tabs {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 20px;
            align-items: flex-end;
            gap: 1px;
        }
        .tab-btn {
            background-color: #f0f0f0;
            border: 1px solid var(--border-color);
            border-bottom: none;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            color: var(--secondary-color);
            transition: background-color 0.2s ease;
            border-radius: 5px 5px 0 0;
        }
        .tab-btn:hover {
            background-color: #e9e9e9;
        }
        .tab-btn.active {
            background-color: var(--light-bg);
            color: var(--primary-color);
            border: 1px solid var(--border-color);
            border-bottom: none;
            position: relative;
            z-index: 1;
            box-shadow: none;
        }
        .tab-content {
            display: none;
            padding-top: 20px;
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 10px 10px;
            box-shadow: var(--box-shadow);
        }
        .tab-content.active {
            display: block;
        }
        .disabled-row td { 
            text-decoration: line-through; 
            color: #999; 
            background-color: #f8f9fa !important; 
        }
        .filter-controls { 
            margin: 15px 0 5px 0; 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
            align-items: stretch; 
            flex-wrap: wrap; 
        }
        .form-row { 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
        }
        .form-row > div { 
            flex: 1; 
        }
        .bulk-action-content {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        /* New Styles for Pagination */
        .spp-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            flex-direction: column;
            gap: 10px;
        }

        .pagination-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .pagination-container select, .pagination-container button {
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .pagination-container button {
            background-color: var(--primary-color);
            color: var(--light-text);
        }
        
        .pagination-container button:hover:not(:disabled) {
            background-color: #0056b3;
        }
        
        .pagination-container button:disabled {
            background-color: #e9ecef;
            color: #999;
            cursor: not-allowed;
        }

        @media (min-width: 768px) {
            .header-section {
                flex-direction: row;
                align-items: center;
            }
            .header-buttons {
                flex-direction: row;
                width: auto;
            }
            .logout-btn, .refresh-btn, .btn-export, .btn-whatsapp, .btn-reset, .action-btn-disable, .action-btn-enable, .action-btn-edit {
                width: auto;
            }
            .form-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
            .form-grid .full-width {
                grid-column: 1 / -1;
            }
            .btn, #addPaymentBtn, #addOtherPaymentBtn, #addStudentForm button, .bulk-action-container button, .action-btn, .transfer-section .action-btn {
                width: auto;
            }
            .legend {
                flex-direction: row;
                gap: 15px;
            }
            .spp-table-controls, .filter-controls {
                flex-direction: row;
                align-items: center;
            }
            .spp-table-controls .filter-group, .filter-controls > div {
                flex-direction: row;
            }
            .spp-table .checkbox-cell, .student-table .checkbox-cell, #otherPaymentsTable .checkbox-cell {
                width: 30px; 
                min-width: 10%;
            }
            .form-row { 
                flex-direction: row; 
                align-items: flex-end; 
                justify-content: flex-start; 
                gap: 10px; 
            }
            .form-row > div { 
                flex: 1; 
                min-width: 150px; 
            }
            .form-row button { 
                width: auto; 
                align-self: flex-end; 
            }
            .bulk-action-content {
                display: flex;
                flex-direction: row;
                align-items: flex-end;
                gap: 10px;
                flex-wrap: wrap;
            }
            .bulk-action-content .form-group {
                display: flex;
                flex-direction: row;
                align-items: center;
                gap: 10px;
                margin-bottom: 0;
            }
            .bulk-action-content select {
                width: 250px;
            }
            .bulk-action-content button {
                width: auto;
                margin-top: 0;
            }
            .transfer-section > .form-row { 
                flex-direction: row;
                align-items: flex-end;
                gap: 15px;
                justify-content: flex-start;
            }
            .transfer-section .form-row > div {
                display: flex;
                flex-direction: column;
                align-items: flex-start;
            }
            .transfer-section button { width: auto; margin-top: 0; }
            .spp-footer {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }
        /* Perbaikan untuk tampilan tab di mobile */
        @media (max-width: 767px) {
            .tabs {
                flex-wrap: nowrap; /* Mencegah tab melompat ke baris baru */
                overflow-x: auto; /* Mengaktifkan scroll horizontal */
                -webkit-overflow-scrolling: touch; /* Mengaktifkan scroll sentuh yang halus pada iOS */
                scrollbar-width: none; /* Menyembunyikan scrollbar Firefox */
                -ms-overflow-style: none; /* Menyembunyikan scrollbar IE dan Edge */
                border-bottom: 2px solid var(--border-color); /* Pastikan border tetap ada */
            }
            /* Menyembunyikan scrollbar di WebKit browsers (Chrome, Safari) */
            .tabs::-webkit-scrollbar {
                display: none;
            }
            .tab-btn {
                flex-shrink: 0; /* Mencegah tab mengecil */
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
</head>
<body>
    <div id="readStatusIndicator">Reads Sesi Ini: 0</div>
    <div class="container">
        <div class="header-section">
            <h1>Panel Bendahara</h1>
            <h4 id="userGreeting">Halo, Bendahara!</h4>
            <div class="header-buttons">
                <button class="btn-export" onclick="openWhatsappSettings()">Pengaturan WhatsApp Templates</button>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>
        <div class="tabs">
            <button class="tab-btn active" onclick="openTab('spp-tab')">Pembayaran SPP</button>
            <button class="tab-btn" onclick="openTab('nonspp-tab')">Laporan Non-SPP</button>
            <button class="tab-btn" onclick="openTab('manajemen-siswa-tab')">Manajemen Siswa</button>
        </div>

        <div id="spp-tab" class="tab-content active">
            <div class="content-block">
                <h3>Input Pembayaran Baru</h3>
                <form id="sppPaymentForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="studentSearchBox">Nama & Status Siswa</label>
                            <input type="text" id="studentSearchBox" placeholder="Cari siswa..." required>
                            <input type="hidden" id="studentSelector" name="studentId">
                        </div>
                        <div class="form-group"><label for="nominal">Nominal (Rp)</label><input type="text" id="nominal" required></div>
                        <div class="form-group">
                            <label for="bankSelector">Bank</label>
                            <select id="bankSelector" required></select>
                        </div>
                        <div class="form-group">
                            <label for="paymentDate">Tanggal Bayar</label>
                            <input type="date" id="paymentDate" required>
                        </div>
                        <div class="form-group">
                            <label for="paymentYear">Tahun Pembayaran</label>
                            <input type="number" id="paymentYear" required min="2000" value="2025">
                        </div>
                        <div class="form-group full-width">
                            <label>Bulan yang Dibayar</label>
                            <div class="month-selector" id="monthSelector"></div>
                        </div>
                        <div class="form-group full-width"><label for="keterangan">Keterangan</label><textarea id="keterangan" rows="2"></textarea></div>
                        <div class="form-group full-width"><label for="attachment">Upload Bukti Bayar</label><input type="file" id="attachment" accept="image/*,.pdf"></div>
                        <div class="form-group full-width">
                            <label for="imageQualitySelector">Kualitas Bukti Bayar (Kompresi)</label>
                            <select id="imageQualitySelector">
                                <option value="0.3">Kualitas Tinggi (30%)</option>
                                <option value="0.2" selected>Kualitas Sedang (20%)</option>
                                <option value="0.1">Kualitas Rendah (10%)</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" id="addPaymentBtn">Simpan Pembayaran</button>
                    <div id="statusMessage"></div>
                </form>
            </div>
            <div class="content-block">
                <h3>Riwayat Pembayaran</h3>
                <div class="spp-table-controls">
                    <div class="filter-group">
                        <label for="studentFilterSearchBox">Nama Siswa:</label>
                        <input type="text" id="studentFilterSearchBox" placeholder="Cari siswa...">
                        <input type="hidden" id="studentFilter" value="all">
                    </div>
                    <div class="filter-group">
                        <label for="yearFilter">Tahun:</label>
                        <select id="yearFilter"></select>
                    </div>
                    <div class="filter-group">
                        <label for="monthFilter">Bulan:</label>
                        <select id="monthFilter">
                            <option value="all">Semua Bulan</option>
                            <option value="0">Januari</option>
                            <option value="1">Februari</option>
                            <option value="2">Maret</option>
                            <option value="3">April</option>
                            <option value="4">Mei</option>
                            <option value="5">Juni</option>
                            <option value="6">Juli</option>
                            <option value="7">Agustus</option>
                            <option value="8">September</option>
                            <option value="9">Oktober</option>
                            <option value="10">November</option>
                            <option value="11">Desember</option>
                        </select>
                    </div>
                    <div class="legend" id="bankLegend"></div>
                    <button class="btn-whatsapp" onclick="generateAndSendPaymentProof()">Kirim Bukti Bayar via WhatsApp</button>
                </div>
                <div class="spp-table-container">
                    <table class="spp-table" id="sppTable">
                        <thead>
                            <tr id="tableHeader"></tr>
                            <tr id="tableSubHeader"></tr>
                        </thead>
                        <tbody id="sppTableBody"></tbody>
                    </table>
                </div>
                <div class="spp-footer">
                    <div class="pagination-container">
                        <span>Tampilkan:</span>
                        <select id="rowsPerPage"><option value="5" selected>5</option><option value="10">10</option><option value="15">15</option><option value="20">20</option></select>
                    </div>
                    <div class="pagination-container">
                        <button id="prevBtn" disabled>&laquo; Sebelumnya</button>
                        <span>Halaman <b id="currentPageDisplay">1</b> dari <b id="totalPagesDisplay">1</b></span>
                        <button id="nextBtn" disabled>Berikutnya &raquo;</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="nonspp-tab" class="tab-content">
            <div class="content-block">
                <h3>Ringkasan Transaksi Non-SPP</h3>
                <div class="filter-controls" style="margin-bottom: 20px;">
                    <div class="form-group">
                        <label for="summaryYearFilter">Tahun:</label>
                        <select id="summaryYearFilter"></select>
                    </div>
                    <div class="form-group">
                        <label for="summaryMonthFilter">Bulan:</label>
                        <select id="summaryMonthFilter">
                            <option value="all">Semua Bulan</option>
                            <option value="0">Januari</option>
                            <option value="1">Februari</option>
                            <option value="2">Maret</option>
                            <option value="3">April</option>
                            <option value="4">Mei</option>
                            <option value="5">Juni</option>
                            <option value="6">Juli</option>
                            <option value="7">Agustus</option>
                            <option value="8">September</option>
                            <option value="9">Oktober</option>
                            <option value="10">November</option>
                            <option value="11">Desember</option>
                        </select>
                    </div>
                </div>
                <div class="summary-dashboard" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    <div id="nonSppSummaryContainer" style="grid-column: 1 / -1; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    </div>
                </div>
            </div>

            <div class="content-block">
                <h3>Input Laporan Non-SPP</h3>
                <form id="otherPaymentForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="otherStudentSearchBox">Nama Siswa</label>
                            <input type="text" id="otherStudentSearchBox" placeholder="Cari siswa..." required>
                            <input type="hidden" id="otherStudentSelector" name="studentId">
                        </div>
                        <div class="form-group"><label for="otherNominal">Nominal (Rp)</label><input type="text" id="otherNominal" required></div>
                        <div class="form-group">
                            <label for="otherBankSelector">Bank</label>
                            <select id="otherBankSelector" required>
                                <option value="">Pilih Bank</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="otherPaymentDate">Tanggal Bayar</label>
                            <input type="date" id="otherPaymentDate" required>
                        </div>
                        <div class="form-group full-width"><label for="otherKeterangan">Keterangan</label><textarea id="otherKeterangan" rows="2" required></textarea></div>
                        <div class="form-group full-width"><label for="otherAttachment">Upload Bukti Bayar</label><input type="file" id="otherAttachment" accept="image/*,.pdf" required></div>
                    </div>
                    <button type="submit" id="addOtherPaymentBtn">Simpan Laporan</button>
                    <div id="otherStatusMessage"></div>
                </form>
            </div>
            
            <div class="content-block">
                <h3>Riwayat Laporan Non-SPP</h3>
                <div class="spp-table-controls">
                    <div class="filter-group">
                        <label for="otherStudentFilterSearchBox">Siswa:</label>
                        <input type="text" id="otherStudentFilterSearchBox" placeholder="Cari siswa...">
                        <input type="hidden" id="otherStudentFilter" value="all">
                    </div>
                    <div class="filter-group">
                        <label for="otherYearFilter">Tahun:</label>
                        <select id="otherYearFilter"></select>
                    </div>
                    <div class="filter-group">
                        <label for="otherBankFilter">Bank:</label>
                        <select id="otherBankFilter">
                            <option value="all">Semua Bank</option>
                        </select>
                    </div>
                </div>
                <div class="spp-table-container">
                    <table class="spp-table" id="otherPaymentsTable">
                        <thead><tr><th class="checkbox-cell"><input type="checkbox" id="selectAllCheckbox" title="Pilih Semua"></th><th>Tanggal</th><th>Nama Siswa</th><th>Keterangan</th><th>Bukti Bayar</th><th>Bank</th><th>Nominal</th><th>Aksi</th></tr></thead>
                        <tbody id="otherPaymentsTableBody"></tbody>
                    </table>
                </div>
                <div class="spp-footer">
                    <div class="pagination-container">
                        <span>Tampilkan:</span>
                        <select id="otherRowsPerPage"><option value="5" selected>5</option><option value="10">10</option><option value="15">15</option><option value="20">20</option></select>
                    </div>
                    <div class="pagination-container">
                        <button id="otherPrevBtn" disabled>&laquo; Sebelumnya</button>
                        <span>Halaman <b id="otherCurrentPageDisplay">1</b> dari <b id="otherTotalPagesDisplay">1</b></span>
                        <button id="otherNextBtn" disabled>Berikutnya &raquo;</button>
                    </div>
                </div>
                <button class="btn-whatsapp" onclick="generateAndSendSelectedOtherPaymentProof()" style="margin-top: 20px;">Kirim Laporan Terpilih via WhatsApp</button>
            </div>
        </div>

        <div id="manajemen-siswa-tab" class="tab-content">
            <div class="content-block">
                <h3>Ringkasan Data</h3>
                <div class="summary-dashboard" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    <div style="padding: 15px; border: 1px solid var(--border-color); border-radius: 8px; background-color: #fff;">
                        <h4>Ringkasan Total</h4>
                        <p>Total Siswa Aktif: <b id="summaryTotalStudents">0</b></p>
                        <p>Total Coach Aktif: <b id="summaryTotalCoaches">0</b></p>
                    </div>
                    <div style="padding: 15px; border: 1px solid var(--border-color); border-radius: 8px; background-color: #fff;">
                        <h4>Siswa Aktif per Level</h4>
                        <ul id="summaryActiveStudentsByLevel" style="list-style-type: none; padding: 0; margin: 0;"></ul>
                    </div>
                </div>
            </div>
            
            <div class="content-block">
                <h3>Tambah & Impor Siswa</h3>
                <form id="addStudentForm">
                    <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
                        <div class="form-group">
                            <label for="newStudentName">Nama Lengkap Siswa</label>
                            <input type="text" id="newStudentName" placeholder="Nama Lengkap" required>
                        </div>
                        <div class="form-group">
                            <label for="newStudentPhone">No. Telepon</label>
                            <input type="tel" id="newStudentPhone" placeholder="cth: 0812...">
                        </div>
                        <div class="form-group">
                            <label for="coachForStudentSelector">Tetapkan Coach</label>
                            <select id="coachForStudentSelector" required></select>
                        </div>
                        <div class="form-group">
                            <button type="submit" id="addStudentBtn" class="action-btn" style="background-color: var(--success-color);">Tambah Siswa</button>
                        </div>
                    </div>
                </form>
                <div id="studentStatusMessage" class="status-message"></div>

                <div style="margin-top: 30px;">
                    <p style="margin-bottom: 10px;">Atau, impor siswa dari file Excel (.xlsx).</p>
                    <div class="form-row" style="align-items: center; gap: 15px;">
                        <button type="button" id="downloadExcelTemplateBtn" class="action-btn" style="background-color: var(--info-color); width: 200px; margin-top: 0;">Unduh Template Excel</button>
                        <form id="importStudentForm" style="display: contents;">
                            <div class="form-group" style="flex: 1;">
                                <input type="file" id="excelFileInput" accept=".xlsx" required>
                            </div>
                            <div class="form-group" style="width: auto;">
                                <button type="submit" class="action-btn" style="background-color: var(--primary-color); width: 150px; margin-top: 0;">Muat File</button>
                            </div>
                        </form>
                    </div>
                    <div id="importStatusMessage" class="status-message"></div>
                </div>
            </div>

            <div class="content-block">
                <h3>Siswa Baru Menunggu Penugasan</h3>
                <p>Siswa di bawah ini menunggu penetapan coach dan level sebelum disimpan ke database utama.</p>
                <div class="student-table-container">
                    <table class="student-table" id="pendingAssignmentTable">
                        <thead>
                            <tr>
                                <th style="width: 5%;"><input type="checkbox" id="selectAllPendingCheckbox"></th>
                                <th>Nama Siswa</th>
                                <th>No. Telepon</th>
                            </tr>
                        </thead>
                        <tbody id="pendingAssignmentTableBody"></tbody>
                    </table>
                </div>
                <div class="bulk-action-content" style="margin-top: 20px;">
                    <div class="form-group">
                        <label for="assignCoachSelector">Tetapkan Coach:</label>
                        <select id="assignCoachSelector"></select>
                    </div>
                    <div class="form-group">
                        <label for="assignLevelSelector">Tetapkan Level:</label>
                        <select id="assignLevelSelector"></select>
                    </div>
                    <button type="button" id="assignAndSaveBtn" class="action-btn" style="background-color: var(--success-color);">Terapkan & Simpan</button>
                    <button type="button" id="cancelImportBtn" class="action-btn" style="background-color: var(--danger-color);">Batalkan Impor</button>
                </div>
                <div id="assignStatusMessage" class="status-message"></div>
            </div>
            
            <div class="content-block">
                <h3>Daftar Siswa (Manajemen Aktif)</h3>
                <div class="filter-controls">
                    <div class="form-group">
                        <label for="studentListSearchBox">Cari Siswa:</label>
                        <input type="text" id="studentListSearchBox" placeholder="Ketik nama siswa...">
                        <input type="hidden" id="studentListFilter" value="all">
                    </div>
                    <div class="form-group">
                        <label for="levelFilterSelector">Level:</label>
                        <select id="levelFilterSelector"><option value="all">Semua Level</option></select>
                    </div>
                    <div class="form-group">
                        <label for="coachFilterSelector">Coach:</label>
                        <select id="coachFilterSelector"></select>
                    </div>
                    <div class="form-group" style="flex-direction: row; align-items: center;">
                        <input type="checkbox" id="showDisabledStudents" style="margin-right: 5px;">
                        <label for="showDisabledStudents">Tampilkan Siswa Nonaktif</label>
                    </div>
                </div>
                <div class="student-table-container">
                    <table class="student-table" id="studentsTable"><thead><tr><th style="width: 5%;"><input type="checkbox" id="selectAllBulkCheckbox"></th><th>Nama Siswa</th><th>Coach Saat Ini</th><th>Level Siswa</th><th style="width: 15%;">Aksi</th></tr></thead><tbody id="studentsTableBody"></tbody></table>
                </div>
                <div class="spp-footer">
                    <div class="pagination-container">
                        <span>Tampilkan:</span>
                        <select id="studentRowsPerPage"><option value="5" selected>5</option><option value="10">10</option><option value="15">15</option><option value="20">20</option></select>
                    </div>
                    <div class="pagination-container">
                        <button type="button" id="studentPrevBtn" disabled>&laquo; Sebelumnya</button>
                        <span>Halaman <b id="studentCurrentPage">1</b> dari <b id="studentTotalPages">1</b></span>
                        <button type="button" id="studentNextBtn" disabled>Berikutnya &raquo;</button>
                    </div>
                </div>
            </div>

            <div class="content-block">
                <h3>Pilihan Aksi Massal</h3>
                <div class="bulk-action-content">
                    <div class="form-group">
                        <label for="bulkCoachSelector">Ganti coach ke:</label>
                        <select id="bulkCoachSelector"></select>
                        <button type="button" id="bulkChangeCoachBtn" class="action-btn" style="background-color: #007bff; margin-top: 10px; padding: 8px 12px; font-size: 14px;">Terapkan</button>
                    </div>
                    <div class="form-group">
                        <label for="bulkLevelSelector">Ganti level ke:</label>
                        <select id="bulkLevelSelector"></select>
                        <button type="button" id="bulkChangeLevelBtn" class="action-btn" style="background-color: #007bff; margin-top: 10px; padding: 8px 12px; font-size: 14px;">Terapkan</button>
                    </div>
                </div>
                <div id="bulkActionStatusMessage" class="status-message"></div>
            </div>
            
            <div class="content-block">
                <h3>Pindah Grup Coach</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="sourceCoachSelector">Dari Coach:</label>
                        <select id="sourceCoachSelector"></select>
                    </div>
                    <div class="form-group">
                        <label for="destinationCoachSelector">Ke Coach:</label>
                        <select id="destinationCoachSelector"></select>
                    </div>
                    <div class="form-group">
                        <button type="button" id="transferStudentsBtn" class="action-btn" style="background-color: #17a2b8;">Pindahkan Siswa</button>
                    </div>
                </div>
                <div id="transferStatusMessage" class="status-message"></div>
            </div>
        </div>
    </div>
    
    <div id="singleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Detail Pembayaran</h3>
                <span class="close-btn" onclick="singleModal.style.display='none'">&times;</span>
            </div>
            <div class="modal-body" id="modalBodyContent"></div>
        </div>
    </div>
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="settingsModalTitle">Pengaturan Template WhatsApp</h3>
                <span class="close-btn" onclick="settingsModal.style.display='none'">&times;</span>
            </div>
            <div class="modal-body">
                <p>Edit teks template di bawah ini. Gunakan placeholder <code>{nama_siswa}</code>, <code>{tahun_bayar}</code>, <code>{rincian_pembayaran}</code>, <code>{total_nominal_formatted}</code>, dan <code>{nama_file}</code> untuk data dinamis.</p>
                <textarea id="whatsappTemplateTextarea" rows="10" style="width:100%;"></textarea>
                <div style="display: flex; justify-content: space-between; margin-top: 10px; align-items: center; flex-direction: column; gap: 10px;">
                    <button class="btn-export" onclick="saveWhatsappTemplate()">Simpan Template</button>
                    <button class="btn-reset" onclick="resetWhatsappTemplate()">Reset ke Awal</button>
                </div>
                <div id="settingsStatusMessage" style="margin-top:10px;"></div>
            </div>
        </div>
    </div>
    <div id="editStudentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Detail Siswa</h2>
                <span class="close-btn" onclick="document.getElementById('editStudentModal').style.display='none';">&times;</span>
            </div>
            <form id="editStudentForm">
                <div class="modal-body">
                    <input type="hidden" id="editStudentId">
                    <div class="form-group">
                        <label for="editStudentName">Nama Siswa</label>
                        <input type="text" id="editStudentName" required>
                    </div>
                    <div class="form-group">
                        <label for="editStudentLevel">Level Siswa</label>
                        <select id="editStudentLevel"></select>
                    </div>
                    <div class="form-group">
                        <label for="editStudentCoach">Pindahkan ke Coach</label>
                        <select id="editStudentCoach" required></select>
                    </div>
                    <div class="form-group">
                        <label for="editStudentPhone">No. Telepon</label>
                        <input type="tel" id="editStudentPhone" placeholder="Contoh: 08123456789">
                    </div>
                </div>
                <div class="modal-footer" style="padding-top: 20px;">
                    <button type="submit" class="action-btn" style="background-color: var(--success-color);">Simpan Perubahan</button>
                </div>
            </form>
        </div>
    </div>

    <div id="pinModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Verifikasi PIN</h3>
                <span class="close-btn" onclick="document.getElementById('pinModal').style.display='none'">&times;</span>
            </div>
            <div class="modal-body">
                <p>Masukkan PIN untuk mengedit data ini.</p>
                <div class="form-group">
                    <label for="pinInput">PIN</label>
                    <input type="password" id="pinInput" placeholder="PIN" required>
                </div>
                <div class="form-group">
                    <button type="button" id="verifyPinBtn" class="action-btn" style="background-color: var(--success-color);">Verifikasi</button>
                </div>
                <div id="pinVerificationMessage" class="status-message" style="margin-top:10px;"></div>
            </div>
        </div>
    </div>

    <div id="editSppModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Pembayaran SPP</h3>
                <span class="close-btn" onclick="document.getElementById('editSppModal').style.display='none'">&times;</span>
            </div>
            <form id="editSppForm">
                <input type="hidden" id="editSppStudentId">
                <input type="hidden" id="editSppYearMonthKey">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="editSppNominal">Nominal (Rp)</label>
                        <input type="text" id="editSppNominal" required>
                    </div>
                    <div class="form-group">
                        <label for="editSppBank">Bank</label>
                        <select id="editSppBank" required></select>
                    </div>
                    <div class="form-group">
                        <label for="editSppPaymentDate">Tanggal Bayar</label>
                        <input type="date" id="editSppPaymentDate" required>
                    </div>
                    <div class="form-group">
                        <label for="editSppKeterangan">Keterangan</label>
                        <textarea id="editSppKeterangan" rows="2"></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label for="editSppAttachment">Ganti Bukti Bayar</label>
                        <input type="file" id="editSppAttachment" accept="image/*,.pdf">
                        <p style="font-size: 0.8em; color: gray; margin-top: 5px;">Abaikan jika tidak ingin mengganti.</p>
                    </div>
                </div>
                <div class="modal-footer" style="padding-top: 20px;">
                    <button type="submit" class="action-btn" style="background-color: var(--success-color);">Simpan Perubahan</button>
                    <button type="button" class="action-btn" style="background-color: var(--danger-color); margin-top: 10px;" onclick="deleteSppPayment()">Hapus Pembayaran</button>
                </div>
            </form>
        </div>
    </div>

    <div id="editNonSppModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Laporan Non-SPP</h3>
                <span class="close-btn" onclick="document.getElementById('editNonSppModal').style.display='none'">&times;</span>
            </div>
            <form id="editNonSppForm">
                <input type="hidden" id="editNonSppId">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="editNonSppStudentName">Nama Siswa</label>
                        <input type="text" id="editNonSppStudentName" required disabled>
                    </div>
                    <div class="form-group">
                        <label for="editNonSppNominal">Nominal (Rp)</label>
                        <input type="text" id="editNonSppNominal" required>
                    </div>
                    <div class="form-group">
                        <label for="editNonSppBank">Bank</label>
                        <select id="editNonSppBank" required></select>
                    </div>
                    <div class="form-group">
                        <label for="editNonSppPaymentDate">Tanggal Bayar</label>
                        <input type="date" id="editNonSppPaymentDate" required>
                    </div>
                    <div class="form-group">
                        <label for="editNonSppKeterangan">Keterangan</label>
                        <textarea id="editNonSppKeterangan" rows="2"></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label for="editNonSppAttachment">Ganti Bukti Bayar</label>
                        <input type="file" id="editNonSppAttachment" accept="image/*,.pdf">
                        <p style="font-size: 0.8em; color: gray; margin-top: 5px;">Abaikan jika tidak ingin mengganti.</p>
                    </div>
                </div>
                <div class="modal-footer" style="padding-top: 20px;">
                    <button type="submit" class="action-btn" style="background-color: var(--success-color);">Simpan Perubahan</button>
                    <button type="button" class="action-btn" style="background-color: var(--danger-color); margin-top: 10px;" onclick="deleteNonSppPayment()">Hapus Laporan</button>
                </div>
            </form>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, setDoc, getDoc, addDoc, updateDoc, query, where, writeBatch, increment, Timestamp, deleteField, deleteDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
        import * as XLSX from 'https://cdn.sheetjs.com/xlsx-0.20.1/package/xlsx.mjs';

        const firebaseConfig = {
            apiKey: "AIzaSyBm3SkLLtl9LvczDDht-OQ6-R4OYLPYAJQ",
            authDomain: "progres-report-5d199.firebaseapp.com",
            projectId: "progres-report-5d199",
            storageBucket: "progres-report-5d199.firebasestorage.app",
            messagingSenderId: "363573365137",
            appId: "1:363573365137:web:98f32d5ff8fae05617b230",
            measurementId: "G-CPX04R69F5"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let sessionReadCount = 0;
        const readStatusElement = document.getElementById('readStatusIndicator');
        function updateReadStatus() {
            if(readStatusElement) readStatusElement.innerHTML = `Reads Sesi Ini: ${sessionReadCount} <button onclick="window.resetReadCount()">Reset</button>`;
        }
        window.resetReadCount = function() {
            sessionReadCount = 0;
            updateReadStatus();
        }
        let allStudents = [];
        let allUsers = []; 
        let allLevels = []; 
        let allYearsWithPayments = [];
        let currentPage = 1;
        let studentCurrentPage = 1; 
        let otherCurrentPage = 1; 
        let rowsPerPage = 5;
        let studentRowsPerPage = 5; 
        let otherRowsPerPage = 10; 
        let bankColors = {};
        let currentBendaharaName = '';
        let brandSettings = {};
        let whatsappTemplateText = '';
        const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        let allOtherPayments = [];
        let pendingImportStudents = []; 
        let appEditPin = '';

        window.logout = function() { signOut(auth).then(() => { window.location.href = 'login.html'; }); };
        const singleModal = document.getElementById('singleModal');
        const modalBodyContent = document.getElementById('modalBodyContent');
        const modalTitle = document.getElementById('modalTitle');
        const settingsModal = document.getElementById('settingsModal');
        const whatsappTemplateTextarea = document.getElementById('whatsappTemplateTextarea');
        const settingsStatusMessage = document.getElementById('settingsStatusMessage');
        const pinModal = document.getElementById('pinModal');
        const editSppModal = document.getElementById('editSppModal');
        const editNonSppModal = document.getElementById('editNonSppModal');
        const defaultWhatsappTemplate = `Halo Bapak/Ibu, ini adalah bukti pembayaran SPP untuk *{nama_siswa}* tahun *{tahun_bayar}*.
Pembayaran yang tercatat:
{rincian_pembayaran}
Total nominal yang tercatat adalah: *{total_nominal_formatted}*
Laporan PDF sudah kami kirimkan ke folder unduhan Anda dengan nama "{nama_file}". Mohon dilampirkan dan dicek.
Terima kasih.`;

        window.onclick = function(event) {
            if (event.target == singleModal) {
                singleModal.style.display = 'none';
            }
            if (event.target == settingsModal) {
                settingsModal.style.display = 'none';
            }
            if (event.target == document.getElementById('editStudentModal')) {
                 document.getElementById('editStudentModal').style.display = 'none';
            }
            if (event.target == pinModal) {
                 pinModal.style.display = 'none';
            }
            if (event.target == editSppModal) {
                editSppModal.style.display = 'none';
            }
            if (event.target == editNonSppModal) {
                editNonSppModal.style.display = 'none';
            }
        }
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                updateReadStatus();
                const docRef = doc(db, "users", user.email);
                const docSnap = await getDoc(docRef);
                sessionReadCount++; updateReadStatus();
                if (docSnap.exists() && docSnap.data().role === 'bendahara') {
                    document.body.style.display = 'block';
                    document.getElementById('paymentDate').valueAsDate = new Date();
                    document.getElementById('paymentYear').value = new Date().getFullYear();
                    currentBendaharaName = docSnap.data().name || 'Bendahara';
                    await loadBrandSettings();
                    await loadBanks();
                    await loadAppEditPin();
                    await loadAllData();
                    await loadWhatsappTemplate();
                    setupEventListeners();
                    populateMonths();
                    initializeNonSppModule();
                    openTab('spp-tab');
                    const userGreeting = document.getElementById('userGreeting');
                    if (userGreeting) {
                        const loggedInUser = allUsers.find(u => u.id === user.email);
                        userGreeting.textContent = `Halo, ${loggedInUser.name || loggedInUser.id}!`;
                    }
                } else {
                    alert("Akses ditolak. Halaman ini hanya untuk Bendahara.");
                    await signOut(auth);
                    window.location.href = 'login.html';
                }
            } else {
                window.location.href = 'login.html';
            }
        });
        
        async function loadAppEditPin() {
            try {
                const docSnap = await getDoc(doc(db, "settings", "appEditPin"));
                sessionReadCount++; updateReadStatus();
                if (docSnap.exists() && docSnap.data().pin) {
                    appEditPin = docSnap.data().pin;
                } else {
                    appEditPin = '';
                }
            } catch (error) {
                console.error("Gagal memuat PIN:", error);
                appEditPin = '';
            }
        }

        async function saveAppEditPin() {
            const pin = document.getElementById('appEditPin').value;
            const pinStatusDiv = document.getElementById('pinStatusMessage');
            if (!pin || pin.length < 4 || pin.length > 6) {
                pinStatusDiv.textContent = 'PIN harus 4-6 digit.';
                pinStatusDiv.style.color = 'red';
                return;
            }
            try {
                await setDoc(doc(db, "settings", "appEditPin"), { pin: pin });
                appEditPin = pin;
                pinStatusDiv.textContent = 'PIN berhasil disimpan!';
                pinStatusDiv.style.color = 'green';
            } catch (error) {
                pinStatusDiv.textContent = `Gagal menyimpan PIN: ${error.message}`;
                pinStatusDiv.style.color = 'red';
            }
        }

        async function loadAllData() {
            try {
                const userSnapshot = await getDocs(collection(db, "users"));
                sessionReadCount += userSnapshot.size;
                allUsers = userSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const studentSnapshot = await getDocs(collection(db, "students"));
                sessionReadCount += studentSnapshot.size;
                allStudents = studentSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const curriculumSnapshot = await getDocs(collection(db, "kurikulum"));
                sessionReadCount += curriculumSnapshot.size;
                allLevels = curriculumSnapshot.docs.map(doc => doc.id).sort();

                pendingImportStudents = JSON.parse(localStorage.getItem('pendingImportStudents')) || [];

                updateReadStatus();
                setupStudentSearchBox();
                populateYearFilter();
                setupStudentFilterSearchBox();
                setupOtherStudentSearchBox();
                setupStudentListSearchBox();
                populateLevelFilterDropdown();
                renderSppTable();
                
                populateCoachDropdowns();
                populateLevelDropdowns();
                renderStudentTable();
                renderPendingAssignmentTable();
                renderSummaryDashboard();

            } catch (error) {
                console.error("ERROR di dalam loadAllData:", error);
                alert("Gagal memuat data utama. Kemungkinan ada masalah dengan koneksi atau Security Rules. Periksa console (F12).");
            }
        }

        function renderSummaryDashboard() {
            const totalStudentsElement = document.getElementById('summaryTotalStudents');
            const totalCoachesElement = document.getElementById('summaryTotalCoaches');
            const studentsByLevelList = document.getElementById('summaryActiveStudentsByLevel');

            // Filter siswa yang berstatus 'active' untuk perhitungan yang akurat
            const activeStudents = allStudents.filter(s => (s.status || 'active') === 'active');
            
            // Hitung total siswa aktif
            const totalActiveStudents = activeStudents.length;

            // Hitung total coach aktif
            const totalActiveCoaches = allUsers.filter(u => u.role === 'user' && (u.status || 'active') === 'active').length;

            // Menampilkan total siswa aktif dan coach aktif di elemen HTML
            totalStudentsElement.textContent = totalActiveStudents;
            totalCoachesElement.textContent = totalActiveCoaches;

            // Menampilkan siswa aktif per level
            const studentsPerLevel = activeStudents.reduce((acc, student) => {
                const level = student.studentLevel || 'Level Tidak Diketahui';
                acc[level] = (acc[level] || 0) + 1;
                return acc;
            }, {});

            studentsByLevelList.innerHTML = '';
            if (Object.keys(studentsPerLevel).length > 0) {
                for (const level in studentsPerLevel) {
                    const listItem = document.createElement('li');
                    listItem.textContent = `${level}: ${studentsPerLevel[level]} siswa`;
                    studentsByLevelList.appendChild(listItem);
                }
            } else {
                 const listItem = document.createElement('li');
                 listItem.textContent = 'Tidak ada siswa aktif.';
                 studentsByLevelList.appendChild(listItem);
            }
        }
        
        window.showPaymentDetails = function(detailsJsonEncoded) {
            const detailsJson = decodeURIComponent(detailsJsonEncoded);
            const details = JSON.parse(detailsJson);
            modalTitle.textContent = 'Detail Pembayaran SPP';
            const nominalFormatted = new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(details.nominal);
            let contentHTML = `
                <p><strong>ID Pembayaran:</strong> ${details.paymentId}</p>
                <p><strong>Tanggal Bayar:</strong> ${details.date}</p>
                <p><strong>Nominal:</strong> ${nominalFormatted}</p>
                <p><strong>Bank:</strong> ${details.bank}</p>
                <p><strong>Level Siswa (saat bayar):</strong> ${details.studentLevel}</p>
            `;
            if (details.keterangan) {
                contentHTML += `
                    <div style="margin-top:15px;">
                        <p><strong>Keterangan:</strong></p>
                        <p style="white-space: pre-wrap; margin-top: 5px;">${details.keterangan}</p>
                    </div>
                `;
            }
            if (details.attachmentBase64) {
                const mimeType = details.attachmentBase64.split(';')[0].split(':')[1];
                contentHTML += `
                    <div style="margin-top: 15px;">
                        <p><strong>Bukti Pembayaran (Snapshot):</strong></p>
                `;
                if (mimeType.startsWith('image/')) {
                    contentHTML += `<img src="${details.attachmentBase64}" alt="Bukti Pembayaran" class="attachment-preview">`;
                } else if (mimeType === 'application/pdf') {
                    contentHTML += `<iframe src="${details.attachmentBase64}" class="attachment-iframe"></iframe>`;
                }
                contentHTML += `</div>`;
            }
            if (!details.keterangan && !details.attachmentBase64) {
                contentHTML += `<p style="margin-top:15px;"><em>Tidak ada keterangan atau bukti bayar tambahan.</em></p>`;
            }
            modalBodyContent.innerHTML = contentHTML;
            singleModal.style.display = 'flex';
        };

        async function loadWhatsappTemplate() {
            try {
                const docSnap = await getDoc(doc(db, "settings", "whatsapp_templates"));
                sessionReadCount++; updateReadStatus();
                if (docSnap.exists()) {
                    whatsappTemplateText = docSnap.data().paymentProof || '';
                } else {
                    whatsappTemplateText = defaultWhatsappTemplate;
                }
            } catch (error) {
                console.error("Gagal memuat template WhatsApp:", error);
                whatsappTemplateText = defaultWhatsappTemplate;
            }
        }
        async function loadBrandSettings() {
            try {
                const docSnap = await getDoc(doc(db, "settings", "brand"));
                sessionReadCount++; updateReadStatus();
                if (docSnap.exists()) {
                    brandSettings = docSnap.data();
                } else {
                    brandSettings = {};
                }
            } catch (error) {
                console.error("Gagal memuat pengaturan brand:", error);
                brandSettings = {};
            }
        }
        async function loadBanks() {
            try {
                const banksCollection = collection(db, "banks");
                const banksSnapshot = await getDocs(banksCollection);
                sessionReadCount += banksSnapshot.size; updateReadStatus();
                bankColors = {};
                banksSnapshot.docs.forEach(doc => {
                    if (doc.data().status === 'active' || !doc.data().status) {
                        bankColors[doc.data().bankName] = doc.data().color;
                    }
                });
                populateBankLegend();
                populateBankSelector();
                populateEditBankSelectors();
            } catch (error) {
                console.error("Gagal memuat data bank:", error);
            }
        }
        
        function setupStudentSearchBox() {
            const searchBox = $('#studentSearchBox');
            const studentSelector = $('#studentSelector');
            const studentData = allStudents.map(student => ({
                label: `${student.name} (${student.studentLevel || 'Level belum diatur'} - ${student.status})`,
                value: student.id
            }));

            searchBox.autocomplete({
                source: studentData,
                minLength: 2,
                select: function(event, ui) {
                    searchBox.val(ui.item.label);
                    studentSelector.val(ui.item.value);
                    return false;
                }
            });
            // Clear the hidden input if the search box is cleared
            searchBox.on('input', function() {
                if ($(this).val() === '') {
                    studentSelector.val('');
                }
            });
        }
        
        function setupStudentFilterSearchBox() {
            const searchBox = $('#studentFilterSearchBox');
            const studentFilter = $('#studentFilter');
            const studentData = [{ label: 'Semua Siswa', value: 'all' }].concat(allStudents.map(student => ({
                label: student.name,
                value: student.id
            })));
            
            searchBox.autocomplete({
                source: studentData,
                minLength: 2,
                select: function(event, ui) {
                    searchBox.val(ui.item.label);
                    studentFilter.val(ui.item.value);
                    renderSppTable();
                    return false;
                }
            });
            // Handle clearing the search box
            searchBox.on('input', function() {
                if ($(this).val() === '') {
                    studentFilter.val('all');
                    renderSppTable();
                }
            });
        }

        function setupOtherStudentSearchBox() {
            const searchBox = $('#otherStudentSearchBox');
            const studentSelector = $('#otherStudentSelector');
            const studentData = allStudents.map(student => ({
                label: `${student.name} (${student.studentLevel || 'N/A'} - ${student.status})`,
                value: student.id
            }));

            searchBox.autocomplete({
                source: studentData,
                minLength: 2,
                select: function(event, ui) {
                    searchBox.val(ui.item.label);
                    studentSelector.val(ui.item.value);
                    return false;
                }
            });
            // Clear the hidden input if the search box is cleared
            searchBox.on('input', function() {
                if ($(this).val() === '') {
                    studentSelector.val('');
                }
            });
        }
        
        // Smart search for the Non-SPP history student filter
        function setupOtherStudentFilterSearchBox() {
            const searchBox = $('#otherStudentFilterSearchBox');
            const studentFilter = $('#otherStudentFilter');
            const studentData = [{ label: 'Semua Siswa', value: 'all' }].concat(allStudents.map(student => ({
                label: student.name,
                value: student.id
            })));
            
            searchBox.autocomplete({
                source: studentData,
                minLength: 2,
                select: function(event, ui) {
                    searchBox.val(ui.item.label);
                    studentFilter.val(ui.item.value);
                    renderOtherPaymentsTable(filterNonSppData());
                    return false;
                }
            });
            // Handle clearing the search box
            searchBox.on('input', function() {
                if ($(this).val() === '') {
                    studentFilter.val('all');
                    renderOtherPaymentsTable(filterNonSppData());
                }
            });
        }

        function setupStudentListSearchBox() {
            const searchBox = $('#studentListSearchBox');
            const studentFilter = $('#studentListFilter');
            const studentData = [{ label: 'Semua Siswa', value: 'all' }].concat(allStudents.map(student => ({
                label: student.name,
                value: student.id
            })));
            
            searchBox.autocomplete({
                source: studentData,
                minLength: 2,
                select: function(event, ui) {
                    searchBox.val(ui.item.label);
                    studentFilter.val(ui.item.value);
                    renderStudentTable();
                    return false;
                }
            });
            searchBox.on('input', function() {
                if ($(this).val() === '') {
                    studentFilter.val('all');
                    renderStudentTable();
                }
            });
        }

        function populateLevelFilterDropdown() {
            const levelSelector = document.getElementById('levelFilterSelector');
            if (levelSelector) {
                levelSelector.innerHTML = '<option value="all">Semua Level</option>';
                allLevels.forEach(level => {
                    levelSelector.innerHTML += `<option value="${level}">${level}</option>`;
                });
            }
        }
        function populateBankSelector() {
            const selector = document.getElementById('bankSelector');
            const otherSelector = document.getElementById('otherBankSelector');
            if (selector) {
                selector.innerHTML = '<option value="">Pilih Bank</option>';
                for (const bankName in bankColors) {
                    const optionHTML = `<option value="${bankName}">${bankName}</option>`;
                    selector.innerHTML += optionHTML;
                }
            }
            if (otherSelector) {
                otherSelector.innerHTML = '<option value="">Pilih Bank</option>';
                for (const bankName in bankColors) {
                    otherSelector.innerHTML += `<option value="${bankName}">${bankName}</option>`;
                }
            }
        }
        function populateEditBankSelectors() {
            const editSppBankSelector = document.getElementById('editSppBank');
            const editNonSppBankSelector = document.getElementById('editNonSppBank');
            let options = '<option value="">Pilih Bank</option>';
            for (const bankName in bankColors) {
                options += `<option value="${bankName}">${bankName}</option>`;
            }
            editSppBankSelector.innerHTML = options;
            editNonSppBankSelector.innerHTML = options;
        }
        function populateMonths() {
            const monthSelector = document.getElementById('monthSelector');
            if (monthSelector) {
                monthSelector.innerHTML = '';
                monthNames.forEach((month, index) => {
                    monthSelector.innerHTML += `
                        <label><input type="checkbox" name="month" value="${index}"> ${month}</label>
                    `;
                });
            }
        }
        function populateBankLegend() {
            const legendDiv = document.getElementById('bankLegend');
            if (legendDiv) {
                legendDiv.innerHTML = '';
                for (const bank in bankColors) {
                    legendDiv.innerHTML += `
                        <div class="legend-item"><span class="bank-color" style="background-color: ${bankColors[bank]};"></span>${bank}</div>
                    `;
                }
            }
        }
        function populateYearFilter() {
            const yearFilter = document.getElementById('yearFilter');
            if (yearFilter) {
                const years = new Set();
                allStudents.forEach(student => {
                    if (student.spp) {
                        Object.keys(student.spp).forEach(key => {
                            const year = key.split('-')[0];
                            if (year) {
                                years.add(parseInt(year));
                            }
                        });
                    }
                });
                allYearsWithPayments = Array.from(years).sort((a, b) => a - b);
                yearFilter.innerHTML = '<option value="all">Semua Tahun</option>';
                allYearsWithPayments.forEach(year => {
                    yearFilter.innerHTML += `<option value="${year}">${year}</option>`;
                });
                if (allYearsWithPayments.length > 0) {
                    yearFilter.value = Math.max(...allYearsWithPayments);
                } else {
                    yearFilter.value = 'all';
                }
            }
        }
        async function getBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
        async function compressImage(file, quality = 0.7) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = event => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        const maxWidth = 800;
                        const maxHeight = 600;
                        if (width > height) {
                            if (width > maxWidth) {
                                height *= maxWidth / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width *= maxHeight / height;
                                height = maxHeight;
                            }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        const compressedBase64 = canvas.toDataURL('image/jpeg', quality);
                        resolve(compressedBase64);
                    };
                    img.onerror = error => reject(error);
                };
                reader.onerror = error => reject(error);
            });
        }
        async function handleAddPayment(e) {
            e.preventDefault();
            const studentId = document.getElementById('studentSelector').value;
            const nominalInput = document.getElementById('nominal').value;
            const nominal = parseFloat(nominalInput.replace(/\./g, ''));
            const bank = document.getElementById('bankSelector').value;
            const paymentDate = document.getElementById('paymentDate').value;
            const paymentYear = document.getElementById('paymentYear').value;
            const keterangan = document.getElementById('keterangan').value;
            const attachmentFile = document.getElementById('attachment').files[0];
            const monthsPaid = Array.from(document.querySelectorAll('input[name="month"]:checked')).map(cb => parseInt(cb.value));
            const statusMessageDiv = document.getElementById('statusMessage');
            const compressionQuality = parseFloat(document.getElementById('imageQualitySelector').value);

            // Validasi tambahan untuk studentSelector
            if (!studentId || studentId === '') {
                statusMessageDiv.textContent = 'Harap pilih siswa yang valid dari daftar.';
                statusMessageDiv.style.color = 'red';
                return;
            }

            if (isNaN(nominal) || nominal <= 0 || !bank || !paymentDate || isNaN(paymentYear) || monthsPaid.length === 0 || !attachmentFile) {
                statusMessageDiv.textContent = 'Semua field wajib diisi, termasuk bukti bayar.';
                statusMessageDiv.style.color = 'red';
                return;
            }
            statusMessageDiv.textContent = 'Menyimpan pembayaran...';
            statusMessageDiv.style.color = 'blue';
            try {
                let attachmentBase64 = '';
                if (attachmentFile) {
                    if (attachmentFile.size > 3 * 1024 * 1024) {
                        statusMessageDiv.textContent = 'Error: Ukuran file terlalu besar. Maksimum 3MB.';
                        statusMessageDiv.style.color = 'red';
                        return;
                    }
                    if (attachmentFile.type.startsWith('image/')) {
                        attachmentBase64 = await compressImage(attachmentFile, compressionQuality);
                    } else if (attachmentFile.type === 'application/pdf') {
                        attachmentBase64 = await getBase64(attachmentFile);
                    } else {
                        statusMessageDiv.textContent = 'Error: Jenis file tidak didukung.';
                        statusMessageDiv.style.color = 'red';
                        return;
                    }
                }
                const studentRef = doc(db, "students", studentId);
                const studentSnap = await getDoc(studentRef);
                sessionReadCount++; updateReadStatus();
                if (!studentSnap.exists()) {
                    statusMessageDiv.textContent = 'Error: Data siswa tidak ditemukan.';
                    statusMessageDiv.style.color = 'red';
                    return;
                }
                const studentData = studentSnap.data();
                const updatedSppData = { ...studentData.spp };
                const paymentUniqueId = crypto.randomUUID();
                const existingMonths = monthsPaid.filter(monthIndex => {
                    const key = `${paymentYear}-${monthIndex}`;
                    return updatedSppData[key] !== undefined;
                });
                if (existingMonths.length > 0) {
                    const existingMonthsNames = existingMonths.map(i => monthNames[i]).join(', ');
                    statusMessageDiv.textContent = `Error: Pembayaran untuk bulan ${existingMonthsNames} pada tahun ${paymentYear} sudah ada.`;
                    statusMessageDiv.style.color = 'red';
                    return;
                }
                monthsPaid.forEach(monthIndex => {
                    const key = `${paymentYear}-${monthIndex}`;
                    updatedSppData[key] = {
                        nominal: nominal,
                        bank: bank,
                        date: Timestamp.fromDate(new Date(paymentDate)),
                        keterangan: keterangan,
                        attachmentBase64: attachmentBase64,
                        paymentId: paymentUniqueId,
                        studentLevel: studentData.studentLevel || 'Level belum diatur'
                    };
                });
                await updateDoc(studentRef, {
                    spp: updatedSppData
                });
                statusMessageDiv.textContent = 'Pembayaran berhasil disimpan!';
                document.getElementById('sppPaymentForm').reset();
                document.getElementById('paymentDate').valueAsDate = new Date();
                document.getElementById('paymentYear').value = new Date().getFullYear();
                await loadAllData();
            } catch (error) {
                statusMessageDiv.textContent = `Error: ${error.message}`;
                statusMessageDiv.style.color = 'red';
                console.error("Error storing payment:", error);
            }
        }
        function renderSppTable() {
            const tableHeader = document.getElementById('tableHeader');
            const tableSubHeader = document.getElementById('tableSubHeader');
            const tableBody = document.getElementById('sppTableBody');
            const selectedStudentId = document.getElementById('studentFilter').value;
            const selectedYear = document.getElementById('yearFilter').value;
            let studentsToDisplay = allStudents.filter(student => {
                let matchesStudent = selectedStudentId === 'all' || student.id === selectedStudentId;
                if (selectedYear === 'all') {
                    return matchesStudent && student.spp && Object.keys(student.spp).length > 0;
                } else {
                    return matchesStudent && Object.keys(student.spp || {}).some(key => key.startsWith(selectedYear));
                }
            });
            const totalPages = Math.ceil(studentsToDisplay.length / rowsPerPage);
            if (currentPage > totalPages) currentPage = totalPages || 1;
            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const paginatedStudents = studentsToDisplay.slice(start, end);
            tableHeader.innerHTML = '';
            tableSubHeader.innerHTML = '';
            if (allYearsWithPayments.length === 0 && selectedYear === 'all') {
                tableBody.innerHTML = `<tr><td colspan="${monthNames.length + 1}" class="no-data">Belum ada data pembayaran SPP sama sekali.</td></tr>`;
                updatePaginationControls('spp', 0, 1);
                return;
            }
            const yearsToDisplay = selectedYear === 'all' ? allYearsWithPayments : [selectedYear];
            tableHeader.innerHTML = `<th rowspan="2">Nama Siswa</th>`;
            yearsToDisplay.forEach(year => {
                tableHeader.innerHTML += `<th colspan="12">${year}</th>`;
            });
            yearsToDisplay.forEach(year => {
                 monthNames.forEach(month => {
                     tableSubHeader.innerHTML += `<th>${month.substring(0,3).toUpperCase()}</th>`;
                 });
            });
            tableBody.innerHTML = '';
            if (paginatedStudents.length === 0) {
                const colspan = 1 + (yearsToDisplay.length * 12);
                tableBody.innerHTML = `<tr><td colspan="${colspan}">Tidak ada data untuk filter ini.</td></tr>`;
                updatePaginationControls('spp', 0, 1);
            } else {
                 paginatedStudents.forEach(student => {
                     const row = tableBody.insertRow();
                     const studentNameCell = row.insertCell();
                     const studentStatus = student.status || 'inactive';
                     studentNameCell.innerHTML = `${student.name}<span class="student-status">${studentStatus.toUpperCase()}</span>`;
                     const studentSpp = student.spp || {};
                     yearsToDisplay.forEach(year => {
                         monthNames.forEach((month, monthIndex) => {
                             const cell = row.insertCell();
                             const key = `${year}-${monthIndex}`;
                             const paymentData = studentSpp[key];
                             if (paymentData) {
                                 const bankColor = bankColors[paymentData.bank] || '#ccc';
                                 const nominalFormatted = new Intl.NumberFormat('id-ID').format(paymentData.nominal);
                                 const paymentDate = (paymentData.date && typeof paymentData.date.toDate === 'function') ? paymentData.date.toDate() : new Date(paymentData.date);
                                 const dateFormatted = paymentDate.toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' });
                                 const studentLevel = paymentData.studentLevel || 'Level tidak tersedia';
                                 
                                 const details = {
                                     paymentId: paymentData.paymentId || 'ID tidak tersedia',
                                     nominal: paymentData.nominal || 0,
                                     bank: paymentData.bank || 'N/A',
                                     date: paymentDate.toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' }),
                                     studentLevel: paymentData.studentLevel || 'N/A',
                                     keterangan: paymentData.keterangan || '',
                                     attachmentBase64: paymentData.attachmentBase64 || '',
                                     key: key,
                                     studentId: student.id
                                 };
                                 const detailsJson = encodeURIComponent(JSON.stringify(details));
                                 
                                 cell.innerHTML = `
                                     <div class="payment-bank-color" style="background-color: ${bankColor};"></div>
                                     <div class="payment-info">
                                         <span class="payment-amount">Rp ${nominalFormatted}</span>
                                         <span class="payment-date">${dateFormatted}</span>
                                         <span class="payment-level">${studentLevel}</span>
                                         <button type="button" class="action-btn-edit" style="margin-top:5px; padding: 5px 10px; font-size:12px;" onclick="openPinModal('spp', '${student.id}', '${key}')">Edit</button>
                                     </div>
                                 `;
                                 if (details.keterangan || details.attachmentBase64) {
                                     cell.innerHTML += `<a href="#" onclick="event.preventDefault(); showPaymentDetails('${detailsJson}')" class="attachment-link">Detail</a>`;
                                 }
                             } else {
                                 cell.innerHTML = '';
                             }
                         });
                     });
                 });
            }
            updatePaginationControls('spp', currentPage, totalPages);
        }

        window.openPinModal = function(type, ...params) {
            pinModal.style.display = 'flex';
            document.getElementById('pinInput').value = '';
            const verifyBtn = document.getElementById('verifyPinBtn');
            verifyBtn.onclick = () => verifyPinAndOpenEdit(type, ...params);
        };

        async function verifyPinAndOpenEdit(type, ...params) {
            const enteredPin = document.getElementById('pinInput').value;
            const pinVerificationMessage = document.getElementById('pinVerificationMessage');
            if (enteredPin === appEditPin) {
                pinModal.style.display = 'none';
                pinVerificationMessage.textContent = '';
                if (type === 'spp') {
                    const [studentId, yearMonthKey] = params;
                    await openEditSppModal(studentId, yearMonthKey);
                } else if (type === 'nonspp') {
                    const [paymentId] = params;
                    await openEditNonSppModal(paymentId);
                }
            } else {
                pinVerificationMessage.textContent = 'PIN salah!';
                pinVerificationMessage.style.color = 'red';
            }
        }
        
        async function openEditSppModal(studentId, yearMonthKey) {
            const student = allStudents.find(s => s.id === studentId);
            if (!student || !student.spp[yearMonthKey]) {
                alert("Pembayaran tidak ditemukan.");
                return;
            }

            const paymentData = student.spp[yearMonthKey];
            
            document.getElementById('editSppStudentId').value = studentId;
            document.getElementById('editSppYearMonthKey').value = yearMonthKey;
            document.getElementById('editSppNominal').value = new Intl.NumberFormat('id-ID').format(paymentData.nominal);
            document.getElementById('editSppBank').value = paymentData.bank || '';
            document.getElementById('editSppPaymentDate').value = (paymentData.date && typeof paymentData.date.toDate === 'function') ? paymentData.date.toDate().toISOString().slice(0, 10) : '';
            document.getElementById('editSppKeterangan').value = paymentData.keterangan || '';
            document.getElementById('editSppAttachment').value = '';

            setupNominalInput('editSppNominal');
            
            const bankSelector = document.getElementById('editSppBank');
            bankSelector.innerHTML = '<option value="">Pilih Bank</option>';
            for (const bankName in bankColors) {
                bankSelector.innerHTML += `<option value="${bankName}">${bankName}</option>`;
            }
            bankSelector.value = paymentData.bank;

            editSppModal.style.display = 'flex';
        }

        async function handleUpdateSppPayment(e) {
            e.preventDefault();
            const studentId = document.getElementById('editSppStudentId').value;
            const yearMonthKey = document.getElementById('editSppYearMonthKey').value;
            const nominalInput = document.getElementById('editSppNominal').value;
            const nominal = parseFloat(nominalInput.replace(/\./g, ''));
            const bank = document.getElementById('editSppBank').value;
            const paymentDate = document.getElementById('editSppPaymentDate').value;
            const keterangan = document.getElementById('editSppKeterangan').value;
            const attachmentFile = document.getElementById('editSppAttachment').files[0];
            
            if (isNaN(nominal) || nominal <= 0 || !bank || !paymentDate) {
                alert('Semua field wajib diisi.');
                return;
            }

            try {
                const studentRef = doc(db, "students", studentId);
                const studentSnap = await getDoc(studentRef);
                if (!studentSnap.exists()) {
                    alert('Siswa tidak ditemukan.');
                    return;
                }
                const studentData = studentSnap.data();
                const updatedSppData = { ...studentData.spp };
                
                const oldPaymentData = updatedSppData[yearMonthKey];
                
                let newAttachmentBase64 = oldPaymentData.attachmentBase64;
                if (attachmentFile) {
                    if (attachmentFile.type.startsWith('image/')) {
                        newAttachmentBase64 = await compressImage(attachmentFile, 0.2); 
                    } else if (attachmentFile.type === 'application/pdf') {
                        newAttachmentBase64 = await getBase64(attachmentFile);
                    }
                }
                
                updatedSppData[yearMonthKey] = {
                    nominal: nominal,
                    bank: bank,
                    date: Timestamp.fromDate(new Date(paymentDate)),
                    keterangan: keterangan,
                    attachmentBase64: newAttachmentBase64,
                    paymentId: oldPaymentData.paymentId || '',
                    studentLevel: oldPaymentData.studentLevel || 'Level belum diatur'
                };

                await updateDoc(studentRef, { spp: updatedSppData });
                alert('Pembayaran SPP berhasil diperbarui!');
                editSppModal.style.display = 'none';
                await loadAllData();
            } catch (error) {
                console.error("Gagal memperbarui pembayaran SPP:", error);
                alert(`Error: ${error.message}`);
            }
        }

        window.deleteSppPayment = async function() {
            if (!confirm('Apakah Anda yakin ingin menghapus pembayaran ini?')) return;
            
            const studentId = document.getElementById('editSppStudentId').value;
            const yearMonthKey = document.getElementById('editSppYearMonthKey').value;
            
            try {
                const studentRef = doc(db, "students", studentId);
                const updateData = {};
                updateData[`spp.${yearMonthKey}`] = deleteField();
                
                await updateDoc(studentRef, updateData);
                alert('Pembayaran SPP berhasil dihapus!');
                editSppModal.style.display = 'none';
                await loadAllData();
            } catch (error) {
                console.error("Gagal menghapus pembayaran SPP:", error);
                alert(`Error: ${error.message}`);
            }
        };

        function updatePaginationControls(type, current, total) {
            let pageDisplay, totalDisplay, prevBtn, nextBtn;
            if (type === 'spp') {
                pageDisplay = document.getElementById('currentPageDisplay');
                totalDisplay = document.getElementById('totalPagesDisplay');
                prevBtn = document.getElementById('prevBtn');
                nextBtn = document.getElementById('nextBtn');
            } else if (type === 'non-spp') {
                pageDisplay = document.getElementById('otherCurrentPageDisplay');
                totalDisplay = document.getElementById('otherTotalPagesDisplay');
                prevBtn = document.getElementById('otherPrevBtn');
                nextBtn = document.getElementById('otherNextBtn');
            } else if (type === 'student') {
                pageDisplay = document.getElementById('studentCurrentPage');
                totalDisplay = document.getElementById('studentTotalPages');
                prevBtn = document.getElementById('studentPrevBtn');
                nextBtn = document.getElementById('studentNextBtn');
            }

            if (pageDisplay) pageDisplay.textContent = current;
            if (totalDisplay) totalDisplay.textContent = total;
            if (prevBtn) prevBtn.disabled = current <= 1;
            if (nextBtn) nextBtn.disabled = current >= total || total === 0;
        }

        function setupEventListeners() {
            document.getElementById('sppPaymentForm').addEventListener('submit', handleAddPayment);
            document.getElementById('editSppForm').addEventListener('submit', handleUpdateSppPayment);
            document.getElementById('editNonSppForm').addEventListener('submit', handleUpdateNonSppPayment);
            document.getElementById('studentFilterSearchBox').addEventListener('input', () => {
                const searchBoxValue = document.getElementById('studentFilterSearchBox').value;
                const studentFilterValue = document.getElementById('studentFilter').value;
                if (!searchBoxValue) {
                    if (studentFilterValue !== 'all') {
                        document.getElementById('studentFilter').value = 'all';
                        renderSppTable();
                    }
                }
            });
            document.getElementById('yearFilter').addEventListener('change', () => {
                currentPage = 1;
                renderSppTable();
            });
            document.getElementById('rowsPerPage').addEventListener('change', (e) => {
                rowsPerPage = parseInt(e.target.value, 10);
                currentPage = 1;
                renderSppTable();
            });
            document.getElementById('prevBtn').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderSppTable();
                }
            });
            document.getElementById('nextBtn').addEventListener('click', () => {
                const totalPages = parseInt(document.getElementById('totalPagesDisplay').textContent);
                if (currentPage < totalPages) {
                    currentPage++;
                    renderSppTable();
                }
            });
            setupNominalInput('nominal');
            setupNominalInput('otherNominal');
            setupNominalInput('editSppNominal');
            setupNominalInput('editNonSppNominal');

            document.getElementById('addStudentForm').addEventListener('submit', handleAddStudent);
            document.getElementById('selectAllBulkCheckbox').addEventListener('click', (e) => {
                document.querySelectorAll('.student-checkbox').forEach(checkbox => {
                    if (checkbox.closest('tr').style.display !== 'none') checkbox.checked = e.target.checked;
                });
            });
            document.getElementById('selectAllPendingCheckbox').addEventListener('click', (e) => {
                document.querySelectorAll('.pending-student-checkbox').forEach(checkbox => {
                    checkbox.checked = e.target.checked;
                });
            });
            document.getElementById('bulkChangeCoachBtn').addEventListener('click', handleBulkChange);
            document.getElementById('bulkChangeLevelBtn').addEventListener('click', handleBulkLevelChange);
            document.getElementById('assignAndSaveBtn').addEventListener('click', handleAssignAndSave);
            document.getElementById('cancelImportBtn').addEventListener('click', handleCancelImport);
            document.getElementById('transferStudentsBtn').addEventListener('click', handleTransfer);
            document.querySelector('#editStudentModal .close-btn').onclick = () => document.getElementById('editStudentModal').style.display = 'none';
            document.getElementById('editStudentForm').addEventListener('submit', handleEditStudent);
            document.getElementById('studentRowsPerPage').addEventListener('change', (e) => {
                studentRowsPerPage = parseInt(e.target.value, 10);
                studentCurrentPage = 1; renderStudentTable(); 
            });
            document.getElementById('studentPrevBtn').addEventListener('click', () => { if (studentCurrentPage > 1) { studentCurrentPage--; renderStudentTable(); } });
            document.getElementById('studentNextBtn').addEventListener('click', () => { const totalPages = parseInt(document.getElementById('studentTotalPages').textContent); if (studentCurrentPage < totalPages) { studentCurrentPage++; renderStudentTable(); } });
            document.getElementById('showDisabledStudents').addEventListener('change', () => { studentCurrentPage = 1; renderStudentTable(); });
            document.getElementById('coachFilterSelector').addEventListener('change', () => { studentCurrentPage = 1; renderStudentTable(); });
            document.getElementById('downloadExcelTemplateBtn').addEventListener('click', downloadExcelTemplate);
            document.getElementById('importStudentForm').addEventListener('submit', handleImportStudent);
            
            document.getElementById('otherRowsPerPage').addEventListener('change', (e) => {
                otherRowsPerPage = parseInt(e.target.value, 10);
                otherCurrentPage = 1; renderOtherPaymentsTable(filterNonSppData()); 
            });
            document.getElementById('otherBankFilter').addEventListener('change', () => {
                otherCurrentPage = 1;
                renderOtherPaymentsTable(filterNonSppData());
            });
            document.getElementById('levelFilterSelector').addEventListener('change', () => {
                studentCurrentPage = 1;
                renderStudentTable();
            });
            document.getElementById('summaryYearFilter').addEventListener('change', populateNonSppSummaryDashboard);
            document.getElementById('summaryMonthFilter').addEventListener('change', populateNonSppSummaryDashboard);
        }

        function setupNominalInput(id) {
            const inputElement = document.getElementById(id);
            if (inputElement) {
                inputElement.addEventListener('keyup', function(e) {
                    let value = e.target.value;
                    value = value.replace(/\./g, '');
                    if (!isNaN(value) && value.length > 0) {
                        e.target.value = new Intl.NumberFormat('id-ID').format(value);
                    }
                });
                inputElement.addEventListener('change', function(e) {
                    let value = e.target.value;
                    value = value.replace(/\./g, '');
                    if (!isNaN(value) && value.length > 0) {
                        e.target.value = new Intl.NumberFormat('id-ID').format(value);
                    }
                });
            }
        }
        function formatPhoneNumber(number) {
            number = String(number).replace(/\s/g, '');
            if (number.startsWith('0')) {
                number = '62' + number.slice(1);
            } else if (number.startsWith('+')) {
                number = number.slice(1);
            }
            if (!number.startsWith('62')) {
                number = '62' + number;
            }
            return number;
        }

        const isMobile = /Mobi|Android/i.test(navigator.userAgent);

        window.generateAndSendPaymentProof = function() {
            const studentFilter = document.getElementById('studentFilter');
            const yearFilter = document.getElementById('yearFilter');
            const monthFilter = document.getElementById('monthFilter');
            if (studentFilter.value === 'all' || yearFilter.value === 'all') {
                alert("Harap pilih satu siswa dan satu tahun spesifik untuk membuat bukti pembayaran.");
                return;
            }
            const studentId = studentFilter.value;
            const student = allStudents.find(s => s.id === studentId);
            const selectedYear = yearFilter.value;
            const selectedMonth = monthFilter.value;
            if (!student || !student.phone) {
                alert("Nomor telepon siswa tidak ditemukan. Harap perbarui data siswa di Panel Admin.");
                return;
            }
            const studentName = student.name;
            const phoneNumber = formatPhoneNumber(student.phone);
            const paymentsForYear = allStudents.find(s => s.id === studentId)?.spp;
            
            let paymentsToPrint = [];
            let fileNameSuffix;
            let title;
            let message = '';
            
            const now = new Date();
            const timestamp = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}${String(now.getSeconds()).padStart(2, '0')}`;

            if (selectedMonth === 'all') {
                paymentsToPrint = Object.keys(paymentsForYear)
                    .filter(key => key.startsWith(selectedYear))
                    .sort((a,b) => parseInt(a.split('-')[1]) - parseInt(b.split('-')[1]))
                    .map(key => ({monthIndex: parseInt(key.split('-')[1]), data: paymentsForYear[key]}));
                if (paymentsToPrint.length === 0) {
                    alert("Tidak ada data pembayaran untuk siswa ini pada tahun yang dipilih.");
                    return;
                }
                fileNameSuffix = `${selectedYear}`;
                title = `Bukti Pembayaran SPP Tahun ${selectedYear}`;
                const totalNominal = paymentsToPrint.reduce((sum, p) => sum + p.data.nominal, 0);
                const totalNominalFormatted = new Intl.NumberFormat('id-ID', {style: 'currency', currency: 'IDR', minimumFractionDigits: 0}).format(totalNominal);
                const rincianPembayaran = paymentsToPrint.map(p => `â€¢ ${monthNames[p.monthIndex]}: ${new Intl.NumberFormat('id-ID', {style: 'currency', currency: 'IDR', minimumFractionDigits: 0}).format(p.data.nominal)}`).join('\n');
                
                message = whatsappTemplateText
                    .replace(/{nama_siswa}/g, studentName)
                    .replace(/{tahun_bayar}/g, selectedYear)
                    .replace(/{total_nominal_formatted}/g, totalNominalFormatted)
                    .replace(/{rincian_pembayaran}/g, rincianPembayaran);
            } else {
                const key = `${selectedYear}-${selectedMonth}`;
                const paymentData = paymentsForYear[key];
                if (!paymentData) {
                    alert(`Tidak ada pembayaran untuk bulan ${monthNames[selectedMonth]} tahun ${selectedYear}.`);
                    return;
                }
                paymentsToPrint = [{
                    monthIndex: parseInt(selectedMonth),
                    data: paymentData
                }];
                fileNameSuffix = `${monthNames[selectedMonth]}_${selectedYear}`;
                title = `Bukti Pembayaran SPP Bulan ${monthNames[selectedMonth]} ${selectedYear}`;
                const totalNominalFormatted = new Intl.NumberFormat('id-ID', {style: 'currency', currency: 'IDR', minimumFractionDigits: 0}).format(paymentData.nominal);
                
                message = `Halo Bapak/Ibu, ini adalah bukti pembayaran SPP untuk *${studentName}* untuk bulan *${monthNames[selectedMonth]}* tahun *${selectedYear}*.
Nominal yang tercatat adalah: *${totalNominalFormatted}*
Pembayaran dilakukan melalui Bank: *${paymentData.bank}*
`;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let yPos = 15;
            const addContentAndSave = () => {
                if (brandSettings && brandSettings.companyName) {
                    doc.setFontSize(12);
                    doc.setFont("helvetica", "normal");
                    doc.text(brandSettings.companyName, doc.internal.pageSize.getWidth() / 2, yPos, { align: "center" });
                    yPos += 8;
                }
                doc.setFontSize(16);
                doc.setFont("helvetica", "bold");
                doc.text(title, doc.internal.pageSize.getWidth() / 2, yPos, { align: "center" });
                yPos += 10;
                doc.setFontSize(10);
                doc.setFont("helvetica", "normal");
                doc.text(`Tahun: ${selectedYear}`, doc.internal.pageSize.getWidth() / 2, yPos, { align: "center" });
                yPos += 15;
                doc.text(`Nama Siswa: ${studentName}`, 15, yPos);
                yPos += 10;
                
                const tableData = paymentsToPrint.map(p => {
                    const nominalFormatted = new Intl.NumberFormat('id-ID', {style: 'currency', currency: 'IDR', minimumFractionDigits: 0}).format(p.data.nominal);
                    return [monthNames[p.monthIndex], nominalFormatted, p.data.bank];
                });
                const totalNominal = paymentsToPrint.reduce((sum, p) => sum + p.data.nominal, 0);
                doc.autoTable({
                    startY: yPos,
                    head: [['Bulan', 'Nominal', 'Bank']],
                    body: tableData,
                });
                yPos = doc.autoTable.previous.finalY + 10;
                doc.text(`Total Terbayar: ${new Intl.NumberFormat('id-ID', {style: 'currency', currency: 'IDR', minimumFractionDigits: 0}).format(totalNominal)}`, 14, yPos);
                
                const fileName = `Bukti_Bayar_SPP_${studentName.replace(/ /g, '_')}_${fileNameSuffix}_${timestamp}.pdf`;
                
                message = message.replace(/{nama_file}/g, fileName);
                
                const encodedMessage = encodeURIComponent(message);
                
                let whatsappUrl;
                if (isMobile) {
                    whatsappUrl = `whatsapp://send?phone=${phoneNumber}&text=${encodedMessage}`;
                } else {
                    whatsappUrl = `https://web.whatsapp.com/send?phone=${phoneNumber}&text=${encodedMessage}`;
                }
                
                doc.save(fileName, { returnPromise: true }).then(() => {
                    alert(`PDF telah diunduh: "${fileName}"\n\nSilakan lampirkan file tersebut di chat WhatsApp yang terbuka.`);
                    window.open(whatsappUrl, '_blank');
                });
            };
            if (brandSettings && brandSettings.logoBase64) {
                const img = new Image();
                img.src = brandSettings.logoBase64;
                img.onload = () => {
                    const desiredLogoHeight = 20;
                    const aspectRatio = img.width / img.height;
                    const calculatedLogoWidth = desiredLogoHeight * aspectRatio;
                    doc.addImage(img, 'PNG', (doc.internal.pageSize.getWidth() - calculatedLogoWidth) / 2, yPos, calculatedLogoWidth, desiredLogoHeight);
                    yPos += desiredLogoHeight + 10;
                    addContentAndSave();
                };
                img.onerror = () => addContentAndSave();
            } else {
                addContentAndSave();
            }
        }
        window.openWhatsappSettings = function() {
            settingsModal.style.display = 'flex';
            settingsStatusMessage.textContent = 'Memuat template...';
            whatsappTemplateTextarea.value = whatsappTemplateText;
            settingsStatusMessage.textContent = '';
        }
        window.saveWhatsappTemplate = async function() {
            settingsStatusMessage.textContent = 'Menyimpan template...';
            settingsStatusMessage.style.color = 'blue';
            const newTemplateText = whatsappTemplateTextarea.value;
            try {
                const templateDocRef = doc(db, "settings", "whatsapp_templates");
                await updateDoc(templateDocRef, {
                    paymentProof: newTemplateText
                });
                whatsappTemplateText = newTemplateText;
                settingsStatusMessage.textContent = 'Template berhasil disimpan!';
                settingsStatusMessage.style.color = 'green';
            } catch (error) {
                console.error("Gagal menyimpan template:", error);
                settingsStatusMessage.textContent = `Error: ${error.message}`;
                settingsStatusMessage.style.color = 'red';
            }
        }
        window.resetWhatsappTemplate = async function() {
            if (confirm("Apakah Anda yakin ingin mengembalikan template ke pengaturan awal? Ini tidak bisa dibatalkan.")) {
                whatsappTemplateTextarea.value = defaultWhatsappTemplate;
                await saveWhatsappTemplate();
            }
        }
        function initializeNonSppModule() {
            loadNonSppData();
            setupNonSppEventListeners();
        }
        async function loadNonSppData() {
            try {
                const querySnapshot = await getDocs(collection(db, "other_payments"));
                sessionReadCount += querySnapshot.size; updateReadStatus();
                allOtherPayments = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                setupOtherStudentSearchBox(); 
                populateNonSppSelectors(); 
                populateNonSppSummarySelectors(); 
                populateNonSppSummaryDashboard(); 
                renderOtherPaymentsTable(filterNonSppData());
            } catch (error) {
                console.error("Error loading Non-SPP data:", error);
            }
        }

        function populateNonSppSummarySelectors() {
            const yearFilter = document.getElementById('summaryYearFilter');
            const years = new Set(allOtherPayments
                .filter(p => p.timestamp && typeof p.timestamp.toDate === 'function')
                .map(p => p.timestamp.toDate().getFullYear())
            );
            const sortedYears = Array.from(years).sort((a,b) => b-a);
            yearFilter.innerHTML = '<option value="all">Semua Tahun</option>';
            sortedYears.forEach(year => {
                yearFilter.innerHTML += `<option value="${year}">${year}</option>`;
            });
            if (sortedYears.length > 0) {
                yearFilter.value = Math.max(...sortedYears);
            } else {
                yearFilter.value = 'all';
            }
        }

        function populateNonSppSelectors() {
            const bankSelector = document.getElementById('otherBankSelector');
            const yearFilter = document.getElementById('otherYearFilter');
            const otherBankFilter = document.getElementById('otherBankFilter');

            let bankOptions = '<option value="">Pilih Bank</option>';
            for (const bankName in bankColors) {
                bankOptions += `<option value="${bankName}">${bankName}</option>`;
            }
            if (bankSelector) {
                bankSelector.innerHTML = bankOptions;
            }
            if (otherBankFilter) {
                otherBankFilter.innerHTML = '<option value="all">Semua Bank</option>' + bankOptions;
            }
            const years = new Set(allOtherPayments
                .filter(p => p.timestamp && typeof p.timestamp.toDate === 'function')
                .map(p => p.timestamp.toDate().getFullYear())
            );
            const sortedYears = Array.from(years).sort((a,b) => b-a);
            yearFilter.innerHTML = '<option value="all">Semua Tahun</option>';
            sortedYears.forEach(year => {
                yearFilter.innerHTML += `<option value="${year}">${year}</option>`;
            });
        }
        
        function populateNonSppSummaryDashboard() {
            const yearFilter = document.getElementById('summaryYearFilter').value;
            const monthFilter = document.getElementById('summaryMonthFilter').value;
            const summaryContainer = document.getElementById('nonSppSummaryContainer');

            const filteredPayments = allOtherPayments.filter(p => {
                const paymentDate = p.timestamp ? p.timestamp.toDate() : null;
                if (!paymentDate) return false;
                let matchesYear = yearFilter === 'all' || paymentDate.getFullYear() == parseInt(yearFilter);
                let matchesMonth = monthFilter === 'all' || paymentDate.getMonth() == parseInt(monthFilter);
                return matchesYear && matchesMonth;
            });

            const bankTransactionCounts = filteredPayments.reduce((acc, payment) => {
                const bankName = payment.bank || 'Bank Tidak Diketahui';
                acc[bankName] = (acc[bankName] || 0) + 1;
                return acc;
            }, {});

            summaryContainer.innerHTML = '';
            const sortedBanks = Object.keys(bankTransactionCounts).sort();
            if (sortedBanks.length > 0) {
                sortedBanks.forEach(bank => {
                    const count = bankTransactionCounts[bank];
                    const divItem = document.createElement('div');
                    divItem.style.padding = '15px';
                    divItem.style.border = '1px solid var(--border-color)';
                    divItem.style.borderRadius = '8px';
                    divItem.style.backgroundColor = '#fff';
                    divItem.innerHTML = `
                        <h4>${bank}</h4>
                        <p>Total Transaksi: <b>${count}</b></p>
                    `;
                    summaryContainer.appendChild(divItem);
                });
            } else {
                summaryContainer.innerHTML = '<p class="no-data" style="grid-column: 1 / -1;">Tidak ada data transaksi untuk filter ini.</p>';
            }
        }

        function setupNonSppEventListeners() {
            document.getElementById('otherPaymentForm').addEventListener('submit', handleAddOtherPayment);
            
            setupOtherStudentFilterSearchBox();
            
            document.getElementById('otherYearFilter').addEventListener('change', () => { 
                otherCurrentPage = 1; 
                renderOtherPaymentsTable(filterNonSppData()); 
            });
            document.getElementById('otherRowsPerPage').addEventListener('change', (e) => {
                otherRowsPerPage = parseInt(e.target.value, 10);
                otherCurrentPage = 1; 
                renderOtherPaymentsTable(filterNonSppData()); 
            });
            document.getElementById('otherPrevBtn').addEventListener('click', () => { 
                if (otherCurrentPage > 1) { 
                    otherCurrentPage--; 
                    renderOtherPaymentsTable(filterNonSppData()); 
                } 
            });
            document.getElementById('otherNextBtn').addEventListener('click', () => {
                const totalPages = parseInt(document.getElementById('otherTotalPagesDisplay').textContent);
                if (otherCurrentPage < totalPages) { 
                    otherCurrentPage++; 
                    renderOtherPaymentsTable(filterNonSppData()); 
                }
            });
            document.getElementById('selectAllCheckbox').addEventListener('change', (e) => {
                document.querySelectorAll('#otherPaymentsTableBody .report-checkbox').forEach(checkbox => {
                    checkbox.checked = e.target.checked;
                });
            });
            setupNominalInput('otherNominal');
            document.getElementById('summaryYearFilter').addEventListener('change', populateNonSppSummaryDashboard);
            document.getElementById('summaryMonthFilter').addEventListener('change', populateNonSppSummaryDashboard);
            document.getElementById('editNonSppForm').addEventListener('submit', handleUpdateNonSppPayment);
            document.getElementById('otherBankFilter').addEventListener('change', () => {
                otherCurrentPage = 1;
                renderOtherPaymentsTable(filterNonSppData());
            });
        }
        async function handleAddOtherPayment(e) {
            e.preventDefault();
            const studentId = document.getElementById('otherStudentSelector').value;
            const studentName = document.getElementById('otherStudentSearchBox').value; 
            const nominalInput = document.getElementById('otherNominal').value;
            const nominal = parseFloat(nominalInput.replace(/\./g, ''));
            const bank = document.getElementById('otherBankSelector').value;
            const paymentDate = document.getElementById('otherPaymentDate').value;
            const keterangan = document.getElementById('otherKeterangan').value;
            const attachmentFile = document.getElementById('otherAttachment').files[0];
            const statusMessageDiv = document.getElementById('otherStatusMessage');
            
            if (!studentId || isNaN(nominal) || !bank || !paymentDate || !keterangan) {
                statusMessageDiv.textContent = 'Semua field harus diisi.';
                statusMessageDiv.style.color = 'red';
                return;
            }
            statusMessageDiv.textContent = 'Menyimpan laporan...';
            statusMessageDiv.style.color = 'blue';
            try {
                let attachmentBase64 = '';
                if (attachmentFile) {
                    if (attachmentFile.size > 3 * 1024 * 1024) {
                        statusMessageDiv.textContent = 'Error: Ukuran file terlalu besar. Maksimum 3MB.';
                        statusMessageDiv.style.color = 'red';
                        return;
                    }
                    if (attachmentFile.type.startsWith('image/')) {
                        attachmentBase64 = await compressImage(attachmentFile, 0.2); // Menggunakan kompresi default
                    } else if (attachmentFile.type === 'application/pdf') {
                        attachmentBase64 = await getBase64(attachmentFile);
                    } else {
                        statusMessageDiv.textContent = 'Error: Jenis file tidak didukung.';
                        statusMessageDiv.style.color = 'red';
                        return;
                    }
                }
                const docData = {
                    timestamp: Timestamp.fromDate(new Date(paymentDate)),
                    studentId, siswa: studentName, keterangan, bank, nominal,
                    bendaharaEmail: auth.currentUser.email,
                    attachmentBase64: attachmentBase64
                };
                await addDoc(collection(db, "other_payments"), docData);
                statusMessageDiv.textContent = 'Laporan berhasil disimpan!';
                statusMessageDiv.style.color = 'green';
                document.getElementById('otherPaymentForm').reset();
                document.getElementById('otherPaymentDate').valueAsDate = new Date();
                await loadNonSppData();
            } catch (error) {
                statusMessageDiv.textContent = `Error: ${error.message}`;
                statusMessageDiv.style.color = 'red';
            }
        }
        function filterNonSppData() {
            const studentId = document.getElementById('otherStudentFilter').value;
            const year = document.getElementById('otherYearFilter').value;
            const bank = document.getElementById('otherBankFilter').value;

            return allOtherPayments.filter(p => {
                const paymentDate = p.timestamp ? p.timestamp.toDate() : null;
                let matchesStudent = (studentId === 'all' || p.studentId === studentId);
                let matchesYear = year === 'all' || (paymentDate && paymentDate.getFullYear() == year);
                let matchesBank = bank === 'all' || p.bank === bank;

                return matchesStudent && matchesYear && matchesBank;
            });
        }
        function renderOtherPaymentsTable(data) {
            const tableBody = document.getElementById('otherPaymentsTableBody');
            const totalPages = Math.ceil(data.length / otherRowsPerPage);
            otherCurrentPage = Math.min(otherCurrentPage, totalPages || 1);
            const paginatedData = data.slice((otherCurrentPage - 1) * otherRowsPerPage, otherCurrentPage * otherRowsPerPage);
            tableBody.innerHTML = '';
            if (paginatedData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" class="no-data">Tidak ada laporan yang cocok dengan filter.</td></tr>';
            } else {
                paginatedData
                    .sort((a, b) => {
                        const dateA = a.timestamp && typeof a.timestamp.toDate === 'function' ? a.timestamp.toDate() : new Date(0);
                        const dateB = b.timestamp && typeof b.timestamp.toDate === 'function' ? b.timestamp.toDate() : new Date(0);
                        return dateB - dateA;
                    })
                    .forEach(item => {
                        const dateString = (item.timestamp && typeof item.timestamp.toDate === 'function')
                            ? item.timestamp.toDate().toLocaleDateString('id-ID')
                            : '<i style="color:red;">Tgl Invalid</i>';
                        const row = tableBody.insertRow();
                        
                        let attachmentLink = 'N/A';
                        if (item.attachmentBase64) {
                            const detailsJson = encodeURIComponent(JSON.stringify({
                                studentName: item.siswa,
                                attachmentBase64: item.attachmentBase64,
                            }));
                            attachmentLink = `<a href="#" onclick="event.preventDefault(); showOtherPaymentDetails('${detailsJson}')">Lihat Bukti</a>`;
                        }

                        row.innerHTML = `
                            <td class="checkbox-cell"><input type="checkbox" class="report-checkbox" data-id="${item.id}"></td>
                            <td>${dateString}</td>
                            <td>${item.siswa || '-'}</td>
                            <td>${item.keterangan || '-'}</td>
                            <td>${attachmentLink}</td>
                            <td>${item.bank || '-'}</td>
                            <td>Rp ${new Intl.NumberFormat('id-ID').format(item.nominal || 0)}</td>
                            <td><button type="button" class="action-btn-edit" onclick="openPinModal('nonspp', '${item.id}')">Edit</button></td>
                        `;
                    });
            }
            updatePaginationControls('non-spp', otherCurrentPage, totalPages);
            document.getElementById('selectAllCheckbox').checked = false;
        }

        window.showOtherPaymentDetails = function(detailsJsonEncoded) {
            const detailsJson = decodeURIComponent(detailsJsonEncoded);
            const details = JSON.parse(detailsJson);
            modalTitle.textContent = `Bukti Bayar Non-SPP untuk ${details.studentName}`;
            let contentHTML = ``;
            if (details.attachmentBase64) {
                const mimeType = details.attachmentBase64.split(';')[0].split(':')[1];
                contentHTML += `
                    <div style="margin-top: 15px;">
                        <p><strong>Bukti Pembayaran (Snapshot):</strong></p>
                `;
                if (mimeType.startsWith('image/')) {
                    contentHTML += `<img src="${details.attachmentBase64}" alt="Bukti Pembayaran" class="attachment-preview">`;
                } else if (mimeType === 'application/pdf') {
                    contentHTML += `<iframe src="${details.attachmentBase64}" class="attachment-iframe"></iframe>`;
                }
                contentHTML += `</div>`;
            }
            modalBodyContent.innerHTML = contentHTML;
            singleModal.style.display = 'flex';
        };

        async function openEditNonSppModal(paymentId) {
            const payment = allOtherPayments.find(p => p.id === paymentId);
            if (!payment) return;
            document.getElementById('editNonSppId').value = paymentId;
            document.getElementById('editNonSppStudentName').value = payment.siswa || 'Tidak Diketahui';
            document.getElementById('editNonSppNominal').value = new Intl.NumberFormat('id-ID').format(payment.nominal);
            document.getElementById('editNonSppBank').value = payment.bank;
            document.getElementById('editNonSppPaymentDate').value = (payment.timestamp && typeof payment.timestamp.toDate === 'function') ? payment.timestamp.toDate().toISOString().slice(0, 10) : '';
            document.getElementById('editNonSppKeterangan').value = payment.keterangan;
            document.getElementById('editNonSppAttachment').value = '';

            setupNominalInput('editNonSppNominal');
            editNonSppModal.style.display = 'flex';
        }

        async function handleUpdateNonSppPayment(e) {
            e.preventDefault();
            const paymentId = document.getElementById('editNonSppId').value;
            const nominalInput = document.getElementById('editNonSppNominal').value;
            const nominal = parseFloat(nominalInput.replace(/\./g, ''));
            const bank = document.getElementById('editNonSppBank').value;
            const paymentDate = document.getElementById('editNonSppPaymentDate').value;
            const keterangan = document.getElementById('editNonSppKeterangan').value;
            const attachmentFile = document.getElementById('editNonSppAttachment').files[0];
            const compressionQuality = 0.2; // Nilai kompresi default
            
            if (isNaN(nominal) || nominal <= 0 || !bank || !paymentDate || !keterangan) {
                alert('Semua field wajib diisi.');
                return;
            }

            try {
                const oldPayment = allOtherPayments.find(p => p.id === paymentId);
                let newAttachmentBase64 = oldPayment.attachmentBase64; // Ambil nilai lama sebagai default
                
                if (attachmentFile) {
                    if (attachmentFile.type.startsWith('image/')) {
                        newAttachmentBase64 = await compressImage(attachmentFile, compressionQuality);
                    } else if (attachmentFile.type === 'application/pdf') {
                        newAttachmentBase64 = await getBase64(attachmentFile);
                    }
                }
                
                const updatedData = {
                    nominal: nominal,
                    bank: bank,
                    timestamp: Timestamp.fromDate(new Date(paymentDate)),
                    keterangan: keterangan,
                    attachmentBase64: newAttachmentBase64 // Gunakan nilai yang sudah dipastikan valid
                };

                await updateDoc(doc(db, "other_payments", paymentId), updatedData);
                alert('Laporan Non-SPP berhasil diperbarui!');
                editNonSppModal.style.display = 'none';
                await loadNonSppData();
            } catch (error) {
                console.error("Gagal memperbarui laporan Non-SPP:", error);
                alert(`Error: ${error.message}`);
            }
        }

        window.deleteNonSppPayment = async function() {
            if (!confirm('Apakah Anda yakin ingin menghapus laporan ini?')) return;
            const paymentId = document.getElementById('editNonSppId').value;
            try {
                await deleteDoc(doc(db, "other_payments", paymentId));
                alert('Laporan Non-SPP berhasil dihapus!');
                editNonSppModal.style.display = 'none';
                await loadNonSppData();
            } catch (error) {
                console.error("Gagal menghapus laporan Non-SPP:", error);
                alert(`Error: ${error.message}`);
            }
        };

        window.generateAndSendSelectedOtherPaymentProof = async function() {
            const selectedCheckboxes = document.querySelectorAll('.report-checkbox:checked');
            if (selectedCheckboxes.length === 0) return alert('Harap centang setidaknya satu laporan.');
            const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.id);
            const selectedReports = allOtherPayments.filter(p => selectedIds.includes(p.id));
            const studentIds = new Set(selectedReports.map(p => p.studentId));
            if (studentIds.size > 1) return alert('Hanya bisa mengirim laporan untuk satu siswa dalam satu waktu.');
            const studentId = [...studentIds][0];
            const student = allStudents.find(s => s.id === studentId);
            if (!student || !student.phone) return alert("Nomor telepon siswa tidak ditemukan.");
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let yPos = 15;
            const addContentAndSave = () => {
                if (brandSettings && brandSettings.companyName) {
                    doc.setFontSize(12);
                    doc.setFont("helvetica", "normal");
                    doc.text(brandSettings.companyName, doc.internal.pageSize.getWidth() / 2, yPos, { align: "center" });
                    yPos += 8;
                }
                doc.setFontSize(16).text('Laporan Non-SPP', doc.internal.pageSize.getWidth() / 2, yPos, { align: 'center' });
                yPos += 15;
                doc.setFontSize(12).text(`Nama Siswa: ${student.name}`, 14, yPos);
                yPos += 10;
                doc.autoTable({
                    startY: yPos,
                    head: [['Tanggal', 'Keterangan', 'Bank', 'Nominal']],
                    body: selectedReports.map(p => {
                        const dateString = (p.timestamp && typeof p.timestamp.toDate === 'function')
                            ? p.timestamp.toDate().toLocaleDateString('id-ID')
                            : 'Tgl Invalid';
                        return [dateString, p.keterangan, p.bank, `Rp ${new Intl.NumberFormat('id-ID').format(p.nominal)}`];
                    })
                });
                
                const now = new Date();
                const timestamp = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}${String(now.getSeconds()).padStart(2, '0')}`;
                const fileName = `Laporan_Non-SPP_${student.name.replace(/ /g, '_')}_${timestamp}.pdf`;
                
                const message = `Halo, ini rincian laporan non-SPP untuk *${student.name}*.\n\n*Mohon lampirkan file PDF "${fileName}" yang baru saja Anda unduh.*`;
                
                const encodedMessage = encodeURIComponent(message);
                
                let whatsappUrl;
                if (isMobile) {
                    whatsappUrl = `whatsapp://send?phone=${formatPhoneNumber(student.phone)}&text=${encodedMessage}`;
                } else {
                    whatsappUrl = `https://web.whatsapp.com/send?phone=${formatPhoneNumber(student.phone)}&text=${encodedMessage}`;
                }
                
                doc.save(fileName, { returnPromise: true }).then(() => {
                    alert(`PDF telah diunduh: "${fileName}"\n\nSilakan lampirkan file tersebut di chat WhatsApp yang terbuka.`);
                    window.open(whatsappUrl, '_blank');
                });
            };
            if (brandSettings && brandSettings.logoBase64) {
                const img = new Image();
                img.src = brandSettings.logoBase64;
                img.onload = () => {
                    const desiredLogoHeight = 20;
                    const aspectRatio = img.width / img.height;
                    const calculatedLogoWidth = desiredLogoHeight * aspectRatio;
                    doc.addImage(img, 'PNG', (doc.internal.pageSize.getWidth() - calculatedLogoWidth) / 2, yPos, calculatedLogoWidth, desiredLogoHeight);
                    yPos += desiredLogoHeight + 10;
                    addContentAndSave();
                };
                img.onerror = () => addContentAndSave();
            } else {
                addContentAndSave();
            }
        }
        window.openTab = async function(tabName) {
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(tab => {
                tab.classList.remove('active');
            });
            const tabButtons = document.querySelectorAll('.tab-btn');
            tabButtons.forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`.tab-btn[onclick="openTab('${tabName}')"]`).classList.add('active');
            if(tabName === 'spp-tab') {
                renderSppTable();
            } else if (tabName === 'nonspp-tab') {
                await loadNonSppData();
                populateNonSppSummaryDashboard();
                renderOtherPaymentsTable(filterNonSppData());
            } else if (tabName === 'manajemen-siswa-tab') {
                renderStudentTable();
                renderPendingAssignmentTable();
                renderSummaryDashboard();
            }
        }

        async function updateCoachStudentCount(coachEmail, value) {
            if (!coachEmail) return;
            const coachRef = doc(db, "users", coachEmail);
            try {
                await updateDoc(coachRef, { studentCount: increment(value) });
            } catch (error) {
                if (error.code && (error.code.includes('not-found') || error.code.includes('no-document-to-update'))) {
                     await setDoc(coachRef, { studentCount: value > 0 ? value : 0 }, { merge: true });
                } else {
                    console.error(`Gagal update studentCount untuk ${coachEmail}:`, error);
                }
            }
        }

        async function handleAddStudent(e) {
            e.preventDefault();
            const studentName = document.getElementById('newStudentName').value.trim();
            const studentPhone = document.getElementById('newStudentPhone').value.trim();
            const coachEmail = document.getElementById('coachForStudentSelector').value;
            const statusMessageDiv = document.getElementById('studentStatusMessage');
            if (!studentName || !coachEmail) { statusMessageDiv.textContent = 'Nama & coach harus diisi.'; return; }
            try {
                await addDoc(collection(db, "students"), { name: studentName, phone: studentPhone, coachEmail: coachEmail, status: 'active' });
                await updateCoachStudentCount(coachEmail, 1);
                alert('Siswa berhasil ditambahkan.');
                document.getElementById('addStudentForm').reset();
                await loadAllData();
            } catch (error) { alert(`Error: ${error.message}`); }
        }

        function renderStudentTable() {
            const tableBody = document.getElementById('studentsTableBody');
            const showDisabled = document.getElementById('showDisabledStudents').checked;
            const coachFilter = document.getElementById('coachFilterSelector').value;
            const studentFilter = document.getElementById('studentListFilter').value;
            const levelFilter = document.getElementById('levelFilterSelector').value;
            let filteredStudents = allStudents;
            
            if (coachFilter !== 'all') { filteredStudents = filteredStudents.filter(s => s.coachEmail === coachFilter); }
            if (studentFilter !== 'all') { filteredStudents = filteredStudents.filter(s => s.id === studentFilter); }
            if (levelFilter !== 'all') { filteredStudents = filteredStudents.filter(s => s.studentLevel === levelFilter); }
            if (!showDisabled) { filteredStudents = filteredStudents.filter(s => (s.status || 'active') === 'active'); }

            const rowsPerPage = parseInt(document.getElementById('studentRowsPerPage').value, 10);
            const totalItems = filteredStudents.length;
            const totalPages = Math.ceil(totalItems / rowsPerPage) || 1;
            if (studentCurrentPage > totalPages) studentCurrentPage = totalPages;
            const start = (studentCurrentPage - 1) * rowsPerPage;
            const paginatedStudents = filteredStudents.slice(start, start + rowsPerPage);
            tableBody.innerHTML = '';
            if (paginatedStudents.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5">Tidak ada siswa yang cocok dengan filter.</td></tr>';
            } else {
                paginatedStudents.forEach(student => {
                    const coachData = allUsers.find(u => u.id === student.coachEmail);
                    const coachName = coachData ? coachData.name : (student.coachEmail || 'N/A');
                    const status = student.status || 'active';
                    const studentLevel = student.studentLevel || '';
                    const row = tableBody.insertRow();
                    row.className = status === 'disabled' ? 'disabled-row' : '';
                    const buttonText = status === 'active' ? 'Disable' : 'Enable';
                    const buttonClass = status === 'active' ? 'action-btn-disable' : 'action-btn-enable';
                    row.innerHTML = `<td class="checkbox-cell"><input type="checkbox" class="student-checkbox" value="${student.id}" data-coach="${student.coachEmail}"></td><td>${student.name}</td><td>${coachName}</td><td>${studentLevel}</td><td style="white-space: nowrap;"><button type="button" class="${buttonClass}" onclick="toggleStudentStatus('${student.id}','${status}')">${buttonText}</button> <button type="button" class="action-btn-edit" onclick="openStudentEditModal('${student.id}')">Edit</button></td>`;
                });
            }
            updatePaginationControls('student', studentCurrentPage, totalPages);
        }

        function renderPendingAssignmentTable() {
            const tableBody = document.getElementById('pendingAssignmentTableBody');
            const assignAndSaveBtn = document.getElementById('assignAndSaveBtn');
            const assignCoachSelector = document.getElementById('assignCoachSelector');
            const assignLevelSelector = document.getElementById('assignLevelSelector');
            const selectAllPendingCheckbox = document.getElementById('selectAllPendingCheckbox');
            const cancelImportBtn = document.getElementById('cancelImportBtn');
            
            tableBody.innerHTML = '';
            if (pendingImportStudents.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="3">Tidak ada siswa yang menunggu penugasan.</td></tr>';
                assignAndSaveBtn.disabled = true;
                assignCoachSelector.disabled = true;
                assignLevelSelector.disabled = true;
                selectAllPendingCheckbox.disabled = true;
                cancelImportBtn.disabled = true;
            } else {
                assignAndSaveBtn.disabled = false;
                assignCoachSelector.disabled = false;
                assignLevelSelector.disabled = false;
                selectAllPendingCheckbox.disabled = false;
                cancelImportBtn.disabled = false;
                pendingImportStudents.forEach((student, index) => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `<td><input type="checkbox" class="pending-student-checkbox" value="${index}"></td><td>${student.name}</td><td>${student.phone || 'N/A'}</td>`;
                });
            }
        }

        async function handleEditStudent(e) {
            e.preventDefault();
            const studentId = document.getElementById('editStudentId').value;
            const studentBefore = allStudents.find(s => s.id === studentId);
            const oldCoachEmail = studentBefore.coachEmail;
            const newCoachEmail = document.getElementById('editStudentCoach').value;

            // Ambil nama coach baru dari data allUsers
            const newCoachData = allUsers.find(u => u.id === newCoachEmail);
            const newCoachName = newCoachData ? newCoachData.name : newCoachEmail;

            const updatedData = {
                name: document.getElementById('editStudentName').value,
                studentLevel: document.getElementById('editStudentLevel').value,
                coachEmail: newCoachEmail,
                phone: document.getElementById('editStudentPhone').value
            };

            try {
                const batch = writeBatch(db);
                const studentDocRef = doc(db, "students", studentId);
                batch.update(studentDocRef, updatedData);

                // Perbarui jumlah siswa hanya jika coach berubah
                if (oldCoachEmail !== newCoachEmail) {
                    if (oldCoachEmail) {
                        const oldCoachRef = doc(db, "users", oldCoachEmail);
                        batch.update(oldCoachRef, { studentCount: increment(-1) });
                    }
                    if (newCoachEmail) {
                        const newCoachRef = doc(db, "users", newCoachEmail);
                        batch.update(newCoachRef, { studentCount: increment(1) });
                    }
                    
                    // Perbarui semua laporan siswa dengan coachEmail & nama coach yang baru
                    const reportsQuery = query(collection(db, "reports"), where("studentId", "==", studentId));
                    const reportsSnapshot = await getDocs(reportsQuery);
                    reportsSnapshot.forEach(reportDoc => {
                        const reportRef = doc(db, "reports", reportDoc.id);
                        batch.update(reportRef, { 
                            coachEmail: newCoachEmail,
                            coach: newCoachName 
                        });
                    });
                }
                
                await batch.commit();
                alert('Detail siswa dan riwayat laporan berhasil diperbarui!');
                document.getElementById('editStudentModal').style.display = 'none';
                await loadAllData();
            } catch(error) { 
                console.error("Gagal menyimpan dan memindahkan riwayat:", error);
                alert('Gagal menyimpan dan memindahkan riwayat. Periksa konsol untuk detail.'); 
            }
        }
        
        window.toggleStudentStatus = async function(studentId, currentStatus) {
            const newStatus = currentStatus === 'active' ? 'disabled' : 'active';
            if (confirm(`Yakin ingin ${newStatus === 'active' ? 'mengaktifkan' : 'menonaktifkan'} siswa ini?`)) {
                const studentBefore = allStudents.find(s => s.id === studentId);
                await updateDoc(doc(db, "students", studentId), { status: newStatus });
                if (studentBefore.coachEmail) {
                    const countChange = newStatus === 'active' ? 1 : -1;
                    await updateCoachStudentCount(studentBefore.coachEmail, countChange);
                }
                await loadAllData();
            }
        };

        async function handleBulkChange() {
            const allSelectedCheckboxes = document.querySelectorAll('.student-checkbox:checked');
            const newCoachEmail = document.getElementById('bulkCoachSelector').value;
            const statusMessageDiv = document.getElementById('bulkActionStatusMessage');

            if (allSelectedCheckboxes.length === 0 || !newCoachEmail) {
                statusMessageDiv.textContent = 'Pilih siswa dan coach tujuan.';
                statusMessageDiv.style.color = 'red';
                return;
            }
            
            if (!confirm(`Yakin ingin memindahkan ${allSelectedCheckboxes.length} siswa ke coach baru?`)) {
                return;
            }

            statusMessageDiv.textContent = 'Menerapkan perubahan...';
            statusMessageDiv.style.color = 'blue';

            try {
                const batch = writeBatch(db);
                const coachCountChanges = new Map();
                const reportsToUpdate = [];

                const selectedStudents = Array.from(allSelectedCheckboxes).map(checkbox => {
                    const studentId = checkbox.value;
                    return allStudents.find(s => s.id === studentId);
                });
                
                const newCoachData = allUsers.find(u => u.id === newCoachEmail);
                const newCoachName = newCoachData ? newCoachData.name : newCoachEmail;

                selectedStudents.forEach(student => {
                    const oldCoachEmail = student.coachEmail;
                    if (oldCoachEmail !== newCoachEmail) {
                        if (oldCoachEmail) {
                            coachCountChanges.set(oldCoachEmail, (coachCountChanges.get(oldCoachEmail) || 0) - 1);
                        }
                        coachCountChanges.set(newCoachEmail, (coachCountChanges.get(newCoachEmail) || 0) + 1);
                        
                        batch.update(doc(db, "students", student.id), { coachEmail: newCoachEmail });
                        reportsToUpdate.push(student.id);
                    }
                });

                if (reportsToUpdate.length === 0) {
                    statusMessageDiv.textContent = 'Tidak ada perubahan yang diperlukan.';
                    statusMessageDiv.style.color = 'green';
                    return;
                }
                
                coachCountChanges.forEach((change, coachEmail) => {
                    batch.update(doc(db, "users", coachEmail), { studentCount: increment(change) });
                });

                for (const studentId of reportsToUpdate) {
                    const reportsQuery = query(collection(db, "reports"), where("studentId", "==", studentId));
                    const reportsSnapshot = await getDocs(reportsQuery);
                    reportsSnapshot.forEach(reportDoc => {
                        const reportRef = doc(db, "reports", reportDoc.id);
                        batch.update(reportRef, { 
                            coachEmail: newCoachEmail,
                            coach: newCoachName
                        });
                    });
                }

                await batch.commit();
                statusMessageDiv.textContent = `Berhasil memindahkan ${selectedStudents.length} siswa ke coach baru.`;
                statusMessageDiv.style.color = 'green';
                document.getElementById('selectAllBulkCheckbox').checked = false; 
                await loadAllData();
            } catch (error) {
                statusMessageDiv.textContent = `Gagal mengganti coach: ${error.message}`;
                statusMessageDiv.style.color = 'red';
                console.error("Gagal mengganti coach secara massal:", error);
            }
        }

        async function handleBulkLevelChange() {
            const allSelectedCheckboxes = document.querySelectorAll('.student-checkbox:checked');
            const newStudentLevel = document.getElementById('bulkLevelSelector').value;
            const statusMessageDiv = document.getElementById('bulkActionStatusMessage');
            
            if (allSelectedCheckboxes.length === 0 || !newStudentLevel) {
                statusMessageDiv.textContent = 'Pilih siswa dan level tujuan.';
                statusMessageDiv.style.color = 'red';
                return;
            }
            
            if (!confirm(`Yakin ingin mengubah level ${allSelectedCheckboxes.length} siswa menjadi '${newStudentLevel}'?`)) {
                return;
            }

            statusMessageDiv.textContent = 'Menerapkan perubahan level...';
            statusMessageDiv.style.color = 'blue';

            try {
                const batch = writeBatch(db);
                let updatedCount = 0;

                allSelectedCheckboxes.forEach(checkbox => {
                    const studentId = checkbox.value;
                    batch.update(doc(db, "students", studentId), { studentLevel: newStudentLevel });
                    updatedCount++;
                });

                if (updatedCount === 0) {
                    statusMessageDiv.textContent = 'Tidak ada siswa yang dipilih.';
                    statusMessageDiv.style.color = 'orange';
                    return;
                }

                await batch.commit();
                statusMessageDiv.textContent = `Sukses! ${updatedCount} siswa telah diperbarui levelnya.`;
                statusMessageDiv.style.color = 'green';
                document.getElementById('selectAllBulkCheckbox').checked = false; 
                await loadAllData();
            } catch (error) {
                statusMessageDiv.textContent = `Gagal mengubah level siswa: ${error.message}`;
                statusMessageDiv.style.color = 'red';
                console.error("Gagal mengubah level siswa secara massal:", error);
            }
        }

        async function handleAssignAndSave() {
            const allSelectedCheckboxes = document.querySelectorAll('.pending-student-checkbox:checked');
            const newCoachEmail = document.getElementById('assignCoachSelector').value;
            const newStudentLevel = document.getElementById('assignLevelSelector').value;
            const assignStatusDiv = document.getElementById('assignStatusMessage');

            if (allSelectedCheckboxes.length === 0 || !newCoachEmail || !newStudentLevel) {
                assignStatusDiv.textContent = 'Harap pilih siswa, coach, dan level.';
                assignStatusDiv.style.color = 'red';
                return;
            }
            
            if (!confirm(`Yakin ingin menetapkan coach & level untuk ${allSelectedCheckboxes.length} siswa dan menyimpannya?`)) {
                return;
            }

            assignStatusDiv.textContent = 'Menyimpan data...';
            assignStatusDiv.style.color = 'blue';

            try {
                const batch = writeBatch(db);
                const coachCountChanges = new Map();
                const studentsToSave = [];

                allSelectedCheckboxes.forEach(checkbox => {
                    const studentIndex = parseInt(checkbox.value, 10);
                    const studentData = pendingImportStudents[studentIndex];
                    studentsToSave.push(studentData);

                    const studentRef = doc(collection(db, "students"));
                    batch.set(studentRef, {
                        name: studentData.name,
                        phone: studentData.phone || '',
                        coachEmail: newCoachEmail,
                        studentLevel: newStudentLevel,
                        status: 'active'
                    });

                    coachCountChanges.set(newCoachEmail, (coachCountChanges.get(newCoachEmail) || 0) + 1);
                });
                
                for (const [coachEmail, count] of coachCountChanges.entries()) {
                    const coachRef = doc(db, "users", coachEmail);
                    batch.update(coachRef, { studentCount: increment(count) });
                }

                await batch.commit();

                pendingImportStudents = pendingImportStudents.filter((_, index) => {
                    return !Array.from(allSelectedCheckboxes).some(cb => parseInt(cb.value, 10) === index);
                });
                localStorage.setItem('pendingImportStudents', JSON.stringify(pendingImportStudents));
                
                assignStatusDiv.textContent = `Berhasil menyimpan ${studentsToSave.length} siswa!`;
                assignStatusDiv.style.color = 'green';
                await loadAllData();
            } catch(error) {
                assignStatusDiv.textContent = `Gagal menyimpan: ${error.message}`;
                assignStatusDiv.style.color = 'red';
                console.error("Gagal menetapkan dan menyimpan siswa:", error);
            }
        }

        async function handleCancelImport() {
            if (confirm('Yakin ingin membatalkan impor dan menghapus semua data di tabel ini?')) {
                pendingImportStudents = [];
                localStorage.removeItem('pendingImportStudents');
                renderPendingAssignmentTable();
                document.getElementById('assignStatusMessage').textContent = 'Impor dibatalkan. Data dibersihkan.';
                document.getElementById('assignStatusMessage').style.color = 'green';
            }
        }

        async function handleTransfer() {
            const sourceCoachEmail = document.getElementById('sourceCoachSelector').value;
            const destCoachEmail = document.getElementById('destinationCoachSelector').value;
            const transferStatusDiv = document.getElementById('transferStatusMessage');
            if (!sourceCoachEmail || !destCoachEmail || sourceCoachEmail === destCoachEmail) {
                transferStatusDiv.textContent = 'Coach sumber dan tujuan harus berbeda.';
                transferStatusDiv.style.color = 'red';
                return;
            }
            
            const studentQuery = query(collection(db, "students"), where("coachEmail", "==", sourceCoachEmail), where("status", "==", "active"));
            const studentSnapshot = await getDocs(studentQuery);
            sessionReadCount += studentSnapshot.size; updateReadStatus();
            
            const studentsToMove = studentSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if (studentsToMove.length === 0) {
                transferStatusDiv.textContent = 'Coach sumber tidak memiliki siswa aktif.';
                transferStatusDiv.style.color = 'orange';
                return;
            }

            if (confirm(`Yakin memindahkan ${studentsToMove.length} siswa dari coach sumber ke coach tujuan?`)) {
                transferStatusDiv.textContent = 'Memindahkan siswa...';
                transferStatusDiv.style.color = 'blue';
                const batch = writeBatch(db);
                
                const studentIdsToUpdate = [];
                
                // Ambil data coach baru untuk mendapatkan namanya
                const newCoachData = allUsers.find(u => u.id === destCoachEmail);
                const newCoachName = newCoachData ? newCoachData.name : destCoachEmail;
                
                studentsToMove.forEach(studentDoc => { 
                    batch.update(doc(db, "students", studentDoc.id), { coachEmail: destCoachEmail }); 
                    studentIdsToUpdate.push(studentDoc.id);
                });

                batch.update(doc(db, "users", sourceCoachEmail), { studentCount: increment(-studentsToMove.length) });
                batch.update(doc(db, "users", destCoachEmail), { studentCount: increment(studentsToMove.length) });

                for (const studentId of studentIdsToUpdate) {
                    const reportsQuery = query(collection(db, "reports"), where("studentId", "==", studentId));
                    const reportsSnapshot = await getDocs(reportsQuery);
                    sessionReadCount += reportsSnapshot.size; updateReadStatus();
                    reportsSnapshot.forEach(reportDoc => {
                        const reportRef = doc(db, "reports", reportDoc.id);
                        batch.update(reportRef, { 
                            coachEmail: destCoachEmail,
                            coach: newCoachName // Tambahkan baris ini
                        });
                    });
                }
                
                await batch.commit();
                transferStatusDiv.textContent = `Sukses! ${studentsToMove.length} siswa dan riwayat laporannya telah dipindahkan.`;
                transferStatusDiv.style.color = 'green';
                await loadAllData();
            }
        }

        function populateCoachDropdowns() {
            const selectors = [
                document.getElementById('coachForStudentSelector'),
                document.getElementById('bulkCoachSelector'),
                document.getElementById('sourceCoachSelector'),
                document.getElementById('destinationCoachSelector'),
                document.getElementById('coachFilterSelector'),
                document.getElementById('editStudentCoach'),
                document.getElementById('assignCoachSelector')
            ];
            const activeCoaches = allUsers.filter(u => u.role === 'user' && (u.status || 'active') === 'active');
            let coachOptions = '';
            activeCoaches.forEach(coach => {
                coachOptions += `<option value="${coach.id}">${coach.name} (${coach.coachId || 'N/A'})</option>`;
            });
            selectors.forEach(selector => {
                if (!selector) return;
                const currentVal = selector.value;
                if (selector.id === 'coachFilterSelector') {
                    selector.innerHTML = '<option value="all" selected>-- Semua Coach --</option>' + coachOptions;
                } else {
                    selector.innerHTML = '<option value="">-- Pilih Coach --</option>' + coachOptions;
                }
                selector.value = currentVal || (selector.id === 'coachFilterSelector' ? 'all' : '');
            });
        }

        function populateLevelDropdowns() {
            const selectors = [
                document.getElementById('editStudentLevel'),
                document.getElementById('bulkLevelSelector'),
                document.getElementById('assignLevelSelector')
            ];
            selectors.forEach(selector => {
                if (!selector) return;
                const currentVal = selector.value;
                let options = '<option value="">-- Pilih Level --</option>';
                allLevels.forEach(level => {
                    options += `<option value="${level}">${level}</option>`;
                });
                selector.innerHTML = options;
                selector.value = currentVal;
            });
        }
        
        window.openStudentEditModal = function(studentId) {
            const student = allStudents.find(s => s.id === studentId);
            if (!student) return;
            document.getElementById('editStudentId').value = studentId;
            document.getElementById('editStudentName').value = student.name;
            const levelSelector = document.getElementById('editStudentLevel');
            levelSelector.value = student.studentLevel || "";
            const coachSelector = document.getElementById('editStudentCoach');
            coachSelector.value = student.coachEmail;
            document.getElementById('editStudentPhone').value = student.phone || '';
            document.getElementById('editStudentModal').style.display = 'block';
        };

        async function downloadExcelTemplate() {
            const header = ['nama', 'phone'];
            const ws = XLSX.utils.aoa_to_sheet([header]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Siswa Baru");
            XLSX.writeFile(wb, "Template_Siswa_Baru.xlsx");
        }

        async function handleImportStudent(e) {
            e.preventDefault();
            const file = document.getElementById('excelFileInput').files[0];
            const importStatusDiv = document.getElementById('importStatusMessage');
        
            if (!file) {
                importStatusDiv.textContent = 'Pilih file Excel terlebih dahulu.';
                importStatusDiv.style.color = 'red';
                return;
            }
            
            importStatusDiv.textContent = 'Memproses file...';
            importStatusDiv.style.color = 'blue';

            const reader = new FileReader();
            reader.onload = async function(event) {
                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonStudents = XLSX.utils.sheet_to_json(worksheet);

                    const existingStudentNames = new Set(allStudents.map(s => s.name.toLowerCase()));
                    
                    pendingImportStudents = [];
                    let newStudentCount = 0;
                    let skippedRows = 0;
        
                    for (const studentData of jsonStudents) {
                        const name = studentData.nama;
        
                        if (!name) {
                            console.warn(`Melewatkan baris karena nama siswa hilang: ${JSON.stringify(studentData)}`);
                            skippedRows++;
                            continue;
                        }

                        if (existingStudentNames.has(name.toLowerCase())) {
                            console.warn(`Melewatkan siswa '${name}' karena sudah ada di database.`);
                            skippedRows++;
                            continue;
                        }
        
                        pendingImportStudents.push({
                            id: `temp_${newStudentCount}_${Date.now()}`,
                            name: name,
                            phone: studentData.phone || ''
                        });
                        newStudentCount++;
                    }
                    
                    localStorage.setItem('pendingImportStudents', JSON.stringify(pendingImportStudents));
                    
                    if (newStudentCount === 0) {
                        importStatusDiv.textContent = 'Tidak ada siswa baru yang valid untuk diimpor. Silakan periksa file Anda.';
                        importStatusDiv.style.color = 'orange';
                    } else {
                        importStatusDiv.textContent = `Berhasil memuat ${newStudentCount} siswa. Silakan tetapkan coach & level di bawah.`;
                        importStatusDiv.style.color = 'green';
                    }

                    renderPendingAssignmentTable();
                    openTab('manajemen-siswa-tab');
        
                } catch (error) {
                    importStatusDiv.textContent = `Gagal mengimpor: ${error.message}`;
                    importStatusDiv.style.color = 'red';
                    console.error("Import Error:", error);
                }
            };
            reader.readAsArrayBuffer(file);
        };
    </script>
</body>
</html>