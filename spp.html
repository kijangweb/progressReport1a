<!DOCTYPE html>
<html lang="id">
<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pembayaran & Manajemen Siswa</title>
<style>
:root {
    --primary-color: #007bff;
    --secondary-color: #6c757d;
    --success-color: #28a745;
    --danger-color: #dc3545;
    --warning-color: #ffc107;
    --info-color: #17a2b8;
    --light-bg: #f8f9fa;
    --dark-text: #212529;
    --light-text: #fff;
    --border-color: #ddd;
    --box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
}
body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    padding: 10px;
    background-color: var(--light-bg);
    display: none;
    color: var(--dark-text);
    font-size: 13px;
}
.container {
    max-width: 1200px;
    margin: auto;
    background: var(--light-text);
    padding: 15px; /* DIKURANGI */
    border-radius: 8px;
    box-shadow: var(--box-shadow);
}
h1, h3, h4 {
    color: var(--primary-color);
    margin-bottom: 10px; /* DIKURANGI */
}
h1 {
    border-bottom: 2px solid var(--primary-color);
    padding-bottom: 8px;
}
.header-section {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    align-items: flex-start;
    gap: 8px;
}
.header-buttons {
    display: flex;
    flex-direction: column;
    gap: 8px;
    width: 100%;
}
.logout-btn, .refresh-btn, .btn-export, .btn-whatsapp, .btn-reset, .action-btn-disable, .action-btn-enable, .action-btn-edit {
    padding: 5px 10px; /* DIKURANGI */
    border: none;
    border-radius: 4px; /* DIKURANGI */
    cursor: pointer;
    font-size: 11px; /* DIKURANGI */
    transition: background-color 0.2s ease;
    width: 100%;
    text-align: center;
}
.logout-btn { background-color: var(--danger-color); color: var(--light-text); }
.logout-btn:hover { background-color: #c82333; }
.action-btn-disable { background-color: var(--warning-color); color: var(--dark-text); }
.action-btn-enable { background-color: var(--success-color); color: var(--light-text); }
.action-btn-edit { background-color: var(--primary-color); color: var(--light-text); }
.content-block {
    margin-top: 15px; /* DIKURANGI */
    padding: 12px; /* DIKURANGI */
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background-color: var(--light-bg);
}
.form-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 10px; /* DIKURANGI */
    align-items: end;
}
.form-grid .full-width { grid-column: 1; }
.form-group {
    display: flex;
    flex-direction: column;
    gap: 4px;
}
label {
    font-weight: 600;
    color: var(--dark-text);
}
input[type="text"], input[type="number"], input[type="email"], input[type="tel"], select, textarea, input[type="date"], input[type="file"], input[type="password"] {
    width: 100%;
    padding: 5px 7px; /* DIKURANGI */
    border: 1px solid #ced4da;
    border-radius: 4px; /* DIKURANGI */
    box-sizing: border-box;
    font-size: 12px; /* DIKURANGI */
}
select:focus, input:focus, textarea:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    outline: none;
}
#studentSelector option { padding: 4px; }
#paymentYear { width: auto; }
.month-selector {
    display: flex;
    flex-wrap: wrap;
    gap: 5px; /* DIKURANGI */
    margin-top: 8px;
}
.month-selector label {
    font-weight: normal;
    display: flex;
    align-items: center;
    cursor: pointer;
    gap: 5px;
    background-color: #e9ecef;
    padding: 4px 7px; /* DIKURANGI */
    border-radius: 4px; /* DIKURANGI */
    transition: background-color 0.2s ease;
}
.month-selector input[type="checkbox"] {
    appearance: none;
    width: 14px; /* DIKURANGI */
    height: 14px; /* DIKURANGI */
    border: 1px solid var(--secondary-color);
    border-radius: 3px;
    position: relative;
    cursor: pointer;
    margin: 0;
    flex-shrink: 0;
}
.month-selector input[type="checkbox"]:checked {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
}
.month-selector input[type="checkbox"]:checked::after {
    content: '✔';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 10px; /* DIKURANGI */
    color: var(--light-text);
}
.month-selector label:hover { background-color: #dee2e6; }
.btn, #addPaymentBtn, #addOtherPaymentBtn, #addStudentForm button, .bulk-action-container button, .action-btn, .transfer-section .action-btn {
    padding: 7px 14px; /* DIKURANGI */
    background-color: var(--success-color);
    color: var(--light-text);
    border: none;
    border-radius: 4px; /* DIKURANGI */
    cursor: pointer;
    font-size: 12px; /* DIKURANGI */
    font-weight: 600;
    margin-top: 12px; /* DIKURANGI */
    width: 100%;
}
.btn:hover, #addPaymentBtn:hover, #addOtherPaymentBtn:hover { background-color: #218838; }
#addOtherPaymentBtn { background-color: var(--info-color); }
#addOtherPaymentBtn:hover { background-color: #138496; }
.bulk-action-container button { background-color: var(--primary-color); }
.bank-color {
    display: inline-block;
    width: 14px; height: 14px;
    border-radius: 50%;
    margin-right: 5px;
    border: 1px solid #ccc;
}
.legend {
    margin-top: 8px;
    display: flex;
    flex-wrap: wrap;
    font-size: 0.9em;
    flex-direction: column;
    gap: 6px;
}
.legend-item { display: flex; align-items: center; }
#statusMessage, #otherStatusMessage, #studentStatusMessage, #importStatusMessage, #assignStatusMessage, #transferStatusMessage, #bulkActionStatusMessage, #pinVerificationMessage, #pinStatusMessage {
    margin-top: 10px; font-weight: 600;
}
.spp-table-controls, .filter-controls {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    align-items: stretch;
    gap: 8px;
    margin-bottom: 10px; /* DIKURANGI */
}
.spp-table-controls .filter-group, .filter-controls > div {
    display: flex;
    flex-direction: column;
    gap: 5px;
}
.spp-table-container, .student-table-container, #otherPaymentsTable-container {
    border: 1px solid var(--border-color);
    border-radius: 8px;
    overflow-x: auto;
}
.spp-table, .student-table, #otherPaymentsTable {
    width: 100%;
    border-collapse: collapse;
}
.spp-table th, .spp-table td, .student-table th, .student-table td, #otherPaymentsTable th, #otherPaymentsTable td {
    border: 1px solid var(--border-color);
    padding: 5px;
    vertical-align: middle;
    font-size: 11px;
    min-width: 65px;
    text-align: left;
}
.spp-table th, .student-table th, #otherPaymentsTable th {
    font-weight: 600;
    background-color: #e9ecef;
    white-space: nowrap;
}
.spp-table thead th { position: sticky; z-index: 10; }
.spp-table thead tr:first-child th { top: 0; }
.spp-table thead tr:nth-child(2) th {
    top: 28px;
    background-color: #e9ecef;
}
.spp-table thead tr:first-child th:first-child,
.spp-table tbody td:first-child {
    position: sticky;
    left: 0;
    background-color: var(--light-bg);
    z-index: 20;
    width: 25%;
    min-width: 150px;
    text-align: left;
    border-right: 2px solid #ccc;
}
.spp-table thead tr:first-child th:first-child { z-index: 30; }
.spp-table td { position: relative; }
.payment-info {
    background-color: #fff;
    padding: 4px;
    border-radius: 4px;
    min-height: 32px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    align-items: center;
}
.payment-info .payment-level, .payment-date {
    font-size: 0.9em;
    color: var(--secondary-color);
    margin-top: 2px;
}
.payment-amount { font-weight: 700; }
.payment-bank-color {
    display: block;
    width: 100%;
    height: 3px;
    border-radius: 4px 4px 0 0;
}
.attachment-link {
    display: inline-block;
    margin-top: 3px;
    text-decoration: none;
    color: var(--primary-color);
    font-weight: 500;
    transition: color 0.2s ease;
}
.attachment-link:hover { color: #0056b3; }
.btn-export, .btn-whatsapp {
    padding: 5px 10px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    transition: background-color 0.2s ease;
}
.btn-export { background-color: var(--primary-color); color: var(--light-text); }
.btn-export:hover { background-color: #0056b3; }
.btn-whatsapp { background-color: #25D366; color: var(--light-text); }
.btn-whatsapp:hover { background-color: #128C7E; }
.pagination-controls {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 8px;
    margin-top: 12px;
    flex-wrap: wrap;
}
.pagination-controls button {
    padding: 4px 8px;
    background-color: var(--primary-color);
    color: var(--light-text);
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 11px;
    transition: background-color 0.2s ease;
}
.pagination-controls button:disabled { background-color: #ccc; cursor: not-allowed; }
.no-data { color: #888; font-style: italic; }
.student-status {
    font-size: 0.85em;
    color: var(--secondary-color);
    margin-top: 3px;
    display: block;
}
.modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.9); justify-content: center; align-items: center; }
.modal-content { background-color: var(--light-bg); margin: auto; padding: 15px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); width: 90%; max-width: 600px; position: relative; }
.modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; margin-bottom: 12px; }
.modal-header h3 { margin: 0; color: var(--dark-text); }
.modal-body { display: flex; flex-direction: column; gap: 4px; }
.modal-body p { margin: 4px 0; }
.close-btn { color: var(--dark-text); font-size: 26px; font-weight: bold; cursor: pointer; transition: color 0.2s; }
.close-btn:hover { color: var(--secondary-color); }
.attachment-preview { max-width: 100%; height: auto; display: block; margin-top: 10px; border-radius: 8px; border: 1px solid var(--border-color); }
.attachment-iframe { width: 100%; height: 500px; border: 1px solid var(--border-color); border-radius: 8px; }
.back-button { background-color: var(--secondary-color); color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px; }
.payment-keterangan-modal { font-size: 1em; color: var(--dark-text); white-space: pre-wrap; text-align: left; padding-top: 8px; }
.btn-reset {
    background-color: var(--secondary-color);
    color: var(--light-text);
    padding: 5px 8px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 11px;
    transition: background-color 0.2s ease;
}
.btn-reset:hover { background-color: #5a6268; }
.spp-table .checkbox-cell, .student-table .checkbox-cell, #otherPaymentsTable .checkbox-cell {
    width: 30px; min-width: 30px; padding: 4px;
}
#readStatusIndicator {
    position: fixed;
    bottom: 8px; right: 8px;
    background-color: #212529;
    color: white;
    padding: 5px 10px;
    border-radius: 20px;
    font-size: 11px;
    font-family: monospace;
    z-index: 2000;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    opacity: 0.8;
    transition: opacity 0.3s;
}
#readStatusIndicator:hover { opacity: 1; }
#readStatusIndicator button { margin-left: 8px; padding: 2px 6px; font-size: 10px; cursor: pointer; }
.tabs { display: flex; border-bottom: 2px solid var(--border-color); margin-bottom: 12px; align-items: flex-end; gap: 1px; }
.tab-btn { background-color: #f0f0f0; border: 1px solid var(--border-color); border-bottom: none; padding: 7px 14px; cursor: pointer; font-size: 0.9em; font-weight: 600; color: var(--secondary-color); transition: background-color 0.2s ease; border-radius: 5px 5px 0 0; }
.tab-btn:hover { background-color: #e9e9e9; }
.tab-btn.active { background-color: var(--light-bg); color: var(--primary-color); border: 1px solid var(--border-color); border-bottom: none; position: relative; z-index: 1; box-shadow: none; }
.tab-content { display: none; padding-top: 12px; border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 8px 8px; box-shadow: var(--box-shadow); }
.tab-content.active { display: block; }
.disabled-row td { text-decoration: line-through; color: #999; background-color: #f8f9fa !important; }
.filter-controls { margin: 10px 0 5px 0; display: flex; flex-direction: column; gap: 8px; align-items: stretch; flex-wrap: wrap; }
.form-row { display: flex; flex-direction: column; gap: 8px; }
.form-row > div { flex: 1; }
.bulk-action-content { display: flex; flex-direction: column; gap: 8px; }
.spp-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 12px;
    flex-direction: column;
    gap: 8px;
}
.pagination-container {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}
.pagination-container select, .pagination-container button {
    padding: 5px 8px;
    border-radius: 4px;
    border: 1px solid var(--border-color);
    cursor: pointer;
    transition: background-color 0.2s;
}
.pagination-container button { background-color: var(--primary-color); color: var(--light-text); }
.pagination-container button:hover:not(:disabled) { background-color: #0056b3; }
.pagination-container button:disabled { background-color: #e9ecef; color: #999; cursor: not-allowed; }
#laporan-aktivitas-tab .actions { display: flex; gap: 8px; align-items: center; }
#laporan-aktivitas-tab .filters { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
#laporan-aktivitas-tab table { width: 100%; border-collapse: collapse; }
#laporan-aktivitas-tab th, #laporan-aktivitas-tab td {
    border: 1px solid #ddd;
    padding: 5px;
    vertical-align: middle;
    text-align: left;
}
#laporan-aktivitas-tab .pagination { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
#studentFilterIndicator { display: none; margin-bottom: 8px; background-color: #e0f7fa; padding: 5px; border-radius: 4px; }

.student-btn {
    background: none;
    border: none;
    color: var(--primary-color);
    text-decoration: underline;
    cursor: pointer;
    padding: 0;
    /* --- PERBAIKAN UNTUK NAMA PANJANG --- */
    text-align: left;
    display: block;
    width: 100%;
    white-space: normal; /* Izinkan nama untuk wrap (patah baris) */
}

.highlight-row { background-color: #fffbe6 !important; }
.eye-btn { background: none; border: none; cursor: pointer; font-size: 1.2em; }
#trackingContainer { margin-top: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
.tracking-item { border-bottom: 1px solid #eee; padding: 4px 0; font-size: 0.9em; }
#laporan-aktivitas-tab th:first-child, #laporan-aktivitas-tab td:first-child { width: 1%; white-space: nowrap; text-align: center; }
#laporan-aktivitas-tab th:nth-child(3), #laporan-aktivitas-tab td:nth-child(3) { white-space: nowrap; }

#studentsTable td:nth-child(2) { text-align: left; width: 30%; }
#studentsTable th:nth-child(4), #studentsTable td:nth-child(4) { white-space: nowrap; }
#studentsTable th:last-child, #studentsTable td:last-child { width: 150px; text-align: center; }
#otherPaymentsTable td:nth-child(3), 
#otherPaymentsTable td:nth-child(4) { text-align: left; }

/* PENGECUALIAN & PENEGASAN ALIGNMENT */
.spp-table td, .spp-table th {
    text-align: center;
}
.spp-table td:first-child, .spp-table th:first-child {
    text-align: left;
}
#laporan-aktivitas-tab th:is(:nth-child(1), :nth-child(4), :nth-child(8)),
#laporan-aktivitas-tab td:is(:nth-child(1), :nth-child(4), :nth-child(8)) {
    text-align: center;
}
#studentsTable th:nth-child(5), #studentsTable td:nth-child(5) {
    text-align: center;
}
#otherPaymentsTable th:is(:nth-child(1), :nth-child(2), :nth-child(8)),
#otherPaymentsTable td:is(:nth-child(1), :nth-child(2), :nth-child(8)) {
    text-align: center;
}

@media (min-width: 768px) {
    .header-section { flex-direction: row; align-items: center; }
    .header-buttons { flex-direction: row; width: auto; }
    .logout-btn, .refresh-btn, .btn-export, .btn-whatsapp, .btn-reset, .action-btn-disable, .action-btn-enable, .action-btn-edit { width: auto; }
    .form-grid { grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); }
    .form-grid .full-width { grid-column: 1 / -1; }
    .btn, #addPaymentBtn, #addOtherPaymentBtn, #addStudentForm button, .bulk-action-container button, .action-btn, .transfer-section .action-btn { width: auto; }
    .legend { flex-direction: row; gap: 10px; }
    .spp-table-controls, .filter-controls { flex-direction: row; align-items: center; }
    .spp-table-controls .filter-group, .filter-controls > div { flex-direction: row; }
    .spp-table .checkbox-cell, .student-table .checkbox-cell, #otherPaymentsTable .checkbox-cell { width: 35px; min-width: 35px; }
    .form-row { flex-direction: row; align-items: flex-end; justify-content: flex-start; gap: 8px; }
    .form-row > div { flex: 1; min-width: 140px; }
    .form-row button { width: auto; align-self: flex-end; }
    .bulk-action-content { display: flex; flex-direction: row; align-items: flex-end; gap: 8px; flex-wrap: wrap; }
    .bulk-action-content .form-group { display: flex; flex-direction: row; align-items: center; gap: 8px; margin-bottom: 0; }
    .bulk-action-content select { width: 200px; }
    .bulk-action-content button { width: auto; margin-top: 0; }
    .transfer-section > .form-row { flex-direction: row; align-items: flex-end; gap: 10px; justify-content: flex-start; }
    .transfer-section .form-row > div { display: flex; flex-direction: column; align-items: flex-start; }
    .transfer-section button { width: auto; margin-top: 0; }
    .spp-footer { flex-direction: row; justify-content: space-between; align-items: center; }
    #sppSummaryFilters { display: flex; flex-direction: row; justify-content: flex-start; gap: 15px; margin-bottom: 15px; }
}
@media (max-width: 767px) {
    .tabs { flex-wrap: nowrap; overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; -ms-overflow-style: none; border-bottom: 2px solid var(--border-color); }
    .tabs::-webkit-scrollbar { display: none; }
    .tab-btn { flex-shrink: 0; }
    #sppSummaryFilters { flex-direction: column; gap: 8px; }
}
</style>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>

</head>
<body>

    <div id="readStatusIndicator">Reads Sesi Ini: 0</div>
    <div class="container">
        <div class="header-section">
            <h1 id="userGreeting">Panel Bendahara</h1>
            <div class="header-buttons">
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>
        <div class="tabs">
            <button class="tab-btn" onclick="openTab('laporan-aktivitas-tab')">Laporan Aktivitas</button>
            <button class="tab-btn active" onclick="openTab('spp-tab')">Pembayaran SPP</button>
            <button class="tab-btn" onclick="openTab('nonspp-tab')">Laporan Non-SPP</button>
            <button class="tab-btn" onclick="openTab('manajemen-siswa-tab')">Manajemen Siswa</button>
        </div>

        <div id="spp-tab" class="tab-content active">
            
            <div class="content-block">
                <h3>Ringkasan Status Pembayaran SPP 
                    <button class="btn-export" onclick="openWhatsappSettings('spp')" style="margin-left: 10px; padding: 5px 15px; font-size: 14px;">Pengaturan Template SPP</button>
                </h3>
                
                <div id="sppSummaryFilters" class="filter-controls">
                    <div class="form-group">
                        <label for="summarySppYearFilter">Pilih Tahun:</label>
                        <select id="summarySppYearFilter"></select>
                    </div>
                    <div class="form-group">
                        <label for="summarySppMonthFilter">Pilih Bulan:</label>
                        <select id="summarySppMonthFilter">
                            <option value="0">Januari</option>
                            <option value="1">Februari</option>
                            <option value="2">Maret</option>
                            <option value="3">April</option>
                            <option value="4">Mei</option>
                            <option value="5">Juni</option>
                            <option value="6">Juli</option>
                            <option value="7">Agustus</option>
                            <option value="8">September</option>
                            <option value="9">Oktober</option>
                            <option value="10">November</option>
                            <option value="11">Desember</option>
                        </select>
                    </div>
                </div>
                <div id="sppSummaryDashboard" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    <div style="padding: 15px; border: 1px solid var(--border-color); border-radius: 8px; background-color: #fff;">
                        <h4>Status <span id="summaryMonthName"></span> (<span id="summaryYearDisplay"></span>)</h4>
                        <p>Status Bulan Terpilih: <b id="currentMonthStatus">Menghitung...</b></p>
                        <p>Total Siswa Aktif: <b id="totalActiveStudentsSPP">0</b></p>
                        <p>Siswa Lunas: <b id="studentsPaidFull">0</b></p>
                        <p>Siswa Belum Lunas: <b id="studentsNotPaid">0</b></p>
                    </div>
                    <div style="padding: 15px; border: 1px solid var(--border-color); border-radius: 8px; background-color: #fff;">
                        <h4>Rekap Bank (Bulan Terpilih)</h4>
                        <ul id="bankMonthlySummary" style="list-style-type: none; padding: 0; margin: 0;"></ul>
                    </div>
                </div>
            </div>
            <div class="content-block">
                <h3>Input Pembayaran Baru</h3>
                <form id="sppPaymentForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="studentSearchBox">Nama & Status Siswa</label>
                            <input type="text" id="studentSearchBox" placeholder="Cari siswa..." required>
                            <input type="hidden" id="studentSelector" name="studentId">
                        </div>
                        <div class="form-group"><label for="nominal">Nominal (Rp)</label><input type="text" id="nominal" required></div>
                        <div class="form-group">
                            <label for="bankSelector">Bank</label>
                            <select id="bankSelector" required></select>
                        </div>
                        <div class="form-group">
                            <label for="paymentDate">Tanggal Bayar</label>
                            <input type="date" id="paymentDate" required>
                        </div>
                        <div class="form-group">
                            <label for="paymentYear">Tahun Pembayaran</label>
                            <input type="number" id="paymentYear" required min="2000" value="2025">
                        </div>
                        <div class="form-group full-width">
                            <label>Bulan yang Dibayar</label>
                            <div class="month-selector" id="monthSelector"></div>
                        </div>
                        <div class="form-group full-width"><label for="keterangan">Keterangan</label><textarea id="keterangan" rows="2"></textarea></div>
                        <div class="form-group full-width"><label for="attachment">Upload Bukti Bayar</label><input type="file" id="attachment" accept="image/*,.pdf"></div>
                        <div class="form-group full-width">
                            <label for="imageQualitySelector">Kualitas Bukti Bayar (Kompresi)</label>
                            <select id="imageQualitySelector">
                                <option value="0.3">Kualitas Tinggi (30%)</option>
                                <option value="0.2" selected>Kualitas Sedang (20%)</option>
                                <option value="0.1">Kualitas Rendah (10%)</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" id="addPaymentBtn">Simpan Pembayaran</button>
                    <div id="statusMessage"></div>
                </form>
            </div>
            <div class="content-block">
                <h3>Riwayat Pembayaran</h3>
                <div class="spp-table-controls">
                    <div class="filter-group">
                        <label for="studentFilterSearchBox">Nama Siswa:</label>
                        <input type="text" id="studentFilterSearchBox" placeholder="Cari siswa...">
                        <input type="hidden" id="studentFilter" value="all">
                    </div>
                    <div class="filter-group">
                        <label for="yearFilter">Tahun:</label>
                        <select id="yearFilter"></select>
                    </div>
                    <div class="filter-group">
                        <label for="monthFilter">Bulan:</label>
                        <select id="monthFilter">
                            <option value="all">Semua Bulan</option>
                            <option value="0">Januari</option>
                            <option value="1">Februari</option>
                            <option value="2">Maret</option>
                            <option value="3">April</option>
                            <option value="4">Mei</option>
                            <option value="5">Juni</option>
                            <option value="6">Juli</option>
                            <option value="7">Agustus</option>
                            <option value="8">September</option>
                            <option value="9">Oktober</option>
                            <option value="10">November</option>
                            <option value="11">Desember</option>
                        </select>
                    </div>
                    <div class="legend" id="bankLegend"></div>
                    <button class="btn-whatsapp" onclick="generateAndSendPaymentProof()">Kirim Bukti Bayar via WhatsApp</button>
                </div>
                <div class="spp-table-container">
                    <table class="spp-table" id="sppTable">
                        <thead>
                            <tr id="tableHeader"></tr>
                            <tr id="tableSubHeader"></tr>
                        </thead>
                        <tbody id="sppTableBody"></tbody>
                    </table>
                </div>
                <div class="spp-footer">
                    <div class="pagination-container">
                        <span>Tampilkan:</span>
                        <select id="rowsPerPage"><option value="5" selected>5</option><option value="10">10</option><option value="15">15</option><option value="20">20</option></select>
                    </div>
                    <div class="pagination-container">
                        <button id="prevBtn" disabled>&laquo; Sebelumnya</button>
                        <span>Halaman <b id="currentPageDisplay">1</b> dari <b id="totalPagesDisplay">1</b></span>
                        <button id="nextBtn" disabled>Berikutnya &raquo;</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="nonspp-tab" class="tab-content">
            <div class="content-block">
                <h3>Ringkasan Transaksi Non-SPP 
                    <button class="btn-export" onclick="openWhatsappSettings('nonspp')" style="margin-left: 10px; padding: 5px 15px; font-size: 14px;">Pengaturan Template Non-SPP</button>
                </h3>
                <div class="filter-controls" style="margin-bottom: 20px;">
                    <div class="form-group">
                        <label for="summaryYearFilter">Tahun:</label>
                        <select id="summaryYearFilter"></select>
                    </div>
                    <div class="form-group">
                        <label for="summaryMonthFilter">Bulan:</label>
                        <select id="summaryMonthFilter">
                            <option value="all">Semua Bulan</option>
                            <option value="0">Januari</option>
                            <option value="1">Februari</option>
                            <option value="2">Maret</option>
                            <option value="3">April</option>
                            <option value="4">Mei</option>
                            <option value="5">Juni</option>
                            <option value="6">Juli</option>
                            <option value="7">Agustus</option>
                            <option value="8">September</option>
                            <option value="9">Oktober</option>
                            <option value="10">November</option>
                            <option value="11">Desember</option>
                        </select>
                    </div>
                </div>
                <div class="summary-dashboard" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    <div id="nonSppSummaryContainer" style="grid-column: 1 / -1; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        </div>
                    <div id="nonSppTotalNominal" style="padding: 15px; border: 1px solid var(--border-color); border-radius: 8px; background-color: #fff; text-align: center;">
                         <h4>Total Nominal Transaksi</h4>
                         <p>Total: <b id="totalNominalDisplay">Rp 0</b></p>
                    </div>
                </div>
            </div>

            <div class="content-block">
                <h3>Input Laporan Non-SPP</h3>
                <form id="otherPaymentForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="otherStudentSearchBox">Nama Siswa</label>
                            <input type="text" id="otherStudentSearchBox" placeholder="Cari siswa..." required>
                            <input type="hidden" id="otherStudentSelector" name="studentId">
                        </div>
                        <div class="form-group"><label for="otherNominal">Nominal (Rp)</label><input type="text" id="otherNominal" required></div>
                        <div class="form-group">
                            <label for="otherBankSelector">Bank</label>
                            <select id="otherBankSelector" required>
                                <option value="">Pilih Bank</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="otherPaymentDate">Tanggal Bayar</label>
                            <input type="date" id="otherPaymentDate" required>
                        </div>
                        <div class="form-group full-width"><label for="otherKeterangan">Keterangan</label><textarea id="otherKeterangan" rows="2" required></textarea></div>
                        <div class="form-group full-width"><label for="otherAttachment">Upload Bukti Bayar</label><input type="file" id="otherAttachment" accept="image/*,.pdf" required></div>
                    </div>
                    <button type="submit" id="addOtherPaymentBtn">Simpan Laporan</button>
                    <div id="otherStatusMessage"></div>
                </form>
            </div>
            
            <div class="content-block">
                <h3>Riwayat Laporan Non-SPP</h3>
                <div class="spp-table-controls">
                    <div class="filter-group">
                        <label for="otherStudentFilterSearchBox">Siswa:</label>
                        <input type="text" id="otherStudentFilterSearchBox" placeholder="Cari siswa...">
                        <input type="hidden" id="otherStudentFilter" value="all">
                    </div>
                    <div class="filter-group">
                        <label for="otherYearFilter">Tahun:</label>
                        <select id="otherYearFilter"></select>
                    </div>
                    <div class="filter-group">
                        <label for="otherBankFilter">Bank:</label>
                        <select id="otherBankFilter">
                            <option value="all">Semua Bank</option>
                        </select>
                    </div>
                </div>
                <div class="spp-table-container">
                    <table class="spp-table" id="otherPaymentsTable">
                        <thead><tr><th class="checkbox-cell"><input type="checkbox" id="selectAllCheckbox" title="Pilih Semua"></th><th>Tanggal</th><th>Nama Siswa</th><th>Keterangan</th><th>Bukti Bayar</th><th>Bank</th><th>Nominal</th><th>Aksi</th></tr></thead>
                        <tbody id="otherPaymentsTableBody"></tbody>
                    </table>
                </div>
                <div class="spp-footer">
                    <div class="pagination-container">
                        <span>Tampilkan:</span>
                        <select id="otherRowsPerPage"><option value="5" selected>5</option><option value="10">10</option><option value="15">15</option><option value="20">20</option></select>
                    </div>
                    <div class="pagination-container">
                        <button id="otherPrevBtn" disabled>&laquo; Sebelumnya</button>
                        <span>Halaman <b id="otherCurrentPageDisplay">1</b> dari <b id="otherTotalPagesDisplay">1</b></span>
                        <button id="otherNextBtn" disabled>Berikutnya &raquo;</button>
                    </div>
                </div>
                <button class="btn-whatsapp" onclick="generateAndSendSelectedOtherPaymentProof()" style="margin-top: 20px;">Kirim Laporan Terpilih via WhatsApp</button>
            </div>
        </div>

        <div id="manajemen-siswa-tab" class="tab-content">
            <div class="content-block">
                <h3>Ringkasan Data</h3>
                <div class="summary-dashboard" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    <div style="padding: 15px; border: 1px solid var(--border-color); border-radius: 8px; background-color: #fff;">
                        <h4>Ringkasan Total</h4>
                        <p>Total Siswa Aktif: <b id="summaryTotalStudents">0</b></p>
                        <p>Total Coach Aktif: <b id="summaryTotalCoaches">0</b></p>
                    </div>
                    <div style="padding: 15px; border: 1px solid var(--border-color); border-radius: 8px; background-color: #fff;">
                        <h4>Siswa Aktif per Level</h4>
                        <ul id="summaryActiveStudentsByLevel" style="list-style-type: none; padding: 0; margin: 0;"></ul>
                    </div>
                </div>
            </div>
            
            <div class="content-block">
                <h3>Tambah & Impor Siswa</h3>
                <form id="addStudentForm">
                    <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
                        <div class="form-group">
                            <label for="newStudentName">Nama Lengkap Siswa</label>
                            <input type="text" id="newStudentName" placeholder="Nama Lengkap" required>
                        </div>
                        <div class="form-group">
                            <label for="newStudentPhone">No. Telepon</label>
                            <input type="tel" id="newStudentPhone" placeholder="cth: 0812...">
                        </div>
                        <div class="form-group">
                            <label for="coachForStudentSelector">Tetapkan Coach</label>
                            <select id="coachForStudentSelector" required></select>
                        </div>
                        <div class="form-group">
                            <button type="submit" id="addStudentBtn" class="action-btn" style="background-color: var(--success-color);">Tambah Siswa</button>
                        </div>
                    </div>
                </form>
                <div id="studentStatusMessage" class="status-message"></div>

                <div style="margin-top: 30px;">
                    <p style="margin-bottom: 10px;">Atau, impor siswa dari file Excel (.xlsx).</p>
                    <div class="form-row" style="align-items: center; gap: 15px;">
                        <button type="button" id="downloadExcelTemplateBtn" class="action-btn" style="background-color: var(--info-color); width: 200px; margin-top: 0;">Unduh Template Excel</button>
                        <form id="importStudentForm" style="display: contents;">
                            <div class="form-group" style="flex: 1;">
                                <input type="file" id="excelFileInput" accept=".xlsx" required>
                            </div>
                            <div class="form-group" style="width: auto;">
                                <button type="submit" class="action-btn" style="background-color: var(--primary-color); width: 150px; margin-top: 0;">Muat File</button>
                            </div>
                        </form>
                    </div>
                    <div id="importStatusMessage" class="status-message"></div>
                </div>
            </div>

            <div class="content-block">
                <h3>Siswa Baru Menunggu Penugasan</h3>
                <p>Siswa di bawah ini menunggu penetapan coach dan level sebelum disimpan ke database utama.</p>
                <div class="student-table-container">
                    <table class="student-table" id="pendingAssignmentTable">
                        <thead>
                            <tr>
                                <th style="width: 5%;"><input type="checkbox" id="selectAllPendingCheckbox"></th>
                                <th>Nama Siswa</th>
                                <th>No. Telepon</th>
                            </tr>
                        </thead>
                        <tbody id="pendingAssignmentTableBody"></tbody>
                    </table>
                </div>
                <div class="bulk-action-content" style="margin-top: 20px;">
                    <div class="form-group">
                        <label for="assignCoachSelector">Tetapkan Coach:</label>
                        <select id="assignCoachSelector"></select>
                    </div>
                    <div class="form-group">
                        <label for="assignLevelSelector">Tetapkan Level:</label>
                        <select id="assignLevelSelector"></select>
                    </div>
                    <button type="button" id="assignAndSaveBtn" class="action-btn" style="background-color: var(--success-color);">Terapkan & Simpan</button>
                    <button type="button" id="cancelImportBtn" class="action-btn" style="background-color: var(--danger-color);">Batalkan Impor</button>
                </div>
                <div id="assignStatusMessage" class="status-message"></div>
            </div>
            
            <div class="content-block">
                <h3>Daftar Siswa (Manajemen Aktif)</h3>
                <div class="filter-controls">
                    <div class="form-group">
                        <label for="studentListSearchBox">Cari Siswa:</label>
                        <input type="text" id="studentListSearchBox" placeholder="Ketik nama siswa...">
                        <input type="hidden" id="studentListFilter" value="all">
                    </div>
                    <div class="form-group">
                        <label for="levelFilterSelector">Level:</label>
                        <select id="levelFilterSelector"><option value="all">Semua Level</option></select>
                    </div>
                    <div class="form-group">
                        <label for="coachFilterSelector">Coach:</label>
                        <select id="coachFilterSelector"></select>
                    </div>
                    <div class="form-group" style="flex-direction: row; align-items: center;">
                        <input type="checkbox" id="showDisabledStudents" style="margin-right: 5px;">
                        <label for="showDisabledStudents">Tampilkan Siswa Nonaktif</label>
                    </div>
                </div>
                <div class="student-table-container">
                    <table class="student-table" id="studentsTable"><thead><tr><th style="width: 5%;"><input type="checkbox" id="selectAllBulkCheckbox"></th><th>Nama Siswa</th><th>Coach Saat Ini</th><th>Level Siswa</th><th style="width: 15%;">Aksi</th></tr></thead><tbody id="studentsTableBody"></tbody></table>
                </div>
                <div class="spp-footer">
                    <div class="pagination-container">
                        <span>Tampilkan:</span>
                        <select id="studentRowsPerPage"><option value="5" selected>5</option><option value="10">10</option><option value="15">15</option><option value="20">20</option></select>
                    </div>
                    <div class="pagination-container">
                        <button type="button" id="studentPrevBtn" disabled>&laquo; Sebelumnya</button>
                        <span>Halaman <b id="studentCurrentPage">1</b> dari <b id="studentTotalPages">1</b></span>
                        <button type="button" id="studentNextBtn" disabled>Berikutnya &raquo;</button>
                    </div>
                </div>
            </div>

            <div class="content-block">
                <h3>Pilihan Aksi Massal</h3>
                <div class="bulk-action-content">
                    <div class="form-group">
                        <label for="bulkCoachSelector">Ganti coach ke:</label>
                        <select id="bulkCoachSelector"></select>
                        <button type="button" id="bulkChangeCoachBtn" class="action-btn" style="background-color: #007bff; margin-top: 10px; padding: 8px 12px; font-size: 14px;">Terapkan</button>
                    </div>
                    <div class="form-group">
                        <label for="bulkLevelSelector">Ganti level ke:</label>
                        <select id="bulkLevelSelector"></select>
                        <button type="button" id="bulkChangeLevelBtn" class="action-btn" style="background-color: #007bff; margin-top: 10px; padding: 8px 12px; font-size: 14px;">Terapkan</button>
                    </div>
                </div>
                <div id="bulkActionStatusMessage" class="status-message"></div>
            </div>
            
            <div class="content-block">
                <h3>Pindah Grup Coach</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="sourceCoachSelector">Dari Coach:</label>
                        <select id="sourceCoachSelector"></select>
                    </div>
                    <div class="form-group">
                        <label for="destinationCoachSelector">Ke Coach:</label>
                        <select id="destinationCoachSelector"></select>
                    </div>
                    <div class="form-group">
                        <button type="button" id="transferStudentsBtn" class="action-btn" style="background-color: #17a2b8;">Pindahkan Siswa</button>
                    </div>
                </div>
                <div id="transferStatusMessage" class="status-message"></div>
            </div>
        </div>

        <div id="laporan-aktivitas-tab" class="tab-content">
            <div class="header-section">
                <h3 id="mainHeader" style="margin: 0; padding: 0;">Laporan Aktivitas</h3>
                <div class="actions" style="display: flex; gap: 10px; align-items: center;">
                  <button id="exportAndSendBtn" class="btn-whatsapp">Export PDF & Kirim WA</button>
                  <button id="exportPdfBtn" style="display:none;" class="btn-export">Export PDF</button>
                </div>
            </div>

            <div class="filter-controls" style="margin-top: 20px;">
                <div class="form-group"><input id="searchBox" type="text" placeholder="Cari nama siswa..."/></div>
                <div class="form-group"><select id="filterCoach"><option value="">-- Semua Coach --</option></select></div>
                <div class="form-group"><select id="filterLevel"><option value="">-- Semua Level --</option></select></div>
                <div class="form-group"><select id="filterMonth"></select></div>
                <div class="form-group"><select id="filterYear"><option value="">-- Semua Tahun --</option></select></div>
                <div class="form-group">
                    <select id="sortField">
                        <option value="timestamp" selected>Urutkan: Tanggal</option>
                        <option value="studentName">Urutkan: Nama Siswa</option>
                        <option value="level">Urutkan: Level</option>
                        <option value="activityNumber">Urutkan: Sesi</option>
                    </select>
                </div>
                <div class="form-group">
                    <select id="sortOrder">
                      <option value="asc">Naik (ASC)</option>
                      <option value="desc" selected>Turun (DESC)</option>
                    </select>
                </div>
                <button id="clearFilters" class="btn-reset" style="margin-top: 0;">Reset Filter</button>
            </div>
            
            <div id="studentFilterIndicator">Filter siswa: <b id="studentFilterName"></b> <button onclick="clearStudentFilter()" class="btn-reset" style="padding: 2px 5px; font-size: 12px;">❌ Hapus</button></div>
          
            <div class="student-table-container">
              <table class="student-table">
                <thead>
                  <tr>
                    <th>Sesi</th><th>Siswa</th><th>Level</th><th>Tanggal</th><th>Lesson</th><th>Aktivitas</th><th>Hasil</th><th>Aksi (Del)</th>
                  </tr>
                </thead>
                <tbody id="reportsTableBody"><tr><td colspan="8">Memuat laporan...</td></tr></tbody>
              </table>
            </div>
          
            <div class="spp-footer">
                <div class="pagination-container">
                    <button id="prevPage">⬅ Sebelumnya</button>
                    <div id="pageInfo" style="margin: 0 10px;"></div>
                    <button id="nextPage">Berikutnya ➡</button>
                </div>
                <div class="pagination-container">
                    <span>Tampilkan </span>
                    <select id="pageSize"><option value="5">5</option><option value="10" selected>10</option><option value="20">20</option></select>
                    <span> per halaman</span>
                </div>
            </div>
              
            <div id="trackingContainer" class="content-block">
              <h3>Riwayat Export WA Terakhir (24 Jam)</h3>
              <div id="trackingList">Memuat riwayat...</div>
              <div id="logPagination" class="spp-footer" style="margin-top: 10px;">
                  <div class="pagination-container">
                      <button id="logPrevPage">⬅ Sebelumnya</button>
                      <div id="logPageInfo" style="margin: 0 10px;"></div>
                      <button id="logNextPage">Berikutnya ➡</button>
                  </div>
                  <div class="pagination-container">
                    <span>Tampilkan </span>
                    <select id="logPageSize"><option value="5" selected>5</option><option value="10">10</option><option value="20">20</option></select>
                    <span> per halaman</span>
                  </div>
              </div>
            </div>
        </div>
    </div>
    
    <div id="singleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Detail Pembayaran</h3>
                <span class="close-btn" onclick="singleModal.style.display='none'">&times;</span>
            </div>
            <div class="modal-body" id="modalBodyContent"></div>
        </div>
    </div>
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="settingsModalTitle">Pengaturan Template WhatsApp</h3>
                <span class="close-btn" onclick="settingsModal.style.display='none'">&times;</span>
            </div>
            <div class="modal-body">
                <input type="hidden" id="currentTemplateType"> <p>Edit teks template di bawah ini. Gunakan placeholder dinamis yang tersedia (dijelaskan dalam judul modal).</p>
                <textarea id="whatsappTemplateTextarea" rows="10" style="width:100%;"></textarea>
                <div style="display: flex; justify-content: space-between; margin-top: 10px; align-items: center; flex-direction: column; gap: 10px;">
                    <button class="btn-export" onclick="saveWhatsappTemplate()">Simpan Template</button>
                    <button class="btn-reset" onclick="resetWhatsappTemplate()">Reset ke Awal</button>
                </div>
                <div id="settingsStatusMessage" style="margin-top:10px;"></div>
            </div>
        </div>
    </div>
    <div id="editStudentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Detail Siswa</h2>
                <span class="close-btn" onclick="document.getElementById('editStudentModal').style.display='none';">&times;</span>
            </div>
            <form id="editStudentForm">
                <div class="modal-body">
                    <input type="hidden" id="editStudentId">
                    <div class="form-group">
                        <label for="editStudentName">Nama Siswa</label>
                        <input type="text" id="editStudentName" required>
                    </div>
                    <div class="form-group">
                        <label for="editStudentLevel">Level Siswa</label>
                        <select id="editStudentLevel"></select>
                    </div>
                    <div class="form-group">
                        <label for="editStudentCoach">Pindahkan ke Coach</label>
                        <select id="editStudentCoach" required></select>
                    </div>
                    <div class="form-group">
                        <label for="editStudentPhone">No. Telepon</label>
                        <input type="tel" id="editStudentPhone" placeholder="Contoh: 08123456789">
                    </div>
                </div>
                <div class="modal-footer" style="padding-top: 20px;">
                    <button type="submit" class="action-btn" style="background-color: var(--success-color);">Simpan Perubahan</button>
                </div>
            </form>
        </div>
    </div>

    <div id="pinModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Verifikasi PIN</h3>
                <span class="close-btn" onclick="document.getElementById('pinModal').style.display='none'">&times;</span>
            </div>
            <div class="modal-body">
                <p>Masukkan PIN untuk mengedit data ini.</p>
                <div class="form-group">
                    <label for="pinInput">PIN</label>
                    <input type="password" id="pinInput" placeholder="PIN" required>
                </div>
                <div class="form-group">
                    <button type="button" id="verifyPinBtn" class="action-btn" style="background-color: var(--success-color);">Verifikasi</button>
                </div>
                <div id="pinVerificationMessage" class="status-message" style="margin-top:10px;"></div>
            </div>
        </div>
    </div>

    <div id="editSppModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Pembayaran SPP</h3>
                <span class="close-btn" onclick="document.getElementById('editSppModal').style.display='none'">&times;</span>
            </div>
            <form id="editSppForm">
                <input type="hidden" id="editSppStudentId">
                <input type="hidden" id="editSppYearMonthKey">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="editSppNominal">Nominal (Rp)</label>
                        <input type="text" id="editSppNominal" required>
                    </div>
                    <div class="form-group">
                        <label for="editSppBank">Bank</label>
                        <select id="editSppBank" required></select>
                    </div>
                    <div class="form-group">
                        <label for="editSppPaymentDate">Tanggal Bayar</label>
                        <input type="date" id="editSppPaymentDate" required>
                    </div>
                    <div class="form-group">
                        <label for="editSppKeterangan">Keterangan</label>
                        <textarea id="editSppKeterangan" rows="2"></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label for="editSppAttachment">Ganti Bukti Bayar</label>
                        <input type="file" id="editSppAttachment" accept="image/*,.pdf">
                        <p style="font-size: 0.8em; color: gray; margin-top: 5px;">Abaikan jika tidak ingin mengganti.</p>
                    </div>
                </div>
                <div class="modal-footer" style="padding-top: 20px;">
                    <button type="submit" class="action-btn" style="background-color: var(--success-color);">Simpan Perubahan</button>
                    <button type="button" class="action-btn" style="background-color: var(--danger-color); margin-top: 10px;" onclick="deleteSppPayment()">Hapus Pembayaran</button>
                </div>
            </form>
        </div>
    </div>

    <div id="editNonSppModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Laporan Non-SPP</h3>
                <span class="close-btn" onclick="document.getElementById('editNonSppModal').style.display='none'">&times;</span>
            </div>
            <form id="editNonSppForm">
                <input type="hidden" id="editNonSppId">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="editNonSppStudentName">Nama Siswa</label>
                        <input type="text" id="editNonSppStudentName" required disabled>
                    </div>
                    <div class="form-group">
                        <label for="editNonSppNominal">Nominal (Rp)</label>
                        <input type="text" id="editNonSppNominal" required>
                    </div>
                    <div class="form-group">
                        <label for="editNonSppBank">Bank</label>
                        <select id="editNonSppBank" required></select>
                    </div>
                    <div class="form-group">
                        <label for="editNonSppPaymentDate">Tanggal Bayar</label>
                        <input type="date" id="editNonSppPaymentDate" required>
                    </div>
                    <div class="form-group">
                        <label for="editNonSppKeterangan">Keterangan</label>
                        <textarea id="editNonSppKeterangan" rows="2"></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label for="editNonSppAttachment">Ganti Bukti Bayar</label>
                        <input type="file" id="editNonSppAttachment" accept="image/*,.pdf">
                        <p style="font-size: 0.8em; color: gray; margin-top: 5px;">Abaikan jika tidak ingin mengganti.</p>
                    </div>
                </div>
                <div class="modal-footer" style="padding-top: 20px;">
                    <button type="submit" class="action-btn" style="background-color: var(--success-color);">Simpan Perubahan</button>
                    <button type="button" class="action-btn" style="background-color: var(--danger-color); margin-top: 10px;" onclick="deleteNonSppPayment()">Hapus Laporan</button>
                </div>
            </form>
        </div>
    </div>

    <div id="deleteModal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header"><h3>Konfirmasi Hapus</h3><span class="close-btn" onclick="closeModal('deleteModal')">&times;</span></div>
            <div class="modal-body">
                <p>Apakah Anda yakin ingin menghapus laporan ini secara permanen?</p>
                <input type="hidden" id="deleteId">
            </div>
            <div class="modal-footer" style="padding-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" class="action-btn" style="background-color: var(--secondary-color);" onclick="closeModal('deleteModal')">Batal</button>
                <button type="button" class="action-btn" style="background-color: var(--danger-color);" onclick="confirmDelete()">Hapus</button>
            </div>
        </div>
    </div>

    <div id="detailModal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header"><h3 id="detailTitle">Detail</h3><span class="close-btn" onclick="closeModal('detailModal')">&times;</span></div>
            <div class="modal-body">
                <p id="detailText" style="white-space: pre-wrap; word-break: break-word;"></p>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, onSnapshot, doc, setDoc, getDoc, addDoc, updateDoc, query, where, writeBatch, increment, Timestamp, deleteField, deleteDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
        import * as XLSX from 'https://cdn.sheetjs.com/xlsx-0.20.1/package/xlsx.mjs';

        // ====================== FIREBASE CONFIG (SINGLE DECLARATION) ======================
        const firebaseConfig = {
            apiKey: "AIzaSyBm3SkLLtl9LvczDDht-OQ6-R4OYLPYAJQ",
            authDomain: "progres-report-5d199.firebaseapp.com",
            projectId: "progres-report-5d199",
            storageBucket: "progres-report-5d199.appspot.com",
            messagingSenderId: "363573365137",
            appId: "1:363573365137:web:98f32d5ff8fae05617b230",
            measurementId: "G-CPX04R69F5"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ====================== GLOBAL VARIABLES ======================
        
        // --- Variables for SPP, Non-SPP, Manajemen Siswa ---
        let sessionReadCount = 0;
        const readStatusElement = document.getElementById('readStatusIndicator');
        let allStudents = [];
        let allUsers = []; 
        let allLevels = []; 
        let allYearsWithPayments = [];
        let currentPage = 1;
        let studentCurrentPage = 1; 
        let otherCurrentPage = 1; 
        let rowsPerPage = 5;
        let studentRowsPerPage = 5; 
        let otherRowsPerPage = 10; 
        let bankColors = {};
        let currentBendaharaName = '';
        let brandSettings = {};
        let whatsappTemplates = {};
        const templateKeys = { spp: "paymentProof", nonspp: "otherPaymentProof" };
        const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        let allOtherPayments = [];
        let pendingImportStudents = []; 
        let appEditPin = '';
        const currentYear = new Date().getFullYear();
        const currentMonthIndex = new Date().getMonth();

        // --- Variables for Laporan Aktivitas ---
        let myStudents=[], allMyReports=[], allActiveStudents = {};
        let reportCurrentPage=1, reportPageSize=10; 
        let isFirstLoad=true, defaultMonth, defaultYear;
        let selectedStudentId=null;
        let globalUserName = "User"; 
        const LS_WA_KEY = 'waExportLogs'; 
        let whatsappTracking = {}; 
        let logCurrentPage=1, logPageSize=5; 

        // ====================== DOM ELEMENTS ======================
        const singleModal = document.getElementById('singleModal');
        const modalBodyContent = document.getElementById('modalBodyContent');
        const modalTitle = document.getElementById('modalTitle');
        const settingsModal = document.getElementById('settingsModal');
        const whatsappTemplateTextarea = document.getElementById('whatsappTemplateTextarea');
        const settingsStatusMessage = document.getElementById('settingsStatusMessage');
        const pinModal = document.getElementById('pinModal');
        const editSppModal = document.getElementById('editSppModal');
        const editNonSppModal = document.getElementById('editNonSppModal');
        
        const defaultWhatsappTemplate = {
            spp: `Halo Bapak/Ibu, ini adalah bukti pembayaran SPP untuk *{nama_siswa}* tahun *{tahun_bayar}*.
Pembayaran yang tercatat:
{rincian_pembayaran}
Total nominal yang tercatat adalah: *{total_nominal_formatted}*
Laporan PDF sudah kami kirimkan ke folder unduhan Anda dengan nama "{nama_file}". Mohon dilampirkan dan dicek.
Terima kasih.`,
            nonspp: `Halo, ini rincian laporan non-SPP untuk *{nama_siswa}* berdasarkan transaksi terpilih.
Total nominal yang tercatat adalah: *{total_nominal_formatted}*.
Mohon lampirkan file PDF "{nama_file}" yang baru saja Anda unduh.
Terima kasih.`
        };

        // ====================== AUTHENTICATION & INITIALIZATION ======================
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const docRef = doc(db, "users", user.email);
                const docSnap = await getDoc(docRef);
                sessionReadCount++; updateReadStatus();
                if (docSnap.exists() && docSnap.data().role === 'bendahara') {
                    document.body.style.display = 'block';
                    
                    // --- Initialization for SPP, etc. ---
                    document.getElementById('paymentDate').valueAsDate = new Date();
                    document.getElementById('paymentYear').value = new Date().getFullYear();
                    currentBendaharaName = docSnap.data().name || 'Bendahara';
                    const userName = docSnap.data().name || user.email;
                    document.getElementById('userGreeting').textContent = `Halo, ${userName}!`; 
                    document.getElementById('userGreeting').style.fontSize = '2.2rem'; 
                    await loadBrandSettings();
                    await loadBanks();
                    await loadAppEditPin();
                    await loadWhatsappTemplate();
                    await loadAllData();
                    setupEventListeners(); // Sets up listeners for all tabs
                    populateMonths();
                    initializeNonSppModule();
                    openTab('spp-tab');
                    
                    // --- Initialization for Laporan Aktivitas ---
                    await setupDataForActivityReport(user);

                } else {
                    alert("Akses ditolak. Halaman ini hanya untuk Bendahara.");
                    await signOut(auth);
                    window.location.href = 'login.html';
                }
            } else {
                window.location.href = 'login.html';
            }
        });

        // ====================== UNIVERSAL & HELPER FUNCTIONS ======================
        window.logout = function() { signOut(auth).then(() => { window.location.href = 'login.html'; }); };
        
        window.onclick = function(event) {
            const modals = [singleModal, settingsModal, document.getElementById('editStudentModal'), pinModal, editSppModal, editNonSppModal, document.getElementById('deleteModal'), document.getElementById('detailModal')];
            modals.forEach(modal => {
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            });
        }
        
        function updateReadStatus() {
            if(readStatusElement) readStatusElement.innerHTML = `Reads Sesi Ini: ${sessionReadCount} <button onclick="window.resetReadCount()">Reset</button>`;
        }
        window.resetReadCount = function() {
            sessionReadCount = 0;
            updateReadStatus();
        }

        const isMobile = /Mobi|Android/i.test(navigator.userAgent);
        
        function formatPhoneNumber(number) {
            if (!number) return null;
            number = String(number).replace(/\s/g, '').replace(/[^0-9+]/g, '');
            if (number.startsWith('+62')) {
                number = '62' + number.slice(3);
            } else if (number.startsWith('0')) {
                number = '62' + number.slice(1);
            } else if (!number.startsWith('62')) {
                number = '62' + number;
            }
            return number.replace('+', '');
        }

        window.openTab = async function(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`.tab-btn[onclick="openTab('${tabName}')"]`).classList.add('active');
            
            if(tabName === 'spp-tab') {
                renderSppTable();
                populateSppSummaryDashboard();
            } else if (tabName === 'nonspp-tab') {
                await loadNonSppData();
                populateNonSppSummaryDashboard();
                renderOtherPaymentsTable(filterNonSppData());
            } else if (tabName === 'manajemen-siswa-tab') {
                renderStudentTable();
                renderPendingAssignmentTable();
                renderSummaryDashboard();
            } else if (tabName === 'laporan-aktivitas-tab') {
                renderReports();
            }
        }

        async function getBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        async function compressImage(file, quality = 0.7) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = event => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        const maxWidth = 800;
                        const maxHeight = 600;
                        if (width > height) {
                            if (width > maxWidth) {
                                height *= maxWidth / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width *= maxHeight / height;
                                height = maxHeight;
                            }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        const compressedBase64 = canvas.toDataURL('image/jpeg', quality);
                        resolve(compressedBase64);
                    };
                    img.onerror = error => reject(error);
                };
                reader.onerror = error => reject(error);
            });
        }

        // ====================================================================
        // || SECTION 1: SPP, NON-SPP, MANAJEMEN SISWA LOGIC               ||
        // ====================================================================
        
        async function loadBrandSettings() {
            try {
                const docSnap = await getDoc(doc(db, "settings", "brand"));
                sessionReadCount++; updateReadStatus();
                if (docSnap.exists()) {
                    brandSettings = docSnap.data();
                } else {
                    brandSettings = {};
                }
            } catch (error) {
                console.error("Gagal memuat pengaturan brand:", error);
                brandSettings = {};
            }
        }
        
        async function loadAppEditPin() {
            try {
                const docSnap = await getDoc(doc(db, "settings", "appEditPin"));
                sessionReadCount++; updateReadStatus();
                if (docSnap.exists() && docSnap.data().pin) {
                    appEditPin = docSnap.data().pin;
                } else {
                    appEditPin = '';
                }
            } catch (error) {
                console.error("Gagal memuat PIN:", error);
                appEditPin = '';
            }
        }

        async function loadAllData() {
            try {
                const userSnapshot = await getDocs(collection(db, "users"));
                sessionReadCount += userSnapshot.size;
                allUsers = userSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const studentSnapshot = await getDocs(collection(db, "students"));
                sessionReadCount += studentSnapshot.size;
                allStudents = studentSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const curriculumSnapshot = await getDocs(collection(db, "kurikulum"));
                sessionReadCount += curriculumSnapshot.size;
                allLevels = curriculumSnapshot.docs.map(doc => doc.id).sort();

                pendingImportStudents = JSON.parse(localStorage.getItem('pendingImportStudents')) || [];

                updateReadStatus();
                setupStudentSearchBox();
                populateYearFilter();
                populateSummarySppFilter();
                setupStudentFilterSearchBox();
                setupOtherStudentSearchBox();
                setupStudentListSearchBox();
                populateLevelFilterDropdown();
                
                document.getElementById('summarySppYearFilter').value = currentYear;
                document.getElementById('summarySppMonthFilter').value = currentMonthIndex;
                populateSppSummaryDashboard(); 
                
                renderSppTable();
                
                populateCoachDropdowns();
                populateLevelDropdowns();
                renderStudentTable();
                renderPendingAssignmentTable();
                renderSummaryDashboard();

            } catch (error) {
                console.error("ERROR di dalam loadAllData:", error);
                alert("Gagal memuat data utama. Kemungkinan ada masalah dengan koneksi atau Security Rules. Periksa console (F12).");
            }
        }
        
        function populateSummarySppFilter() {
            const yearFilter = document.getElementById('summarySppYearFilter');
            const yearsSet = new Set();
            allStudents.forEach(student => {
                if (student.spp) {
                    Object.keys(student.spp).forEach(key => {
                        const year = parseInt(key.split('-')[0]);
                        if (year) yearsSet.add(year);
                    });
                }
            });
            yearsSet.add(currentYear);
            const sortedYears = Array.from(yearsSet).sort((a, b) => b - a);
            let yearsOptions = '';
            sortedYears.forEach(year => {
                yearsOptions += `<option value="${year}">${year}</option>`;
            });
            yearFilter.innerHTML = yearsOptions;
            document.getElementById('summarySppMonthFilter').value = currentMonthIndex;
        }

        function populateSppSummaryDashboard() {
            const selectedYear = parseInt(document.getElementById('summarySppYearFilter').value);
            const selectedMonthIndex = parseInt(document.getElementById('summarySppMonthFilter').value);
            document.getElementById('summaryYearDisplay').textContent = selectedYear;
            document.getElementById('summaryMonthName').textContent = monthNames[selectedMonthIndex];
            const activeStudents = allStudents.filter(s => (s.status || 'active') === 'active' && s.studentLevel);
            const totalActiveStudents = activeStudents.length;
            document.getElementById('totalActiveStudentsSPP').textContent = totalActiveStudents;
            const targetMonthKey = `${selectedYear}-${selectedMonthIndex}`;
            let studentsPaidFull = 0;
            let studentsNotPaid = 0;
            const bankTransactions = {};
            activeStudents.forEach(student => {
                const paymentData = student.spp && student.spp[targetMonthKey];
                if (paymentData) {
                    studentsPaidFull++;
                    const bankName = paymentData.bank || 'Tidak Diketahui';
                    bankTransactions[bankName] = (bankTransactions[bankName] || 0) + 1;
                } else {
                    studentsNotPaid++;
                }
            });
            const currentMonthStatusElement = document.getElementById('currentMonthStatus');
            const statusText = studentsPaidFull > 0 ? 'Sudah Ada Transaksi' : 'Belum Ada Transaksi';
            currentMonthStatusElement.textContent = statusText;
            currentMonthStatusElement.style.color = studentsPaidFull > 0 ? 'var(--success-color)' : 'var(--danger-color)';
            document.getElementById('studentsPaidFull').textContent = studentsPaidFull;
            document.getElementById('studentsNotPaid').textContent = studentsNotPaid;
            const bankMonthlySummary = document.getElementById('bankMonthlySummary');
            bankMonthlySummary.innerHTML = '';
            const sortedBanks = Object.keys(bankTransactions).sort();
            if (sortedBanks.length > 0) {
                sortedBanks.forEach(bank => {
                    const listItem = document.createElement('li');
                    listItem.textContent = `${bank}: ${bankTransactions[bank]} transaksi`;
                    bankMonthlySummary.appendChild(listItem);
                });
            } else {
                 const listItem = document.createElement('li');
                 listItem.textContent = 'Tidak ada transaksi bulan ini.';
                 bankMonthlySummary.appendChild(listItem);
            }
        }
        
        function renderSummaryDashboard() {
            const totalStudentsElement = document.getElementById('summaryTotalStudents');
            const totalCoachesElement = document.getElementById('summaryTotalCoaches');
            const studentsByLevelList = document.getElementById('summaryActiveStudentsByLevel');
            const activeStudents = allStudents.filter(s => (s.status || 'active') === 'active');
            const totalActiveStudents = activeStudents.length;
            const totalActiveCoaches = allUsers.filter(u => u.role === 'user' && (u.status || 'active') === 'active').length;
            totalStudentsElement.textContent = totalActiveStudents;
            totalCoachesElement.textContent = totalActiveCoaches;
            const studentsPerLevel = activeStudents.reduce((acc, student) => {
                const level = student.studentLevel || 'Level Tidak Diketahui';
                acc[level] = (acc[level] || 0) + 1;
                return acc;
            }, {});
            studentsByLevelList.innerHTML = '';
            if (Object.keys(studentsPerLevel).length > 0) {
                for (const level in studentsPerLevel) {
                    const listItem = document.createElement('li');
                    listItem.textContent = `${level}: ${studentsPerLevel[level]} siswa`;
                    studentsByLevelList.appendChild(listItem);
                }
            } else {
                 const listItem = document.createElement('li');
                 listItem.textContent = 'Tidak ada siswa aktif.';
                 studentsByLevelList.appendChild(listItem);
            }
        }
        
        window.showPaymentDetails = function(detailsJsonEncoded) {
            const detailsJson = decodeURIComponent(detailsJsonEncoded);
            const details = JSON.parse(detailsJson);
            modalTitle.textContent = 'Detail Pembayaran SPP';
            const nominalFormatted = new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(details.nominal);
            let contentHTML = `
                <p><strong>ID Pembayaran:</strong> ${details.paymentId}</p>
                <p><strong>Tanggal Bayar:</strong> ${details.date}</p>
                <p><strong>Nominal:</strong> ${nominalFormatted}</p>
                <p><strong>Bank:</strong> ${details.bank}</p>
                <p><strong>Level Siswa (saat bayar):</strong> ${details.studentLevel}</p>
            `;
            if (details.keterangan) {
                contentHTML += `<div style="margin-top:15px;"><p><strong>Keterangan:</strong></p><p style="white-space: pre-wrap; margin-top: 5px;">${details.keterangan}</p></div>`;
            }
            if (details.attachmentBase64) {
                const mimeType = details.attachmentBase64.split(';')[0].split(':')[1];
                contentHTML += `<div style="margin-top: 15px;"><p><strong>Bukti Pembayaran (Snapshot):</strong></p>`;
                if (mimeType.startsWith('image/')) {
                    contentHTML += `<img src="${details.attachmentBase64}" alt="Bukti Pembayaran" class="attachment-preview">`;
                } else if (mimeType === 'application/pdf') {
                    contentHTML += `<iframe src="${details.attachmentBase64}" class="attachment-iframe"></iframe>`;
                }
                contentHTML += `</div>`;
            }
            if (!details.keterangan && !details.attachmentBase64) {
                contentHTML += `<p style="margin-top:15px;"><em>Tidak ada keterangan atau bukti bayar tambahan.</em></p>`;
            }
            modalBodyContent.innerHTML = contentHTML;
            singleModal.style.display = 'flex';
        };

        async function loadWhatsappTemplate() {
            try {
                const docSnap = await getDoc(doc(db, "settings", "whatsapp_templates"));
                sessionReadCount++; updateReadStatus();
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    whatsappTemplates.spp = data.paymentProof || defaultWhatsappTemplate.spp;
                    whatsappTemplates.nonspp = data.otherPaymentProof || defaultWhatsappTemplate.nonspp;
                } else {
                    whatsappTemplates.spp = defaultWhatsappTemplate.spp;
                    whatsappTemplates.nonspp = defaultWhatsappTemplate.nonspp;
                }
            } catch (error) {
                console.error("Gagal memuat template WhatsApp:", error);
                whatsappTemplates.spp = defaultWhatsappTemplate.spp;
                whatsappTemplates.nonspp = defaultWhatsappTemplate.nonspp;
            }
        }
        
        window.openWhatsappSettings = function(type) {
            const titleElement = document.getElementById('settingsModalTitle');
            const templateTextarea = document.getElementById('whatsappTemplateTextarea');
            const currentTemplateTypeInput = document.getElementById('currentTemplateType');
            if (type === 'spp') {
                titleElement.textContent = 'Pengaturan Template WhatsApp SPP (Placeholder: {nama_siswa}, {tahun_bayar}, {rincian_pembayaran}, {total_nominal_formatted}, {nama_file})';
                templateTextarea.value = whatsappTemplates.spp;
                currentTemplateTypeInput.value = 'spp';
            } else if (type === 'nonspp') {
                titleElement.textContent = 'Pengaturan Template WhatsApp Non-SPP (Placeholder: {nama_siswa}, {total_nominal_formatted}, {nama_file})';
                templateTextarea.value = whatsappTemplates.nonspp;
                currentTemplateTypeInput.value = 'nonspp';
            } else {
                 alert('Jenis template tidak valid.');
                 return;
            }
            settingsModal.style.display = 'flex';
            document.getElementById('settingsStatusMessage').textContent = '';
        }
        
        window.saveWhatsappTemplate = async function() {
            const templateType = document.getElementById('currentTemplateType').value;
            const newTemplateText = document.getElementById('whatsappTemplateTextarea').value;
            const statusMessageDiv = document.getElementById('settingsStatusMessage');
            if (!templateType) { statusMessageDiv.textContent = 'Error: Jenis template tidak diketahui.'; return; }
            const fieldToUpdate = templateKeys[templateType];
            try {
                const settingsRef = doc(db, "settings", "whatsapp_templates");
                await setDoc(settingsRef, { [fieldToUpdate]: newTemplateText }, { merge: true });
                whatsappTemplates[templateType] = newTemplateText;
                statusMessageDiv.textContent = `Template ${templateType.toUpperCase()} berhasil disimpan!`;
                statusMessageDiv.style.color = 'green';
            } catch (error) {
                statusMessageDiv.textContent = `Gagal menyimpan template: ${error.message}`;
                statusMessageDiv.style.color = 'red';
            }
        }
        
        window.resetWhatsappTemplate = async function() {
            const templateType = document.getElementById('currentTemplateType').value;
            const statusMessageDiv = document.getElementById('settingsStatusMessage');
            if (!templateType) { statusMessageDiv.textContent = 'Error: Jenis template tidak diketahui.'; return; }
            if (confirm(`Yakin ingin mereset template ${templateType.toUpperCase()} ke pengaturan awal?`)) {
                const defaultText = defaultWhatsappTemplate[templateType];
                const fieldToUpdate = templateKeys[templateType];
                try {
                    const settingsRef = doc(db, "settings", "whatsapp_templates");
                    await setDoc(settingsRef, { [fieldToUpdate]: defaultText }, { merge: true });
                    whatsappTemplates[templateType] = defaultText;
                    document.getElementById('whatsappTemplateTextarea').value = defaultText;
                    statusMessageDiv.textContent = `Template ${templateType.toUpperCase()} berhasil direset!`;
                    statusMessageDiv.style.color = 'green';
                } catch (error) {
                    statusMessageDiv.textContent = `Gagal mereset template: ${error.message}`;
                    statusMessageDiv.style.color = 'red';
                }
            }
        }
        
        async function loadBanks() {
            try {
                const banksSnapshot = await getDocs(collection(db, "banks"));
                sessionReadCount += banksSnapshot.size; updateReadStatus();
                bankColors = {};
                banksSnapshot.docs.forEach(doc => {
                    if (doc.data().status === 'active' || !doc.data().status) {
                        bankColors[doc.data().bankName] = doc.data().color;
                    }
                });
                populateBankLegend();
                populateBankSelector();
                populateEditBankSelectors();
            } catch (error) {
                console.error("Gagal memuat data bank:", error);
            }
        }
        
        function setupStudentSearchBox() {
            const searchBox = $('#studentSearchBox');
            const studentSelector = $('#studentSelector');
            const studentData = allStudents.map(student => ({
                label: `${student.name} (${student.studentLevel || 'Level belum diatur'} - ${student.status})`,
                value: student.id
            }));
            searchBox.autocomplete({
                source: studentData, minLength: 2,
                select: function(event, ui) {
                    searchBox.val(ui.item.label); studentSelector.val(ui.item.value); return false;
                }
            });
            searchBox.on('input', function() { if ($(this).val() === '') { studentSelector.val(''); } });
        }
        
        function setupStudentFilterSearchBox() {
            const searchBox = $('#studentFilterSearchBox');
            const studentFilter = $('#studentFilter');
            const studentData = [{ label: 'Semua Siswa', value: 'all' }].concat(allStudents.map(student => ({
                label: student.name, value: student.id
            })));
            searchBox.autocomplete({
                source: studentData, minLength: 2,
                select: function(event, ui) {
                    searchBox.val(ui.item.label); studentFilter.val(ui.item.value); renderSppTable(); return false;
                }
            });
            searchBox.on('input', function() { if ($(this).val() === '') { studentFilter.val('all'); renderSppTable(); } });
        }

        function setupOtherStudentSearchBox() {
            const searchBox = $('#otherStudentSearchBox');
            const studentSelector = $('#otherStudentSelector');
            const studentData = allStudents.map(student => ({
                label: `${student.name} (${student.studentLevel || 'N/A'} - ${student.status})`,
                value: student.id
            }));
            searchBox.autocomplete({
                source: studentData, minLength: 2,
                select: function(event, ui) {
                    searchBox.val(ui.item.label); studentSelector.val(ui.item.value); return false;
                }
            });
            searchBox.on('input', function() { if ($(this).val() === '') { studentSelector.val(''); } });
        }
        
        function setupOtherStudentFilterSearchBox() {
            const searchBox = $('#otherStudentFilterSearchBox');
            const studentFilter = $('#otherStudentFilter');
            const studentData = [{ label: 'Semua Siswa', value: 'all' }].concat(allStudents.map(student => ({
                label: student.name, value: student.id
            })));
            searchBox.autocomplete({
                source: studentData, minLength: 2,
                select: function(event, ui) {
                    searchBox.val(ui.item.label); studentFilter.val(ui.item.value); renderOtherPaymentsTable(filterNonSppData()); return false;
                }
            });
            searchBox.on('input', function() { if ($(this).val() === '') { studentFilter.val('all'); renderOtherPaymentsTable(filterNonSppData()); } });
        }

        function setupStudentListSearchBox() {
            const searchBox = $('#studentListSearchBox');
            const studentFilter = $('#studentListFilter');
            const studentData = [{ label: 'Semua Siswa', value: 'all' }].concat(allStudents.map(student => ({
                label: student.name, value: student.id
            })));
            searchBox.autocomplete({
                source: studentData, minLength: 2,
                select: function(event, ui) {
                    searchBox.val(ui.item.label); studentFilter.val(ui.item.value); renderStudentTable(); return false;
                }
            });
            searchBox.on('input', function() { if ($(this).val() === '') { studentFilter.val('all'); renderStudentTable(); } });
        }

        function populateLevelFilterDropdown() {
            const levelSelector = document.getElementById('levelFilterSelector');
            if (levelSelector) {
                levelSelector.innerHTML = '<option value="all">Semua Level</option>';
                allLevels.forEach(level => { levelSelector.innerHTML += `<option value="${level}">${level}</option>`; });
            }
        }

        function populateBankSelector() {
            const selector = document.getElementById('bankSelector');
            const otherSelector = document.getElementById('otherBankSelector');
            if (selector) {
                selector.innerHTML = '<option value="">Pilih Bank</option>';
                for (const bankName in bankColors) { selector.innerHTML += `<option value="${bankName}">${bankName}</option>`; }
            }
            if (otherSelector) {
                otherSelector.innerHTML = '<option value="">Pilih Bank</option>';
                for (const bankName in bankColors) { otherSelector.innerHTML += `<option value="${bankName}">${bankName}</option>`; }
            }
        }
        function populateEditBankSelectors() {
            const editSppBankSelector = document.getElementById('editSppBank');
            const editNonSppBankSelector = document.getElementById('editNonSppBank');
            let options = '<option value="">Pilih Bank</option>';
            for (const bankName in bankColors) { options += `<option value="${bankName}">${bankName}</option>`; }
            editSppBankSelector.innerHTML = options;
            editNonSppBankSelector.innerHTML = options;
        }
        function populateMonths() {
            const monthSelector = document.getElementById('monthSelector');
            if (monthSelector) {
                monthSelector.innerHTML = '';
                monthNames.forEach((month, index) => {
                    monthSelector.innerHTML += `<label><input type="checkbox" name="month" value="${index}"> ${month}</label>`;
                });
            }
        }
        function populateBankLegend() {
            const legendDiv = document.getElementById('bankLegend');
            if (legendDiv) {
                legendDiv.innerHTML = '';
                for (const bank in bankColors) {
                    legendDiv.innerHTML += `<div class="legend-item"><span class="bank-color" style="background-color: ${bankColors[bank]};"></span>${bank}</div>`;
                }
            }
        }
        function populateYearFilter() {
            const yearFilter = document.getElementById('yearFilter');
            if (yearFilter) {
                const years = new Set();
                allStudents.forEach(student => {
                    if (student.spp) {
                        Object.keys(student.spp).forEach(key => {
                            const year = key.split('-')[0];
                            if (year) years.add(parseInt(year));
                        });
                    }
                });
                allYearsWithPayments = Array.from(years).sort((a, b) => a - b);
                yearFilter.innerHTML = '<option value="all">Semua Tahun</option>';
                allYearsWithPayments.forEach(year => { yearFilter.innerHTML += `<option value="${year}">${year}</option>`; });
                if (allYearsWithPayments.length > 0) {
                    yearFilter.value = Math.max(...allYearsWithPayments);
                } else {
                    yearFilter.value = 'all';
                }
            }
        }

        async function handleAddPayment(e) {
            e.preventDefault();
            const studentId = document.getElementById('studentSelector').value;
            const nominal = parseFloat(document.getElementById('nominal').value.replace(/\./g, ''));
            const bank = document.getElementById('bankSelector').value;
            const paymentDate = document.getElementById('paymentDate').value;
            const paymentYear = document.getElementById('paymentYear').value;
            const keterangan = document.getElementById('keterangan').value;
            const attachmentFile = document.getElementById('attachment').files[0];
            const monthsPaid = Array.from(document.querySelectorAll('input[name="month"]:checked')).map(cb => parseInt(cb.value));
            const statusMessageDiv = document.getElementById('statusMessage');
            const compressionQuality = parseFloat(document.getElementById('imageQualitySelector').value);

            if (!studentId || studentId === '') {
                statusMessageDiv.textContent = 'Harap pilih siswa yang valid dari daftar.'; statusMessageDiv.style.color = 'red'; return;
            }
            if (isNaN(nominal) || nominal <= 0 || !bank || !paymentDate || isNaN(paymentYear) || monthsPaid.length === 0 || !attachmentFile) {
                statusMessageDiv.textContent = 'Semua field wajib diisi, termasuk bukti bayar.'; statusMessageDiv.style.color = 'red'; return;
            }
            statusMessageDiv.textContent = 'Menyimpan pembayaran...'; statusMessageDiv.style.color = 'blue';
            try {
                let attachmentBase64 = '';
                if (attachmentFile) {
                    if (attachmentFile.size > 3 * 1024 * 1024) {
                        statusMessageDiv.textContent = 'Error: Ukuran file terlalu besar. Maksimum 3MB.'; statusMessageDiv.style.color = 'red'; return;
                    }
                    if (attachmentFile.type.startsWith('image/')) {
                        attachmentBase64 = await compressImage(attachmentFile, compressionQuality);
                    } else if (attachmentFile.type === 'application/pdf') {
                        attachmentBase64 = await getBase64(attachmentFile);
                    } else {
                        statusMessageDiv.textContent = 'Error: Jenis file tidak didukung.'; statusMessageDiv.style.color = 'red'; return;
                    }
                }
                const studentRef = doc(db, "students", studentId);
                const studentSnap = await getDoc(studentRef);
                sessionReadCount++; updateReadStatus();
                if (!studentSnap.exists()) {
                    statusMessageDiv.textContent = 'Error: Data siswa tidak ditemukan.'; statusMessageDiv.style.color = 'red'; return;
                }
                const studentData = studentSnap.data();
                const updatedSppData = { ...studentData.spp };
                const paymentUniqueId = crypto.randomUUID();
                const existingMonths = monthsPaid.filter(monthIndex => updatedSppData[`${paymentYear}-${monthIndex}`] !== undefined);
                if (existingMonths.length > 0) {
                    const existingMonthsNames = existingMonths.map(i => monthNames[i]).join(', ');
                    statusMessageDiv.textContent = `Error: Pembayaran untuk bulan ${existingMonthsNames} pada tahun ${paymentYear} sudah ada.`; statusMessageDiv.style.color = 'red'; return;
                }
                monthsPaid.forEach(monthIndex => {
                    const key = `${paymentYear}-${monthIndex}`;
                    updatedSppData[key] = {
                        nominal, bank, keterangan, attachmentBase64, paymentId: paymentUniqueId,
                        date: Timestamp.fromDate(new Date(paymentDate)),
                        studentLevel: studentData.studentLevel || 'Level belum diatur'
                    };
                });
                await updateDoc(studentRef, { spp: updatedSppData });
                statusMessageDiv.textContent = 'Pembayaran berhasil disimpan!';
                document.getElementById('sppPaymentForm').reset();
                document.getElementById('paymentDate').valueAsDate = new Date();
                document.getElementById('paymentYear').value = new Date().getFullYear();
                await loadAllData();
                populateSppSummaryDashboard();
            } catch (error) {
                statusMessageDiv.textContent = `Error: ${error.message}`; statusMessageDiv.style.color = 'red'; console.error("Error storing payment:", error);
            }
        }
        
        function filterSppData() {
            const selectedStudentId = document.getElementById('studentFilter').value;
            const selectedYear = document.getElementById('yearFilter').value;
            const selectedMonth = document.getElementById('monthFilter').value;
            return allStudents.filter(student => {
                if (selectedStudentId !== 'all' && student.id !== selectedStudentId) return false;
                if (!student.spp || Object.keys(student.spp).length === 0) return false;
                if (selectedYear === 'all') return true;
                const paymentsInSelectedYear = Object.keys(student.spp).some(key => key.startsWith(selectedYear));
                if (!paymentsInSelectedYear) return false;
                if (selectedMonth !== 'all') {
                    return student.spp[`${selectedYear}-${selectedMonth}`] !== undefined;
                }
                return true;
            });
        }

        function renderSppTable() {
            const tableHeader = document.getElementById('tableHeader');
            const tableSubHeader = document.getElementById('tableSubHeader');
            const tableBody = document.getElementById('sppTableBody');
            const selectedYear = document.getElementById('yearFilter').value;
            const selectedMonth = document.getElementById('monthFilter').value;
            let studentsToDisplay = filterSppData();
            const totalPages = Math.ceil(studentsToDisplay.length / rowsPerPage);
            if (currentPage > totalPages) currentPage = totalPages || 1;
            const paginatedStudents = studentsToDisplay.slice((currentPage - 1) * rowsPerPage, (currentPage - 1) * rowsPerPage + rowsPerPage);
            tableHeader.innerHTML = '';
            tableSubHeader.innerHTML = '';
            const yearsToDisplay = selectedYear === 'all' ? allYearsWithPayments : [selectedYear];
            let monthsToDisplay = selectedMonth !== 'all' ? [parseInt(selectedMonth)] : monthNames.map((_, index) => index);
            tableHeader.innerHTML = `<th rowspan="2">Nama Siswa</th>`;
            if (selectedYear === 'all') {
                yearsToDisplay.forEach(year => { tableHeader.innerHTML += `<th colspan="${monthsToDisplay.length}">${year}</th>`; });
            } else {
                tableHeader.innerHTML += `<th colspan="${monthsToDisplay.length}">${selectedYear}</th>`;
            }
            yearsToDisplay.forEach(() => {
                 monthsToDisplay.forEach(monthIndex => { tableSubHeader.innerHTML += `<th>${monthNames[monthIndex].substring(0,3).toUpperCase()}</th>`; });
            });
            tableBody.innerHTML = '';
            if (paginatedStudents.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="${1 + (yearsToDisplay.length * monthsToDisplay.length)}">Tidak ada data untuk filter ini.</td></tr>`;
                updatePaginationControls('spp', 0, 1);
            } else {
                 paginatedStudents.forEach(student => {
                     const row = tableBody.insertRow();
                     const studentStatus = student.status || 'inactive';
                     row.insertCell().innerHTML = `${student.name}<span class="student-status">${studentStatus.toUpperCase()}</span>`;
                     const studentSpp = student.spp || {};
                     yearsToDisplay.forEach(year => {
                         monthsToDisplay.forEach(monthIndex => {
                             const cell = row.insertCell();
                             const key = `${year}-${monthIndex}`;
                             const paymentData = studentSpp[key];
                             if (paymentData) {
                                 const bankColor = bankColors[paymentData.bank] || '#ccc';
                                 const nominalFormatted = new Intl.NumberFormat('id-ID').format(paymentData.nominal);
                                 const paymentDate = (paymentData.date && typeof paymentData.date.toDate === 'function') ? paymentData.date.toDate() : new Date(paymentData.date);
                                 const dateFormatted = paymentDate.toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' });
                                 const details = {
                                     paymentId: paymentData.paymentId || 'ID tidak tersedia',
                                     nominal: paymentData.nominal || 0,
                                     bank: paymentData.bank || 'N/A',
                                     date: paymentDate.toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' }),
                                     studentLevel: paymentData.studentLevel || 'N/A',
                                     keterangan: paymentData.keterangan || '',
                                     attachmentBase64: paymentData.attachmentBase64 || '',
                                 };
                                 const detailsJson = encodeURIComponent(JSON.stringify(details));
                                 cell.innerHTML = `
                                     <div class="payment-bank-color" style="background-color: ${bankColor};"></div>
                                     <div class="payment-info">
                                         <span class="payment-amount">Rp ${nominalFormatted}</span>
                                         <span class="payment-date">${dateFormatted}</span>
                                         <span class="payment-level">${paymentData.studentLevel || 'N/A'}</span>
                                         <button type="button" class="action-btn-edit" style="margin-top:5px; padding: 5px 10px; font-size:12px;" onclick="openPinModal('spp', '${student.id}', '${key}')">Edit</button>
                                     </div>
                                     ${(details.keterangan || details.attachmentBase64) ? `<a href="#" onclick="event.preventDefault(); showPaymentDetails('${detailsJson}')" class="attachment-link">Detail</a>` : ''}
                                 `;
                             }
                         });
                     });
                 });
                 updatePaginationControls('spp', currentPage, totalPages);
            }
        }

        window.openPinModal = function(type, ...params) {
            pinModal.style.display = 'flex';
            document.getElementById('pinInput').value = '';
            document.getElementById('verifyPinBtn').onclick = () => verifyPinAndOpenEdit(type, ...params);
        };

        async function verifyPinAndOpenEdit(type, ...params) {
            const enteredPin = document.getElementById('pinInput').value;
            const pinVerificationMessage = document.getElementById('pinVerificationMessage');
            if (enteredPin === appEditPin) {
                pinModal.style.display = 'none';
                pinVerificationMessage.textContent = '';
                if (type === 'spp') {
                    await openEditSppModal(params[0], params[1]);
                } else if (type === 'nonspp') {
                    await openEditNonSppModal(params[0]);
                }
            } else {
                pinVerificationMessage.textContent = 'PIN salah!';
                pinVerificationMessage.style.color = 'red';
            }
        }
        
        async function openEditSppModal(studentId, yearMonthKey) {
            const student = allStudents.find(s => s.id === studentId);
            if (!student || !student.spp[yearMonthKey]) { alert("Pembayaran tidak ditemukan."); return; }
            const paymentData = student.spp[yearMonthKey];
            document.getElementById('editSppStudentId').value = studentId;
            document.getElementById('editSppYearMonthKey').value = yearMonthKey;
            document.getElementById('editSppNominal').value = new Intl.NumberFormat('id-ID').format(paymentData.nominal);
            document.getElementById('editSppPaymentDate').value = (paymentData.date && typeof paymentData.date.toDate === 'function') ? paymentData.date.toDate().toISOString().slice(0, 10) : '';
            document.getElementById('editSppKeterangan').value = paymentData.keterangan || '';
            document.getElementById('editSppAttachment').value = '';
            setupNominalInput('editSppNominal');
            const bankSelector = document.getElementById('editSppBank');
            bankSelector.innerHTML = '<option value="">Pilih Bank</option>';
            for (const bankName in bankColors) { bankSelector.innerHTML += `<option value="${bankName}">${bankName}</option>`; }
            bankSelector.value = paymentData.bank;
            editSppModal.style.display = 'flex';
        }

        async function handleUpdateSppPayment(e) {
            e.preventDefault();
            const studentId = document.getElementById('editSppStudentId').value;
            const yearMonthKey = document.getElementById('editSppYearMonthKey').value;
            const nominal = parseFloat(document.getElementById('editSppNominal').value.replace(/\./g, ''));
            const bank = document.getElementById('editSppBank').value;
            const paymentDate = document.getElementById('editSppPaymentDate').value;
            const keterangan = document.getElementById('editSppKeterangan').value;
            const attachmentFile = document.getElementById('editSppAttachment').files[0];
            if (isNaN(nominal) || nominal <= 0 || !bank || !paymentDate) { alert('Semua field wajib diisi.'); return; }
            try {
                const studentRef = doc(db, "students", studentId);
                const studentSnap = await getDoc(studentRef);
                if (!studentSnap.exists()) { alert('Siswa tidak ditemukan.'); return; }
                const studentData = studentSnap.data();
                const updatedSppData = { ...studentData.spp };
                const oldPaymentData = updatedSppData[yearMonthKey];
                let newAttachmentBase64 = oldPaymentData.attachmentBase64;
                if (attachmentFile) {
                    if (attachmentFile.type.startsWith('image/')) newAttachmentBase64 = await compressImage(attachmentFile, 0.2); 
                    else if (attachmentFile.type === 'application/pdf') newAttachmentBase64 = await getBase64(attachmentFile);
                }
                updatedSppData[yearMonthKey] = {
                    nominal, bank, keterangan, attachmentBase64: newAttachmentBase64,
                    date: Timestamp.fromDate(new Date(paymentDate)),
                    paymentId: oldPaymentData.paymentId || '',
                    studentLevel: oldPaymentData.studentLevel || 'Level belum diatur'
                };
                await updateDoc(studentRef, { spp: updatedSppData });
                alert('Pembayaran SPP berhasil diperbarui!');
                editSppModal.style.display = 'none';
                await loadAllData();
                populateSppSummaryDashboard();
            } catch (error) { console.error("Gagal memperbarui pembayaran SPP:", error); alert(`Error: ${error.message}`); }
        }

        window.deleteSppPayment = async function() {
            if (!confirm('Apakah Anda yakin ingin menghapus pembayaran ini?')) return;
            const studentId = document.getElementById('editSppStudentId').value;
            const yearMonthKey = document.getElementById('editSppYearMonthKey').value;
            try {
                const studentRef = doc(db, "students", studentId);
                const updateData = { [`spp.${yearMonthKey}`]: deleteField() };
                await updateDoc(studentRef, updateData);
                alert('Pembayaran SPP berhasil dihapus!');
                editSppModal.style.display = 'none';
                await loadAllData();
                populateSppSummaryDashboard();
            } catch (error) { console.error("Gagal menghapus pembayaran SPP:", error); alert(`Error: ${error.message}`); }
        };

        function updatePaginationControls(type, current, total) {
            let pageDisplay, totalDisplay, prevBtn, nextBtn;
            if (type === 'spp') {
                pageDisplay = document.getElementById('currentPageDisplay'); totalDisplay = document.getElementById('totalPagesDisplay');
                prevBtn = document.getElementById('prevBtn'); nextBtn = document.getElementById('nextBtn');
            } else if (type === 'non-spp') {
                pageDisplay = document.getElementById('otherCurrentPageDisplay'); totalDisplay = document.getElementById('otherTotalPagesDisplay');
                prevBtn = document.getElementById('otherPrevBtn'); nextBtn = document.getElementById('otherNextBtn');
            } else if (type === 'student') {
                pageDisplay = document.getElementById('studentCurrentPage'); totalDisplay = document.getElementById('studentTotalPages');
                prevBtn = document.getElementById('studentPrevBtn'); nextBtn = document.getElementById('studentNextBtn');
            }
            if (pageDisplay) pageDisplay.textContent = current;
            if (totalDisplay) totalDisplay.textContent = total;
            if (prevBtn) prevBtn.disabled = current <= 1;
            if (nextBtn) nextBtn.disabled = current >= total || total === 0;
        }
        
        function setupNominalInput(id) {
            const inputElement = document.getElementById(id);
            if (inputElement) {
                const format = (e) => {
                    let value = e.target.value.replace(/\./g, '');
                    if (!isNaN(value) && value.length > 0) e.target.value = new Intl.NumberFormat('id-ID').format(value);
                };
                inputElement.addEventListener('keyup', format);
                inputElement.addEventListener('change', format);
            }
        }
        
window.generateAndSendPaymentProof = function() {
            const studentId = document.getElementById('studentFilter').value;
            const selectedYear = document.getElementById('yearFilter').value;
            if (studentId === 'all' || selectedYear === 'all') {
                alert("Harap pilih satu siswa dan satu tahun spesifik."); return;
            }
            const student = allStudents.find(s => s.id === studentId);
            if (!student || !student.phone) {
                alert("Nomor telepon siswa tidak ditemukan."); return;
            }
            const phoneNumber = formatPhoneNumber(student.phone);
            const paymentsForYear = student.spp || {};
            let paymentsToPrint = Object.keys(paymentsForYear)
                .filter(key => key.startsWith(selectedYear))
                .sort((a,b) => parseInt(a.split('-')[1]) - parseInt(b.split('-')[1]))
                .map(key => ({monthIndex: parseInt(key.split('-')[1]), data: paymentsForYear[key]}));

            if (paymentsToPrint.length === 0) {
                alert("Tidak ada data pembayaran untuk siswa ini pada tahun yang dipilih."); return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const totalNominal = paymentsToPrint.reduce((sum, p) => sum + p.data.nominal, 0);
            const totalNominalFormatted = new Intl.NumberFormat('id-ID', {style: 'currency', currency: 'IDR', minimumFractionDigits: 0}).format(totalNominal);
            const rincianPembayaran = paymentsToPrint.map(p => `• ${monthNames[p.monthIndex]}: ${new Intl.NumberFormat('id-ID', {style: 'currency', currency: 'IDR', minimumFractionDigits: 0}).format(p.data.nominal)}`).join('\n');
            
            const now = new Date();
            const timestamp = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}`;
            const fileName = `Bukti_Bayar_SPP_${student.name.replace(/ /g, '_')}_${selectedYear}_${timestamp}.pdf`;
            
            let message = whatsappTemplates.spp
                .replace(/{nama_siswa}/g, student.name)
                .replace(/{tahun_bayar}/g, selectedYear)
                .replace(/{total_nominal_formatted}/g, totalNominalFormatted)
                .replace(/{rincian_pembayaran}/g, rincianPembayaran)
                .replace(/{nama_file}/g, fileName);
            
            let yPos = 15;

            const addSppContentAndSave = () => {
                if (brandSettings && brandSettings.companyName) {
                    doc.setFontSize(12).setFont("helvetica", "normal");
                    doc.text(brandSettings.companyName, doc.internal.pageSize.getWidth() / 2, yPos, { align: "center" });
                    yPos += 8;
                }

                doc.setFontSize(16).text(`Laporan Pembayaran SPP`, doc.internal.pageSize.getWidth() / 2, yPos, { align: 'center' });
                yPos += 15;
                
                // --- MODIFIKASI 1: Tambahkan Nama Siswa dan Level ---
                doc.setFontSize(12);
                doc.text(`Nama Siswa: ${student.name}`, 14, yPos);
                doc.text(`Level: ${student.studentLevel || 'N/A'}`, 14, yPos + 7);
                doc.text(`Tahun: ${selectedYear}`, 14, yPos + 14);
                yPos += 22; // Tambahkan spasi ekstra

                doc.autoTable({
                    startY: yPos,
                    head: [['Bulan', 'Nominal', 'Bank', 'Tanggal Bayar']],
                    body: paymentsToPrint.map(p => [
                        monthNames[p.monthIndex],
                        `Rp ${new Intl.NumberFormat('id-ID').format(p.data.nominal)}`,
                        p.data.bank,
                        (p.data.date && typeof p.data.date.toDate === 'function') ? p.data.date.toDate().toLocaleDateString('id-ID') : 'N/A'
                    ]),
                    theme: 'grid'
                });

                doc.setFontSize(12).setFont("helvetica", "bold");
                doc.text(`Total Pembayaran: ${totalNominalFormatted}`, 14, doc.autoTable.previous.finalY + 10);
                
                // --- MODIFIKASI 2: Tambahkan Footer dengan Timestamp di setiap halaman ---
                const pageCount = doc.internal.getNumberOfPages();
                const printTimestamp = new Date().toLocaleString('id-ID', { dateStyle: 'long', timeStyle: 'short' });
                for(let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(150);
                    doc.text(
                        `Dicetak pada: ${printTimestamp}`, 
                        doc.internal.pageSize.getWidth() - 14, // Posisi X (kanan)
                        doc.internal.pageSize.getHeight() - 10, // Posisi Y (bawah)
                        { align: 'right' }
                    );
                }

                doc.save(fileName, { returnPromise: true }).then(() => {
                    alert(`PDF telah diunduh: "${fileName}"`);
                    const whatsappUrl = isMobile ? `whatsapp://send?phone=${phoneNumber}&text=${encodeURIComponent(message)}` : `https://web.whatsapp.com/send?phone=${phoneNumber}&text=${encodeURIComponent(message)}`;
                    window.open(whatsappUrl, '_blank');
                });
            };

            if (brandSettings && brandSettings.logoBase64) {
                const img = new Image();
                img.src = brandSettings.logoBase64;
                img.onload = () => {
                    const desiredLogoHeight = 20;
                    const aspectRatio = img.width / img.height;
                    const calculatedLogoWidth = desiredLogoHeight * aspectRatio;
                    doc.addImage(img, 'PNG', (doc.internal.pageSize.getWidth() - calculatedLogoWidth) / 2, yPos, calculatedLogoWidth, desiredLogoHeight);
                    yPos += desiredLogoHeight + 10;
                    addSppContentAndSave();
                };
                img.onerror = () => addSppContentAndSave();
            } else {
                addSppContentAndSave();
            }
        };

        function initializeNonSppModule() {
            loadNonSppData();
            setupNonSppEventListeners();
        }

        // ================== NEW FUNCTION TO FIX NON-SPP FILTERS ==================
        function populateNonSppFilters() {
            const historyYearFilter = document.getElementById('otherYearFilter');
            const historyBankFilter = document.getElementById('otherBankFilter');
            const summaryYearFilter = document.querySelector('#nonspp-tab #summaryYearFilter');
            
            const years = new Set();
            const banks = new Set();

            allOtherPayments.forEach(p => {
                if (p.timestamp && typeof p.timestamp.toDate === 'function') {
                    years.add(p.timestamp.toDate().getFullYear());
                }
                if (p.bank) {
                    banks.add(p.bank);
                }
            });

            // --- Mengisi Filter untuk Tabel Riwayat ---
            const sortedYears = Array.from(years).sort((a, b) => b - a);
            historyYearFilter.innerHTML = '<option value="all">Semua Tahun</option>';
            sortedYears.forEach(year => {
                historyYearFilter.innerHTML += `<option value="${year}">${year}</option>`;
            });

            const sortedBanks = Array.from(banks).sort();
            historyBankFilter.innerHTML = '<option value="all">Semua Bank</option>';
            sortedBanks.forEach(bank => {
                historyBankFilter.innerHTML += `<option value="${bank}">${bank}</option>`;
            });
            
            // --- Mengisi Filter untuk Ringkasan/Summary ---
            if (summaryYearFilter) {
                summaryYearFilter.innerHTML = '<option value="all">Semua Tahun</option>';
                 sortedYears.forEach(year => {
                    summaryYearFilter.innerHTML += `<option value="${year}">${year}</option>`;
                });
                // Atur nilai default ke tahun terbaru jika ada
                if (sortedYears.length > 0) {
                    summaryYearFilter.value = sortedYears[0];
                }
            }
        }
        
        async function loadNonSppData() {
            try {
                const querySnapshot = await getDocs(collection(db, "other_payments"));
                sessionReadCount += querySnapshot.size; updateReadStatus();
                allOtherPayments = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                setupOtherStudentSearchBox(); 
                populateNonSppFilters(); // PANGGIL FUNGSI BARU DI SINI
                populateNonSppSummaryDashboard();
                renderOtherPaymentsTable(filterNonSppData());
            } catch (error) {
                console.error("Error loading Non-SPP data:", error);
            }
        }
        function populateNonSppSummaryDashboard() {
            const yearFilter = document.querySelector('#nonspp-tab #summaryYearFilter').value;
            const monthFilter = document.querySelector('#nonspp-tab #summaryMonthFilter').value;
            const summaryContainer = document.getElementById('nonSppSummaryContainer');
            const totalNominalDisplay = document.getElementById('totalNominalDisplay');
            const filteredPayments = allOtherPayments.filter(p => {
                const paymentDate = p.timestamp ? p.timestamp.toDate() : null;
                if (!paymentDate) return false;
                let matchesYear = yearFilter === 'all' || paymentDate.getFullYear() == parseInt(yearFilter);
                let matchesMonth = monthFilter === 'all' || paymentDate.getMonth() == parseInt(monthFilter);
                return matchesYear && matchesMonth;
            });
            const bankTransactionCounts = filteredPayments.reduce((acc, payment) => {
                const bankName = payment.bank || 'Bank Tidak Diketahui';
                acc[bankName] = { 
                    count: (acc[bankName]?.count || 0) + 1,
                    nominal: (acc[bankName]?.nominal || 0) + (payment.nominal || 0)
                };
                return acc;
            }, {});
            let totalNominal = 0;
            summaryContainer.innerHTML = '';
            const sortedBanks = Object.keys(bankTransactionCounts).sort();
            if (sortedBanks.length > 0) {
                sortedBanks.forEach(bank => {
                    const data = bankTransactionCounts[bank];
                    totalNominal += data.nominal;
                    const nominalFormatted = new Intl.NumberFormat('id-ID', {style: 'currency', currency: 'IDR', minimumFractionDigits: 0}).format(data.nominal);
                    const divItem = document.createElement('div');
                    divItem.style.padding = '15px';
                    divItem.style.border = '1px solid var(--border-color)';
                    divItem.style.borderRadius = '8px';
                    divItem.style.backgroundColor = '#fff';
                    divItem.innerHTML = `
                        <h4>${bank}</h4>
                        <p>Total Transaksi: <b>${data.count}</b></p>
                        <p>Total Nominal: <b>${nominalFormatted}</b></p>
                    `;
                    summaryContainer.appendChild(divItem);
                });
            } else {
                summaryContainer.innerHTML = '<p class="no-data" style="grid-column: 1 / -1;">Tidak ada data transaksi untuk filter ini.</p>';
            }
            const totalNominalFormatted = new Intl.NumberFormat('id-ID', {style: 'currency', currency: 'IDR', minimumFractionDigits: 0}).format(totalNominal);
            totalNominalDisplay.textContent = totalNominalFormatted;
        }
        function setupNonSppEventListeners() {
            document.getElementById('otherPaymentForm').addEventListener('submit', handleAddOtherPayment);
            
            setupOtherStudentFilterSearchBox();
            
            document.getElementById('otherYearFilter').addEventListener('change', () => { 
                otherCurrentPage = 1; 
                renderOtherPaymentsTable(filterNonSppData()); 
            });
            document.getElementById('otherRowsPerPage').addEventListener('change', (e) => {
                otherRowsPerPage = parseInt(e.target.value, 10);
                otherCurrentPage = 1; 
                renderOtherPaymentsTable(filterNonSppData()); 
            });
            document.getElementById('otherPrevBtn').addEventListener('click', () => { 
                if (otherCurrentPage > 1) { 
                    otherCurrentPage--; 
                    renderOtherPaymentsTable(filterNonSppData()); 
                } 
            });
            document.getElementById('otherNextBtn').addEventListener('click', () => {
                const totalPages = parseInt(document.getElementById('otherTotalPagesDisplay').textContent);
                if (otherCurrentPage < totalPages) { 
                    otherCurrentPage++; 
                    renderOtherPaymentsTable(filterNonSppData()); 
                }
            });
            document.getElementById('selectAllCheckbox').addEventListener('change', (e) => {
                document.querySelectorAll('#otherPaymentsTableBody .report-checkbox').forEach(checkbox => {
                    checkbox.checked = e.target.checked;
                });
            });
            setupNominalInput('otherNominal');
            document.querySelector('#nonspp-tab #summaryYearFilter').addEventListener('change', populateNonSppSummaryDashboard);
            document.querySelector('#nonspp-tab #summaryMonthFilter').addEventListener('change', populateNonSppSummaryDashboard);
            document.getElementById('editNonSppForm').addEventListener('submit', handleUpdateNonSppPayment);
            document.getElementById('otherBankFilter').addEventListener('change', () => {
                otherCurrentPage = 1;
                renderOtherPaymentsTable(filterNonSppData());
            });
        }
        async function handleAddOtherPayment(e) {
            e.preventDefault();
            const studentId = document.getElementById('otherStudentSelector').value;
            const studentName = document.getElementById('otherStudentSearchBox').value; 
            const nominalInput = document.getElementById('otherNominal').value;
            const nominal = parseFloat(nominalInput.replace(/\./g, ''));
            const bank = document.getElementById('otherBankSelector').value;
            const paymentDate = document.getElementById('otherPaymentDate').value;
            const keterangan = document.getElementById('otherKeterangan').value;
            const attachmentFile = document.getElementById('otherAttachment').files[0];
            const statusMessageDiv = document.getElementById('otherStatusMessage');
            
            if (!studentId || isNaN(nominal) || !bank || !paymentDate || !keterangan) {
                statusMessageDiv.textContent = 'Semua field harus diisi.';
                statusMessageDiv.style.color = 'red';
                return;
            }
            statusMessageDiv.textContent = 'Menyimpan laporan...';
            statusMessageDiv.style.color = 'blue';
            try {
                let attachmentBase64 = '';
                if (attachmentFile) {
                    if (attachmentFile.size > 3 * 1024 * 1024) {
                        statusMessageDiv.textContent = 'Error: Ukuran file terlalu besar. Maksimum 3MB.';
                        statusMessageDiv.style.color = 'red';
                        return;
                    }
                    if (attachmentFile.type.startsWith('image/')) {
                        attachmentBase64 = await compressImage(attachmentFile, 0.2);
                    } else if (attachmentFile.type === 'application/pdf') {
                        attachmentBase64 = await getBase64(attachmentFile);
                    } else {
                        statusMessageDiv.textContent = 'Error: Jenis file tidak didukung.';
                        statusMessageDiv.style.color = 'red';
                        return;
                    }
                }
                const docData = {
                    timestamp: Timestamp.fromDate(new Date(paymentDate)),
                    studentId, siswa: studentName, keterangan, bank, nominal,
                    bendaharaEmail: auth.currentUser.email,
                    attachmentBase64: attachmentBase64
                };
                await addDoc(collection(db, "other_payments"), docData);
                statusMessageDiv.textContent = 'Laporan berhasil disimpan!';
                statusMessageDiv.style.color = 'green';
                document.getElementById('otherPaymentForm').reset();
                document.getElementById('otherPaymentDate').valueAsDate = new Date();
                await loadNonSppData();
                populateNonSppSummaryDashboard();
            } catch (error) {
                statusMessageDiv.textContent = `Error: ${error.message}`;
                statusMessageDiv.style.color = 'red';
            }
        }
        function filterNonSppData() {
            const studentId = document.getElementById('otherStudentFilter').value;
            const year = document.getElementById('otherYearFilter').value;
            const bank = document.getElementById('otherBankFilter').value;

            return allOtherPayments.filter(p => {
                const paymentDate = p.timestamp ? p.timestamp.toDate() : null;
                let matchesStudent = (studentId === 'all' || p.studentId === studentId);
                let matchesYear = year === 'all' || (paymentDate && paymentDate.getFullYear() == year);
                let matchesBank = bank === 'all' || p.bank === bank;

                return matchesStudent && matchesYear && matchesBank;
            });
        }
        function renderOtherPaymentsTable(data) {
            const tableBody = document.getElementById('otherPaymentsTableBody');
            const totalPages = Math.ceil(data.length / otherRowsPerPage);
            otherCurrentPage = Math.min(otherCurrentPage, totalPages || 1);
            const paginatedData = data.slice((otherCurrentPage - 1) * otherRowsPerPage, otherCurrentPage * otherRowsPerPage);
            tableBody.innerHTML = '';
            if (paginatedData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" class="no-data">Tidak ada laporan yang cocok dengan filter.</td></tr>';
            } else {
                paginatedData
                    .sort((a, b) => {
                        const dateA = a.timestamp && typeof a.timestamp.toDate === 'function' ? a.timestamp.toDate() : new Date(0);
                        const dateB = b.timestamp && typeof b.timestamp.toDate === 'function' ? b.timestamp.toDate() : new Date(0);
                        return dateB - dateA;
                    })
                    .forEach(item => {
                        const dateString = (item.timestamp && typeof item.timestamp.toDate === 'function')
                            ? item.timestamp.toDate().toLocaleDateString('id-ID')
                            : '<i style="color:red;">Tgl Invalid</i>';
                        const row = tableBody.insertRow();
                        
                        let attachmentLink = 'N/A';
                        if (item.attachmentBase64) {
                            const detailsJson = encodeURIComponent(JSON.stringify({
                                studentName: item.siswa,
                                attachmentBase64: item.attachmentBase64,
                            }));
                            attachmentLink = `<a href="#" onclick="event.preventDefault(); showOtherPaymentDetails('${detailsJson}')">Lihat Bukti</a>`;
                        }

                        row.innerHTML = `
                            <td class="checkbox-cell"><input type="checkbox" class="report-checkbox" data-id="${item.id}"></td>
                            <td>${dateString}</td>
                            <td>${item.siswa || '-'}</td>
                            <td>${item.keterangan || '-'}</td>
                            <td>${attachmentLink}</td>
                            <td>${item.bank || '-'}</td>
                            <td>Rp ${new Intl.NumberFormat('id-ID').format(item.nominal || 0)}</td>
                            <td><button type="button" class="action-btn-edit" onclick="openPinModal('nonspp', '${item.id}')">Edit</button></td>
                        `;
                    });
            }
            updatePaginationControls('non-spp', otherCurrentPage, totalPages);
            document.getElementById('selectAllCheckbox').checked = false;
        }
        window.showOtherPaymentDetails = function(detailsJsonEncoded) {
            const detailsJson = decodeURIComponent(detailsJsonEncoded);
            const details = JSON.parse(detailsJson);
            modalTitle.textContent = `Bukti Bayar Non-SPP untuk ${details.studentName}`;
            let contentHTML = ``;
            if (details.attachmentBase64) {
                const mimeType = details.attachmentBase64.split(';')[0].split(':')[1];
                contentHTML += `
                    <div style="margin-top: 15px;">
                        <p><strong>Bukti Pembayaran (Snapshot):</strong></p>
                `;
                if (mimeType.startsWith('image/')) {
                    contentHTML += `<img src="${details.attachmentBase64}" alt="Bukti Pembayaran" class="attachment-preview">`;
                } else if (mimeType === 'application/pdf') {
                    contentHTML += `<iframe src="${details.attachmentBase64}" class="attachment-iframe"></iframe>`;
                }
                contentHTML += `</div>`;
            }
            modalBodyContent.innerHTML = contentHTML;
            singleModal.style.display = 'flex';
        };
        async function openEditNonSppModal(paymentId) {
            const payment = allOtherPayments.find(p => p.id === paymentId);
            if (!payment) return;
            document.getElementById('editNonSppId').value = paymentId;
            document.getElementById('editNonSppStudentName').value = payment.siswa || 'Tidak Diketahui';
            document.getElementById('editNonSppNominal').value = new Intl.NumberFormat('id-ID').format(payment.nominal);
            document.getElementById('editNonSppBank').value = payment.bank;
            document.getElementById('editNonSppPaymentDate').value = (payment.timestamp && typeof payment.timestamp.toDate === 'function') ? payment.timestamp.toDate().toISOString().slice(0, 10) : '';
            document.getElementById('editNonSppKeterangan').value = payment.keterangan;
            document.getElementById('editNonSppAttachment').value = '';

            setupNominalInput('editNonSppNominal');
            editNonSppModal.style.display = 'flex';
        }
        async function handleUpdateNonSppPayment(e) {
            e.preventDefault();
            const paymentId = document.getElementById('editNonSppId').value;
            const nominalInput = document.getElementById('editNonSppNominal').value;
            const nominal = parseFloat(nominalInput.replace(/\./g, ''));
            const bank = document.getElementById('editNonSppBank').value;
            const paymentDate = document.getElementById('editNonSppPaymentDate').value;
            const keterangan = document.getElementById('editNonSppKeterangan').value;
            const attachmentFile = document.getElementById('editNonSppAttachment').files[0];
            const compressionQuality = 0.2;
            
            if (isNaN(nominal) || nominal <= 0 || !bank || !paymentDate || !keterangan) {
                alert('Semua field wajib diisi.');
                return;
            }

            try {
                const oldPayment = allOtherPayments.find(p => p.id === paymentId);
                let newAttachmentBase64 = oldPayment.attachmentBase64;
                
                if (attachmentFile) {
                    if (attachmentFile.type.startsWith('image/')) {
                        newAttachmentBase64 = await compressImage(attachmentFile, compressionQuality);
                    } else if (attachmentFile.type === 'application/pdf') {
                        newAttachmentBase64 = await getBase64(attachmentFile);
                    }
                }
                
                const updatedData = {
                    nominal: nominal,
                    bank: bank,
                    timestamp: Timestamp.fromDate(new Date(paymentDate)),
                    keterangan: keterangan,
                    attachmentBase64: newAttachmentBase64
                };

                await updateDoc(doc(db, "other_payments", paymentId), updatedData);
                alert('Laporan Non-SPP berhasil diperbarui!');
                editNonSppModal.style.display = 'none';
                await loadNonSppData();
                populateNonSppSummaryDashboard();
            } catch (error) {
                console.error("Gagal memperbarui laporan Non-SPP:", error);
                alert(`Error: ${error.message}`);
            }
        }
        window.deleteNonSppPayment = async function() {
            if (!confirm('Apakah Anda yakin ingin menghapus laporan ini?')) return;
            const paymentId = document.getElementById('editNonSppId').value;
            try {
                await deleteDoc(doc(db, "other_payments", paymentId));
                alert('Laporan Non-SPP berhasil dihapus!');
                editNonSppModal.style.display = 'none';
                await loadNonSppData();
                populateNonSppSummaryDashboard();
            } catch (error) {
                console.error("Gagal menghapus laporan Non-SPP:", error);
                alert(`Error: ${error.message}`);
            }
        };
        window.generateAndSendSelectedOtherPaymentProof = async function() {
            const selectedCheckboxes = document.querySelectorAll('.report-checkbox:checked');
            if (selectedCheckboxes.length === 0) return alert('Harap centang setidaknya satu laporan.');
            const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.id);
            const selectedReports = allOtherPayments.filter(p => selectedIds.includes(p.id));
            const studentIds = new Set(selectedReports.map(p => p.studentId));
            if (studentIds.size > 1) return alert('Hanya bisa mengirim laporan untuk satu siswa dalam satu waktu.');
            const studentId = [...studentIds][0];
            const student = allStudents.find(s => s.id === studentId);
            if (!student || !student.phone) return alert("Nomor telepon siswa tidak ditemukan.");
            const phoneNumber = formatPhoneNumber(student.phone);
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let yPos = 15;
            
            const nonsppTemplate = whatsappTemplates.nonspp;
            
            const totalNominal = selectedReports.reduce((sum, p) => sum + p.nominal, 0);
            const totalNominalFormatted = new Intl.NumberFormat('id-ID', {style: 'currency', currency: 'IDR', minimumFractionDigits: 0}).format(totalNominal);
            
            const now = new Date();
            const timestamp = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}${String(now.getSeconds()).padStart(2, '0')}`;
            const fileName = `Bukti_Bayar_Non-SPP_${student.name.replace(/ /g, '_')}_${timestamp}.pdf`;
            
            const message = nonsppTemplate
                .replace(/{nama_siswa}/g, student.name)
                .replace(/{total_nominal_formatted}/g, totalNominalFormatted)
                .replace(/{nama_file}/g, fileName);

            const addContentAndSave = () => {
                if (brandSettings && brandSettings.companyName) {
                    doc.setFontSize(12);
                    doc.setFont("helvetica", "normal");
                    doc.text(brandSettings.companyName, doc.internal.pageSize.getWidth() / 2, yPos, { align: "center" });
                    yPos += 8;
                }
                doc.setFontSize(16).text('Laporan Non-SPP', doc.internal.pageSize.getWidth() / 2, yPos, { align: 'center' });
                yPos += 15;
                doc.setFontSize(12).text(`Nama Siswa: ${student.name}`, 14, yPos);
                yPos += 10;
                doc.autoTable({
                    startY: yPos,
                    head: [['Tanggal', 'Keterangan', 'Bank', 'Nominal']],
                    body: selectedReports.map(p => {
                        const dateString = (p.timestamp && typeof p.timestamp.toDate === 'function')
                            ? p.timestamp.toDate().toLocaleDateString('id-ID')
                            : 'Tgl Invalid';
                        return [dateString, p.keterangan, p.bank, `Rp ${new Intl.NumberFormat('id-ID').format(p.nominal)}`];
                    })
                });
                
                doc.setFontSize(12);
                doc.setFont("helvetica", "bold");
                doc.text(`Total Laporan: ${totalNominalFormatted}`, 14, doc.autoTable.previous.finalY + 10);

                const encodedMessage = encodeURIComponent(message);
                
                let whatsappUrl = isMobile 
                    ? `whatsapp://send?phone=${phoneNumber}&text=${encodedMessage}` 
                    : `https://web.whatsapp.com/send?phone=${phoneNumber}&text=${encodedMessage}`;
                
                doc.save(fileName, { returnPromise: true }).then(() => {
                    alert(`PDF telah diunduh: "${fileName}"\n\nSilakan lampirkan file tersebut di chat WhatsApp yang terbuka.`);
                    window.open(whatsappUrl, '_blank');
                });
            };

            if (brandSettings && brandSettings.logoBase64) {
                const img = new Image();
                img.src = brandSettings.logoBase64;
                img.onload = () => {
                    const desiredLogoHeight = 20;
                    const aspectRatio = img.width / img.height;
                    const calculatedLogoWidth = desiredLogoHeight * aspectRatio;
                    doc.addImage(img, 'PNG', (doc.internal.pageSize.getWidth() - calculatedLogoWidth) / 2, yPos, calculatedLogoWidth, desiredLogoHeight);
                    yPos += desiredLogoHeight + 10;
                    addContentAndSave();
                };
                img.onerror = () => addContentAndSave();
            } else {
                addContentAndSave();
            }
        };
        async function updateCoachStudentCount(coachEmail, value) {
            if (!coachEmail) return;
            const coachRef = doc(db, "users", coachEmail);
            try {
                await updateDoc(coachRef, { studentCount: increment(value) });
            } catch (error) {
                if (error.code && (error.code.includes('not-found') || error.code.includes('no-document-to-update'))) {
                     await setDoc(coachRef, { studentCount: value > 0 ? value : 0 }, { merge: true });
                } else {
                    console.error(`Gagal update studentCount untuk ${coachEmail}:`, error);
                }
            }
        }
        async function handleAddStudent(e) {
            e.preventDefault();
            const studentName = document.getElementById('newStudentName').value.trim();
            const studentPhone = document.getElementById('newStudentPhone').value.trim();
            const coachEmail = document.getElementById('coachForStudentSelector').value;
            const statusMessageDiv = document.getElementById('studentStatusMessage');
            if (!studentName || !coachEmail) { statusMessageDiv.textContent = 'Nama & coach harus diisi.'; return; }
            try {
                await addDoc(collection(db, "students"), { name: studentName, phone: studentPhone, coachEmail: coachEmail, status: 'active' });
                await updateCoachStudentCount(coachEmail, 1);
                alert('Siswa berhasil ditambahkan.');
                document.getElementById('addStudentForm').reset();
                await loadAllData();
            } catch (error) { alert(`Error: ${error.message}`); }
        }
        function renderStudentTable() {
            const tableBody = document.getElementById('studentsTableBody');
            const showDisabled = document.getElementById('showDisabledStudents').checked;
            const coachFilter = document.getElementById('coachFilterSelector').value;
            const studentFilter = document.getElementById('studentListFilter').value;
            const levelFilter = document.getElementById('levelFilterSelector').value;
            let filteredStudents = allStudents;
            
            if (coachFilter !== 'all') { filteredStudents = filteredStudents.filter(s => s.coachEmail === coachFilter); }
            if (studentFilter !== 'all') { filteredStudents = filteredStudents.filter(s => s.id === studentFilter); }
            if (levelFilter !== 'all') { filteredStudents = filteredStudents.filter(s => s.studentLevel === levelFilter); }
            if (!showDisabled) { filteredStudents = filteredStudents.filter(s => (s.status || 'active') === 'active'); }

            const rowsPerPage = parseInt(document.getElementById('studentRowsPerPage').value, 10);
            const totalItems = filteredStudents.length;
            const totalPages = Math.ceil(totalItems / rowsPerPage) || 1;
            if (studentCurrentPage > totalPages) studentCurrentPage = totalPages;
            const start = (studentCurrentPage - 1) * rowsPerPage;
            const paginatedStudents = filteredStudents.slice(start, start + rowsPerPage);
            tableBody.innerHTML = '';
            if (paginatedStudents.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5">Tidak ada siswa yang cocok dengan filter.</td></tr>';
            } else {
                paginatedStudents.forEach(student => {
                    const coachData = allUsers.find(u => u.id === student.coachEmail);
                    const coachName = coachData ? coachData.name : (student.coachEmail || 'N/A');
                    const status = student.status || 'active';
                    const studentLevel = student.studentLevel || '';
                    const row = tableBody.insertRow();
                    row.className = status === 'disabled' ? 'disabled-row' : '';
                    const buttonText = status === 'active' ? 'Disable' : 'Enable';
                    const buttonClass = status === 'active' ? 'action-btn-disable' : 'action-btn-enable';
                    row.innerHTML = `<td class="checkbox-cell"><input type="checkbox" class="student-checkbox" value="${student.id}" data-coach="${student.coachEmail}"></td><td>${student.name}</td><td>${coachName}</td><td>${studentLevel}</td><td style="white-space: nowrap;"><button type="button" class="${buttonClass}" onclick="toggleStudentStatus('${student.id}','${status}')">${buttonText}</button> <button type="button" class="action-btn-edit" onclick="openStudentEditModal('${student.id}')">Edit</button></td>`;
                });
            }
            updatePaginationControls('student', studentCurrentPage, totalPages);
        }
        function renderPendingAssignmentTable() {
            const tableBody = document.getElementById('pendingAssignmentTableBody');
            const assignAndSaveBtn = document.getElementById('assignAndSaveBtn');
            const assignCoachSelector = document.getElementById('assignCoachSelector');
            const assignLevelSelector = document.getElementById('assignLevelSelector');
            const selectAllPendingCheckbox = document.getElementById('selectAllPendingCheckbox');
            const cancelImportBtn = document.getElementById('cancelImportBtn');
            
            tableBody.innerHTML = '';
            if (pendingImportStudents.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="3">Tidak ada siswa yang menunggu penugasan.</td></tr>';
                assignAndSaveBtn.disabled = true;
                assignCoachSelector.disabled = true;
                assignLevelSelector.disabled = true;
                selectAllPendingCheckbox.disabled = true;
                cancelImportBtn.disabled = true;
            } else {
                assignAndSaveBtn.disabled = false;
                assignCoachSelector.disabled = false;
                assignLevelSelector.disabled = false;
                selectAllPendingCheckbox.disabled = false;
                cancelImportBtn.disabled = false;
                pendingImportStudents.forEach((student, index) => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `<td><input type="checkbox" class="pending-student-checkbox" value="${index}"></td><td>${student.name}</td><td>${student.phone || 'N/A'}</td>`;
                });
            }
        }
        async function handleEditStudent(e) {
            e.preventDefault();
            const studentId = document.getElementById('editStudentId').value;
            const studentBefore = allStudents.find(s => s.id === studentId);
            const oldCoachEmail = studentBefore.coachEmail;
            const newCoachEmail = document.getElementById('editStudentCoach').value;
            const newCoachData = allUsers.find(u => u.id === newCoachEmail);
            const newCoachName = newCoachData ? newCoachData.name : newCoachEmail;
            const updatedData = {
                name: document.getElementById('editStudentName').value,
                studentLevel: document.getElementById('editStudentLevel').value,
                coachEmail: newCoachEmail,
                phone: document.getElementById('editStudentPhone').value
            };
            try {
                const batch = writeBatch(db);
                const studentDocRef = doc(db, "students", studentId);
                batch.update(studentDocRef, updatedData);
                if (oldCoachEmail !== newCoachEmail) {
                    if (oldCoachEmail) {
                        const oldCoachRef = doc(db, "users", oldCoachEmail);
                        batch.update(oldCoachRef, { studentCount: increment(-1) });
                    }
                    if (newCoachEmail) {
                        const newCoachRef = doc(db, "users", newCoachEmail);
                        batch.update(newCoachRef, { studentCount: increment(1) });
                    }
                    const reportsQuery = query(collection(db, "reports"), where("studentId", "==", studentId));
                    const reportsSnapshot = await getDocs(reportsQuery);
                    reportsSnapshot.forEach(reportDoc => {
                        const reportRef = doc(db, "reports", reportDoc.id);
                        batch.update(reportRef, { 
                            coachEmail: newCoachEmail,
                            coach: newCoachName 
                        });
                    });
                }
                await batch.commit();
                alert('Detail siswa dan riwayat laporan berhasil diperbarui!');
                document.getElementById('editStudentModal').style.display = 'none';
                await loadAllData();
                populateSppSummaryDashboard();
            } catch(error) { 
                console.error("Gagal menyimpan dan memindahkan riwayat:", error);
                alert('Gagal menyimpan dan memindahkan riwayat. Periksa konsol untuk detail.'); 
            }
        }
        window.toggleStudentStatus = async function(studentId, currentStatus) {
            const newStatus = currentStatus === 'active' ? 'disabled' : 'active';
            if (confirm(`Yakin ingin ${newStatus === 'active' ? 'mengaktifkan' : 'menonaktifkan'} siswa ini?`)) {
                const studentBefore = allStudents.find(s => s.id === studentId);
                await updateDoc(doc(db, "students", studentId), { status: newStatus });
                if (studentBefore.coachEmail) {
                    const countChange = newStatus === 'active' ? 1 : -1;
                    await updateCoachStudentCount(studentBefore.coachEmail, countChange);
                }
                await loadAllData();
                populateSppSummaryDashboard();
            }
        };
        async function handleBulkChange() {
            const allSelectedCheckboxes = document.querySelectorAll('.student-checkbox:checked');
            const newCoachEmail = document.getElementById('bulkCoachSelector').value;
            const statusMessageDiv = document.getElementById('bulkActionStatusMessage');
            if (allSelectedCheckboxes.length === 0 || !newCoachEmail) {
                statusMessageDiv.textContent = 'Pilih siswa dan coach tujuan.';
                statusMessageDiv.style.color = 'red';
                return;
            }
            if (!confirm(`Yakin ingin memindahkan ${allSelectedCheckboxes.length} siswa ke coach baru?`)) {
                return;
            }
            statusMessageDiv.textContent = 'Menerapkan perubahan...';
            statusMessageDiv.style.color = 'blue';
            try {
                const batch = writeBatch(db);
                const coachCountChanges = new Map();
                const reportsToUpdate = [];
                const selectedStudents = Array.from(allSelectedCheckboxes).map(checkbox => {
                    const studentId = checkbox.value;
                    return allStudents.find(s => s.id === studentId);
                });
                const newCoachData = allUsers.find(u => u.id === newCoachEmail);
                const newCoachName = newCoachData ? newCoachData.name : newCoachEmail;
                selectedStudents.forEach(student => {
                    const oldCoachEmail = student.coachEmail;
                    if (oldCoachEmail !== newCoachEmail) {
                        if (oldCoachEmail) {
                            coachCountChanges.set(oldCoachEmail, (coachCountChanges.get(oldCoachEmail) || 0) - 1);
                        }
                        coachCountChanges.set(newCoachEmail, (coachCountChanges.get(newCoachEmail) || 0) + 1);
                        batch.update(doc(db, "students", student.id), { coachEmail: newCoachEmail });
                        reportsToUpdate.push(student.id);
                    }
                });
                if (reportsToUpdate.length === 0) {
                    statusMessageDiv.textContent = 'Tidak ada perubahan yang diperlukan.';
                    statusMessageDiv.style.color = 'green';
                    return;
                }
                coachCountChanges.forEach((change, coachEmail) => {
                    batch.update(doc(db, "users", coachEmail), { studentCount: increment(change) });
                });
                for (const studentId of reportsToUpdate) {
                    const reportsQuery = query(collection(db, "reports"), where("studentId", "==", studentId));
                    const reportsSnapshot = await getDocs(reportsQuery);
                    reportsSnapshot.forEach(reportDoc => {
                        const reportRef = doc(db, "reports", reportDoc.id);
                        batch.update(reportRef, { 
                            coachEmail: newCoachEmail,
                            coach: newCoachName
                        });
                    });
                }
                await batch.commit();
                statusMessageDiv.textContent = `Berhasil memindahkan ${selectedStudents.length} siswa ke coach baru.`;
                statusMessageDiv.style.color = 'green';
                document.getElementById('selectAllBulkCheckbox').checked = false; 
                await loadAllData();
                populateSppSummaryDashboard();
            } catch (error) {
                statusMessageDiv.textContent = `Gagal mengganti coach: ${error.message}`;
                statusMessageDiv.style.color = 'red';
                console.error("Gagal mengganti coach secara massal:", error);
            }
        }
        async function handleBulkLevelChange() {
            const allSelectedCheckboxes = document.querySelectorAll('.student-checkbox:checked');
            const newStudentLevel = document.getElementById('bulkLevelSelector').value;
            const statusMessageDiv = document.getElementById('bulkActionStatusMessage');
            if (allSelectedCheckboxes.length === 0 || !newStudentLevel) {
                statusMessageDiv.textContent = 'Pilih siswa dan level tujuan.';
                statusMessageDiv.style.color = 'red';
                return;
            }
            if (!confirm(`Yakin ingin mengubah level ${allSelectedCheckboxes.length} siswa menjadi '${newStudentLevel}'?`)) {
                return;
            }
            statusMessageDiv.textContent = 'Menerapkan perubahan level...';
            statusMessageDiv.style.color = 'blue';
            try {
                const batch = writeBatch(db);
                let updatedCount = 0;
                allSelectedCheckboxes.forEach(checkbox => {
                    const studentId = checkbox.value;
                    batch.update(doc(db, "students", studentId), { studentLevel: newStudentLevel });
                    updatedCount++;
                });
                if (updatedCount === 0) {
                    statusMessageDiv.textContent = 'Tidak ada siswa yang dipilih.';
                    statusMessageDiv.style.color = 'orange';
                    return;
                }
                await batch.commit();
                statusMessageDiv.textContent = `Sukses! ${updatedCount} siswa telah diperbarui levelnya.`;
                statusMessageDiv.style.color = 'green';
                document.getElementById('selectAllBulkCheckbox').checked = false; 
                await loadAllData();
            } catch (error) {
                statusMessageDiv.textContent = `Gagal mengubah level siswa: ${error.message}`;
                statusMessageDiv.style.color = 'red';
                console.error("Gagal mengubah level siswa secara massal:", error);
            }
        }
        async function handleAssignAndSave() {
            const allSelectedCheckboxes = document.querySelectorAll('.pending-student-checkbox:checked');
            const newCoachEmail = document.getElementById('assignCoachSelector').value;
            const newStudentLevel = document.getElementById('assignLevelSelector').value;
            const assignStatusDiv = document.getElementById('assignStatusMessage');
            if (allSelectedCheckboxes.length === 0 || !newCoachEmail || !newStudentLevel) {
                assignStatusDiv.textContent = 'Harap pilih siswa, coach, dan level.';
                assignStatusDiv.style.color = 'red';
                return;
            }
            if (!confirm(`Yakin ingin menetapkan coach & level untuk ${allSelectedCheckboxes.length} siswa dan menyimpannya?`)) {
                return;
            }
            assignStatusDiv.textContent = 'Menyimpan data...';
            assignStatusDiv.style.color = 'blue';
            try {
                const batch = writeBatch(db);
                const coachCountChanges = new Map();
                const studentsToSave = [];
                allSelectedCheckboxes.forEach(checkbox => {
                    const studentIndex = parseInt(checkbox.value, 10);
                    const studentData = pendingImportStudents[studentIndex];
                    studentsToSave.push(studentData);
                    const studentRef = doc(collection(db, "students"));
                    batch.set(studentRef, {
                        name: studentData.name,
                        phone: studentData.phone || '',
                        coachEmail: newCoachEmail,
                        studentLevel: newStudentLevel,
                        status: 'active'
                    });
                    coachCountChanges.set(newCoachEmail, (coachCountChanges.get(newCoachEmail) || 0) + 1);
                });
                for (const [coachEmail, count] of coachCountChanges.entries()) {
                    const coachRef = doc(db, "users", coachEmail);
                    batch.update(coachRef, { studentCount: increment(count) });
                }
                await batch.commit();
                pendingImportStudents = pendingImportStudents.filter((_, index) => {
                    return !Array.from(allSelectedCheckboxes).some(cb => parseInt(cb.value, 10) === index);
                });
                localStorage.setItem('pendingImportStudents', JSON.stringify(pendingImportStudents));
                assignStatusDiv.textContent = `Berhasil menyimpan ${studentsToSave.length} siswa!`;
                assignStatusDiv.style.color = 'green';
                await loadAllData();
                populateSppSummaryDashboard();
            } catch(error) {
                assignStatusDiv.textContent = `Gagal menyimpan: ${error.message}`;
                assignStatusDiv.style.color = 'red';
                console.error("Gagal menetapkan dan menyimpan siswa:", error);
            }
        }
        async function handleCancelImport() {
            if (confirm('Yakin ingin membatalkan impor dan menghapus semua data di tabel ini?')) {
                pendingImportStudents = [];
                localStorage.removeItem('pendingImportStudents');
                renderPendingAssignmentTable();
                document.getElementById('assignStatusMessage').textContent = 'Impor dibatalkan. Data dibersihkan.';
                document.getElementById('assignStatusMessage').style.color = 'green';
            }
        }
        async function handleTransfer() {
            const sourceCoachEmail = document.getElementById('sourceCoachSelector').value;
            const destCoachEmail = document.getElementById('destinationCoachSelector').value;
            const transferStatusDiv = document.getElementById('transferStatusMessage');
            if (!sourceCoachEmail || !destCoachEmail || sourceCoachEmail === destCoachEmail) {
                transferStatusDiv.textContent = 'Coach sumber dan tujuan harus berbeda.';
                transferStatusDiv.style.color = 'red';
                return;
            }
            const studentQuery = query(collection(db, "students"), where("coachEmail", "==", sourceCoachEmail), where("status", "==", "active"));
            const studentSnapshot = await getDocs(studentQuery);
            sessionReadCount += studentSnapshot.size; updateReadStatus();
            const studentsToMove = studentSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if (studentsToMove.length === 0) {
                transferStatusDiv.textContent = 'Coach sumber tidak memiliki siswa aktif.';
                transferStatusDiv.style.color = 'orange';
                return;
            }
            if (confirm(`Yakin memindahkan ${studentsToMove.length} siswa dari coach sumber ke coach tujuan?`)) {
                transferStatusDiv.textContent = 'Memindahkan siswa...';
                transferStatusDiv.style.color = 'blue';
                const batch = writeBatch(db);
                const studentIdsToUpdate = [];
                const newCoachData = allUsers.find(u => u.id === destCoachEmail);
                const newCoachName = newCoachData ? newCoachData.name : destCoachEmail;
                studentsToMove.forEach(studentDoc => { 
                    batch.update(doc(db, "students", studentDoc.id), { coachEmail: destCoachEmail }); 
                    studentIdsToUpdate.push(studentDoc.id);
                });
                batch.update(doc(db, "users", sourceCoachEmail), { studentCount: increment(-studentsToMove.length) });
                batch.update(doc(db, "users", destCoachEmail), { studentCount: increment(studentsToMove.length) });
                for (const studentId of studentIdsToUpdate) {
                    const reportsQuery = query(collection(db, "reports"), where("studentId", "==", studentId));
                    const reportsSnapshot = await getDocs(reportsQuery);
                    sessionReadCount += reportsSnapshot.size; updateReadStatus();
                    reportsSnapshot.forEach(reportDoc => {
                        const reportRef = doc(db, "reports", reportDoc.id);
                        batch.update(reportRef, { 
                            coachEmail: destCoachEmail,
                            coach: newCoachName
                        });
                    });
                }
                await batch.commit();
                transferStatusDiv.textContent = `Sukses! ${studentsToMove.length} siswa dan riwayat laporannya telah dipindahkan.`;
                transferStatusDiv.style.color = 'green';
                await loadAllData();
                populateSppSummaryDashboard();
            }
        }
        function populateCoachDropdowns() {
            const selectors = [
                document.getElementById('coachForStudentSelector'),
                document.getElementById('bulkCoachSelector'),
                document.getElementById('sourceCoachSelector'),
                document.getElementById('destinationCoachSelector'),
                document.getElementById('coachFilterSelector'),
                document.getElementById('editStudentCoach'),
                document.getElementById('assignCoachSelector')
            ];
            const activeCoaches = allUsers.filter(u => u.role === 'user' && (u.status || 'active') === 'active');
            let coachOptions = '';
            activeCoaches.forEach(coach => {
                coachOptions += `<option value="${coach.id}">${coach.name} (${coach.coachId || 'N/A'})</option>`;
            });
            selectors.forEach(selector => {
                if (!selector) return;
                const currentVal = selector.value;
                if (selector.id === 'coachFilterSelector') {
                    selector.innerHTML = '<option value="all" selected>-- Semua Coach --</option>' + coachOptions;
                } else {
                    selector.innerHTML = '<option value="">-- Pilih Coach --</option>' + coachOptions;
                }
                selector.value = currentVal || (selector.id === 'coachFilterSelector' ? 'all' : '');
            });
        }
        function populateLevelDropdowns() {
            const selectors = [
                document.getElementById('editStudentLevel'),
                document.getElementById('bulkLevelSelector'),
                document.getElementById('assignLevelSelector')
            ];
            selectors.forEach(selector => {
                if (!selector) return;
                const currentVal = selector.value;
                let options = '<option value="">-- Pilih Level --</option>';
                allLevels.forEach(level => {
                    options += `<option value="${level}">${level}</option>`;
                });
                selector.innerHTML = options;
                selector.value = currentVal;
            });
        }
        window.openStudentEditModal = function(studentId) {
            const student = allStudents.find(s => s.id === studentId);
            if (!student) return;
            document.getElementById('editStudentId').value = studentId;
            document.getElementById('editStudentName').value = student.name;
            const levelSelector = document.getElementById('editStudentLevel');
            levelSelector.value = student.studentLevel || "";
            const coachSelector = document.getElementById('editStudentCoach');
            coachSelector.value = student.coachEmail;
            document.getElementById('editStudentPhone').value = student.phone || '';
            document.getElementById('editStudentModal').style.display = 'block';
        };
        async function downloadExcelTemplate() {
            const header = ['nama', 'phone'];
            const ws = XLSX.utils.aoa_to_sheet([header]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Siswa Baru");
            XLSX.writeFile(wb, "Template_Siswa_Baru.xlsx");
        }
        async function handleImportStudent(e) {
            e.preventDefault();
            const file = document.getElementById('excelFileInput').files[0];
            const importStatusDiv = document.getElementById('importStatusMessage');
        
            if (!file) {
                importStatusDiv.textContent = 'Pilih file Excel terlebih dahulu.';
                importStatusDiv.style.color = 'red';
                return;
            }
            
            importStatusDiv.textContent = 'Memproses file...';
            importStatusDiv.style.color = 'blue';

            const reader = new FileReader();
            reader.onload = async function(event) {
                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonStudents = XLSX.utils.sheet_to_json(worksheet);
                    const existingStudentNames = new Set(allStudents.map(s => s.name.toLowerCase()));
                    pendingImportStudents = [];
                    let newStudentCount = 0;
                    let skippedRows = 0;
                    for (const studentData of jsonStudents) {
                        const name = studentData.nama;
                        if (!name) {
                            console.warn(`Melewatkan baris karena nama siswa hilang: ${JSON.stringify(studentData)}`);
                            skippedRows++;
                            continue;
                        }
                        if (existingStudentNames.has(name.toLowerCase())) {
                            console.warn(`Melewatkan siswa '${name}' karena sudah ada di database.`);
                            skippedRows++;
                            continue;
                        }
                        pendingImportStudents.push({
                            id: `temp_${newStudentCount}_${Date.now()}`,
                            name: name,
                            phone: studentData.phone || ''
                        });
                        newStudentCount++;
                    }
                    localStorage.setItem('pendingImportStudents', JSON.stringify(pendingImportStudents));
                    if (newStudentCount === 0) {
                        importStatusDiv.textContent = 'Tidak ada siswa baru yang valid untuk diimpor. Silakan periksa file Anda.';
                        importStatusDiv.style.color = 'orange';
                    } else {
                        importStatusDiv.textContent = `Berhasil memuat ${newStudentCount} siswa. Silakan tetapkan coach & level di bawah.`;
                        importStatusDiv.style.color = 'green';
                    }
                    renderPendingAssignmentTable();
                    openTab('manajemen-siswa-tab');
                } catch (error) {
                    importStatusDiv.textContent = `Gagal mengimpor: ${error.message}`;
                    importStatusDiv.style.color = 'red';
                    console.error("Import Error:", error);
                }
            };
            reader.readAsArrayBuffer(file);
        };



        // ====================================================================
        // || SECTION 2: LAPORAN AKTIVITAS LOGIC                             ||
        // ====================================================================
        
        function saveTrackingToLocalStorage() {
            const serializableLogs = {};
            for (const key in whatsappTracking) {
                serializableLogs[key] = {
                    studentName: whatsappTracking[key].studentName,
                    level: whatsappTracking[key].level,
                    timestamp: whatsappTracking[key].timestamp.getTime() 
                };
            }
            try { localStorage.setItem(LS_WA_KEY, JSON.stringify(serializableLogs)); } catch (e) { console.error("Gagal menyimpan ke LocalStorage:", e); }
        }

        function loadAndCleanTracking() {
            const trackingList = document.getElementById("trackingList");
            trackingList.innerHTML = "Memuat riwayat...";
            const cutoffTime = Date.now() - (24 * 60 * 60 * 1000); 
            try {
                const storedJson = localStorage.getItem(LS_WA_KEY);
                let allLogs = storedJson ? JSON.parse(storedJson) : {};
                const currentTracking = {};
                let needsSave = false;
                for (const key in allLogs) {
                    const log = allLogs[key];
                    if (log.timestamp < cutoffTime) { needsSave = true; continue; }
                    currentTracking[key] = { studentName: log.studentName, level: log.level, timestamp: new Date(log.timestamp) };
                }
                whatsappTracking = currentTracking;
                if (needsSave || !storedJson) saveTrackingToLocalStorage();
                renderTracking();
            } catch(e) {
                console.error("Gagal memuat/membersihkan log WA dari LocalStorage:", e);
                trackingList.innerHTML = `<span style="color: red;">Gagal memuat riwayat: ${e.message}</span>`;
                whatsappTracking = {};
                renderTracking();
            }
        }

        function renderTracking() {
            const trackingList = document.getElementById("trackingList");
            const items = Object.values(whatsappTracking);
            if (items.length === 0) {
                trackingList.innerHTML = "Belum ada aktivitas export yang tercatat di browser ini (atau sudah kedaluwarsa).";
                document.getElementById("logPagination").style.display = 'none';
                return;
            }
            document.getElementById("logPagination").style.display = 'flex';
            items.sort((a, b) => b.timestamp.getTime() - a.timestamp.getTime());
            const totalLogPages = Math.max(1, Math.ceil(items.length / logPageSize));
            if(logCurrentPage > totalLogPages) logCurrentPage = totalLogPages;
            const logPage = items.slice((logCurrentPage - 1) * logPageSize, (logCurrentPage - 1) * logPageSize + logPageSize);
            trackingList.innerHTML = logPage.map(item => {
                const formattedDate = item.timestamp.toLocaleDateString("id-ID", { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                return `<div class="tracking-item"><b>${item.studentName}</b> (${item.level}) - Export WA Terakhir: ${formattedDate}</div>`;
            }).join("");
            document.getElementById("logPageInfo").innerText = `Halaman ${logCurrentPage} dari ${totalLogPages}`;
            document.getElementById("logPrevPage").disabled = logCurrentPage === 1;
            document.getElementById("logNextPage").disabled = logCurrentPage === totalLogPages;
        }

        function parseTimestamp(ts){ 
            if(!ts) return new Date();
            if(typeof ts.toDate==="function") return ts.toDate();
            if(ts.seconds) return new Date(ts.seconds*1000);
            return new Date(ts);
        }

        function truncateText(t,m=30){ return t && t.length>m ? t.substring(0,m)+"..." : (t||"-"); }

        function assignActivityNumbers(reports){
            const grouped={}; const processed=[];
            reports.forEach(r=>{const k=`${r.studentId}_${r.level}`;(grouped[k]=grouped[k]||[]).push(r);});
            for(const k in grouped){
                grouped[k].sort((a,b)=>parseTimestamp(a.timestamp)-parseTimestamp(b.timestamp));
                grouped[k].forEach((r,i)=>{r.activityNumber=i+1; processed.push(r);});
            }
            return processed;
        }

        function populateFilters(){
            const coachSel=document.getElementById("filterCoach");
            coachSel.innerHTML='<option value="">-- Semua Coach --</option>';
            [...new Set(allMyReports.map(r=>r.coachEmail).filter(Boolean))].forEach(c=>coachSel.innerHTML+=`<option value="${c}">${c}</option>`);
            const levelSel=document.getElementById("filterLevel");
            let levels=selectedStudentId?allMyReports.filter(r=>r.studentId===selectedStudentId).map(r=>r.level):allMyReports.map(r=>r.level);
            levelSel.innerHTML='<option value="">-- Semua Level --</option>';
            [...new Set(levels.filter(Boolean))].forEach(l=>levelSel.innerHTML+=`<option value="${l}">${l}</option>`);
            const yearSel=document.getElementById("filterYear");
            yearSel.innerHTML='<option value="">-- Semua Tahun --</option>';
            [...new Set(allMyReports.map(r=>parseTimestamp(r.timestamp).getFullYear()))].sort().forEach(y=>yearSel.innerHTML+=`<option value="${y}">${y}</option>`);
        }

        function applyFilters() {
            let f=[...allMyReports];
            const c=document.getElementById("filterCoach").value;
            const l=document.getElementById("filterLevel").value;
            const m=document.getElementById("filterMonth").value;
            const y=document.getElementById("filterYear").value;
            const s=document.getElementById("searchBox").value.trim().toLowerCase();
            
            if(c) f=f.filter(r=>r.coachEmail===c);
            if(l) f=f.filter(r=>r.level===l);
            if(m) f=f.filter(r=>(parseTimestamp(r.timestamp).getMonth()+1).toString()===m);
            if(y) f=f.filter(r=>parseTimestamp(r.timestamp).getFullYear().toString()===y);
            if(selectedStudentId) f=f.filter(r=>r.studentId===selectedStudentId);
            if(s) f=f.filter(r=>r.studentName.toLowerCase().includes(s));
            
            const sf=document.getElementById("sortField").value;
            const so=document.getElementById("sortOrder").value;
            f.sort((a,b)=>{
                let va=a[sf]||"", vb=b[sf]||"";
                if(sf==="timestamp"){va=parseTimestamp(va).getTime();vb=parseTimestamp(vb).getTime();}
                if(typeof va==="string") va=va.toLowerCase();
                if(typeof vb==="string") vb=vb.toLowerCase();
                return va<vb?(so==="asc"?-1:1):va>vb?(so==="asc"?1:-1):0;
            });
            return f;
        }

        function renderReports(){
            const tbody=document.getElementById("reportsTableBody");
            tbody.innerHTML="";
            const reports=applyFilters();
            const totalPages=Math.max(1,Math.ceil(reports.length/reportPageSize));
            if(reportCurrentPage>totalPages) reportCurrentPage=totalPages;
            const page=reports.slice((reportCurrentPage-1)*reportPageSize, (reportCurrentPage-1)*reportPageSize+reportPageSize);
            if(page.length===0){tbody.innerHTML="<tr><td colspan='8'>Tidak ada laporan yang cocok dengan filter.</td></tr>";}
            else page.forEach(r=>{
                const d=parseTimestamp(r.timestamp).toLocaleDateString("id-ID");
                const hl=selectedStudentId&&r.studentId===selectedStudentId?"highlight-row":"";
                tbody.innerHTML+=`<tr class="${hl}">
                <td>${r.activityNumber||"-"}</td>
                <td><button class="student-btn" onclick="filterByStudent('${r.studentId}','${r.studentName}')">${r.studentName}</button></td>
                <td>${r.level}</td>
                <td>${d}</td>
                <td>${truncateText(r.lessonName||"-",40)}</td>
                <td>${truncateText(r.lesson||"-",50)}${r.lesson&&r.lesson.length>50?`<button class="eye-btn" onclick="openDetailModal('Aktivitas','${encodeURIComponent(r.lesson)}')">👁️</button>`:""}</td>
                <td>${truncateText(r.hasil||"-",50)}${r.hasil&&r.hasil.length>50?`<button class="eye-btn" onclick="openDetailModal('Hasil','${encodeURIComponent(r.hasil)}')">👁️</button>`:""}</td>
                <td><button onclick="openDeleteModal('${r.id}')" class="btn-reset" style="background-color: var(--danger-color); color: white; padding: 5px;">🗑</button></td>
                </tr>`;
            });
            document.getElementById("pageInfo").innerText=`Halaman ${reportCurrentPage} dari ${totalPages}`;
            document.getElementById("prevPage").disabled = reportCurrentPage === 1;
            document.getElementById("nextPage").disabled = reportCurrentPage === totalPages;
        }

        async function setupDataForActivityReport(user){
            const userDocSnap = await getDoc(doc(db, "users", user.email));
            globalUserName = userDocSnap.exists() && userDocSnap.data().name ? userDocSnap.data().name : user.email;
            document.getElementById("mainHeader").innerText = `Laporan Aktivitas`;
            
            const stu=await getDocs(collection(db,"students"));
            myStudents=stu.docs.map(d=>({id:d.id,...d.data()}));
            myStudents.forEach(s => { allActiveStudents[s.id] = s; });

            onSnapshot(collection(db,"reports"),(snap)=>{
                const raw=snap.docs.map(d=>{
                    const data=d.data();const s=myStudents.find(x=>x.id===data.studentId);
                    return {id:d.id, studentId:data.studentId||"", studentName:s?.name||data.siswa||"N/A",
                    level:s?.studentLevel||data.level||"N/A", lessonName:data.lessonName||"", lesson:data.lesson||"",
                    hasil:data.hasil||"", timestamp:data.timestamp||data.tanggal||null, coachEmail:data.coachEmail||""};
                });
                allMyReports=assignActivityNumbers(raw);
                populateFilters();
                if(isFirstLoad){
                    const now=new Date();
                    defaultMonth=(now.getMonth()+1).toString();defaultYear=now.getFullYear().toString();
                    document.getElementById("filterMonth").innerHTML='<option value="">-- Semua Bulan --</option>'+
                    [...Array(12).keys()].map(i=>`<option value="${i+1}" ${i+1===now.getMonth()+1?"selected":""}>${new Date(0,i).toLocaleString("id-ID",{month:"long"})}</option>`).join("");
                    document.getElementById("filterYear").value=defaultYear;
                    isFirstLoad=false;
                }
                renderReports();
                loadAndCleanTracking(); 
            });
        }
        
async function triggerExportPdf(studentId, level) {
            const reports = allMyReports.filter(r => r.studentId === studentId && r.level === level);
            if (reports.length === 0) { alert("Gagal membuat PDF: Tidak ada laporan ditemukan."); return false; }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let yPos = 15;
            
            const addActivityContentAndSave = () => {
                if(brandSettings.companyName){
                    doc.setFontSize(12).setFont("helvetica","bold").text(brandSettings.companyName.toUpperCase(), doc.internal.pageSize.getWidth()/2, yPos, {align:"center"});
                    yPos += 15;
                }

                doc.setFontSize(12).setFont("helvetica","bold").text("Laporan Aktivitas Siswa", doc.internal.pageSize.getWidth()/2, yPos, {align:"center"});
                yPos += 10;
                
                // --- MODIFIKASI: Mengambil nama coach, bukan email ---
                const studentName = reports[0].studentName;
                const coachEmail = reports[0].coachEmail;
                const coachData = allUsers.find(user => user.id === coachEmail);
                const coachName = coachData ? coachData.name : (coachEmail || 'N/A'); // Gunakan nama jika ada, jika tidak, email
                
                doc.setFontSize(10).setFont("helvetica","normal");
                doc.text(`Coach : ${coachName}`, 15, yPos); // Menampilkan nama coach
                doc.text(`Siswa / Level : ${studentName} / ${level}`, 15, yPos+6);
                yPos += 12;
                
                const rows = reports.map(r=>[r.activityNumber,parseTimestamp(r.timestamp).toLocaleDateString("id-ID"),r.lessonName||"-",r.lesson||"-",r.hasil||"-"]);
                doc.autoTable({startY:yPos, head:[["Sesi","Tanggal","Lesson","Aktivitas","Hasil"]], body:rows, styles:{fontSize:9,cellPadding:2}, headStyles:{fillColor:[74,144,226]}});

                const pageCount = doc.internal.getNumberOfPages();
                const printTimestamp = new Date().toLocaleString('id-ID', { dateStyle: 'long', timeStyle: 'short' });
                for(let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(150);
                    doc.text(
                        `Dicetak pada: ${printTimestamp}`, 
                        doc.internal.pageSize.getWidth() - 14, 
                        doc.internal.pageSize.getHeight() - 10,
                        { align: 'right' }
                    );
                }

                const now = new Date();
                const fileName = `${studentName.replace(/\s/g, '_')}_${level.replace(/\s/g, '')}_${now.toISOString().slice(0,10)}.pdf`;
                doc.save(fileName);
            };

            if (brandSettings && brandSettings.logoBase64) {
                const img = new Image();
                img.src = brandSettings.logoBase64;
                img.onload = () => {
                    const desiredLogoHeight = 20;
                    const aspectRatio = img.width / img.height;
                    const calculatedLogoWidth = desiredLogoHeight * aspectRatio;
                    const logoX = (doc.internal.pageSize.getWidth() - calculatedLogoWidth) / 2;

                    doc.addImage(img, 'PNG', logoX, yPos, calculatedLogoWidth, desiredLogoHeight);
                    yPos += desiredLogoHeight + 10;
                    addActivityContentAndSave();
                };
                img.onerror = () => addActivityContentAndSave();
            } else {
                addActivityContentAndSave();
            }

            return true; 
        }

        window.openDeleteModal=(id)=>{document.getElementById("deleteId").value=id;document.getElementById("deleteModal").style.display="flex";};
        window.closeModal=(id)=>{document.getElementById(id).style.display="none";};
        window.confirmDelete=async()=>{const id=document.getElementById("deleteId").value;await deleteDoc(doc(db,"reports",id));closeModal("deleteModal");};
        window.openDetailModal=(t,enc)=>{document.getElementById("detailTitle").innerText=t;document.getElementById("detailText").innerText=decodeURIComponent(enc);document.getElementById("detailModal").style.display="flex";};
        window.filterByStudent=(id,n)=>{
            selectedStudentId=id;
            document.getElementById("studentFilterIndicator").style.display="inline-block";
            document.getElementById("studentFilterName").innerText=n;
            reportCurrentPage=1;
            populateFilters();
            renderReports();
        };
        window.clearStudentFilter=()=>{
            selectedStudentId=null;
            document.getElementById("studentFilterIndicator").style.display="none";
            reportCurrentPage=1;
            populateFilters();
            renderReports();
        };
        
        // ====================== EVENT LISTENERS ======================
        function setupEventListeners() {
            // --- Listeners for SPP ---
            document.getElementById('sppPaymentForm').addEventListener('submit', handleAddPayment);
            document.getElementById('editSppForm').addEventListener('submit', handleUpdateSppPayment);
            ['yearFilter', 'monthFilter'].forEach(id => document.getElementById(id).addEventListener('change', () => { currentPage = 1; renderSppTable(); }));
            ['summarySppYearFilter', 'summarySppMonthFilter'].forEach(id => document.getElementById(id).addEventListener('change', populateSppSummaryDashboard));
            document.getElementById('rowsPerPage').addEventListener('change', (e) => { rowsPerPage = parseInt(e.target.value); currentPage = 1; renderSppTable(); });
            document.getElementById('prevBtn').addEventListener('click', () => { if (currentPage > 1) { currentPage--; renderSppTable(); } });
            document.getElementById('nextBtn').addEventListener('click', () => { const total = parseInt(document.getElementById('totalPagesDisplay').textContent); if (currentPage < total) { currentPage++; renderSppTable(); } });
            
            // --- Listeners for Non-SPP & Manajemen Siswa ---
            setupNominalInput('nominal');
            setupNominalInput('otherNominal');
            setupNominalInput('editSppNominal');
            setupNominalInput('editNonSppNominal');
            document.getElementById('addStudentForm').addEventListener('submit', handleAddStudent);
            document.getElementById('bulkChangeCoachBtn').addEventListener('click', handleBulkChange);
            document.getElementById('bulkChangeLevelBtn').addEventListener('click', handleBulkLevelChange);
            document.getElementById('assignAndSaveBtn').addEventListener('click', handleAssignAndSave);
            document.getElementById('cancelImportBtn').addEventListener('click', handleCancelImport);
            document.getElementById('transferStudentsBtn').addEventListener('click', handleTransfer);
            document.getElementById('editStudentForm').addEventListener('submit', handleEditStudent);
            document.getElementById('downloadExcelTemplateBtn').addEventListener('click', downloadExcelTemplate);
            document.getElementById('importStudentForm').addEventListener('submit', handleImportStudent);
            document.getElementById('studentRowsPerPage').addEventListener('change', (e) => { studentRowsPerPage = parseInt(e.target.value, 10); studentCurrentPage = 1; renderStudentTable(); });
            document.getElementById('studentPrevBtn').addEventListener('click', () => { if (studentCurrentPage > 1) { studentCurrentPage--; renderStudentTable(); } });
            document.getElementById('studentNextBtn').addEventListener('click', () => { const totalPages = parseInt(document.getElementById('studentTotalPages').textContent); if (studentCurrentPage < totalPages) { studentCurrentPage++; renderStudentTable(); } });
            document.getElementById('showDisabledStudents').addEventListener('change', () => { studentCurrentPage = 1; renderStudentTable(); });
            document.getElementById('coachFilterSelector').addEventListener('change', () => { studentCurrentPage = 1; renderStudentTable(); });
            document.getElementById('levelFilterSelector').addEventListener('change', () => { studentCurrentPage = 1; renderStudentTable(); });
            document.getElementById('selectAllBulkCheckbox').addEventListener('click', (e) => {
                document.querySelectorAll('.student-checkbox').forEach(checkbox => {
                    if (checkbox.closest('tr').style.display !== 'none') checkbox.checked = e.target.checked;
                });
            });
             document.getElementById('selectAllPendingCheckbox').addEventListener('click', (e) => {
                document.querySelectorAll('.pending-student-checkbox').forEach(checkbox => {
                    checkbox.checked = e.target.checked;
                });
            });

            // --- Listeners for Laporan Aktivitas ---
            document.getElementById("exportAndSendBtn").onclick = async () => {
                const studentId = selectedStudentId;
                const level = document.getElementById("filterLevel").value;
                if (!studentId || !level) { alert("Pilih siswa dan level terlebih dahulu."); return; }
                const studentData = allActiveStudents[studentId];
                const normalizedPhone = formatPhoneNumber(studentData ? studentData.phone : null);
                if (!normalizedPhone || normalizedPhone.length < 10) { alert(`Nomor telepon siswa ${studentData.name} tidak valid.`); return; }
                
                const downloadTriggered = await triggerExportPdf(studentId, level);
                if (downloadTriggered) {
                    const trackingKey = `${studentId}_${level}`;
                    whatsappTracking[trackingKey] = { studentName: studentData.name, level: level, timestamp: new Date() };
                    saveTrackingToLocalStorage();
                    loadAndCleanTracking();
                    let message = `*Laporan Aktivitas Siswa*\nHalo Bapak/Ibu, ini laporan progres terbaru untuk:\n\n👤 *Siswa*: ${studentData.name}\n📚 *Level*: ${level}\n\nSilakan cek file PDF yang baru saja terunduh.`;
                    const whatsappUrl = isMobile ? `https://api.whatsapp.com/send?phone=${normalizedPhone}&text=${encodeURIComponent(message)}` : `https://web.whatsapp.com/send?phone=${normalizedPhone}&text=${encodeURIComponent(message)}`;
                    window.open(whatsappUrl, 'whatsappWindow'); 
                } 
            };
            document.getElementById("prevPage").onclick=()=>{if(reportCurrentPage>1){reportCurrentPage--;renderReports();}};
            document.getElementById("nextPage").onclick=()=>{ const total = Math.ceil(applyFilters().length/reportPageSize); if(reportCurrentPage < total) {reportCurrentPage++;renderReports();}};
            document.getElementById("pageSize").onchange=(e)=>{ reportPageSize=parseInt(e.target.value); reportCurrentPage=1; renderReports(); };
            document.getElementById("searchBox").oninput=()=>{reportCurrentPage=1;renderReports();};
            document.getElementById("clearFilters").onclick=()=>{
                document.getElementById("searchBox").value="";
                document.getElementById("filterCoach").value="";
                document.getElementById("filterLevel").value="";
                document.getElementById("filterMonth").value=defaultMonth;
                document.getElementById("filterYear").value=defaultYear;
                document.getElementById("sortField").value="timestamp";
                document.getElementById("sortOrder").value="desc";
                document.getElementById("pageSize").value="10"; reportPageSize=10;
                selectedStudentId=null;
                document.getElementById("studentFilterIndicator").style.display="none";
                populateFilters();
                reportCurrentPage=1;
                renderReports();
            };
            ["filterCoach","filterLevel","filterMonth","filterYear","sortField","sortOrder"].forEach(id=>document.getElementById(id).onchange=()=>{reportCurrentPage=1;renderReports();});
            document.getElementById("logPrevPage").onclick=()=>{if(logCurrentPage>1){logCurrentPage--;renderTracking();}};
            document.getElementById("logNextPage").onclick=()=>{ const total = Math.ceil(Object.keys(whatsappTracking).length/logPageSize); if(logCurrentPage < total) {logCurrentPage++;renderTracking();}};
            document.getElementById("logPageSize").onchange=(e)=>{logPageSize=parseInt(e.target.value);logCurrentPage=1;renderTracking();};
        }

    </script>
</body>
</html>
