<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Coach</title> 
    <style>
        /* Palet Warna */
        :root {
            --primary-color: #4A90E2;
            --secondary-color: #50E3C2;
            --accent-color: #F5A623;
            --background-color: #F9F9F9;
            --container-bg: #FFFFFF;
            --text-color: #333333;
            --light-text-color: #888888;
            --border-color: #E0E0E0;
            --success-color: #4CAF50;
            --error-color: #F44336;
        }

        /* Reset dan Dasar */
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            padding: 20px;
            background-color: var(--background-color);
            color: var(--text-color);
            display: none;
        }
        .container {
            max-width: 1000px;
            margin: auto;
            background: var(--container-bg);
            padding: 30px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        h1 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 15px;
            margin-bottom: 25px;
            font-size: 2.2rem;
        }
        h3 {
            color: var(--primary-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        /* Header dan Tombol */
        .header-info {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: flex-start;
            gap: 15px;
        }
        .header-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
            margin-top: 15px;
        }
        .btn-export, .logout-btn, .btn-reset, .report-form-section button, .action-btn-edit {
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            text-align: center;
            width: 100%;
            font-weight: bold;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .btn-export, .report-form-section button {
            background-color: var(--primary-color);
            color: white;
        }
        .action-btn-edit:hover {
            background-color: #0b7dda;
        }
        .btn-export:hover, .report-form-section button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            background-color: #3a75c1;
        }
        .logout-btn:hover, .btn-reset:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            background-color: var(--border-color);
        }
        #addReportForm button { margin-top: 20px; }
        
        .section-container {
            margin-top: 30px;
        }

        /* Tabel Siswa */
        .student-list-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            table-layout: fixed;
            border-radius: 8px;
            overflow: hidden;
        }
        .student-list-table th, .student-list-table td {
            border: 1px solid var(--border-color);
            padding: 10px;
            text-align: left;
            word-wrap: break-word;
        }
        .student-list-table th {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
        }
        .student-list-table tr:nth-child(even) {
            background-color: #f6f6f6;
        }
        .student-list-table tr:hover {
            background-color: #e9f5ff;
        }

        /* Form Input Progress Anak */
        .report-form-section {
            margin-top: 30px;
            padding: 25px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--container-bg);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        .form-row {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 20px;
        }
        .form-group { flex: 1; }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--text-color);
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            box-sizing: border-box;
            background-color: #fefefe;
            color: var(--text-color);
            transition: border-color 0.3s;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2);
        }
        input[readonly] {
            background-color: #EFEFEF;
            cursor: not-allowed;
        }
        #reportStatusMessage {
            margin-top: 15px;
            font-weight: bold;
            text-align: center;
        }
        .error-message {
            color: var(--error-color);
        }
        .success-message {
            color: var(--success-color);
        }

        /* Report Controls dan Filter */
        .report-controls {
            margin-top: 40px;
            padding: 25px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--container-bg);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        .report-filters {
            display: flex;
            flex-direction: column;
            flex-wrap: wrap;
            gap: 15px;
            align-items: stretch;
            margin-bottom: 20px;
        }
        .report-filters > div { width: 100%; }
        #clearReportFilterBtn, #sendPdfBtn {
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            width: 100%;
            font-weight: bold;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        #clearReportFilterBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            background-color: #d18d1f;
        }
        
        /* Aktivitas Checkbox */
        #activityCheckboxes, #editActivityCheckboxes {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
            padding: 15px;
            background-color: var(--background-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            padding-right: 10px;
        }
        #activityCheckboxes label, #editActivityCheckboxes label {
            font-weight: normal;
            display: flex;
            align-items: center;
        }
        #activityCheckboxes input, #editActivityCheckboxes input {
            width: auto;
            margin-right: 10px;
        }
        input[type="checkbox"] {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            width: 18px;
            height: 18px;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            position: relative;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
        }
        input[type="checkbox"]:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        input[type="checkbox"]:checked::after {
            content: '\2713';
            font-size: 14px;
            color: white;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .modal-content {
            background-color: var(--container-bg);
            padding: 30px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            width: 90%;
            max-width: 600px;
            position: relative;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            animation: fadeIn 0.3s ease-out;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        .modal-header h3 {
            margin: 0;
            color: var(--primary-color);
        }
        .close-btn {
            color: var(--light-text-color);
            font-size: 36px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }
        .close-btn:hover { color: var(--text-color); }
        .modal-body {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .modal-body textarea {
            min-height: 150px;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Read Status Indicator */
        #readStatusIndicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--text-color);
            color: white;
            padding: 10px 18px;
            border-radius: 25px;
            font-size: 14px;
            font-family: monospace;
            z-index: 2000;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            opacity: 0.9;
            transition: opacity 0.3s;
        }
        #readStatusIndicator button {
            margin-left: 10px;
            padding: 4px 10px;
            font-size: 12px;
            cursor: pointer;
            background-color: var(--light-text-color);
            color: white;
            border: 1px solid #666;
            border-radius: 15px;
        }
        #readStatusIndicator button:hover {
            background-color: #666;
        }

        /* Report Table */
        .table-scroll-wrapper { 
            overflow-x: auto;
        }
        .student-list-table, .report-table {
            width: 100%;
            border-collapse: collapse;
            white-space: nowrap;
            border-radius: 8px;
            overflow: hidden;
        }
        .student-list-table th, .student-list-table td, .report-table th, .report-table td {
            border: 1px solid var(--border-color);
            padding: 10px;
            text-align: left;
            word-wrap: break-word;
        }
        .student-list-table th, .report-table th {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
            /* PERBAIKAN: Memastikan judul kolom bisa wrap dan rapi */
            white-space: normal; 
            vertical-align: middle;
            text-align: center;
        }
        .student-list-table tr:nth-child(even), .report-table tr:nth-child(even) {
            background-color: #f6f6f6;
        }
        .student-list-table tr:hover, .report-table tr:hover {
            background-color: #e9f5ff;
        }
        
        /* CSS UNTUK FITUR PENANDA WARNA */
        .report-table tr.sent-report {
            background-color: #e8f5e9;
        }
        .report-table tr.sent-report:hover {
            background-color: #c8e6c9;
        }

        /* Tombol Aksi dalam Tabel */
        .report-table td .action-btn-edit, .report-table td .action-btn-delete {
            padding: 8px 10px;
            border-radius: 4px;
            font-weight: normal;
            color: white;
            border: none;
            box-shadow: none;
            cursor: pointer;
            width: auto;
            display: inline-block;
            white-space: nowrap;
            font-size: 0.9rem;
            transition: transform 0.2s;
        }
        .report-table td .action-btn-edit {
            background-color: var(--primary-color);
        }
        .report-table td .action-btn-delete {
            background-color: var(--error-color);
        }
        .action-btn-edit:hover {
            background-color: #3a75c1;
            transform: translateY(-1px);
        }
        .action-btn-delete:hover {
            background-color: #d32f2f;
        }

        /* Pagination */
        .pagination-controls {
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        .pagination-controls button {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            background-color: var(--container-bg);
            color: var(--text-color);
            border-radius: 20px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .pagination-controls button:disabled {
            background-color: #eee;
            cursor: not-allowed;
            color: #888;
            border-color: #ddd;
        }
        .pagination-controls button:hover:not(:disabled) {
            background-color: var(--border-color);
        }
        .pagination-controls select {
            width: auto;
            border: 1px solid var(--border-color);
            padding: 6px;
            border-radius: 5px;
        }
        .pagination-controls .page-info {
            text-align: center;
            color: var(--text-color);
            font-size: 0.95rem;
        }

        /* Select2 Specific Styling */
        .select2-container .select2-selection--single {
            height: 42px;
            border: 1px solid var(--border-color) !important;
            border-radius: 5px;
        }
        .select2-container.select2-container--focus .select2-selection--single {
            border-color: var(--primary-color) !important;
            box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2);
        }
        .select2-container .select2-selection__rendered {
            padding-left: 12px;
        }
        
        /* Media Queries untuk Desktop */
        @media (min-width: 768px) {
            .header-info {
                flex-direction: row;
                align-items: center;
            }
            .header-buttons { flex-direction: row; width: auto; margin-top: 0; }
            .logout-btn, .btn-export, .btn-reset { width: auto; }

            .form-row { flex-direction: row; }
            .report-filters { 
                flex-direction: row; 
                align-items: flex-end; 
                gap: 15px;
            }
            .report-filters > div {
                flex-grow: 1;
                min-width: 150px;
            }
            #clearReportFilterBtn, #sendPdfBtn { width: auto; }
            #activityCheckboxes, #editActivityCheckboxes { 
                display: grid; 
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            }

            .table-scroll-wrapper, .report-table-container {
                overflow-x: unset;
            }
            .student-list-table, .report-table { 
                table-layout: fixed;
                white-space: normal;
                width: 100%;
            }
            .report-table th, .report-table td { min-width: unset; padding: 10px; }

            .report-table .col-sesi { width: 5%; }
            .report-table .col-siswa { width: 12%; }
            .report-table .col-level { width: 8%; }
            .report-table .col-tanggal { width: 10%; }
            .report-table .col-lesson { width: 15%; }
            .report-table .col-aktivitas { width: 30%; }
            .report-table .col-hasil { width: 20%; }
            .report-table .col-aksi { width: 10%; text-align: center; }
        }
        
        /* Mobile Optimization */
        @media (max-width: 767px) {
            .table-scroll-wrapper, .report-table-container {
                overflow-x: auto;
            }
            .student-list-table, .report-table {
                white-space: nowrap;
                table-layout: auto;
                width: auto;
            }
            .student-list-table th, .report-table th {
                 white-space: normal;
            }
        }
        
        /* CSS untuk Fitur Detail Klik */
        .content-cell {
            display: flex;
            align-items: flex-start;
            gap: 5px;
        }
        .truncated-text {
            display: block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-grow: 1;
            line-height: 1.3;
        }
        .detail-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            font-size: 1.1em;
            cursor: pointer;
            padding: 0 5px;
            line-height: 1.3;
            flex-shrink: 0;
            transition: color 0.2s;
        }
        .detail-btn:hover {
            color: #3a75c1;
        }
        #detailModal .modal-body-content {
            white-space: pre-wrap;
            font-size: 1.05rem;
            padding: 10px;
            background-color: var(--background-color);
            border-radius: 5px;
            border: 1px solid var(--border-color);
        }
    </style>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

</head>
<body>
    <div id="readStatusIndicator">Reads Sesi Ini: 0</div>
    <div class="container">
        <div class="header-info">
            <h1 id="mainHeader">Selamat datang, user</h1> 
            <div class="header-buttons">
                <button type="button" class="logout-btn" onclick="window.logout()">Logout</button>
            </div>
        </div>
        <div class="section-container">
            <h3>Daftar Siswa Anda</h3>
            <div class="report-filters" style="margin-bottom: 10px;">
                <div>
                    <label for="studentLevelFilter">Filter Berdasarkan Level</label>
                    <select id="studentLevelFilter"></select>
                </div>
                <div>
                    <label for="studentTodayFilter">Status Input Hari Ini</label>
                    <select id="studentTodayFilter">
                        <option value="all" selected>Semua Siswa</option>
                        <option value="pending">Belum Input Hari Ini</option>
                    </select>
                </div>
                <div>
                    <label>Total Siswa (Filtered)</label>
                    <span id="totalStudentsCount" style="font-weight: bold; color: var(--primary-color);">0 siswa</span>
                </div>
            </div>
            <div class="table-scroll-wrapper">
                <table class="student-list-table">
                    <thead><tr><th>Nama Siswa</th><th>Level</th><th>Lesson Terakhir</th><th>Input Terakhir</th></tr></thead>
                    <tbody id="myStudentsTableBody"></tbody>
                </table>
            </div>
            <div class="pagination-controls" id="studentPagination">
                <div>
                    <label for="studentRowsPerPage">Baris per Halaman:</label>
                    <select id="studentRowsPerPage">
                        <option value="5" selected>5</option>
                        <option value="10">10</option>
                        <option value="15">15</option>
                        <option value="20">20</option>
                    </select>
                </div>
                <div class="pagination-nav">
                    <button type="button" id="studentPrevBtn" disabled>&laquo; Sebelumnya</button>
                    <span class="page-info">Halaman <b id="studentCurrentPage">1</b> dari <b id="studentTotalPages">1</b></span>
                    <button type="button" id="studentNextBtn" disabled>Berikutnya &raquo;</button>
                </div>
            </div>
        </div>

        <div class="report-form-section">
            <h3>Input Progress Anak</h3>
            <form id="addReportForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="studentSelectorForReport">Pilih Siswa</label>
                        <select id="studentSelectorForReport" required></select>
                    </div>
                    <div class="form-group">
                        <label for="reportDate">Tanggal Aktivitas</label>
                        <input type="date" id="reportDate" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="reportLevel">Level Siswa</label>
                        <input type="text" id="reportLevel" placeholder="Pilih siswa..." readonly required>
                    </div>
                    <div class="form-group">
                        <label for="reportLessonSelector">Lesson</label>
                        <select id="reportLessonSelector" required></select>
                    </div>
                </div>
                <div class="form-group" id="activityCheckboxesContainer" style="display: none;">
                    <label>Aktivitas yang Dilakukan</label>
                    <div id="activityCheckboxes"></div>
                </div>
                <div class="form-group">
                    <label for="reportHasil">Hasil</label>
                    <textarea id="reportHasil" rows="2" required></textarea>
                </div>
                <button type="submit">Kirim Laporan</button>
                <div id="reportStatusMessage"></div>
            </form>
        </div>

        <div class="report-controls">
            <h3>Riwayat Progress Anak</h3>
            <div class="report-filters">
                <div><label for="reportFilterStudent">Filter Berdasarkan Siswa</label><select id="reportFilterStudent"></select></div>
                <div><label for="reportFilterLevel">Filter Berdasarkan Level</label><select id="reportFilterLevel"></select></div>
                <div>
                    <label for="reportSort">Urutkan Berdasarkan</label>
                    <select id="reportSort">
                        <option value="activityNumber_desc" selected>Nomor Sesi (Menurun)</option>
                        <option value="activityNumber_asc">Nomor Sesi (Menaik)</option>
                        <option value="submissionTimestamp_desc">Tanggal Input (Terbaru)</option>
                        <option value="submissionTimestamp_asc">Tanggal Input (Terlama)</option>
                        <option value="timestamp_desc">Tanggal Aktivitas (Terbaru)</option>
                        <option value="timestamp_asc">Tanggal Aktivitas (Terlama)</option>
                    </select>
                </div>
                <div><button type="button" id="clearReportFilterBtn">Reset Filter</button></div>
            </div>
            <div class="report-table-container">
                <table class="report-table" id="reportTableForPdf">
                    <thead>
                        <tr>
                            <th class="col-sesi">Sesi</th>
                            <th class="col-siswa">Siswa</th>
                            <th class="col-level">Level</th>
                            <th class="col-tanggal">Tanggal</th>
                            <th class="col-lesson">Lesson</th>
                            <th class="col-aktivitas">Aktivitas</th>
                            <th class="col-hasil">Hasil</th>
                            <th class="col-aksi">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="reportsTableBody"></tbody>
                </table>
            </div>
            <div class="pagination-controls" id="reportPagination">
                <div>
                    <label for="reportRowsPerPage">Baris per Halaman:</label>
                    <select id="reportRowsPerPage">
                        <option value="5" selected>5</option>
                        <option value="10">10</option>
                        <option value="15">15</option>
                        <option value="20">20</option>
                    </select>
                </div>
                <div class="pagination-nav">
                    <button type="button" id="reportPrevBtn" disabled>&laquo; Sebelumnya</button>
                    <span class="page-info">Halaman <b id="reportCurrentPage">1</b> dari <b id="reportTotalPages">1</b></span>
                    <button type="button" id="reportNextBtn" disabled>Berikutnya &raquo;</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="detailModalTitle">Detail Laporan</h3>
                <span class="close-btn" onclick="document.getElementById('detailModal').style.display='none'">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label id="detailContentLabel">Konten Lengkap</label>
                    <div id="detailContent" class="modal-body-content"></div>
                </div>
            </div>
        </div>
    </div>
    <div id="editReportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Laporan</h3>
                <span class="close-btn" onclick="document.getElementById('editReportModal').style.display='none'">&times;</span>
            </div>
            <form id="editReportForm">
                <input type="hidden" id="editReportId">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="editReportSiswa">Nama Siswa</label>
                        <input type="text" id="editReportSiswa" disabled>
                    </div>
                    <div class="form-group">
                        <label for="editReportTanggal">Tanggal Aktivitas</label>
                        <input type="date" id="editReportTanggal" required>
                    </div>
                    <div class="form-group">
                        <label for="editReportLevel">Level Siswa</label>
                        <input type="text" id="editReportLevel" disabled>
                    </div>
                    <div class="form-group">
                        <label for="editReportLesson">Lesson</label>
                        <select id="editReportLesson" required></select>
                    </div>
                    <div class="form-group" id="editActivityCheckboxesContainer">
                        <label>Aktivitas yang Dilakukan</label>
                        <div id="editActivityCheckboxes"></div>
                    </div>
                    <div class="form-group">
                        <label for="editReportHasil">Hasil</label>
                        <textarea id="editReportHasil" rows="2" required></textarea>
                    </div>
                </div>
                <div class="modal-footer" style="padding-top: 20px;">
                    <button type="submit" class="btn-export" style="border-radius: 4px;">Simpan Perubahan</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="pinModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Verifikasi PIN</h3>
                <span class="close-btn" onclick="document.getElementById('pinModal').style.display='none'">&times;</span>
            </div>
            <div class="modal-body">
                <p>Masukkan PIN untuk mengedit data ini.</p>
                <div class="form-group">
                    <label for="pinInput">PIN</label>
                    <input type="password" id="pinInput" placeholder="PIN" required>
                </div>
                <div class="form-group">
                    <button type="button" id="verifyPinBtn" class="action-btn-edit" style="border-radius: 4px;">Verifikasi</button>
                </div>
                <div id="pinVerificationMessage"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, getDoc, addDoc, query, where, Timestamp, orderBy, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBm3SkLLtl9LvczDDht-OQ6-R4OYLPYAJQ", authDomain: "progres-report-5d199.firebaseapp.com", projectId: "progres-report-5d199", storageBucket: "progres-report-5d199.firebasestorage.app", messagingSenderId: "363573365137", appId: "1:363573365137:web:98f32d5ff8fae05617b230", measurementId: "G-CPX04R69F5" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let sessionReadCount = 0;
        const readStatusElement = document.getElementById('readStatusIndicator');

        window.updateReadStatus = function() {
            if(readStatusElement) readStatusElement.innerHTML = `Reads Sesi Ini: ${sessionReadCount} <button onclick="window.resetReadCount()">Reset</button>`;
        }
        window.resetReadCount = function() {
            sessionReadCount = 0;
            window.updateReadStatus();
        }
        let currentCoachName = '';
        let kurikulum = {};
        let myStudents = [];
        let allMyReports = [];
        let filteredAndSortedReports = [];
        let brandSettings = {};
        let studentCurrentPage = 1;
        let studentRowsPerPage = 5;
        let reportCurrentPage = 1;
        let reportRowsPerPage = 5;
        let appEditPin = '';

        // Helper function to check if a date is today
        function isToday(timestamp) {
            if (!timestamp) return false;
            let date;
            try {
                 date = (typeof timestamp.toDate === 'function') ? timestamp.toDate() : new Date(timestamp);
            } catch (e) {
                date = new Date(timestamp);
            }
            
            const today = new Date();
            // Normalisasi waktu ke tengah malam agar perbandingan tanggal akurat
            const targetDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());

            return targetDate.getTime() === todayStart.getTime();
        }

        function truncateText(text, maxLength = 30) {
            if (!text || text.length <= maxLength) {
                return text;
            }
            return text.substring(0, maxLength) + '...';
        }

        window.selectStudentForReport = function(studentId, studentName) {
            const studentSelector = $('#studentSelectorForReport');
            if (studentSelector.find("option[value='" + studentId + "']").length) {
                studentSelector.val(studentId).trigger('change');
            } else {
                var newOption = new Option(studentName, studentId, true, true);
                studentSelector.append(newOption).trigger('change');
            }
            document.querySelector('.report-form-section').scrollIntoView({ behavior: 'smooth' });
            setTimeout(() => {
                document.getElementById('reportDate').focus();
            }, 200);
        }
        
        window.logout = function() {
            sessionStorage.clear();
            localStorage.clear();
            signOut(auth).then(() => { window.location.href = 'login.html'; });
        };
        const saveToCache = (key, data) => {
            sessionStorage.setItem(key, JSON.stringify({ timestamp: Date.now(), data: data }));
        };
        const loadFromCache = (key, maxAgeMinutes = 5) => {
            const item = sessionStorage.getItem(key);
            if (!item) return null;
            const cache = JSON.parse(item);
            if (Date.now() - cache.timestamp > maxAgeMinutes * 60 * 1000) {
                sessionStorage.removeItem(key);
                return null;
            }
            return cache.data;
        };
        
        async function loadAppEditPin() {
            try {
                const docSnap = await getDoc(doc(db, "settings", "appEditPin"));
                sessionReadCount++; updateReadStatus();
                if (docSnap.exists() && docSnap.data().pin) {
                    appEditPin = docSnap.data().pin;
                } else {
                    appEditPin = '';
                }
            } catch (error) {
                console.error("Gagal memuat PIN:", error);
                appEditPin = '';
            }
        }
        
        function setupStudentsListener(coachEmail) {
            const studentQuery = query(collection(db, "students"), where("coachEmail", "==", coachEmail), where("status", "==", "active"));
            onSnapshot(studentQuery, (querySnapshot) => {
                sessionReadCount += querySnapshot.docs.length;
                window.updateReadStatus();
                myStudents = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                populateStudentLevelFilter();
                renderStudentTable();
            }, (error) => {
                console.error("Gagal memuat daftar siswa:", error);
                const studentsTableBody = document.getElementById('myStudentsTableBody');
                studentsTableBody.innerHTML = '<tr><td colspan="4">Terjadi kesalahan saat memuat data siswa.</td></tr>';
            });
        }
        
        function renderStudentTable() {
            const studentsTableBody = document.getElementById('myStudentsTableBody');
            const studentLevelFilter = document.getElementById('studentLevelFilter');
            const studentTodayFilter = document.getElementById('studentTodayFilter');
            
            const selectedLevel = studentLevelFilter.value; 
            const selectedTodayStatus = studentTodayFilter.value;
            
            const totalStudentsCountEl = document.getElementById('totalStudentsCount');

            let filteredStudents = myStudents;
            
            // Logika Filter Level
            if (selectedLevel !== 'all') {
                filteredStudents = filteredStudents.filter(student => student.studentLevel === selectedLevel);
            }
            
            // Logika Filter Status Input Hari Ini
            if (selectedTodayStatus === 'pending') {
                 filteredStudents = filteredStudents.filter(student => {
                    return !isToday(student.lastReportTimestamp);
                });
            }

            totalStudentsCountEl.textContent = `${filteredStudents.length} siswa`;

            studentsTableBody.innerHTML = '';
            const sortedStudents = filteredStudents.sort((a, b) => a.name.localeCompare(b.name));
            const startIndex = (studentCurrentPage - 1) * studentRowsPerPage;
            const endIndex = startIndex + studentRowsPerPage;
            const paginatedStudents = sortedStudents.slice(startIndex, endIndex);

            if (paginatedStudents.length === 0) {
                studentsTableBody.innerHTML = `<tr><td colspan="4">Tidak ada siswa di filter ini.</td></tr>`;
            } else {
                paginatedStudents.forEach(student => {
                    const lastLessonDisplay = student.lastLesson || 'Belum ada laporan';
                    
                    // Menggabungkan Tanggal Input Terakhir dan Nomor Sesi Terakhir
                    let lastInputDisplay = 'Belum pernah input'; 
                    if (student.lastReportTimestamp) {
                        const date = (student.lastReportTimestamp && typeof student.lastReportTimestamp.toDate === 'function' ? student.lastReportTimestamp.toDate() : new Date(student.lastReportTimestamp)).toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' });
                        
                        let activityNumberDisplay = '';
                        if (student.lastSentReport && student.lastSentReport.activityNumber) {
                           activityNumberDisplay = `, Sesi ${student.lastSentReport.activityNumber}`;
                        }
                        
                        lastInputDisplay = `Tgl ${date}${activityNumberDisplay}`;
                    }

                    const studentNameHtml = `<a href="#" onclick="window.selectStudentForReport('${student.id}', '${student.name.replace(/'/g, "\\'")}')" style="text-decoration: underline; color: var(--primary-color); font-weight: bold;">${student.name}</a>`;
                    
                    studentsTableBody.innerHTML += `<tr><td>${studentNameHtml}</td><td>${student.studentLevel || ''}</td><td>${lastLessonDisplay}</td><td>${lastInputDisplay}</td></tr>`;
                });
            }
            updateStudentPagination(filteredStudents.length);
        }

        function populateStudentLevelFilter() {
            const studentLevelFilter = document.getElementById('studentLevelFilter');
            const uniqueLevels = [...new Set(myStudents.map(student => student.studentLevel))].filter(Boolean);
            uniqueLevels.sort();
            
            const currentLevel = studentLevelFilter.value;
            studentLevelFilter.innerHTML = '<option value="all">Semua Level</option>';
            
            uniqueLevels.forEach(level => {
                studentLevelFilter.innerHTML += `<option value="${level}">${level}</option>`;
            });
            studentLevelFilter.value = currentLevel || 'all';
        }

        function updateStudentPagination(totalItems) {
            const totalPages = Math.ceil(totalItems / studentRowsPerPage) || 1;
            document.getElementById('studentCurrentPage').textContent = studentCurrentPage;
            document.getElementById('studentTotalPages').textContent = totalPages;
            document.getElementById('studentPrevBtn').disabled = studentCurrentPage === 1;
            document.getElementById('studentNextBtn').disabled = studentCurrentPage >= totalPages;
        }

        function setupReportsListener(coachEmail) {
            const reportsTableBody = document.getElementById('reportsTableBody');
            reportsTableBody.innerHTML = '<tr><td colspan="8">Memuat laporan...</td></tr>';
            
            const reportQuery = query(collection(db, "reports"), where("coachEmail", "==", coachEmail));
            onSnapshot(reportQuery, (querySnapshot) => {
                sessionReadCount += querySnapshot.docs.length;
                window.updateReadStatus();
                allMyReports = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                handleReportFilterChange();
            }, (error) => {
                console.error("Gagal memuat data laporan:", error);
                reportsTableBody.innerHTML = '<tr><td colspan="8">Terjadi kesalahan saat memuat data.</td></tr>';
            });
        }
        
        // FUNGSI INI DIPERBAIKI UNTUK MEMASTIKAN SISWA TERBARU BENAR-BENAR TERPILIH
        async function handleInitialReportLoad() {
            if (myStudents.length === 0) {
                handleReportFilterChange();
                return;
            }

            // Fungsi helper untuk mendapatkan nilai waktu (milidetik) dari Timestamp/Date Object/String
            const getDateValue = (ts) => {
                if (!ts) return 0;
                if (typeof ts.toDate === 'function') {
                    // Jika ini adalah Firebase Timestamp
                    return ts.toDate().getTime();
                } else if (ts.seconds) {
                    // Jika ini adalah objek { seconds, nanoseconds } yang tidak diproses
                    return ts.seconds * 1000 + Math.round(ts.nanoseconds / 1000000); // Pastikan nanoseconds juga diperhitungkan
                } else {
                     // Coba konversi dari objek atau string biasa (fallback)
                     try { return new Date(ts).getTime(); } catch { return 0; }
                }
            };

            // 1. Sort siswa berdasarkan lastReportTimestamp (terbaru di atas)
            const latestStudent = myStudents.sort((a, b) => {
                const dateA = getDateValue(a.lastReportTimestamp);
                const dateB = getDateValue(b.lastReportTimestamp);
                
                // Urutkan dari tanggal terbaru ke terlama (descending)
                if (dateB !== dateA) {
                    return dateB - dateA; 
                }
                
                // Jika tanggal sama persis, urutkan berdasarkan nama (agar stabil)
                return a.name.localeCompare(b.name);
            })[0];

            if (latestStudent && latestStudent.lastReportTimestamp) {
                const reportFilterStudent = $('#reportFilterStudent');
                
                // Pastikan opsi siswa terbaru ada di select2
                const currentStudentOption = myStudents.find(s => s.id === latestStudent.id);
                if (currentStudentOption) {
                    // Kita asumsikan opsi sudah ada (dari AJAX), hanya perlu memastikan ia dipilih
                    if (!reportFilterStudent.find(`option[value='${latestStudent.id}']`).length) {
                        const newOption = new Option(currentStudentOption.name, currentStudentOption.id, false, false);
                        reportFilterStudent.append(newOption);
                    }
                }
                
                // Set nilai filter ke siswa terbaru dan trigger perubahan
                reportFilterStudent.val(latestStudent.id).trigger('change');
            } else {
                // Jika tidak ada laporan sama sekali, biarkan filter kosong
                handleReportFilterChange();
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const docRef = doc(db, "users", user.email);

                onSnapshot(docRef, async (docSnap) => {
                    sessionReadCount++;
                    window.updateReadStatus();
                    if (docSnap.exists() && docSnap.data().role === 'user' && docSnap.data().status !== 'disabled') {
                        document.body.style.display = 'block';
                        const userData = docSnap.data();
                        
                        document.getElementById('mainHeader').textContent = `Selamat datang, ${userData.name || user.email}`;
                        currentCoachName = userData.name || user.email;
                        
                        document.getElementById('reportDate').value = new Date().toISOString().split('T')[0];

                        if (!window.initialLoadDone) {
                            window.initialLoadDone = true;
                            
                            kurikulum = JSON.parse(localStorage.getItem('kurikulum'))?.data || await fetchCurriculum();
                            brandSettings = JSON.parse(localStorage.getItem('brandSettings'))?.data || await fetchBrandSettings();

                            setupStudentsListener(user.email);
                            setupReportsListener(user.email);
                            await loadAppEditPin();
                            setupEventListeners();
                            initSelect2Dropdowns(user.email);
                            
                            // Eksekusi pemuatan filter riwayat setelah data siswa dan laporan dimuat
                            setTimeout(() => {
                                handleInitialReportLoad();
                            }, 500); 
                        }
                    } else {
                        alert("Akses ditolak.");
                        await signOut(auth);
                        window.location.href = 'login.html';
                    }
                }, (error) => {
                    console.error("Gagal mendengarkan perubahan data pengguna:", error);
                });
            } else {
                window.location.href = 'login.html';
            }
        });

        async function fetchCurriculum() {
            try {
                const querySnapshot = await getDocs(collection(db, "kurikulum"));
                sessionReadCount += querySnapshot.size; window.updateReadStatus();
                const data = {};
                querySnapshot.forEach(doc => { data[doc.id] = doc.data().lessons; });
                saveToCache('kurikulum', data);
                return data;
            } catch (error) { console.error("Gagal ambil kurikulum:", error); return {}; }
        }

        async function fetchBrandSettings() {
            try {
                const docSnap = await getDoc(doc(db, "settings", "brand"));
                sessionReadCount++; window.updateReadStatus();
                const settings = docSnap.exists() ? docSnap.data() : {};
                saveToCache('brandSettings', settings);
                return settings;
            } catch (error) { console.error("Gagal ambil brand settings:", error); return {}; }
        }

        function initSelect2Dropdowns(coachEmail) {
            $('#studentSelectorForReport').select2({
                placeholder: "-- Pilih Siswa --",
                allowClear: false,
                width: 'style',
                ajax: {
                    delay: 250,
                    transport: function(params, success) {
                        const term = (params.data.q || '').toLowerCase();
                        
                        // BATASAN 2 HURUF UNTUK INPUT LAPORAN
                        if (term.length < 2) { 
                            return success({ results: [] }); 
                        }
                        
                        const filteredResults = myStudents
                            .filter(s => s.name.toLowerCase().includes(term))
                            .map(s => ({ id: s.id, text: s.name, data: s }));
                        success({ results: filteredResults });
                    }
                }
            });

            $('#reportFilterStudent').select2({
                placeholder: "-- Semua Siswa --",
                allowClear: true,
                width: 'style',
                ajax: {
                    delay: 250,
                    transport: function(params, success) {
                        const term = (params.data.q || '').toLowerCase();
                        
                        // Batasi pencarian: Jika term kosong, hanya tampilkan opsi default, 
                        // Jika term < 2, batalkan pencarian untuk menghemat kinerja Select2
                        if (term.length < 2 && term.length > 0) { 
                            return success({ results: [] }); 
                        }
                        
                        // Tampilkan semua siswa jika term kosong (logika Select2) atau hasil filter
                        const allStudents = myStudents.map(s => ({ id: s.id, text: s.name }));
                        const filteredResults = allStudents
                            .filter(s => s.text.toLowerCase().includes(term));
                        
                        // Jika term kosong, kita hanya ingin menampilkan opsi default dan siswa yang sudah terpilih,
                        // untuk mencegah daftar panjang.
                        if (term.length === 0) {
                            let results = [];
                            // Tambahkan siswa yang sedang terpilih di filter (jika ada)
                            const currentSelectedId = $('#reportFilterStudent').val();
                            if (currentSelectedId) {
                                const selectedStudent = allStudents.find(s => s.id === currentSelectedId);
                                if (selectedStudent) results.push(selectedStudent);
                            }
                            // Kita hanya membiarkan opsi default yang ditambahkan di processResults
                            success({ results: results });
                            return;
                        }
                        
                        success({ results: filteredResults });
                    },
                    processResults: function(data) {
                        // Tambahkan opsi 'Semua Siswa' di awal, hanya jika belum ada di hasil
                        const initialOption = [{ id: '', text: '-- Semua Siswa --' }];
                        const existingIds = new Set(data.results.map(r => r.id));

                        let finalResults = [];
                        if (!existingIds.has('')) {
                            finalResults = initialOption;
                        }
                        
                        // Jika hasil pencarian kosong (karena term < 2), kita hanya ingin opsi 'Semua Siswa'
                        if (data.results.length === 0) {
                            return { results: initialOption };
                        }
                        
                        // Gabungkan hasil filter (kecuali opsi 'Semua Siswa' yang duplikat)
                        data.results.forEach(item => {
                            if (item.id !== '') {
                                finalResults.push(item);
                            }
                        });
                        
                        return {
                            results: finalResults
                        };
                    }
                }
            });
        }

        async function handleAddReport(e) {
            e.preventDefault();
            const statusMessageDiv = document.getElementById('reportStatusMessage');
            const studentSelector = document.getElementById('studentSelectorForReport');
            const studentId = studentSelector.value;
            const reportLevelInput = document.getElementById('reportLevel');
            const reportLessonSelector = document.getElementById('reportLessonSelector');
            const activityCheckboxesContainer = document.getElementById('activityCheckboxesContainer');

            if (!studentId) {
                statusMessageDiv.textContent = 'Harap pilih siswa terlebih dahulu.'; 
                statusMessageDiv.classList.add('error-message');
                return;
            }
            
            if (!reportLevelInput.value) {
                statusMessageDiv.textContent = 'Level siswa tidak ditemukan. Harap periksa data siswa atau kurikulum.';
                statusMessageDiv.classList.add('error-message');
                return;
            }
            
            const lessonName = reportLessonSelector.value;
            const reportDate = document.getElementById('reportDate').value;
            const checkedActivities = Array.from(document.querySelectorAll('#activityCheckboxes input:checked')).map(cb => cb.value);
            const reportHasil = document.getElementById('reportHasil').value;

            if (!lessonName || !reportDate || checkedActivities.length === 0 || !reportHasil) {
                statusMessageDiv.textContent = 'Harap lengkapi semua isian laporan.';
                statusMessageDiv.classList.add('error-message');
                return;
            }

            statusMessageDiv.classList.remove('error-message');
            statusMessageDiv.textContent = 'Mengirim...';
            
            const reportData = {
                siswa: $(`#studentSelectorForReport option[value="${studentId}"]`).text(),
                studentId: studentId,
                level: reportLevelInput.value,
                coach: currentCoachName,
                coachEmail: auth.currentUser.email,
                lessonName: lessonName,
                lesson: checkedActivities.join(', '),
                hasil: reportHasil,
                timestamp: Timestamp.fromDate(new Date(reportDate)),
                submissionTimestamp: Timestamp.now(),
                isSent: false
            };

            try {
                // Tambahkan laporan baru
                await addDoc(collection(db, "reports"), reportData);
                
                // Update timestamp input terakhir di dokumen siswa
                const studentDocRef = doc(db, "students", studentId);
                await updateDoc(studentDocRef, {
                    lastLesson: lessonName,
                    // PENTING: Menggunakan Timestamp.now() untuk waktu input yang paling akurat
                    lastReportTimestamp: Timestamp.now() 
                });
                
                statusMessageDiv.textContent = 'Laporan berhasil dikirim!';
                statusMessageDiv.classList.add('success-message');

                document.getElementById('addReportForm').reset();
                studentSelector.value = null;
                $(studentSelector).trigger('change');
                reportLessonSelector.innerHTML = '';
                reportLevelInput.value = '';
                activityCheckboxesContainer.style.display = 'none';
                document.getElementById('reportDate').value = new Date().toISOString().split('T')[0];

                const reportFilterStudent = $('#reportFilterStudent');
                const studentOption = new Option(reportData.siswa, reportData.studentId, false, true);
                if (!reportFilterStudent.find(`option[value='${reportData.studentId}']`).length) {
                    reportFilterStudent.append(studentOption);
                }
                reportFilterStudent.val(reportData.studentId).trigger('change');
                document.querySelector('.report-controls').scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                statusMessageDiv.textContent = `Error: ${error.message}`;
                statusMessageDiv.classList.add('error-message');
            }
        }
        
        function handleReportFilterChange() {
            const studentId = document.getElementById('reportFilterStudent').value;
            const level = document.getElementById('reportFilterLevel').value;
            const reportsTableBody = document.getElementById('reportsTableBody');

            if (allMyReports.length === 0) {
                reportsTableBody.innerHTML = '<tr><td colspan="8">Tidak ada laporan yang cocok.</td></tr>';
                window.updateReportPagination(0);
                return;
            }

            let filteredReports = allMyReports;
            if (studentId) {
                filteredReports = filteredReports.filter(r => r.studentId === studentId);
            }
            if (level) {
                filteredReports = filteredReports.filter(r => r.level === level);
            }

            const levels = [...new Set(allMyReports.map(r => r.level))].filter(Boolean);
            const levelFilter = document.getElementById('reportFilterLevel');
            const currentLevelValue = levelFilter.value;
            levelFilter.innerHTML = '<option value="">-- Semua Level --</option>';
            levels.forEach(lvl => {
                levelFilter.innerHTML += `<option value="${lvl}">${lvl}</option>`;
            });
            if (levels.includes(currentLevelValue)) {
                levelFilter.value = currentLevelValue;
            }

            const processedReports = processAndSortReports(filteredReports);
            filteredAndSortedReports = processedReports;
            
            reportCurrentPage = 1;
            renderTableFromGlobalReports();
        }

        function processAndSortReports(reports) {
            if (!reports || reports.length === 0) return [];
            
            const groupedReports = reports.reduce((acc, report) => {
                const key = `${report.studentId}_${report.level}`;
                if (!acc[key]) acc[key] = [];
                acc[key].push(report);
                return acc;
            }, {});

            const sortedGroupKeys = Object.keys(groupedReports).sort((a, b) => {
                const studentA = myStudents.find(s => s.id === a.split('_')[0]);
                const studentB = myStudents.find(s => s.id === b.split('_')[0]);
                if (studentA && studentB) {
                    return studentA.name.localeCompare(studentB.name);
                }
                return 0;
            });
            
            let processedReports = [];
            sortedGroupKeys.forEach(key => {
                const group = groupedReports[key];
                group.sort((a, b) => {
                    const dateA = a.timestamp && a.timestamp.toDate ? a.timestamp.toDate() : new Date(a.timestamp);
                    const dateB = b.timestamp && b.timestamp.toDate ? b.timestamp.toDate() : new Date(b.timestamp);
                    return dateA - dateB;
                });
                group.forEach((report, index) => {
                    report.activityNumber = index + 1;
                    processedReports.push(report);
                });
            });
            return processedReports;
        }

        function renderTableFromGlobalReports() {
            const tableBody = document.getElementById('reportsTableBody');
            tableBody.innerHTML = '';
            
            if (filteredAndSortedReports.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8">Tidak ada laporan yang cocok.</td></tr>';
                window.updateReportPagination(0);
                return;
            }
            
            const sortOption = document.getElementById('reportSort').value;
            const [sortBy, sortDirection] = sortOption.split('_');

            const sortedReports = filteredAndSortedReports.sort((a, b) => {
                let comparison = 0;
                if (sortBy === 'activityNumber') {
                    comparison = a.activityNumber - b.activityNumber;
                } else {
                    let sortValueA = 0;
                    let sortValueB = 0;
                    try {
                        sortValueA = a[sortBy] && a[sortBy].toDate ? a[sortBy].toDate().getTime() : (a[sortBy] ? new Date(a[sortBy]).getTime() : 0);
                        sortValueB = b[sortBy] && b[sortBy].toDate ? b[sortBy].toDate().getTime() : (b[sortBy] ? new Date(b[sortBy]).getTime() : 0);
                    } catch (e) {
                        sortValueA = a[sortBy] ? new Date(a[sortBy]).getTime() : 0;
                        sortValueB = b[sortBy] ? new Date(b[sortBy]).getTime() : 0;
                    }
                    comparison = sortValueA - sortValueB;
                }
                return sortDirection === 'asc' ? comparison : -comparison;
            });

            const startIndex = (reportCurrentPage - 1) * reportRowsPerPage;
            const endIndex = startIndex + reportRowsPerPage;
            const paginatedReports = sortedReports.slice(startIndex, endIndex);

            paginatedReports.forEach(report => {
                const date = (report.timestamp && typeof report.timestamp.toDate === 'function' ? report.timestamp.toDate() : new Date(report.timestamp)).toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' });
                const rowClass = report.isSent ? 'sent-report' : '';
                const activityText = report.lesson || '';
                const resultText = report.hasil || '';
                const truncatedActivity = truncateText(activityText, 30);
                const truncatedResult = truncateText(resultText, 30);
                const escapedActivityText = activityText.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const escapedResultText = resultText.replace(/'/g, "\\'").replace(/"/g, '&quot;');

                const activityCellHtml = `
                    <div class="content-cell">
                        <span class="truncated-text">${truncatedActivity}</span>
                        ${activityText.length > 30 ? 
                            `<button type="button" class="detail-btn" onclick="window.openDetailModal('Aktivitas', '${escapedActivityText}')">...</button>` : ''
                        }
                    </div>`;

                const resultCellHtml = `
                    <div class="content-cell">
                        <span class="truncated-text">${truncatedResult}</span>
                        ${resultText.length > 30 ? 
                            `<button type="button" class="detail-btn" onclick="window.openDetailModal('Hasil', '${escapedResultText}')">...</button>` : ''
                        }
                    </div>`;

                tableBody.innerHTML += `
                    <tr class="${rowClass}">
                        <td style="text-align: center;">${report.activityNumber || ''}</td>
                        <td>${report.siswa}</td>
                        <td>${report.level}</td>
                        <td>${date}</td>
                        <td>${report.lessonName || ''}</td>
                        <td>${activityCellHtml}</td>
                        <td>${resultCellHtml}</td>
                        <td><button type="button" class="action-btn-edit" onclick="window.openPinModal('report', '${report.id}')">Edit</button></td>
                    </tr>`;
            });
            window.updateReportPagination(filteredAndSortedReports.length);
        }

        window.updateReportPagination = function(totalItems) {
            const totalPages = Math.ceil(totalItems / reportRowsPerPage) || 1;
            document.getElementById('reportCurrentPage').textContent = reportCurrentPage;
            document.getElementById('reportTotalPages').textContent = totalPages;
            document.getElementById('reportPrevBtn').disabled = reportCurrentPage === 1;
            document.getElementById('reportNextBtn').disabled = reportCurrentPage >= totalPages;
        };
        
        window.openDetailModal = function(type, content) {
            document.getElementById('detailModalTitle').textContent = `Detail ${type}`;
            document.getElementById('detailContentLabel').textContent = `${type} Lengkap:`;
            document.getElementById('detailContent').textContent = content; 
            document.getElementById('detailModal').style.display = 'flex';
        };

        window.openPinModal = function(type, id) {
            document.getElementById('pinModal').style.display = 'flex';
            document.getElementById('pinInput').value = '';
            const verifyBtn = document.getElementById('verifyPinBtn');
            verifyBtn.onclick = () => verifyPinAndOpenEdit(type, id);
        };

        async function verifyPinAndOpenEdit(type, id) {
            const enteredPin = document.getElementById('pinInput').value;
            const pinVerificationMessage = document.getElementById('pinVerificationMessage');

            if (enteredPin === appEditPin) {
                document.getElementById('pinModal').style.display = 'none';
                pinVerificationMessage.textContent = '';
                if (type === 'report') {
                    await openEditReportModal(id);
                }
            } else {
                pinVerificationMessage.textContent = 'PIN salah!';
                pinVerificationMessage.style.color = 'red';
            }
        }
        
        async function openEditReportModal(reportId) {
            const report = allMyReports.find(r => r.id === reportId);
            if (!report) {
                alert("Laporan tidak ditemukan.");
                return;
            }
            document.getElementById('editReportId').value = report.id;
            document.getElementById('editReportSiswa').value = report.siswa;
            document.getElementById('editReportTanggal').value = (report.timestamp && report.timestamp.toDate) ? report.timestamp.toDate().toISOString().split('T')[0] : '';
            const editLevelInput = document.getElementById('editReportLevel');
            editLevelInput.value = report.level;
            
            const editLessonSelector = document.getElementById('editReportLesson');
            const editActivityContainer = document.getElementById('editActivityCheckboxesContainer');
            const editActivityCheckboxes = document.getElementById('editActivityCheckboxes');
            
            editLessonSelector.innerHTML = '';
            editActivityCheckboxes.innerHTML = '';
            
            if (report.level && kurikulum[report.level]) {
                const lessons = kurikulum[report.level];
                const sortedLessonKeys = Object.keys(lessons).sort((a, b) => (parseInt(a.split(' ')[1]) || 0) - (parseInt(b.split(' ')[1]) || 0));
                
                editLessonSelector.innerHTML += '<option value="">-- Pilih Lesson --</option>';
                sortedLessonKeys.forEach(lessonKey => {
                    const selected = (lessonKey === report.lessonName) ? 'selected' : '';
                    editLessonSelector.innerHTML += `<option value="${lessonKey}" ${selected}>${lessonKey}</option>`;
                });
                
                if (report.lessonName && lessons[report.lessonName]) {
                    const activities = lessons[report.lessonName];
                    const selectedActivities = report.lesson ? report.lesson.split(', ').sort() : [];
                    
                    activities.sort().forEach(activity => {
                        const checked = selectedActivities.includes(activity) ? 'checked' : '';
                        editActivityCheckboxes.innerHTML += `<label><input type="checkbox" value="${activity}" ${checked}> ${activity}</label>`;
                    });
                    editActivityContainer.style.display = 'block';
                } else {
                    editActivityCheckboxes.innerHTML = '';
                    editActivityCheckboxes.style.display = 'none';
                }
            } else {
                editActivityCheckboxes.innerHTML = '';
                editActivityCheckboxes.style.display = 'none';
            }

            editLessonSelector.onchange = function() {
                const newLessonName = this.value;
                editActivityCheckboxes.innerHTML = '';
                if (newLessonName && kurikulum[report.level] && kurikulum[report.level][newLessonName]) {
                    const newActivities = kurikulum[report.level][newLessonName].sort();
                    newActivities.forEach(activity => {
                        editActivityCheckboxes.innerHTML += `<label><input type="checkbox" value="${activity}" checked> ${activity}</label>`;
                    });
                    editActivityContainer.style.display = 'block';
                } else {
                    editActivityCheckboxes.innerHTML = '';
                    editActivityContainer.style.display = 'none';
                }
            };

            document.getElementById('editReportHasil').value = report.hasil;
            document.getElementById('editReportModal').style.display = 'flex';
        }
        
        async function handleEditReport(e) {
            e.preventDefault();
            const reportId = document.getElementById('editReportId').value;
            
            const editLessonSelector = document.getElementById('editReportLesson');
            const editActivityCheckboxes = document.querySelectorAll('#editActivityCheckboxes input:checked');
            
            if (!editLessonSelector.value || editActivityCheckboxes.length === 0 || !document.getElementById('editReportTanggal').value || !document.getElementById('editReportHasil').value) {
                alert('Harap lengkapi semua isian laporan.');
                return;
            }

            const updatedActivities = Array.from(editActivityCheckboxes).map(cb => cb.value).sort().join(', ');

            const updatedData = {
                timestamp: Timestamp.fromDate(new Date(document.getElementById('editReportTanggal').value)),
                lessonName: editLessonSelector.value,
                lesson: updatedActivities,
                hasil: document.getElementById('editReportHasil').value,
            };

            try {
                await updateDoc(doc(db, "reports", reportId), updatedData);
                alert('Laporan berhasil diperbarui!');
                document.getElementById('editReportModal').style.display = 'none';
            } catch (error) {
                alert(`Gagal memperbarui laporan: ${error.message}`);
                console.error("Error updating report:", error);
            }
        }

        function handleStudentSelectForReport(e) {
            const studentId = $(this).val();
            const levelInput = document.getElementById('reportLevel');
            const lessonSelector = document.getElementById('reportLessonSelector');
            const activityContainer = document.getElementById('activityCheckboxesContainer');

            if (!studentId) {
                levelInput.value = '';
                lessonSelector.innerHTML = '';
                activityContainer.style.display = 'none';
                return;
            }

            const student = myStudents.find(s => s.id === studentId);
            if (student && student.studentLevel) {
                const studentLevelValue = student.studentLevel;
                levelInput.value = studentLevelValue;
                const lessons = kurikulum[studentLevelValue];
                lessonSelector.innerHTML = '<option value="">-- Pilih Lesson --</option>';
                if (lessons) {
                    const sortedLessonKeys = Object.keys(lessons).sort((a, b) => (parseInt(a.split(' ')[1]) || 0) - (parseInt(b.split(' ')[1]) || 0));
                    sortedLessonKeys.forEach(lessonKey => {
                        if (lessons[lessonKey] && lessons[lessonKey].length > 0) {
                            lessonSelector.innerHTML += `<option value="${lessonKey}">${lessonKey}</option>`;
                        }
                    });
                }
            } else {
                 levelInput.value = '';
                 lessonSelector.innerHTML = '';
                 activityContainer.style.display = 'none';
            }
        }

        function handleLessonSelect(e) {
            const lessonName = e.target.value;
            const level = document.getElementById('reportLevel').value;
            const container = document.getElementById('activityCheckboxesContainer');
            const checkboxes = document.getElementById('activityCheckboxes');
            checkboxes.innerHTML = '';
            if (!lessonName || !level || !kurikulum[level]) { container.style.display = 'none'; return; }

            const activities = kurikulum[level][lessonName].sort();
            if (activities && activities.length > 0) {
                activities.forEach(activity => {
                    checkboxes.innerHTML += `<label><input type="checkbox" value="${activity}" checked> ${activity}</label>`;
                });
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        }

        let isSetupDone = false;
        function setupEventListeners() {
            if (isSetupDone) return;
            document.getElementById('addReportForm').addEventListener('submit', handleAddReport);
            $('#studentSelectorForReport').on('change', handleStudentSelectForReport);
            document.getElementById('reportLessonSelector').addEventListener('change', handleLessonSelect);
            $('#reportFilterStudent').on('change', handleReportFilterChange);
            document.getElementById('reportSort').addEventListener('change', handleReportFilterChange);
            document.getElementById('clearReportFilterBtn').addEventListener('click', () => {
                $('#reportFilterStudent').val(null).trigger('change');
                document.getElementById('reportSort').value = 'activityNumber_desc';
                handleReportFilterChange();
            });
            
            document.getElementById('studentRowsPerPage').addEventListener('change', (e) => {
                studentRowsPerPage = parseInt(e.target.value);
                studentCurrentPage = 1;
                renderStudentTable();
            });
            document.getElementById('studentPrevBtn').addEventListener('click', () => {
                if (studentCurrentPage > 1) {
                    studentCurrentPage--;
                    renderStudentTable();
                }
            });
            document.getElementById('studentNextBtn').addEventListener('click', () => {
                // Tentukan total item berdasarkan filter level dan filter today
                const selectedLevel = document.getElementById('studentLevelFilter').value;
                const selectedTodayStatus = document.getElementById('studentTodayFilter').value;
                
                let filteredItems = myStudents;
                if (selectedLevel !== 'all') {
                    filteredItems = filteredItems.filter(s => s.studentLevel === selectedLevel);
                }
                if (selectedTodayStatus === 'pending') {
                    filteredItems = filteredItems.filter(s => !isToday(s.lastReportTimestamp));
                }
                
                const totalItems = filteredItems.length;
                const totalPages = Math.ceil(totalItems / studentRowsPerPage) || 1;
                
                if (studentCurrentPage < totalPages) {
                    studentCurrentPage++;
                    renderStudentTable();
                }
            });
            
            // MODIFIKASI: Menambahkan event listener untuk filter siswa (Level dan Today)
            document.getElementById('studentLevelFilter').addEventListener('change', () => {
                studentCurrentPage = 1;
                renderStudentTable();
            });
            document.getElementById('studentTodayFilter').addEventListener('change', () => {
                studentCurrentPage = 1;
                renderStudentTable();
            });

            document.getElementById('editReportForm').addEventListener('submit', handleEditReport);
            document.querySelector('#editReportModal .close-btn').onclick = () => document.getElementById('editReportModal').style.display = 'none';

            isSetupDone = true;
        }

        window.formatPhoneNumber = function(number) {
            if (typeof number !== 'string') {
                return '';
            }
            number = number.replace(/\s/g, '');
            if (number.startsWith('0')) {
                return '62' + number.slice(1);
            } else if (number.startsWith('+')) {
                return number.slice(1);
            }
            return number;
        };
    </script>
</body>
</html>
